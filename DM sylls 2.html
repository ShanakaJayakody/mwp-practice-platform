<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DM Syllogisms Worksheet 2 - MedwithPurpose</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        /* Custom styles for better UI/UX */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent scrolling on body */
        }
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f0f2f5; /* Light background */
        }
        #app-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 2rem); /* Full height minus padding */
            width: 100%;
            max-width: 1200px; /* Optional: Max width for larger screens */
            background-color: #ffffff;
            border: 1px solid #d1d5db; /* Border */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-radius: 0.375rem; /* Slightly rounded corners */
            margin: 1rem; /* Add some margin */
            overflow: hidden; /* Prevent content overflow from container */
            position: relative; /* For calculator positioning */
        }
        /* Header and Footer */
        .header-bar, .footer-bar {
            flex-shrink: 0; /* Prevent shrinking */
            background-color: #005A8C; /* Slightly darker blue for top bar */
            color: white; /* Set default text color to white */
            padding: 0.75rem 1.5rem; /* Padding */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Secondary toolbar styling */
        .secondary-toolbar {
            flex-shrink: 0;
            background-color: #007BBD;
            color: white;
            padding: 0.5rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #005A8C;
            z-index: 19;
        }

        /* Buttons in secondary toolbar */
        .secondary-toolbar-button {
            background-color: transparent;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.6);
            padding: 0.3rem 0.7rem;
            font-size: 0.8rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s ease, border-color 0.2s ease;
            margin-left: 0.5rem; /* Spacing between buttons */
        }
        .secondary-toolbar-button:hover:not(:disabled) {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: white;
        }
        .secondary-toolbar-button.active { /* For calculator button when active */
            background-color: rgba(255, 255, 255, 0.2);
            border-color: white;
        }

        /* Specific text colors within header/footer */
        .header-bar span, .header-bar div {
             color: white;
        }

        /* Footer Button Styling */
        .footer-bar button {
            background-color: transparent;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.5); /* Subtle white border */
            padding: 0.4rem 0.8rem; /* Adjust padding */
            font-size: 0.8rem; /* Adjust font size */
            border-radius: 0.375rem;
             transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        .footer-bar button:hover:not(:disabled) {
            background-color: rgba(255, 255, 255, 0.15); /* Slight white background on hover */
            border-color: white;
        }
         .footer-bar button:disabled {
             opacity: 0.5;
             cursor: not-allowed;
             border-color: rgba(255, 255, 255, 0.3);
         }
         /* Keep primary button distinct */
         .footer-bar button#next-button {
             background-color: #ffffff; /* White background */
             color: #006DAA; /* Blue text */
             border: 1px solid white;
             font-weight: 500;
         }
         .footer-bar button#next-button:hover:not(:disabled) {
             background-color: #f0f0f0; /* Slightly off-white on hover */
         }
         /* Flag button specific style */
         #flag-button {
             background-color: transparent;
             border: 1px solid white;
             color: white;
             transition: background-color 0.2s ease, color 0.2s ease; /* Add transition */
         }
         #flag-button:hover {
             background-color: white;
             color: #006DAA;
         }
         /* Style for when a question IS flagged */
          #flag-button.flagged {
             background-color: #facc15; /* Yellow-400 */
             border-color: #facc15;
             color: #422006; /* Dark brown text for contrast */
          }
          #flag-button.flagged:hover {
             background-color: #f59e0b; /* Amber-500 */
             border-color: #f59e0b;
          }

        /* Main Content Area - Single Column Layout */
        .main-content-area {
            flex-grow: 1; /* Take remaining vertical space */
            display: flex;
            flex-direction: column; /* Stack premises and questions */
            overflow-y: auto; /* Allow scrolling for the whole area */
            padding: 1rem 1.5rem; /* Padding */
        }

        /* Premises Section */
        .premises-section {
            margin-bottom: 1.5rem; /* Space below premises */
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            background-color: #f9fafb;
            flex-shrink: 0; /* Prevent premises from shrinking too much */
        }
        .premises-section h3 {
            margin-bottom: 0.5rem;
        }

        /* Statements Section Wrapper (NEW) */
        .statements-wrapper {
            flex-grow: 1; /* Allow this section to take remaining space */
            display: flex; /* Use flexbox for side-by-side layout */
            gap: 1.5rem; /* Gap between statements and draggable options */
            overflow: hidden; /* Prevent internal overflow issues */
        }


        /* Statements Section (List on the Left) */
        .statements-section {
             flex-grow: 1; /* Allow statements list to take available space */
             display: flex;
             flex-direction: column;
             overflow-y: auto; /* Allow scrolling only for statements list */
             padding-right: 0.5rem; /* Padding before options */
        }
        .statements-section h4 {
            margin-bottom: 0.25rem;
             position: sticky; /* Make header sticky */
             top: 0;
             background-color: white; /* Background to cover scrolling content */
             z-index: 10;
             padding-bottom: 0.25rem;
        }
        .statements-section p.instructions {
             margin-bottom: 1rem;
             position: sticky;
             top: 2rem; /* Adjust based on h4 height */
             background-color: white;
             z-index: 10;
             padding-bottom: 0.5rem;
        }

        /* Styling for individual statement rows */
        .statement-row {
            display: flex;
            align-items: center; /* Vertically align items */
            gap: 1rem; /* Space between text and answer box */
            margin-bottom: 0.75rem;
            padding: 0.5rem;
            border-radius: 0.375rem;
            background-color: #ffffff;
            border: 1px solid #d1d5db;
            transition: border-color 0.2s ease, background-color 0.2s ease; /* Add transition */
        }

        /* Style when dragging over the statement row */
        .statement-row.drag-over {
            border-color: #3b82f6; /* Solid blue border */
            background-color: #eff6ff; /* Lighter blue background */
        }

        /* Styling for statement text */
        .statement-text {
            flex-grow: 1; /* Take available space */
            font-size: 0.9rem;
            color: #374151;
            padding: 0.25rem; /* Add slight padding */
            pointer-events: none; /* Prevent text from interfering with drop */
        }

        /* Styling for the answer box (visual indicator within the row) */
        .statement-answer-box {
            flex-shrink: 0; /* Prevent shrinking */
            width: 6rem; /* Wider box */
            height: 2.5rem; /* Taller box */
            border: 2px solid transparent; /* Initially transparent border */
            border-radius: 0.375rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            color: #6b7280; /* Default text color */
            background-color: #f3f4f6; /* Light grey background */
            transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
            pointer-events: none; /* Prevent box from interfering with row drop */
        }

        /* Style for answered boxes */
        .statement-answer-box.answered-yes {
            background-color: #dcfce7; /* Green-100 */
            border: 2px solid #22c55e; /* Green-500 */
            color: #15803d; /* Green-700 */
        }
        .statement-answer-box.answered-no {
            background-color: #fee2e2; /* Red-100 */
            border: 2px solid #ef4444; /* Red-500 */
            color: #b91c1c; /* Red-700 */
        }

        /* Styling for the draggable Yes/No options sidebar (NEW) */
        #draggable-options-sidebar {
            flex-shrink: 0; /* Prevent shrinking */
            width: 8rem; /* Fixed width for the sidebar */
            padding-top: 4rem; /* Align roughly with start of statements */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem; /* Space between Yes and No */
        }

        /* Styling for draggable Yes/No elements */
        .draggable-option {
            padding: 0.6rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: grab; /* Indicate draggable */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.1s ease;
            text-align: center;
            width: 80%; /* Make buttons fill sidebar width */
        }
        .draggable-option:active {
             cursor: grabbing;
             transform: scale(0.95);
        }
        .draggable-option-yes {
            background-color: #86efac; /* Green-300 */
            border: 1px solid #22c55e; /* Green-500 */
            color: #14532d; /* Green-900 */
        }
        .draggable-option-no {
            background-color: #fca5a5; /* Red-300 */
            border: 1px solid #ef4444; /* Red-500 */
            color: #7f1d1d; /* Red-900 */
        }

        /* Style for navigator buttons */
        .nav-answered { background-color: #a7f3d0; }
        .nav-current { border: 2px solid #3b82f6 !important; font-weight: bold; }
        .nav-flagged, .review-flagged { border: 2px solid #f59e0b !important; position: relative; }

        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 0.5rem; }
        .modal.flex { display: flex; }

        /* General Button Styling (outside footer) */
        button, .button {
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            border-radius: 0.375rem;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            cursor: pointer;
        }
        button:active, .button:active { transform: scale(0.98); }
        button:disabled { opacity: 0.6; cursor: not-allowed; }

        .primary-button { background-color: #3b82f6; color: white; border: 1px solid transparent; }
        .primary-button:hover:not(:disabled) { background-color: #2563eb; }
        .secondary-button { background-color: white; color: #374151; border: 1px solid #d1d5db; }
        .secondary-button:hover:not(:disabled) { background-color: #f9fafb; }
        .danger-button { background-color: #ef4444; color: white; border: 1px solid transparent; }
        .danger-button:hover:not(:disabled) { background-color: #dc2626; }
        .subtle-button { background-color: #f3f4f6; color: #374151; border: 1px solid transparent; }
        .subtle-button:hover:not(:disabled) { background-color: #e5e7eb; }

        /* --- Result Styling --- */
       .correct-answer { background-color: #dcfce7; border-left: 4px solid #22c55e; }
       .partially-correct-answer { background-color: #fef9c3; border-left: 4px solid #eab308; }
       .incorrect-answer { background-color: #fee2e2; border-left: 4px solid #ef4444; }
       .result-item-clickable { cursor: pointer; transition: background-color 0.2s ease-in-out; border: 1px solid #e5e7eb; border-radius: 0.5rem; margin-bottom: 0.5rem; padding: 0.75rem; }
       .result-item-clickable:hover { background-color: #f0f0f0; }
       .correct-indicator-text { color: #16a34a; font-weight: 600;}
       .incorrect-indicator-text { color: #dc2626; font-weight: 600;}
       .result-statement { font-size: 0.8rem; margin-left: 1rem; margin-bottom: 0.25rem; padding-left: 0.5rem; border-left: 2px solid #e5e7eb; }
       .result-statement.correct { border-left-color: #22c55e; }
       .result-statement.incorrect { border-left-color: #ef4444; }
       /* --- END Result Styling --- */

        /* --- Results Overview Grid (New) --- */
        #results-overview-grid {
            /* Styles for the grid container itself are in Tailwind classes */
        }
        .result-summary-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            background-color: #fff;
            border: 1px solid #e5e7eb; /* Tailwind gray-200 */
            border-radius: 0.5rem; /* Tailwind rounded-lg */
            padding: 0.75rem; /* Tailwind p-3 */
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); /* Subtle shadow */
            cursor: pointer;
            position: relative; /* Added for tooltip positioning */
        }
        .result-summary-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .result-summary-item.flagged-result {
            border-left-width: 4px;
            border-left-color: #f59e0b; /* Tailwind amber-500 */
        }
        .result-summary-points {
            font-size: 1.125rem; /* Tailwind text-lg */
            font-weight: 600; /* Tailwind font-semibold */
            margin-bottom: 0.25rem;
        }
        .result-summary-points.correct-2pts { color: #16a34a; } /* Tailwind green-600 */
        .result-summary-points.correct-1pt { color: #ca8a04; } /* Tailwind yellow-600 */
        .result-summary-points.incorrect-0pts { color: #dc2626; } /* Tailwind red-600 */
        
        .result-summary-qnum {
            font-size: 0.875rem; /* Tailwind text-sm */
            color: #4b5563; /* Tailwind gray-600 */
            margin-bottom: 0.5rem;
        }
        .result-summary-statements {
            font-size: 0.75rem; /* Tailwind text-xs */
            color: #6b7280; /* Tailwind gray-500 */
            line-height: 1.2;
        }
         /* Tooltip for statement summary on hover (simple version) */
        .result-summary-item .tooltip-text {
            visibility: hidden;
            width: 180px;
            background-color: #374151; /* Tailwind gray-700 */
            color: #fff;
            text-align: left;
            padding: 8px;
            border-radius: 6px;
            position: absolute;
            z-index: 1;
            bottom: 110%; /* Position above the item */
            left: 50%;
            margin-left: -90px; /* Use half of the width to center */
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 0.75rem;
            line-height: 1.3;
        }
        .result-summary-item:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        .result-summary-item .tooltip-text::after { /* Arrow */
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #374151 transparent transparent transparent;
        }
        /* --- END Results Overview Grid --- */

        /* Style for explanation box */
        .explanation-box { background-color: #fef3c7; border: 1px solid #fcd34d; padding: 0.75rem; margin-top: 1rem; border-radius: 0.375rem; font-size: 0.875rem; color: #78350f; }

        /* Review Grid Button Styles */
        .review-grid-button { padding: 0.5rem 0.25rem; border: 1px solid #d1d5db; border-radius: 0.375rem; text-align: center; transition: background-color 0.2s ease, border-color 0.2s ease; font-size: 0.875rem; line-height: 1.25rem; cursor: pointer; }
        .review-grid-button-answered { background-color: #dcfce7; border-color: #86efac; color: #15803d; }
        .review-grid-button-unanswered { background-color: #f3f4f6; border-color: #d1d5db; color: #4b5563; }
         .review-grid-button:hover { filter: brightness(95%); }


        /* Responsive adjustments */
        @media (max-width: 768px) {
            #app-container { height: auto; margin: 0.5rem; }
            .main-content-area { padding: 0.75rem; }
            .premises-section { padding: 0.75rem; }
            .statements-wrapper { flex-direction: column; gap: 1rem; } /* Stack statements and options */
            .statements-section { padding-right: 0; overflow-y: visible; } /* Remove padding, disable scroll */
            #draggable-options-sidebar {
                width: 100%;
                padding-top: 0;
                flex-direction: row; /* Options side-by-side */
                justify-content: space-around; /* Space out options */
                padding: 0.75rem 0;
                border-top: 1px solid #e5e7eb; /* Add separator */
            }
            .draggable-option { width: 40%; padding: 0.5rem 1rem; font-size: 0.85rem;}

            .statement-row { gap: 0.5rem; padding: 0.4rem; }
            .statement-text { font-size: 0.85rem; }
            .statement-answer-box { width: 5rem; height: 2.2rem; font-size: 0.8rem; }

            .header-bar, .footer-bar, .secondary-toolbar { padding: 0.5rem 1rem; }
            .header-bar span, .footer-bar button, .secondary-toolbar-button { font-size: 0.8rem; }
            button, .button { padding: 0.4rem 0.8rem; }
            .footer-bar button { padding: 0.3rem 0.6rem; font-size: 0.75rem; }
            .grid-cols-5 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
            #review-grid { grid-template-columns: repeat(5, minmax(0, 1fr)); }
            .review-grid-button { font-size: 0.8rem; }
            #calculator-ui { width: 210px; top: 90px; padding: 10px;} 
            .calc-button { padding: 8px 0; font-size: 0.8rem;}
            #calc-display { font-size: 1.4rem; }
        }
         @media (max-width: 480px) {
             .main-content-area { padding: 0.5rem; }
             .grid-cols-5 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
             #review-grid { grid-template-columns: repeat(4, minmax(0, 1fr)); }
             .header-bar span, .footer-bar button { font-size: 0.75rem; }
             button, .button { padding: 0.3rem 0.6rem; }
             .footer-bar button { padding: 0.25rem 0.5rem; font-size: 0.7rem; }
             .statement-row { flex-direction: column; align-items: stretch; gap: 0.4rem; } /* Stack text and box */
             .statement-answer-box { width: auto; } /* Full width */
             #draggable-options-sidebar { gap: 0.5rem; }
             .draggable-option { width: 45%; padding: 0.4rem 0.8rem; font-size: 0.8rem; }
             .review-grid-button { font-size: 0.75rem; }
             #calculator-ui { width: 90%; max-width: 200px; top: 85px; padding: 8px; } 
             .calc-button { padding: 7px 0; font-size: 0.75rem;}
             #calc-display { font-size: 1.3rem; }
         }

    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    </head>
<body>

    <div id="app-container">

        <div id="setup-screen" class="p-6 md:p-8 flex flex-col justify-center items-center h-full">
             <div class="text-center mb-6">
                 <img src="https://ik.imagekit.io/mwp/MWP%20Color%20no%20background.png?updatedAt=1745982959141"
                      alt="MedwithPurpose Logo"
                      class="mx-auto h-20 w-auto mb-4"
                      onerror="this.style.display='none'; this.onerror=null;">
                 <h1 class="text-2xl md:text-3xl font-bold text-blue-600">Decision Making Syllogisms Worksheet 2</h1>
                 <p class="text-gray-600 mt-2">Practice the UCAT Decision Making section.</p>
                  <p class="text-sm text-gray-500 mt-4">
                       This section contains <strong id="setup-question-count">5 questions</strong>, each with 5 statements. Maximum score is <strong id="setup-max-score">10 points</strong>.
                  </p>
             </div>
             <div class="space-y-4 w-full max-w-md">
                 <div>
                     <label for="goal" class="block text-sm font-medium text-gray-700">Goal (Score out of 10):</label>
                     <input type="number" id="goal" name="goal" min="0" max="10" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="e.g., 8">
                 </div>
                 <div>
                     <label for="focus-area" class="block text-sm font-medium text-gray-700">Area of Focus / Intention For Practice:</label>
                     <input type="text" id="focus-area" name="focus-area" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="e.g., Syllogisms, Logic Puzzles">
                 </div>
             </div>
             <div class="mt-8 text-center">
                 <button id="start-button" class="primary-button text-lg px-8 py-3">
                     Start Practice
                 </button>
                 <button onclick="window.location.href = 'student_dashboard.html';" class="secondary-button text-md px-6 py-2 mt-4">
                     Return to Dashboard
                 </button>
             </div>
        </div>

        <div id="exam-screen" class="hidden flex flex-col h-full">
            <div class="header-bar">
                <span id="exam-title" class="font-semibold">Decision Making</span>
                <div class="flex items-center space-x-4">
                    <div id="timer" class="font-semibold">06:00</div>
                    <span class="text-sm">Question <span id="question-number-info">1</span> of 5</span>
                </div>
            </div>
            <div class="secondary-toolbar">
                <div> 
                    <button id="calculator-toggle-button" class="secondary-toolbar-button">Calculator (Alt+C)</button>
                </div>
                <div> 
                    <button id="flag-button" class="secondary-toolbar-button">Flag for Review</button>
                </div>
            </div>

            <div class="main-content-area">
                <div class="premises-section">
                    <h3 class="text-lg font-semibold">Premises</h3>
                    <div id="premises-text" class="text-sm text-gray-700 leading-relaxed whitespace-pre-wrap">
                        </div>
                </div>

                <div class="statements-wrapper">
                    <div class="statements-section">
                        <h4 class="text-md font-semibold">Statements (Question <span id="question-number">1</span>)</h4>
                        <p class="text-xs text-gray-500 instructions">Drag 'Yes' or 'No' onto the statement row.</p>
                        <div id="statements-list">
                            </div>
                    </div> <div id="draggable-options-sidebar">
                        <div id="draggable-yes" class="draggable-option draggable-option-yes" draggable="true">Yes</div>
                        <div id="draggable-no" class="draggable-option draggable-option-no" draggable="true">No</div>
                     </div>
                </div> <div id="review-explanation-container" class="mt-4"></div>

            </div> <div class="footer-bar">
                 <button id="back-to-results-button" class="hidden mr-auto">← Back to Results</button>
                 <button id="end-exam-button-footer">End Practice</button>
                 <div class="flex items-center space-x-2 ml-auto">
                     <button id="prev-button" disabled>← Previous (Alt+P)</button>
                     <button id="navigator-button">Navigator</button>
                     <button id="next-button">Next (Alt+N) →</button>
                 </div>
            </div>
        </div>

        <div id="review-screen" class="hidden p-6 md:p-8 flex flex-col items-center h-full overflow-y-auto">
             <div class="w-full max-w-3xl mb-4 flex justify-between items-center">
                 <h2 class="text-2xl font-bold text-blue-600">Review Your Answers</h2>
                 <button id="filter-flagged-button" class="secondary-button text-sm">Show Flagged Only</button>
             </div>
             <p class="text-center text-gray-600 mb-6">Click on a question number to review it. Green indicates answered, Yellow border indicates flagged.</p>
            <div id="review-grid" class="grid grid-cols-5 gap-3 mb-6 w-full max-w-xl"> </div>
            <div class="mt-auto pt-6">
                <button id="end-exam-button" class="danger-button text-lg px-8 py-3">
                    End Practice & See Results
                </button>
            </div>
        </div>

        <div id="results-screen" class="hidden p-6 md:p-8 flex flex-col h-full">
             <div class="text-center mb-6 flex-shrink-0">
                 <img src="https://ik.imagekit.io/mwp/MWP%20Color%20no%20background.png?updatedAt=1745982959141"
                      alt="MedwithPurpose Logo"
                      class="mx-auto h-16 w-auto mb-4"
                      onerror="this.style.display='none'; this.onerror=null;">
                  <h2 class="text-2xl md:text-3xl font-bold text-blue-600">DM Syllogisms Worksheet 2 Results</h2>
             </div>
            <div class="bg-blue-50 p-4 rounded-lg mb-6 text-center flex-shrink-0">
                 <p class="text-lg font-semibold">Your Score: <span id="score" class="text-blue-700">0</span> / <span id="total-score-possible">10</span> Points</p>
                 <p class="text-gray-600">Time Taken: <span id="time-taken">N/A</span></p>
            </div>

            <h3 class="text-xl font-semibold mb-1 text-center flex-shrink-0">Detailed Results Overview</h3>
            <p class="text-sm text-gray-500 mb-4 text-center flex-shrink-0">Click on a question box below to review it. Hover for statement summary.</p>
            
            <div id="results-overview-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-6 overflow-y-auto flex-grow px-2 py-1">
                <!-- Question summary boxes will be populated here by JavaScript -->
            </div>
            
            <div class="mt-auto flex-shrink-0 border-t pt-4">
                 <div class="mb-4">
                     <label for="focus-rating" class="block text-md font-semibold text-gray-700 mb-1">My focus out of 5 (1 very low, 5 very high):</label>
                     <input type="number" id="focus-rating" name="focus-rating" min="1" max="5" class="mt-1 block w-20 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="1-5">
                 </div>
                 <div>
                     <label for="reflection-text" class="block text-md font-semibold text-gray-700 mb-1">Main takeaway from this practice:</label>
                     <textarea id="reflection-text" name="reflection-text" rows="3" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Reflect on your performance, strategies, or areas for improvement..."></textarea>
                 </div>
            </div>
             <div class="mt-6 text-center flex-shrink-0 flex justify-center space-x-4">
                <button onclick="window.location.href = 'practice.html#dm-content';" class="secondary-button px-6 py-2">
                    Back to DM Worksheets
                </button>
                <button onclick="window.location.href = 'student_dashboard.html';" class="secondary-button px-6 py-2">
                    Return to Dashboard
                </button>
                <button id="download-pdf-button" class="primary-button px-6 py-2">
                    Download Results PDF
                </button>
            </div>
        </div>

        <div id="navigator-modal" class="modal">
            <div class="modal-content bg-white p-6 rounded-lg shadow-xl">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">Question Navigator</h3>
                    <button id="close-modal-button" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
                </div>
                 <p class="text-sm text-gray-600 mb-4">Click a number to jump. Green: answered, Yellow border: flagged.</p>
                <div id="navigator-grid" class="grid grid-cols-5 gap-3">
                    </div>
            </div>
        </div>

        <div id="calculator-ui">
            <div class="calculator-header" id="calculator-drag-header">
                <span class="title">Calculator</span>
                <button class="close-calc-btn" id="close-calculator-button">×</button>
            </div>
            <div class="calculator-decorative-text">TEXAS INSTRUMENTS TI-108</div>
            <div id="calc-display-container">
                <span id="calc-memory-indicator">M</span>
                <div id="calc-display">0</div>
            </div>
            <div class="calc-buttons-grid">
                <button class="calc-button calc-button-red" data-calc-action="negate">+/-</button>
                <button class="calc-button calc-button-red" data-calc-action="sqrt">√</button>
                <button class="calc-button calc-button-red" data-calc-action="percent">%</button>
                <button class="calc-button calc-button-red operator" data-calc-value="/">÷</button>
                
                <button class="calc-button calc-button-red" data-calc-action="mrc">MRC</button>
                <button class="calc-button calc-button-red" data-calc-action="m-">M-</button>
                <button class="calc-button calc-button-red" data-calc-action="m+">M+</button>
                <button class="calc-button calc-button-red operator" data-calc-value="*">×</button>

                <button class="calc-button calc-button-num" data-calc-value="7">7</button>
                <button class="calc-button calc-button-num" data-calc-value="8">8</button>
                <button class="calc-button calc-button-num" data-calc-value="9">9</button>
                <button class="calc-button calc-button-red operator" data-calc-value="-">-</button>

                <button class="calc-button calc-button-num" data-calc-value="4">4</button>
                <button class="calc-button calc-button-num" data-calc-value="5">5</button>
                <button class="calc-button calc-button-num" data-calc-value="6">6</button>
                <button class="calc-button calc-button-red operator" data-calc-value="+">+</button>
                
                <button class="calc-button calc-button-num" data-calc-value="1">1</button>
                <button class="calc-button calc-button-num" data-calc-value="2">2</button>
                <button class="calc-button calc-button-num" data-calc-value="3">3</button>
                <button class="calc-button calc-button-red equals" data-calc-action="equals">=</button>

                <button class="calc-button calc-button-red" data-calc-action="clear">ON/C</button>
                <button class="calc-button calc-button-num" data-calc-value="0">0</button>
                <button class="calc-button calc-button-num" data-calc-value=".">.</button>
            </div>
        </div>

    </div>

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyASKsaFFTZ-finv2d5egR9K_mZNstEwdns",
          authDomain: "mwp-qr-test-page.firebaseapp.com",
          projectId: "mwp-qr-test-page",
          storageBucket: "mwp-qr-test-page.appspot.com",
          messagingSenderId: "309084045110",
          appId: "1:309084045110:web:b09ca0fdff84b094963d97",
          measurementId: "G-4M3ED641M9"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        let currentUserId = null;

        auth.onAuthStateChanged((user) => {
          if (user) {
            currentUserId = user.uid;
            console.log("Anonymous user signed in with UID:", currentUserId);
          } else {
            currentUserId = null;
            console.log("User signed out.");
            auth.signInAnonymously().catch((error) => {
                console.error("Error signing in anonymously on auth state change:", error);
            });
          }
        });
        if (!auth.currentUser) {
            auth.signInAnonymously().catch((error) => {
                console.error("Error signing in anonymously on load:", error);
            });
        }

        // --- Data ---
        const premisesData = [
            "All students in Club A play chess.\nSome members of Club A also play tennis.",
            "Some trees in the park are oaks.\nNo oaks in the park are dead.",
            "All tickets sold after noon were half-price.\nSome tickets were sold before noon.",
            "No cats in the household like water.\nLuna is a cat in the household.",
            "Some pictures in the gallery are abstract.\nAll abstract pictures in the gallery are large."
        ];

        const questionsData = [
            { premiseIndex: 0, statements: ["Some chess players in Club A play tennis.","All chess players in Club A play tennis.","Some tennis players in Club A play chess.","No tennis players in Club A play chess.","Some students in Club A play neither chess nor tennis."], correctAnswers: ['Y','N','N','N','N'], explanation: "Explanation for Q1: Evaluate each conclusion based on the premises about Club A members, chess, and tennis." },
            { premiseIndex: 1, statements: ["Some trees in the park are dead.","Some trees in the park are not dead.","No dead trees in the park are oaks.","All trees in the park are oaks.","Some oaks in the park are dead."], correctAnswers: ['N','N','Y','N','N'], explanation: "Explanation for Q2: Consider what can be deduced about dead trees and oaks given the provided premises." },
            { premiseIndex: 2, statements: ["Some half-price tickets were sold after noon.","All half-price tickets were sold after noon.","Some tickets sold after noon were not half-price.","Some tickets sold before noon were half-price.","No tickets sold after noon were full price."], correctAnswers: ['N','N','N','N','Y'], explanation: "Explanation for Q3: Analyze the timing of ticket sales and their pricing based on the premises." },
            { premiseIndex: 3, statements: ["Luna likes water.","Luna does not like water.","Some cats in the household dislike water.","All animals that dislike water are cats.","Some animals in the household like water."], correctAnswers: ['N','Y','N','N','N'], explanation: "Explanation for Q4: Determine Luna's preference for water and other conclusions about cats and animals in the household." },
            { premiseIndex: 4, statements: ["Some large pictures in the gallery are abstract.","All large pictures in the gallery are abstract.","Some pictures in the gallery are not large.","No large pictures in the gallery are abstract.","Some abstract pictures in the gallery are not large."], correctAnswers: ['N','N','N','N','N'], explanation: "Explanation for Q5: Evaluate the relationships between pictures, their size, and whether they are abstract, based on the gallery's contents." }
        ];

        // --- State ---
        let currentQuestionIndex = 0;
        let userAnswers = Array(questionsData.length).fill(null).map(() => Array(5).fill(null));
        let examStartTime;
        let examEndTime;
        let userName = '';
        let userGoal = '';
        let userFocusArea = '';
        let isReviewingFromResults = false;
        let flaggedQuestions = new Array(questionsData.length).fill(false);
        let isFilteringFlagged = false;
        let currentlyDisplayedPremiseIndex = -1;
        let questionTimings = new Array(questionsData.length).fill(0);
        let currentQuestionStartTime;
        let lastQuestionIndexForTiming = -1;

        // Timer variables
        const totalTimeAllowedInSeconds = 360; // 6 minutes
        let timeLeft = totalTimeAllowedInSeconds;
        let timerInterval = null;

        // --- Elements ---
        const appContainer = document.getElementById('app-container');
        const setupScreen = document.getElementById('setup-screen');
        const examScreen = document.getElementById('exam-screen');
        const reviewScreen = document.getElementById('review-screen');
        const resultsScreen = document.getElementById('results-screen');
        const navigatorModal = document.getElementById('navigator-modal');
        const startButton = document.getElementById('start-button');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const navigatorButton = document.getElementById('navigator-button');
        const closeModalButton = document.getElementById('close-modal-button');
        const endExamButton = document.getElementById('end-exam-button');
        const endExamButtonFooter = document.getElementById('end-exam-button-footer');
        const backToResultsButton = document.getElementById('back-to-results-button');
        const flagButton = document.getElementById('flag-button');
        const premisesTextEl = document.getElementById('premises-text');
        const questionNumberEl = document.getElementById('question-number');
        const questionNumberInfoEl = document.getElementById('question-number-info');
        const statementsListContainer = document.getElementById('statements-list');
        const draggableYes = document.getElementById('draggable-yes'); // Draggable Yes
        const draggableNo = document.getElementById('draggable-no');   // Draggable No
        const reviewGrid = document.getElementById('review-grid');
        const navigatorGrid = document.getElementById('navigator-grid');
        const scoreEl = document.getElementById('score');
        const totalScorePossibleEl = document.getElementById('total-score-possible');
        const timeTakenEl = document.getElementById('time-taken');
        const resultsDetails = document.getElementById('results-details');
        const focusAreaInput = document.getElementById('focus-area');
        const examTitleEl = document.getElementById('exam-title');
        const filterFlaggedButton = document.getElementById('filter-flagged-button');
        const setupQuestionCountEl = document.getElementById('setup-question-count');
        const setupMaxScoreEl = document.getElementById('setup-max-score');
        const reviewExplanationContainer = document.getElementById('review-explanation-container');
        const reflectionText = document.getElementById('reflection-text');
        const downloadPdfButton = document.getElementById('download-pdf-button');
        const focusRatingInput = document.getElementById('focus-rating');
        const timerDisplay = document.getElementById('timer');
        const goalInput = document.getElementById('goal');

        // --- NEW Elements for Calculator and Secondary Toolbar ---
        const calculatorToggleButton = document.getElementById('calculator-toggle-button');
        const calculatorUI = document.getElementById('calculator-ui');
        const closeCalculatorButton = document.getElementById('close-calculator-button');
        const calculatorDragHeader = document.getElementById('calculator-drag-header');
        const calcDisplay = document.getElementById('calc-display');
        const calcButtons = document.querySelectorAll('.calc-button');
        const calcMemoryIndicator = document.getElementById('calc-memory-indicator');

        // --- Calculator variables (from DM sylls 2 more complex version) ---
        let calcCurrentInput = '0';
        let calcPreviousInput = '';
        let calcOperator = null;
        let calcShouldResetDisplay = false;
        let calcMemory = 0;
        let calcMrcPressedOnce = false;

        // --- Functions ---

        // --- Calculator Functions (Adapted from DM Sylls 2 more complex version) ---
        function toggleCalculator() {
            // Use classList.toggle with .show class as defined in CSS
            const isVisible = calculatorUI.classList.toggle('show'); 
            // calculatorToggleButton.classList.toggle('active', isVisible); // Optional: if an 'active' class is styled
        }

        function updateCalcDisplay() {
            if (!calcDisplay) return;
            if (calcCurrentInput === 'Error') {
                calcDisplay.value = 'Error';
            } else if (calcCurrentInput.length > 10) { // Max 10 digits before exponent
                try {
                    const num = parseFloat(calcCurrentInput);
                    if (isFinite(num)) {
                        calcDisplay.value = num.toExponential(5); // 5 decimal places in exponent
                    } else {
                        calcDisplay.value = 'Error';
                    }
                } catch (e) {
                    // Fallback for very long non-numeric strings if they somehow get here
                    calcDisplay.value = calcCurrentInput.substring(0, 10);
                }
            } else {
                calcDisplay.value = calcCurrentInput;
            }
            if (calcMemoryIndicator) {
                calcMemoryIndicator.style.visibility = calcMemory !== 0 ? 'visible' : 'hidden';
            }
        }

        function clearCalculator(clearMemory = false) {
            calcCurrentInput = '0';
            calcPreviousInput = '';
            calcOperator = null;
            calcShouldResetDisplay = false;
            if (clearMemory) {
                calcMemory = 0;
            }
            calcMrcPressedOnce = false; 
            updateCalcDisplay();
        }
        
        function inputDigit(digit) {
            if (calcCurrentInput === 'Error') calcCurrentInput = '0'; // Reset on new input after error
            if (calcShouldResetDisplay) {
                calcCurrentInput = digit;
                calcShouldResetDisplay = false;
            } else {
                // Limit overall length, more nuanced check for decimal places needed if very specific
                if (calcCurrentInput.length >= 10 && calcCurrentInput !== '0') return; 
                calcCurrentInput = calcCurrentInput === '0' ? digit : calcCurrentInput + digit;
            }
            updateCalcDisplay();
            calcMrcPressedOnce = false; 
        }

        function inputDecimal() {
            if (calcCurrentInput === 'Error') calcCurrentInput = '0';
            if (calcShouldResetDisplay) {
                calcCurrentInput = '0.';
                calcShouldResetDisplay = false;
            } else if (!calcCurrentInput.includes('.')) {
                calcCurrentInput += '.';
            }
            updateCalcDisplay();
            calcMrcPressedOnce = false;
        }

        function handleCalcOperator(nextOperator) {
            if (calcCurrentInput === 'Error') return;
            const inputValue = parseFloat(calcCurrentInput);

            if (calcOperator && !calcShouldResetDisplay) { 
                performCalculation(); // Perform existing operation before setting new one
                if (calcCurrentInput === 'Error') return; // Stop if calculation caused error
                calcPreviousInput = calcCurrentInput; 
            } else {
                calcPreviousInput = calcCurrentInput; // Store current input as previous
            }
            calcOperator = nextOperator;
            calcShouldResetDisplay = true; // Next digit input should reset display
            calcMrcPressedOnce = false;
        }

        function performCalculation() {
            if (!calcOperator || calcPreviousInput === '' || calcCurrentInput === 'Error') return;
            const prev = parseFloat(calcPreviousInput);
            const current = parseFloat(calcCurrentInput);
            if (isNaN(prev) || isNaN(current)) {
                calcCurrentInput = 'Error';
                updateCalcDisplay();
                return;
            }

            let result;
            switch (calcOperator) {
                case '+': result = prev + current; break;
                case '-': result = prev - current; break;
                case '*': result = prev * current; break;
                case '/': 
                    if (current === 0) {
                        calcCurrentInput = 'Error'; // Division by zero
                        updateCalcDisplay();
                        return;
                    }
                    result = prev / current; 
                    break;
                default: return;
            }
            // Basic check for excessively large/small numbers or precision issues
            if (Math.abs(result) > 1e10 || (Math.abs(result) < 1e-8 && result !== 0) ) {
                 calcCurrentInput = result.toExponential(5);
            } else if (result.toString().includes('.') && result.toString().split('.')[1].length > 8) {
                calcCurrentInput = parseFloat(result.toFixed(8)).toString();
            } else {
                calcCurrentInput = result.toString();
            }
            
            calcOperator = null; // Reset operator after calculation
            // calcShouldResetDisplay = true; // Display will show result, next op or digit will modify/reset
            updateCalcDisplay();
        }

        function handleMemory(action) {
            const currentValue = parseFloat(calcCurrentInput);
            if (calcCurrentInput === 'Error' && action !== 'mrc' && action !== 'clear-memory') return;

            switch (action) {
                case 'm+':
                    if (!isNaN(currentValue)) calcMemory += currentValue;
                    calcShouldResetDisplay = true; // After M+, new number input clears display
                    break;
                case 'm-':
                    if (!isNaN(currentValue)) calcMemory -= currentValue;
                    calcShouldResetDisplay = true; // After M-, new number input clears display
                    break;
                case 'mrc':
                    if (calcMrcPressedOnce) { // Second press: clear memory
                        calcMemory = 0;
                        calcMrcPressedOnce = false;
                    } else { // First press: recall memory
                        calcCurrentInput = calcMemory.toString();
                        calcMrcPressedOnce = true;
                        // calcShouldResetDisplay = true; // Allow user to operate on recalled number
                    }
                    break;
            }
            updateCalcDisplay();
        }

        function makeCalculatorDraggable() {
            // ... existing code ...
        }

        // --- Event Listeners ---
        startButton.addEventListener('click', () => {
            userGoal = goalInput.value.trim();
            userFocusArea = focusAreaInput.value.trim();

            // Initialize userName based on Firebase auth or default
            if (currentUserId) {
                userName = "User " + currentUserId.substring(0, 6);
            } else {
                userName = "User";
            }

            if (!userGoal) {
                 alert("Please enter your goal for this session.");
                 goalInput.focus();
                 return;
            }

            currentQuestionIndex = 0;
            userAnswers = Array(questionsData.length).fill(null).map(() => Array(5).fill(null));
            flaggedQuestions = new Array(questionsData.length).fill(false);
            questionTimings = new Array(questionsData.length).fill(0); 
            currentQuestionStartTime = null;
            lastQuestionIndexForTiming = -1;
            isReviewingFromResults = false;
            isFilteringFlagged = false;
            examEndTime = null; 
            // Reset calculator state if needed, or assume it's fresh per session
            clearCalculator(); 

            showExamScreen(); 
            loadQuestion(0); 
            populateNavigator(); // Populate navigator on start
            // updateNavigatorButtons(); // Initial update for navigator, populateNavigator should handle this
            startTimer(); 
            makeCalculatorDraggable(); // Initialize draggable calculator
            // Initialize calculator display
            clearCalculator(true); // Clear display and memory on start
        });

        nextButton.addEventListener('click', showNextQuestion);
        prevButton.addEventListener('click', showPrevQuestion);
        endExamButton.addEventListener('click', endExamAndShowResults);
        endExamButtonFooter.addEventListener('click', handleEndExamFooterClick); 
        backToResultsButton.addEventListener('click', () => { isReviewingFromResults = false; showResultsScreen(); });
        navigatorButton.addEventListener('click', () => { 
            // updateNavigatorButtons(); // Ensure nav buttons are up-to-date before showing
            navigatorModal.classList.remove('hidden'); 
            navigatorModal.classList.add('flex');
        });
        closeModalButton.addEventListener('click', () => { navigatorModal.classList.remove('flex'); navigatorModal.classList.add('hidden');});
        navigatorModal.addEventListener('click', (event) => { if (event.target === navigatorModal) closeModalButton.click(); });
        flagButton.addEventListener('click', toggleFlag);
        filterFlaggedButton.addEventListener('click', () => { isFilteringFlagged = !isFilteringFlagged; showReviewScreen(isFilteringFlagged); });
        downloadPdfButton.addEventListener('click', generatePDF);

        // Calculator event listeners
        calculatorToggleButton.addEventListener('click', toggleCalculator);
        closeCalculatorButton.addEventListener('click', toggleCalculator);
        makeDraggable(calculatorUI, calculatorDragHeader);

        calcButtons.forEach(button => {
            button.addEventListener('click', () => {
                const value = button.dataset.calcValue;
                const action = button.dataset.calcAction;

                if (value) { // Digit or decimal
                    if (value === '.') {
                        inputDecimal();
                    } else {
                        inputDigit(value);
                    }
                } else if (action) { // Operator or special function
                    switch (action) {
                        case 'clear': // This is ON/C
                            if (calcMrcPressedOnce && calcCurrentInput === calcMemory.toString()) { // If MRC was just pressed and display shows memory
                                 clearCalculator(false); // Clear display, keep memory
                            } else if (calcCurrentInput !== '0') { // If display is not 0, clear current input (CE)
                                 calcCurrentInput = '0';
                                 updateCalcDisplay();
                                 calcShouldResetDisplay = false; // Allow further input on 0
                            } else { // If display is 0, clear all (C), including memory potentially
                                 clearCalculator(true); // Full clear including memory
                            }
                            calcMrcPressedOnce = false; // Reset MRC flag on any clear operation
                            break;
                        case 'equals':
                            performCalculation();
                            calcShouldResetDisplay = true; // Next number starts new calculation
                            break;
                        case 'm+':
                        case 'm-':
                        case 'mrc':
                            handleMemory(action);
                            break;
                        // Operators (+, -, *, /) are handled by their data-calc-value and class 'operator'
                    }
                } 
                // Handle direct operator buttons if any are not covered by calc-value approach
                if (button.classList.contains('operator') && value) { // e.g. <button class="operator" data-calc-value="+">+</button>
                     handleCalcOperator(value);
                }
            });
        });

        // Initialize calculator display
        updateCalcDisplay();

        function handleKeyboardShortcuts(e) {
             const isExamVisible = !examScreen.classList.contains('hidden');
             const isModalVisible = navigatorModal.classList.contains('flex');
             const isInputFocused = document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA');
             const isCalcVisible = calculatorUI.classList.contains('visible');

             if (isModalVisible || isInputFocused) return;
             if (!isExamVisible) return;

             if (isCalcVisible && !isInputFocused) {
                 if (e.key >= '0' && e.key <= '9') { e.preventDefault(); inputDigit(e.key); return; }
                 if (e.key === '.') { e.preventDefault(); inputDecimal(); return; }
                 // Corrected to check e.key directly for operators
                 if (e.key === '+' || e.key === '-' || e.key === '*' || e.key === '/') { e.preventDefault(); handleCalcOperator(e.key); return; } 
                 if (e.key === 'Enter' || e.key === '=') { e.preventDefault(); performCalculation(); return; }
                 if (e.key === 'Escape') { e.preventDefault(); toggleCalculator(); return; }
                 if (e.key === 'Backspace') { e.preventDefault(); handleSpecialFunction('backspace'); return; }
             }

             const altOrOption = e.altKey;
             const code = e.code.toLowerCase();

             if (altOrOption) {
                 switch (code) {
                     case 'keyn': e.preventDefault(); if (!nextButton.disabled) nextButton.click(); break;
                     case 'keyp': e.preventDefault(); if (!prevButton.disabled) prevButton.click(); break;
                     case 'keyf': e.preventDefault(); if (!isReviewingFromResults && !flagButton.disabled) flagButton.click(); break;
                     case 'keyc': e.preventDefault(); if(calculatorToggleButton) calculatorToggleButton.click(); break; // Ensure button exists
                 }
             }
        }
        document.addEventListener('keydown', handleKeyboardShortcuts);

        // --- MODIFIED Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            checkForReviewMode();
        });

        // --- NEW FUNCTION to check for and load review mode ---
        function checkForReviewMode() {
            const reviewSubmissionId = localStorage.getItem('reviewSubmissionId');
            const isReviewHash = window.location.hash === '#review';

            if (reviewSubmissionId && isReviewHash) {
                console.log("Review mode detected. Submission ID:", reviewSubmissionId);
                if(setupScreen) setupScreen.classList.add('hidden');
                if(resultsScreen) resultsScreen.classList.add('hidden');
                if(reviewScreen) reviewScreen.classList.add('hidden');
                
                if (!db) {
                    console.error("Firestore (db) is not initialized. Cannot load review data.");
                    alert("Error: Could not connect to load review data.");
                    showSetupScreen(); 
                    localStorage.removeItem('reviewSubmissionId'); 
                    return;
                }

                db.collection("performanceSubmissions").doc(reviewSubmissionId).get()
                    .then(doc => {
                        if (doc.exists) {
                            const submissionData = doc.data();
                            console.log("Submission data fetched for review:", submissionData);
                            
                            if (submissionData.questions && Array.isArray(submissionData.questions)) {
                                userAnswers = submissionData.questions.map(q => q.userAnswers || Array(5).fill(null));
                                flaggedQuestions = submissionData.questions.map(q => q.isFlagged || false);
                            } else {
                                console.error("Submission data does not have the expected 'questions' array structure.");
                                alert("Error: Could not load review data due to unexpected format.");
                                showSetupScreen(); 
                                localStorage.removeItem('reviewSubmissionId');
                                return;
                            }
                            userName = submissionData.studentName || 'Review User'; 

                            showExamScreen(); 
                            
                            const nextBtn = document.getElementById('next-button');
                            const endExamFoot = document.getElementById('end-exam-button-footer');
                            const navigatorBtn = document.getElementById('navigator-button');
                            const backToDashResultsButton = document.createElement('button');

                            if(nextBtn) nextBtn.textContent = 'Next Question →';
                            if(endExamFoot) endExamFoot.style.display = 'none'; 
                            if(navigatorBtn) navigatorBtn.style.display = 'none'; 
                            if(flagButton) flagButton.style.display = 'none'; 
                            if(timerDisplay) timerDisplay.style.display = 'none'; 
                            if(document.getElementById('draggable-options-sidebar')) document.getElementById('draggable-options-sidebar').style.display = 'none';

                            backToDashResultsButton.textContent = '← Back to Dashboard Results';
                            backToDashResultsButton.className = 'secondary-button'; 
                            backToDashResultsButton.onclick = () => {
                                if(localStorage.getItem('returnToDashboardResults')) {
                                    localStorage.removeItem('reviewSubmissionId');
                                    localStorage.removeItem('returnToDashboardResults');
                                    window.location.href = 'student_dashboard.html#results';
                                } else {
                                     window.location.href = 'student_dashboard.html'; 
                                }
                            };
                            const footerBar = document.querySelector('.footer-bar');
                            if (footerBar) {
                                const existingBackToResults = footerBar.querySelector('#back-to-dashboard-results-review');
                                if (existingBackToResults) existingBackToResults.remove();
                                backToDashResultsButton.id = 'back-to-dashboard-results-review';
                                footerBar.insertBefore(backToDashResultsButton, footerBar.firstChild);
                            }

                            currentQuestionIndex = 0; 
                            loadQuestion(currentQuestionIndex, true); 

                        } else {
                            console.error("No such submission document! ID:", reviewSubmissionId);
                            alert("Could not find the submission to review. It may have been deleted.");
                            showSetupScreen(); 
                            localStorage.removeItem('reviewSubmissionId');
                        }
                    }).catch(error => {
                        console.error("Error getting submission document:", error);
                        alert("Error fetching review data. Please try again.");
                        showSetupScreen(); 
                        localStorage.removeItem('reviewSubmissionId');
                    });
            } else {
                if(reviewSubmissionId) localStorage.removeItem('reviewSubmissionId'); 
                if(localStorage.getItem('returnToDashboardResults')) localStorage.removeItem('returnToDashboardResults');
                showSetupScreen();
            }
        }

        // --- NEW FUNCTION TO SAVE RESULTS TO FIREBASE ---
        function saveResultsToFirebase() {
            if (!db) {
                console.error("Firestore (db) is not initialized.");
                return;
            }

            const worksheetName = "DM Syllogisms Worksheet 2";
            const totalScore = parseInt(scoreEl.textContent, 10);
            const totalPossible = parseInt(totalScorePossibleEl.textContent, 10);
            const timeTakenString = timeTakenEl.textContent;
            const reflection = reflectionText.value.trim();
            const focusRatingVal = focusRatingInput.value;

            const detailedAnswers = questionsData.map((qData, index) => {
                const userAnsArray = userAnswers[index] || Array(5).fill(null);
                const correctAnsArray = qData.correctAnswers;
                let correctStatements = 0;
                userAnsArray.forEach((userAns, stmtIndex) => {
                    if (userAns === correctAnsArray[stmtIndex]) {
                        correctStatements++;
                    }
                });
                let points = 0;
                if (correctStatements === 5) points = 2;
                else if (correctStatements === 4) points = 1;

                return {
                    questionIndex: index,
                    premise: premisesData[qData.premiseIndex],
                    statements: qData.statements,
                    userAnswers: userAnsArray,
                    correctAnswers: correctAnsArray,
                    explanation: qData.explanation || "",
                    points: points,
                    timeTakenMs: questionTimings[index] || 0,
                    isFlagged: flaggedQuestions[index] || false
                };
            });

            const performanceData = {
                studentName: userName || (currentUserId ? 'Anonymous User' : 'Unknown User'),
                userId: currentUserId || null,
                studentEmail: null,
                examName: worksheetName,
                score: totalScore,
                totalPossibleScore: totalPossible,
                timeTaken: timeTakenString,
                goal: userGoal || '',
                focusArea: userFocusArea || '',
                focusRating: focusRatingVal || '',
                reflection: reflection || '',
                questions: detailedAnswers,
                submissionTimestamp: firebase.firestore.FieldValue.serverTimestamp(),
                userAgent: navigator.userAgent
            };

            db.collection("performanceSubmissions").add(performanceData)
                .then((docRef) => {
                    console.log("Results saved to Firestore with ID: ", docRef.id);
                })
                .catch((error) => {
                    console.error("Error saving results to Firebase: ", error);
                });
        }
        // --- END OF SAVE RESULTS FUNCTION ---

        function handleEndExamFooterClick() {
            showReviewScreen();
        }

        // --- PDF Generation Function ---
        function generatePDF() {
            const doc = new jsPDF();
            doc.setFontSize(16);
            doc.text("UCAT Decision Making Practice Results", 14, 10);
            doc.setFontSize(12);
            doc.text(`Date: ${new Date().toLocaleString()}`, 14, 20);
            doc.setFontSize(12);
            doc.text(`Total Score: ${scoreEl.textContent} / ${totalScorePossibleEl.textContent}`, 14, 30);
            doc.setFontSize(12);
            doc.text(`Time Taken: ${timeTakenEl.textContent}`, 14, 40);
            doc.setFontSize(12);
            doc.text(`Focus Rating: ${focusRatingInput.value}`, 14, 50);
            doc.setFontSize(12);
            doc.text(`Reflection: ${reflectionText.value.trim()}`, 14, 60);

            // Add more details as needed

            doc.save("UCAT_Decision_Making_Practice_Results.pdf");
        }

    </script>

</body>
</html>

