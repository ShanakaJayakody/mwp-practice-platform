<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UCAT DM Test 1 - MedwithPurpose</title>
    <link rel="icon" href="https://ik.imagekit.io/mwp/2.svg?updatedAt=1745982956185" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Firebase SDK -->
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        /* Custom styles for better UI/UX */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent scrolling on body */
        }
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f0f2f5; /* Light background like UCAT */
        }
        #app-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 2rem); /* Full height minus padding */
            width: 100%;
            background-color: #ffffff;
            border: 1px solid #d1d5db; /* Border like UCAT */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-radius: 0.375rem; /* Slightly rounded corners */
            margin: 1rem; /* Add some margin */
            overflow: hidden; /* Prevent content overflow from container */
            position: relative; /* For calculator positioning */
        }
        /* Header and Footer */
        .header-bar { /* Topmost bar */
            flex-shrink: 0;
            background-color: #005A8C; /* Slightly darker blue for top bar */
            color: white;
            padding: 0.5rem 1.5rem; /* Adjusted padding */
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 20; /* Ensure it's above the secondary bar if overlapping */
        }

        .secondary-toolbar { /* New toolbar for calculator and flag */
            flex-shrink: 0;
            background-color: #007BBD; /* Lighter blue for secondary bar */
            color: white;
            padding: 0.5rem 1.5rem; /* Consistent padding */
            display: flex;
            justify-content: space-between; /* Align items */
            align-items: center;
            border-bottom: 1px solid #005A8C; /* Optional: a subtle separator */
            z-index: 19;
        }

        /* Specific text colors within header/footer */
        .header-bar span, .header-bar div, .secondary-toolbar span, .secondary-toolbar div {
             color: white;
        }
        #timer {
             background-color: rgba(255, 255, 255, 0.2); 
             color: white;
             font-weight: bold;
             padding: 0.25rem 0.75rem; 
             border-radius: 0.25rem; 
        }
        
        /* Buttons in secondary toolbar */
        .secondary-toolbar-button {
            background-color: transparent;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.6);
            padding: 0.3rem 0.7rem;
            font-size: 0.8rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s ease, border-color 0.2s ease;
            margin-left: 0.5rem; /* Spacing between buttons */
        }
        .secondary-toolbar-button:hover:not(:disabled) {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: white;
        }
        .secondary-toolbar-button.active { /* For calculator button when active */
            background-color: rgba(255, 255, 255, 0.2);
            border-color: white;
        }


         /* Footer Button Styling */
        .footer-bar {
            flex-shrink: 0;
            background-color: #005A8C; /* Match top bar color */
            color: white;
            padding: 0.75rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .footer-bar button {
            background-color: transparent;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.5); 
            padding: 0.4rem 0.8rem; 
            font-size: 0.8rem; 
            border-radius: 0.375rem;
             transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        .footer-bar button:hover:not(:disabled) {
            background-color: rgba(255, 255, 255, 0.15); 
            border-color: white;
        }
         .footer-bar button:disabled {
             opacity: 0.5;
             cursor: not-allowed;
             border-color: rgba(255, 255, 255, 0.3);
         }
         .footer-bar button#next-button {
             background-color: #ffffff; 
             color: #006DAA; 
             border: 1px solid white;
             font-weight: 500;
         }
         .footer-bar button#next-button:hover:not(:disabled) {
             background-color: #f0f0f0; 
         }
         #flag-button.flagged {
             background-color: #facc15; 
             border-color: #facc15;
             color: #422006; 
          }
          #flag-button.flagged:hover {
             background-color: #f59e0b; 
             border-color: #f59e0b;
          }

        /* Main Content Area */
        .main-content-area {
            flex-grow: 1; 
            display: block;
            overflow: hidden; 
            padding: 1rem; 
        }
        .question-column {
             width: 100%;
             overflow-y: auto; 
             padding: 1rem;
             border: 1px solid #e5e7eb;
             border-radius: 0.375rem;
             background-color: #fff;
             height: 100%; 
             position: relative; 
        }

        .selected-answer {
            background-color: #bfdbfe !important; 
            border-color: #3b82f6 !important; 
        }
        .nav-answered { background-color: #a7f3d0; }
        .nav-current { border: 2px solid #3b82f6 !important; font-weight: bold; }
        .nav-flagged, .review-flagged { border: 2px solid #f59e0b !important; position: relative; }
        
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 0.5rem; }
        .modal.flex { display: flex; }

        button, .button {
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            border-radius: 0.375rem; padding: 0.5rem 1rem; font-size: 0.875rem; font-weight: 500;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); cursor: pointer;
        }
        button:active, .button:active { transform: scale(0.98); }
        button:disabled { opacity: 0.6; cursor: not-allowed; }

        .primary-button { background-color: #3b82f6; color: white; border: 1px solid transparent; }
        .primary-button:hover:not(:disabled) { background-color: #2563eb; }
        .secondary-button { background-color: white; color: #374151; border: 1px solid #d1d5db; }
        .secondary-button:hover:not(:disabled) { background-color: #f9fafb; }
        .danger-button { background-color: #ef4444; color: white; border: 1px solid transparent; }
        .danger-button:hover:not(:disabled) { background-color: #dc2626; }
        
        .option-label {
            display: block; padding: 0.75rem 1rem; border: 1px solid #d1d5db; 
            border-radius: 0.375rem; margin-bottom: 0.5rem; cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease;
            background-color: #ffffff; 
        }
        .option-label:hover:not(.selected-answer) { background-color: #f3f4f6; border-color: #a5b4fc; }
        input[type="radio"] { display: none; }

        #results-details-grid {
            display: grid; 
            grid-template-columns: repeat(10, 1fr); 
            gap: 0.75rem; 
            padding-top: 0.5rem; 
            max-width: 950px; 
            margin-left: auto; 
            margin-right: auto;
        }
        .result-summary-item { display: flex; flex-direction: column; align-items: center; text-align: center; }
        .result-summary-box {
            width: 68px; 
            height: 68px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            border-radius: 0.375rem; 
            font-weight: 600; 
            color: white; 
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .result-summary-box:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .correct-box { background-color: #22c55e; border: 2px solid #16a34a; }
        .incorrect-box { background-color: #ef4444; border: 2px solid #dc2626; }
        .not-answered-box { background-color: #9ca3af; border: 2px solid #6b7280; }
        .time-display-in-box { font-size: 1rem; }
        .question-number-label { margin-top: 0.5rem; font-size: 0.875rem; color: #4b5563; font-weight: 500; }
        
        .explanation-box {
             background-color: #fef3c7; border: 1px solid #fcd34d; padding: 0.5rem 0.75rem; 
             margin-top: 0.75rem; border-radius: 0.375rem; font-size: 0.875rem; color: #78350f; 
        }
        .review-grid-button {
             padding: 0.5rem 0.25rem; border: 1px solid #d1d5db; border-radius: 0.375rem;
             text-align: center; transition: background-color 0.2s ease, border-color 0.2s ease;
             font-size: 0.875rem; line-height: 1.25rem; cursor: pointer;
        }
        .review-grid-button-answered { background-color: #dcfce7; border-color: #86efac; color: #15803d; }
        .review-grid-button-unanswered { background-color: #f3f4f6; border-color: #d1d5db; color: #4b5563; }
        .review-grid-button:hover { filter: brightness(95%); }

        /* Calculator Styles */
        #calculator-ui {
            display: none; 
            position: absolute;
            top: 100px; 
            left: 50%;
            width: 225px;
            background-color: #0077b6; /* Bright blue background matching image */
            border: 1px solid #005a8c;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            padding: 12px;
            z-index: 1000; 
            cursor: grab;
            transform: translateX(-50%); /* Center horizontally */
        }
        #calculator-ui.visible { display: block; }
        .calculator-header {
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            color: white; 
            margin-bottom: 8px; 
            font-size: 0.9rem; 
            padding: 0 3px;
        }
        .calculator-header .title { font-weight: 600; }
        .calculator-header .close-calc-btn {
            background: none; 
            border: none; 
            color: white; 
            font-size: 1.1rem; 
            cursor: pointer;
            font-weight: bold;
        }
        .calculator-decorative-text {
            color: white;
            font-size: 0.65rem;
            text-align: center;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        #calc-display-container {
            background-color: #FFFFFF;
            border: 1px solid #cccccc; 
            border-radius: 4px; 
            padding: 8px 12px;
            margin-bottom: 12px; 
            text-align: right; 
            min-height: 36px;
            display: flex; 
            align-items: center; 
            justify-content: flex-end;
            position: relative; /* Add position relative to properly position the memory indicator */
        }
        #calc-display {
            font-family: 'Courier New', Courier, monospace; 
            font-size: 1.6rem;
            color: #000000; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            white-space: nowrap; 
            max-width: 100%;
        }
        #calc-memory-indicator {
            position: absolute;
            left: 6px;
            top: 4px;
            color: #2D3748;
            font-weight: bold;
            font-size: 0.9rem;
            display: none;
        }
        .calc-buttons-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }
        .calc-button {
            border: none;
            border-radius: 4px;
            padding: 10px 0;
            font-size: 1rem;
            font-weight: 500; 
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            display: flex; 
            align-items: center; 
            justify-content: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .calc-button:active { transform: scale(0.95); }

        /* Number buttons (0-9, .) */
        .calc-button-num {
            background-color: #FFFFFF;
            color: #000000;
        }
        .calc-button-num:hover { background-color: #F0F0F0; }

        /* Function and Operator buttons (Red background, white text) */
        .calc-button-red {
            background-color: #d62828; /* Bright red matching image */
            color: white;
        }
        .calc-button-red:hover { background-color: #e63946; }
        
        .calc-button.equals {
            grid-row: span 1; /* Only span 1 row */
            grid-column: 4; /* Position in 4th column */
            grid-row-start: 5; /* Start at row 5, below the + button */
        }


        @media (max-width: 1024px) {
            #results-details-grid { 
                grid-template-columns: repeat(8, 1fr);
                max-width: 760px;
            }
        }
        
        @media (max-width: 768px) {
            #app-container { height: auto; margin: 0.5rem; }
            .main-content-area { flex-direction: column; padding: 0.5rem; gap: 0.5rem; }
            .question-column { flex-basis: auto; width: 100%; height: auto; max-height: 35vh; padding: 0.75rem; }
            .header-bar, .secondary-toolbar, .footer-bar { padding: 0.5rem 1rem; }
            .header-bar span, .footer-bar button, .secondary-toolbar-button { font-size: 0.8rem; }
            button, .button { padding: 0.4rem 0.8rem; }
            .footer-bar button { padding: 0.3rem 0.6rem; font-size: 0.75rem; }
            #review-grid { grid-template-columns: repeat(4, minmax(0, 1fr)); } 
            .review-grid-button { font-size: 0.8rem; }
            #results-details-grid { 
                grid-template-columns: repeat(5, 1fr); 
                gap: 0.75rem;
                max-width: 450px;
            }
            .result-summary-box { width: 60px; height: 60px; }
            .time-display-in-box { font-size: 0.9rem; }
            #calculator-ui { width: 210px; top: 90px; padding: 10px;} 
            .calc-button { padding: 8px 0; font-size: 0.8rem;}
            #calc-display { font-size: 1.4rem; }
        }
         @media (max-width: 480px) {
             #review-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } 
             .header-bar span, .footer-bar button, .secondary-toolbar-button { font-size: 0.75rem; }
             button, .button { padding: 0.3rem 0.6rem; }
             .footer-bar button { padding: 0.25rem 0.5rem; font-size: 0.7rem; }
             .option-label { padding: 0.5rem 0.75rem; font-size: 0.8rem;}
             .review-grid-button { font-size: 0.75rem; }
             #results-details-grid { 
                grid-template-columns: repeat(3, 1fr); 
                gap: 0.5rem;
                max-width: 220px;
             }
             .result-summary-box { width: 50px; height: 50px; }
             .time-display-in-box { font-size: 0.8rem; }
             .question-number-label { font-size: 0.8rem; }
             #calculator-ui { width: 90%; max-width: 200px; top: 85px; padding: 8px; } 
             .calc-button { padding: 7px 0; font-size: 0.75rem;}
             #calc-display { font-size: 1.3rem; }
         }

        /* Statement answer boxes and Yes/No buttons - Copied from DM sylls 1.html */
        .statement-row {
            transition: all 0.2s ease;
            border-radius: 0.375rem;
            cursor: pointer;
        }
        .statement-row:hover {
            background-color: #f9fafb;
        }
        .statement-row.selected {
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5); /* blue-500 with 50% opacity */
            background-color: #eff6ff; /* blue-50 */
        }
        .statement-answer-box {
            transition: all 0.2s ease;
            font-weight: 600;
            font-size: 1rem;
            user-select: none;
            background-color: #f5f5f5; /* neutral-200 */
            color: #4b5563; /* gray-600 */
        }
        .drag-button {
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        #yes-button {
            background-color: #dcfce7; /* green-100 */
            border-color: #22c55e; /* green-500 */
            color: #166534; /* green-800 */
        }
        #yes-button:hover {
            background-color: #bbf7d0; /* green-200 */
            transform: translateY(-1px);
        }
        #no-button {
            background-color: #fee2e2; /* red-100 */
            border-color: #ef4444; /* red-500 */
            color: #991b1b; /* red-800 */
        }
        #no-button:hover {
            background-color: #fecaca; /* red-200 */
            transform: translateY(-1px);
        }
        .drag-button[draggable=true] {
            cursor: grab;
        }
        .drag-button.opacity-50 {
            opacity: 0.5;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="app-container">

        <div id="setup-screen" class="p-6 md:p-8 flex flex-col justify-center items-center h-full">
             <div class="text-center mb-6">
                <img src="https://ik.imagekit.io/mwp/MWP%20Color%20no%20background.png?updatedAt=1745982959141"
                     alt="MedwithPurpose Logo" class="mx-auto h-11 w-auto mb-4" onerror="this.style.display='none'; this.onerror=null;">
                <h1 class="text-2xl md:text-3xl font-bold text-blue-600">Decision Making Test 1</h1>
                <p class="text-gray-600 mt-2">Prepare for the UCAT DM section.</p>
                 <p class="text-sm text-gray-500 mt-4">
                     This section contains <strong id="setup-question-count">8 questions</strong> and you have <strong id="setup-time-limit">9 minutes</strong> to complete it. Max score <strong id="setup-max-score">16 points</strong>.
                 </p>
            </div>
            <div class="space-y-4 w-full max-w-md">
                <div>
                    <label for="goal" class="block text-sm font-medium text-gray-700">Goal (Score out of 16):</label>
                    <input type="number" id="goal" name="goal" min="0" max="16" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="e.g., 10">
                </div>
                <div>
                    <label for="focus-area" class="block text-sm font-medium text-gray-700">Area of Focus / Intention For Practice:</label>
                    <input type="text" id="focus-area" name="focus-area" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="e.g., Calculations, Speed">
                </div>
            </div>
            <div class="mt-8 text-center space-y-3">
                <button id="start-button" class="primary-button text-lg px-8 py-3">Begin</button>
                <button onclick="window.location.href='student_dashboard.html'" class="secondary-button text-lg px-8 py-3">Return to Dashboard</button>
            </div>
        </div>

        <div id="practice-session-screen" class="hidden flex flex-col h-full">
            <div class="header-bar">
                <span id="practice-session-title" class="font-semibold">Decision Making</span>
                <div class="flex items-center space-x-4">
                    <div id="timer" class="text-base px-3 py-1 rounded-md">09:00</div>
                    <span class="text-sm">Question <span id="question-number-info">1</span> of 8</span>
                </div>
            </div>
            <div class="secondary-toolbar">
                <div> <button id="calculator-toggle-button" class="secondary-toolbar-button">Calculator (Alt+C)</button>
                </div>
                <div> <button id="flag-button" class="secondary-toolbar-button">Flag for Review</button>
                </div>
            </div>

            <div class="main-content-area">
                <div class="question-column w-full">
                    <!-- Content will be dynamically inserted here by JavaScript -->
                </div>
            </div>

            <div class="footer-bar">
                 <button id="back-to-results-button" class="hidden mr-auto">← Back to Results</button>
                 <button id="end-practice-session-button-footer">End Practice Session</button>
                 <div class="flex items-center space-x-2 ml-auto">
                     <button id="prev-button" disabled>← Previous (Alt+P)</button>
                     <button id="navigator-button">Navigator</button>
                     <button id="next-button">Next (Alt+N) →</button>
                 </div>
            </div>
        </div>
        
        <div id="calculator-ui">
            <div class="calculator-header" id="calculator-drag-header">
                <span class="title">Calculator</span>
                <button class="close-calc-btn" id="close-calculator-button">×</button>
            </div>
            <div class="calculator-decorative-text">TEXAS INSTRUMENTS TI-108</div>
            <div id="calc-display-container">
                <span id="calc-memory-indicator" style="position: absolute; left: 6px; top: 50%; transform: translateY(-50%); color: #2D3748; font-weight: bold; font-size: 0.9rem; display: none;">M</span>
                <div id="calc-display">0</div>
            </div>
            <div class="calc-buttons-grid">
                <button class="calc-button calc-button-red" data-calc-action="negate">+/-</button>
                <button class="calc-button calc-button-red" data-calc-action="sqrt">√</button>
                <button class="calc-button calc-button-red" data-calc-action="percent">%</button>
                <button class="calc-button calc-button-red operator" data-calc-value="/">÷</button>
                
                <button class="calc-button calc-button-red" data-calc-action="mrc">MRC</button>
                <button class="calc-button calc-button-red" data-calc-action="m-">M-</button>
                <button class="calc-button calc-button-red" data-calc-action="m+">M+</button>
                <button class="calc-button calc-button-red operator" data-calc-value="*">×</button>

                <button class="calc-button calc-button-num" data-calc-value="7">7</button>
                <button class="calc-button calc-button-num" data-calc-value="8">8</button>
                <button class="calc-button calc-button-num" data-calc-value="9">9</button>
                <button class="calc-button calc-button-red operator" data-calc-value="-">-</button>

                <button class="calc-button calc-button-num" data-calc-value="4">4</button>
                <button class="calc-button calc-button-num" data-calc-value="5">5</button>
                <button class="calc-button calc-button-num" data-calc-value="6">6</button>
                <button class="calc-button calc-button-red operator" data-calc-value="+">+</button>
                
                <button class="calc-button calc-button-num" data-calc-value="1">1</button>
                <button class="calc-button calc-button-num" data-calc-value="2">2</button>
                <button class="calc-button calc-button-num" data-calc-value="3">3</button>
                <button class="calc-button calc-button-red equals" data-calc-action="equals">=</button>

                <button class="calc-button calc-button-red" data-calc-action="clear">ON/C</button>
                <button class="calc-button calc-button-num" data-calc-value="0">0</button>
                <button class="calc-button calc-button-num" data-calc-value=".">.</button>
            </div>
        </div>


        <div id="review-screen" class="hidden p-6 md:p-8 flex flex-col items-center h-full overflow-y-auto">
             <div class="w-full max-w-3xl mb-4 flex justify-between items-center">
                 <h2 class="text-2xl font-bold text-blue-600">Review Your Answers</h2>
                 <button id="filter-flagged-button" class="secondary-button text-sm">Show Flagged Only</button>
             </div>
             <p class="text-center text-gray-600 mb-6">Click on a question number to review it. Green indicates answered, Yellow border indicates flagged.</p>
            <div id="review-grid" class="grid grid-cols-4 gap-3 mb-6 w-full max-w-xs sm:max-w-sm md:max-w-md"></div>
            <div class="mt-auto pt-6">
                <button id="end-practice-session-button" class="danger-button text-lg px-8 py-3">Submit</button>
            </div>
        </div>

        <div id="results-screen" class="hidden p-6 md:p-8 flex flex-col h-full">
             <div class="text-center mb-6 flex-shrink-0">
                <img src="https://ik.imagekit.io/mwp/MWP%20Color%20no%20background.png?updatedAt=1745982959141"
                     alt="MedwithPurpose Logo" class="mx-auto h-11 w-auto mb-4" onerror="this.style.display='none'; this.onerror=null;">
                 <h2 class="text-2xl md:text-3xl font-bold text-blue-600">Practice Session Results</h2>
             </div>
            <div class="bg-blue-50 p-4 rounded-lg mb-6 text-center flex-shrink-0">
                 <p class="text-lg font-semibold">Your Score: <span id="score" class="text-blue-700">0</span> / <span id="total-score-possible">16</span> Points</p>
                 <p class="text-gray-600">Time Taken: <span id="time-taken"></span></p>
            </div>
            <h3 class="text-xl font-semibold mb-2 flex-shrink-0">Detailed Results Summary:</h3>
            <p class="text-sm text-gray-500 mb-4 flex-shrink-0">Click on a question box below to review it.</p>
            <div id="results-details-grid" class="overflow-y-auto flex-grow"></div>
            <div class="mt-6 flex-shrink-0 border-t pt-4">
                 <div class="p-3 bg-blue-50 border border-blue-100 rounded-md mb-4 text-center">
                    <p class="text-blue-800 text-sm">Your test results have been submitted. You can add a reflection below if you'd like.</p>
                 </div>
                 <div class="mb-4">
                    <label for="focus-rating" class="block text-md font-semibold text-gray-700 mb-1">My focus out of 5 (1 very low, 5 very high):</label>
                    <input type="number" id="focus-rating" name="focus-rating" min="1" max="5" class="mt-1 block w-20 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="1-5">
                 </div>
                 <div>
                    <label for="reflection-text" class="block text-md font-semibold text-gray-700 mb-1">Main takeaway from this practice:</label>
                    <textarea id="reflection-text" name="reflection-text" rows="3" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Reflect on your performance, strategies, or areas for improvement..."></textarea>
                 </div>
            </div>
              <div class="mt-6 text-center flex-shrink-0 flex flex-col sm:flex-row justify-center items-center space-y-3 sm:space-y-0 sm:space-x-4">
                <button onclick="window.location.href='student_dashboard.html'" class="secondary-button px-6 py-2 w-full sm:w-auto">Return to Dashboard</button>
                <button onclick="window.location.reload()" class="secondary-button px-6 py-2 w-full sm:w-auto">Try Again</button>
                <div class="w-full sm:w-auto relative group">
                    <button id="submit-performance-button" class="primary-button px-6 py-2 w-full">Submit Reflections</button>
                    <div class="absolute left-0 right-0 -top-10 bg-blue-100 text-blue-800 text-xs p-1 rounded border border-blue-200 opacity-0 group-hover:opacity-100 transition-opacity">
                        ↓ Optional: Submit your reflection on this practice session
                    </div>
                </div>
                <button id="download-pdf-button" class="primary-button px-6 py-2 w-full sm:w-auto">Download Results PDF</button>
            </div>
        </div>

        <div id="navigator-modal" class="modal">
            <div class="modal-content bg-white p-6 rounded-lg shadow-xl">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">Question Navigator</h3>
                    <button id="close-modal-button" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
                </div>
                 <p class="text-sm text-gray-600 mb-4">Click a number to jump. Green: answered, Yellow border: flagged.</p>
                <div id="navigator-grid" class="grid grid-cols-4 gap-3"> </div>
            </div>
        </div>
    </div>

    <script>
document.addEventListener('DOMContentLoaded', function() {
        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyASKsaFFTZ-finv2d5egR9K_mZNstEwdns",
          authDomain: "mwp-qr-test-page.firebaseapp.com",
          projectId: "mwp-qr-test-page",
          storageBucket: "mwp-qr-test-page.appspot.com", 
          messagingSenderId: "309084045110",
          appId: "1:309084045110:web:b09ca0fdff84b094963d97",
          measurementId: "G-4M3ED641M9"
        };
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore(); 
        const auth = firebase.auth();

        const urlParams = new URLSearchParams(window.location.search);
        const reviewParam = urlParams.get('review');
        
        auth.onAuthStateChanged(user => {
            if (user) {
                console.log("User is logged in:", user.displayName, user.email);
            } else {
                console.log("No user is logged in");
            }
        });
        
        window.startTest = function() {
            if (auth.currentUser) {
                userName = auth.currentUser.displayName || auth.currentUser.email || '';
                userEmail = auth.currentUser.email || '';
            } else {
                userName = '';
                userEmail = '';
            }
            
            userGoal = document.getElementById('goal').value.trim();
            userFocusArea = document.getElementById('focus-area').value.trim();
            timeLeft = 9 * 60; // 9 minutes for 8 questions
            
            userAnswers = new Array(passageTexts.length).fill(null).map(() => new Array(5).fill(null));
            questionTimes = new Array(passageTexts.length).fill(0);
            flaggedQuestions = new Array(passageTexts.length).fill(false);
            
            questionStartTime = null;
            currentQuestionIndex = 0; // Passage index
            isReviewingFromResults = false;
            isFilteringFlagged = false;
            practiceSessionEndTime = null;

            showPracticeSessionScreen();
            startTimer();
            loadQuestion(0); // Load first passage
            populateNavigator();
        };
        
        let currentQuestionIndex = 0; // Current passage index
        let userAnswers = []; // userAnswers[passageIndex][statementIndex] = 'Y' or 'N'
        let timerInterval;
        let timeLeft = 9 * 60; 
        let practiceSessionStartTime;
        let practiceSessionEndTime;
        let userName = '';
        let userEmail = '';
        let userGoal = '';
        let userFocusArea = '';
        let isReviewingFromResults = false;
        let questionStartTime = null;
        let questionTimes = []; // Time per passage
        let flaggedQuestions = []; // Flagged status per passage
        let isFilteringFlagged = false;
        let score = 0; // Ensure score is globally defined
        let maxScore = 16; // Define maxScore globally for DM Test 1

        let calcCurrentInput = '0';
        let calcPreviousInput = '';
        let calcOperator = null;
        let calcMemory = 0;
        let calcShouldResetDisplay = false; 
        let calcMrcPressedOnce = false; 
        let isDraggingCalculator = false;
        let calculatorOffsetX, calculatorOffsetY;
        let isSubmittingReflection = false;
        
        const appContainer = document.getElementById('app-container');
        const setupScreen = document.getElementById('setup-screen');
        const practiceSessionScreen = document.getElementById('practice-session-screen');
        const reviewScreen = document.getElementById('review-screen');
        const resultsScreen = document.getElementById('results-screen');
        const navigatorModal = document.getElementById('navigator-modal');
        const startButton = document.getElementById('start-button');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const navigatorButton = document.getElementById('navigator-button');
        const closeModalButton = document.getElementById('close-modal-button');
        const endPracticeSessionButton = document.getElementById('end-practice-session-button');
        const endPracticeSessionButtonFooter = document.getElementById('end-practice-session-button-footer');
        const backToResultsButton = document.getElementById('back-to-results-button');
        const flagButton = document.getElementById('flag-button');
        const questionNumberInfoEl = document.getElementById('question-number-info');
        const timerEl = document.getElementById('timer');
        const reviewGrid = document.getElementById('review-grid');
        const navigatorGrid = document.getElementById('navigator-grid');
        const scoreEl = document.getElementById('score');
        const totalQuestionsResultsEl = document.getElementById('total-questions-results');
        const timeTakenEl = document.getElementById('time-taken');
        const resultsDetailsGrid = document.getElementById('results-details-grid');
        const goalInput = document.getElementById('goal');
        const focusAreaInput = document.getElementById('focus-area');
        const practiceSessionTitleEl = document.getElementById('practice-session-title');
        const filterFlaggedButton = document.getElementById('filter-flagged-button');
        const setupQuestionCountEl = document.getElementById('setup-question-count');
        const setupTimeLimitEl = document.getElementById('setup-time-limit');
        const reflectionText = document.getElementById('reflection-text');
        const downloadPdfButton = document.getElementById('download-pdf-button');
        const focusRatingInput = document.getElementById('focus-rating');
        const calculatorToggleButton = document.getElementById('calculator-toggle-button');
        const calculatorUI = document.getElementById('calculator-ui');
        const calcDisplay = document.getElementById('calc-display');
        const calcButtons = document.querySelectorAll('.calc-button');
        const closeCalculatorButton = document.getElementById('close-calculator-button');
        const calculatorDragHeader = document.getElementById('calculator-drag-header');
        const setupMaxScoreEl = document.getElementById('setup-max-score'); // For max score display

        // --- Data ---
        const passageTexts = [ // Renamed from 'passages' to avoid conflict with the concept of passages in questions array
            "No reptile is a mammal.<br>All pythons are reptiles.<br>Some reptiles are kept as pets.<br><br>Place 'Yes' if the conclusion does follow. Place 'No' if the conclusion does not follow.",
            "Whiffles and sparrows are animals, but neither has scales, although both have wings. A flarn has wings but is not a sparrow.<br><br>(Place 'Yes' if the conclusion does follow, 'No' if it does not.)",
            "The bookstore received the same number of hard-cover, paperback, and audio-book copies of a new title.<br>On one particular day:<br>It sold twice as many paperbacks as hard-covers, and<br>It sold exactly as many audio-books as hard-covers and paperbacks combined.<br><br>(Place 'Yes' if the conclusion does follow, 'No' if it does not follow.)",
            "Inside the suitcase were some green hats, some yellow hats, but only a few purple hats.<br>There was nothing else in the suitcase except for some black gloves and a few purple gloves.<br><br>(Place 'Yes' if the conclusion does follow, 'No' if it does not follow.)",
            "Zephyrs and kites are types of aircraft.<br>All zephyrs are aeros.<br>Only the aeros that fly over the Atlantic carry radar.<br>All aeros are blue.<br><br>(Place 'Yes' if the conclusion does follow, 'No' if it does not.)",
            "In Maria's fruit bowl, there are green apples and there are peaches.<br>Nothing else is in the bowl except for the yellow bananas.<br><br>(Place 'Yes' if the conclusion does follow, 'No' if it does not follow.)",
            "Lina has copper (C), aluminium (A) and steel (S) rods.<br>All rods of the same metal weigh the same.<br>A bundle containing 2 copper + 3 aluminium + 1 steel rod weighs 70 kg.<br>A bundle containing 1 copper + 2 aluminium + 1 steel rod weighs 40 kg.<br><br>What is most likely the weight of a bundle containing 4 copper rods, 4 aluminium rods and 1 steel rod?",
            "There are six folders stacked in a tray, numbered 1 (top) to 6 (bottom).<br>Zoe's folder is not the bottom-most folder.<br>The number of folders below Zoe's folder is less than the number above it.<br>Ethan's folder is the last-but-one folder from the bottom of the stack.<br>There are exactly two folders between Maya's folder and Zoe's folder.<br>Liam's folder is not above Zoe's folder.<br><br>How many folders are there between Maya's folder and Liam's folder?"
        ];

        // questions array will now group statements by passage
        const questionsByPassage = [
            // Passage 1 statements
            [
                { text: "Nobody kept as a pet is a python.", correctAnswer: "N", explanation: "The premises allow for the possibility that some pythons are among the pet reptiles mentioned in premise 3, so the universal denial does not follow." },
                { text: "No python is a mammal.", correctAnswer: "Y", explanation: "All pythons are reptiles (premise 2) and no reptile is a mammal (premise 1); by transitive reasoning, no python is a mammal." },
                { text: "An animal that is a mammal cannot be kept as a pet.", correctAnswer: "N", explanation: "The premises provide no information about whether mammals can or cannot be pets; many mammals (e.g., cats, dogs) could be pets, so the conclusion is unsupported." },
                { text: "An animal that is not a python cannot be a mammal.", correctAnswer: "N", explanation: "Knowing an animal is \"not a python\" tells us nothing about its mammal status; plenty of non-pythons (horses, cats) are mammals, so the conclusion does not follow." },
                { text: "No mammals are reptiles.", correctAnswer: "Y", explanation: "A universal negative is symmetric: if no reptile is a mammal, then no mammal is a reptile. This restatement of premise 1 therefore follows." }
            ],
            // Passage 2 statements
            [
                { text: "Flarns do not have scales.", correctAnswer: "N", explanation: "The premises never state whether flarns have, or lack, scales—so the universal denial is unsupported." },
                { text: "Flarns are animals.", correctAnswer: "N", explanation: "The information given does not tell us whether a flarn is (or is not) an animal." },
                { text: "Either sparrows or flarns have scales.", correctAnswer: "N", explanation: "We know sparrows lack scales, and flarns may or may not have scales; hence the disjunction \"either … or …\" is unjustified." },
                { text: "If an animal has no wings, it cannot be a whiffle.", correctAnswer: "Y", explanation: "All whiffles possess wings; so any animal without wings cannot be a whiffle (valid contrapositive of a universal affirmative)." },
                { text: "If an animal is a flarn, it cannot be a sparrow.", correctAnswer: "Y", explanation: "The premise explicitly says a flarn is not a sparrow; therefore the conditional statement follows." }
            ],
            // Passage 3 statements
            [
                { text: "A quarter of all sales that day were hard-cover copies.", correctAnswer: "N", explanation: "Let the number of hard-covers sold = H. Then paperbacks sold = 2H, and audio-books sold = (H + 2H) = 3H. Total sales = 6H, so hard-covers represent 1⁄6 of sales, not 1⁄4." },
                { text: "By closing time the store had fewer paperbacks left in stock than hard-covers.", correctAnswer: "Y", explanation: "The store began with equal quantities of each format. Because it sold twice as many paperbacks as hard-covers, more paperbacks left the shelves, leaving fewer paperbacks than hard-covers remaining in stock." },
                { text: "Hard-cover copies were less popular with customers than audio-books.", correctAnswer: "Y", explanation: "Audio-book sales equalled the combined sales of hard-covers and paperbacks, making audio-books the top-selling format and hard-covers the least popular of the three." },
                { text: "If, on the following day, the store doubled the number of hard-covers sold while selling the same number of paperbacks, it would have sold more hard-covers than paperbacks.", correctAnswer: "N", explanation: "Doubling hard-cover sales would make them 2H (the same figure already achieved by paperbacks). Hence the two formats would be tied, not with hard-covers ahead." },
                { text: "Exactly one-third of all the copies originally stocked were audio-books.", correctAnswer: "Y", explanation: "The initial shipment was divided equally among three formats; therefore each format— including audio-books—accounted for one-third of the total stock." }
            ],
            // Passage 4 statements
            [
                { text: "If you took out a purple item, it would be a hat.", correctAnswer: "N", explanation: "The suitcase holds purple gloves as well as purple hats, so drawing a purple item does not guarantee it is a hat." },
                { text: "As well as purple and black items, the suitcase also contained some yellow items.", correctAnswer: "Y", explanation: "The premise lists yellow hats in addition to the purple (hats + gloves) and black (gloves) items, so yellow garments are indeed present." },
                { text: "There were no black garments in the suitcase.", correctAnswer: "N", explanation: "The suitcase explicitly contains black gloves, so the claim that no black garments are present is false." },
                { text: "There were more purple garments than green garments in the suitcase.", correctAnswer: "N", explanation: "Quantities are unspecified: we know only \"some\" green hats and \"a few\" purple hats plus \"a few\" purple gloves. Without actual counts, we cannot rank total purple versus green garments." },
                { text: "The only yellow garments were hats.", correctAnswer: "Y", explanation: "Yellow appears only as hats, because—apart from hats—the suitcase contains only black or purple gloves. Hence no yellow gloves (or other yellow garments) exist." }
            ],
            // Passage 5 statements
            [
                { text: "Zephyrs are blue.", correctAnswer: "Y", explanation: "Every zephyr is an aero (premise 2), and every aero is blue (premise 4) ⇒ all zephyrs are blue." },
                { text: "All aircraft are aeros.", correctAnswer: "N", explanation: "The premises tell us that zephyrs ⊂ aeros, but give no information about kites (or any other aircraft) being aeros; therefore we cannot extend \"aero\" to all aircraft." },
                { text: "Neither zephyrs nor kites fly over the Atlantic.", correctAnswer: "N", explanation: "Some zephyrs are aeros, and some aeros fly over the Atlantic (implied by \"only the aeros that fly over the Atlantic carry radar\"); hence we cannot rule out the possibility that zephyrs—or even kites—fly there." },
                { text: "If an aero carries radar, it must fly over the Atlantic.", correctAnswer: "Y", explanation: "\"Only the aeros that fly over the Atlantic carry radar\" translates to: If an aero carries radar ⇒ it flies over the Atlantic (valid conditional direction).\"" },
                { text: "Not all blue aeros carry radar.", correctAnswer: "Y", explanation: "All aeros are blue, but only those that fly over the Atlantic carry radar. Therefore at least some blue aeros (those that do not fly over the Atlantic) lack radar, so \"not all blue aeros carry radar\" is true." }
            ],
            // Passage 6 statements
            [
                { text: "There are no yellow fruits.", correctAnswer: "N", explanation: "The bowl definitely contains yellow bananas; therefore it is false that there are no yellow fruits." },
                { text: "There are some green fruits.", correctAnswer: "Y", explanation: "The premise explicitly says the bowl contains green apples, so at least some fruit is green." },
                { text: "Some of the fruit is red.", correctAnswer: "N", explanation: "Peaches might be red-tinged, but this is not stated; the information only guarantees green apples and yellow bananas, so a red fruit is not certain." },
                { text: "There are no red bananas.", correctAnswer: "Y", explanation: "Bananas in the bowl are specified as yellow; hence red bananas do not exist in this scenario." },
                { text: "All of the fruit is either green or yellow.", correctAnswer: "N", explanation: "Although all apples are green and all bananas are yellow, the colour of the peaches is unspecified; they could be orange, red, etc., so not all fruit is necessarily green or yellow." }
            ],
            // Question 7 - MCQ
            [
                { 
                    type: "mcq",
                    options: ["120 kg", "128 kg", "160 kg", "176 kg"],
                    correctAnswer: "B",
                    explanation: "Let C = weight of copper rod, A = weight of aluminium rod, S = weight of steel rod.\nFrom the given information:\n2C + 3A + S = 70 ... (1)\nC + 2A + S = 40 ... (2)\nSubtracting (2) from (1): C + A = 30\nFrom (2): C + 2A + S = 40\nSubstituting C = 30 - A: (30 - A) + 2A + S = 40\n30 + A + S = 40\nA + S = 10\nSo S = 10 - A\nFrom C + A = 30 and A + S = 10:\nC = 30 - A and S = 10 - A\nSubstituting back into equation (1):\n2(30 - A) + 3A + (10 - A) = 70\n60 - 2A + 3A + 10 - A = 70\n70 = 70 ✓\nThis confirms our equations are consistent.\nTo find specific values, from equation (2):\nC + 2A + S = 40\n(30 - A) + 2A + (10 - A) = 40\n30 - A + 2A + 10 - A = 40\n40 = 40 ✓\nSince C + A = 30 and A + S = 10, and all weights must be positive:\nIf A = 10, then C = 20 and S = 0 (not valid as S must be positive)\nIf A = 8, then C = 22 and S = 2\nChecking: 2(22) + 3(8) + 2 = 44 + 24 + 2 = 70 ✓\nAnd: 22 + 2(8) + 2 = 22 + 16 + 2 = 40 ✓\nTherefore: C = 22 kg, A = 8 kg, S = 2 kg\nFor 4C + 4A + S: 4(22) + 4(8) + 2 = 88 + 32 + 8 = 128 kg"
                }
            ],
            // Question 8 - MCQ
            [
                {
                    type: "mcq",
                    options: ["1", "2", "3", "4"],
                    correctAnswer: "D",
                    explanation: "Let's work through the constraints:\n- 6 folders numbered 1 (top) to 6 (bottom)\n- Zoe is not in position 6\n- Folders below Zoe < folders above Zoe\n- Ethan is in position 5 (last-but-one from bottom)\n- Exactly 2 folders between Maya and Zoe\n- Liam is not above Zoe\n\nFrom constraint 2: If Zoe is in position p, then (6-p) < (p-1), so 6-p < p-1, thus 7 < 2p, so p > 3.5\nSince p must be integer and Zoe ≠ 6, Zoe must be in position 4 or 5.\nBut Ethan is in position 5, so Zoe must be in position 4.\n\nWith Zoe in position 4 and exactly 2 folders between Maya and Zoe:\nMaya must be in position 1 (3 positions away from 4).\n\nLiam is not above Zoe (position 4), so Liam must be in position 5 or 6.\nBut Ethan is in position 5, so Liam must be in position 6.\n\nPositions: Maya(1), Zoe(4), Ethan(5), Liam(6)\nFolders between Maya(1) and Liam(6): positions 2, 3, 4, 5 = 4 folders"
                }
            ]
        ];

        // Now initialize arrays with passageTexts.length (which is the number of main questions)
        userAnswers = new Array(passageTexts.length).fill(null).map(() => new Array(5).fill(null));
        questionTimes = new Array(passageTexts.length).fill(0);
        flaggedQuestions = new Array(passageTexts.length).fill(false);

        // Check for review mode and initialize appropriate screen
        if (reviewParam) {
            // We're in review mode - load the past test data
            loadPastTestForReview(reviewParam);
        } else {
            // Regular test mode - continue with normal setup
            showSetupScreen();
        }

        // --- Functions ---
        function startTimer() {
            practiceSessionStartTime = new Date();
            clearInterval(timerInterval);
            timerEl.textContent = formatTimeSeconds(timeLeft);
            timerEl.classList.remove('text-gray-300');
            timerEl.classList.add('text-white', 'bg-opacity-20', 'bg-white');
            timerInterval = setInterval(() => {
                timeLeft--;
                timerEl.textContent = formatTimeSeconds(timeLeft);
                if (timeLeft <= 0) {
                    endPracticeSessionAndShowResults();
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            practiceSessionEndTime = practiceSessionEndTime || new Date();
            timerEl.classList.remove('text-white', 'bg-opacity-20', 'bg-white');
            timerEl.classList.add('text-gray-300');
        }

        function formatTimeSeconds(totalSeconds) {
             if (totalSeconds < 0) totalSeconds = 0;
             const minutes = Math.floor(totalSeconds / 60);
             const seconds = totalSeconds % 60;
             return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }

        function formatTimeDifference(milliseconds) {
            if (!milliseconds || milliseconds < 0) return "0 min 00 sec";
            const totalSeconds = Math.round(milliseconds / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes} min ${seconds < 10 ? '0' : ''}${seconds} sec`;
        }

        function recordTimeSpent(index) {
            if (questionStartTime && index >= 0 && index < questions.length) {
                const timeSpent = Date.now() - questionStartTime;
                questionTimes[index] = (questionTimes[index] || 0) + timeSpent;
            }
            questionStartTime = null;
        }

        function toggleFlag() {
            if (isReviewingFromResults) return;
            const index = currentQuestionIndex;
            flaggedQuestions[index] = !flaggedQuestions[index];
            updateFlagButtonAppearance();
            updateNavigatorButtons();
        }

        function updateFlagButtonAppearance() {
            const isFlagged = flaggedQuestions[currentQuestionIndex];
            flagButton.textContent = isFlagged ? 'Unflag' : 'Flag for Review';
            flagButton.classList.toggle('flagged', isFlagged);
        }

        function loadQuestion(index, reviewMode = false) {
            if (index < 0 || index >= passageTexts.length) return; // Check against passageTexts length
             if (!isReviewingFromResults && !reviewMode) {
                 recordTimeSpent(currentQuestionIndex); // currentQuestionIndex is passage index
            }
            const currentPassageText = passageTexts[index];
            const statementsForPassage = questionsByPassage[index];
            const questionContainer = document.querySelector('.question-column');
            
            // Check if this is an MCQ question
            const isMCQ = statementsForPassage.length === 1 && statementsForPassage[0].type === 'mcq';
            
            if (questionContainer) {
                if (isMCQ) {
                    // MCQ layout (similar to QR Test)
                    questionContainer.innerHTML = `
                        <div class="p-4 bg-gray-50 rounded-md mb-4" style="background-color: #f9fafb; border: 1px solid #e5e7eb; padding: 1.25rem; line-height: 1.5;">
                            ${currentPassageText}
                        </div>
                        <h4 class="text-md font-semibold mb-3 bg-white pb-1">Question ${index + 1}</h4>
                        <div id="options-container" class="space-y-2"></div>
                        <div id="review-explanation-container"></div>
                    `;
                } else {
                    // Syllogism layout (existing)
                    questionContainer.innerHTML = `
                        <div class="p-4 bg-gray-50 rounded-md mb-4" style="background-color: #f9fafb; border: 1px solid #e5e7eb; padding: 1.25rem; line-height: 1.5;">
                            ${currentPassageText}
                        </div>
                        <div class="flex justify-between items-center mb-3">
                            <div>
                                <h4 class="text-md font-semibold bg-white pb-1">Question ${index + 1}</h4>
                                <h5 class="font-medium mb-2">Conclusions</h5>
                                <p class="text-sm text-gray-600">Drag 'Yes' or 'No' onto the statement row, or click a statement then click 'Yes' or 'No'.</p>
                            </div>
                            <div class="flex space-x-2">
                                <button id="yes-button" class="drag-button px-6 py-2 rounded-md font-medium">Yes</button>
                                <button id="no-button" class="drag-button px-6 py-2 rounded-md font-medium">No</button>
                            </div>
                        </div>
                        <div id="statements-container" class="space-y-3"></div>
                        <div id="review-explanation-container"></div>
                    `;
                }
                
                
                const stimulusDiv = questionContainer.querySelector('.p-4.bg-gray-50');
                if (stimulusDiv) {
                    const stimulusImages = stimulusDiv.querySelectorAll('img');
                    stimulusImages.forEach(img => {
                        img.style.maxWidth = '60%'; // Consistent image sizing
                        img.style.margin = '0 auto';
                        img.style.display = 'block';
                    });
                }
            }
            
            currentQuestionIndex = index; // This is passage index
            isReviewingFromResults = reviewMode;
            
            const statementsContainer = document.getElementById('statements-container');
            const reviewExplanationContainer = document.getElementById('review-explanation-container');
            
            questionNumberInfoEl.textContent = `${index + 1} of ${passageTexts.length}`;
            if (questionContainer) questionContainer.scrollTop = 0;
            
            if (statementsContainer) {
                statementsContainer.innerHTML = '';
                statementsForPassage.forEach((statementData, statementIdx) => {
                    const statementId = `q${index}_statement${statementIdx}`;
                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'statement-row flex items-center mb-3 border border-gray-200 rounded-md p-3 bg-white';
                    rowDiv.dataset.statementIndex = statementIdx;
                    
                    const userAnswerForStatement = userAnswers[index] && userAnswers[index][statementIdx] ? userAnswers[index][statementIdx] : null;
                    let displayAnswer = '...';
                    if (userAnswerForStatement === 'Y') displayAnswer = 'Yes';
                    else if (userAnswerForStatement === 'N') displayAnswer = 'No';

                    rowDiv.innerHTML = `
                        <div class="flex-grow statement-text">
                            <span class="font-medium">${statementIdx + 1}.</span> ${statementData.text}
                        </div>
                        <div class="flex-shrink-0 ml-4 relative">
                            <div class="statement-answer-box w-16 h-10 border border-gray-300 rounded flex items-center justify-center" 
                                 data-statement-index="${statementIdx}">
                                ${displayAnswer}
                            </div>
                        </div>
                    `;
                    statementsContainer.appendChild(rowDiv);

                    if (reviewMode) {
                        const answerBox = rowDiv.querySelector('.statement-answer-box');
                        const correctAnswer = statementData.correctAnswer; // Y or N
                        
                        answerBox.classList.remove('border-gray-300', 'bg-gray-50');
                        if (userAnswerForStatement === correctAnswer) {
                            answerBox.classList.add('border-green-500', 'bg-green-50', 'text-green-700');
                        } else {
                            answerBox.classList.add('border-red-500', 'bg-red-50', 'text-red-700');
                            const correctDiv = document.createElement('div');
                            correctDiv.className = 'mt-1 text-xs text-gray-600';
                            correctDiv.textContent = `Correct: ${correctAnswer === 'Y' ? 'Yes' : 'No'}`;
                            rowDiv.querySelector('.flex-shrink-0').appendChild(correctDiv);
                        }
                        
                        // Display explanation for this statement
                        if (statementData.explanation) {
                             const explanationDiv = document.createElement('div');
                             explanationDiv.classList.add('explanation-box', 'mt-2', 'text-sm');
                             explanationDiv.innerHTML = `<strong class="font-semibold">Explanation (${statementIdx + 1}):</strong> ${statementData.explanation.replace(/\n/g, '<br>')}`;
                             if(reviewExplanationContainer && statementIdx === 0) reviewExplanationContainer.innerHTML = ''; // Clear for new passage
                             if(reviewExplanationContainer) reviewExplanationContainer.appendChild(explanationDiv);
                        }
                    }
                });
                if (!reviewMode) {
                    initDragAndDrop();
                }
            }
            
            prevButton.disabled = index === 0;
            if (!reviewMode && index === passageTexts.length - 1) {
                 nextButton.textContent = 'Finish & Review';
                 nextButton.disabled = false;
            } else if (!reviewMode) {
                 nextButton.textContent = 'Next (Alt+N) →';
                 nextButton.disabled = false;
            } else {
                 nextButton.disabled = index === passageTexts.length - 1;
                 if (!nextButton.disabled) nextButton.textContent = 'Next →';
            }

            updateFlagButtonAppearance();
            if (reviewMode) {
                backToResultsButton.classList.remove('hidden');
                endPracticeSessionButtonFooter.classList.add('hidden');
                practiceSessionTitleEl.textContent = "Reviewing Question";
                navigatorButton.disabled = false;
                flagButton.disabled = true;
            } else {
                backToResultsButton.classList.add('hidden');
                endPracticeSessionButtonFooter.classList.remove('hidden');
                practiceSessionTitleEl.textContent = "Decision Making";
                navigatorButton.disabled = false;
                flagButton.disabled = false;
            }
            updateNavigatorHighlight();
            if (!isReviewingFromResults) {
                questionStartTime = Date.now();
            }
        }

         function handleOptionSelect(questionIndex, optionIndex, optionValue) {
             // This function is no longer used in the same way.
             // Answer selection is handled by initDragAndDrop.
             // We can remove this or adapt if a different selection method is needed.
             console.warn("handleOptionSelect called, but should be handled by drag and drop logic for syllogisms.");
         }

        function showNextQuestion() {
            // Hide calculator if it's open
            if (calculatorUI.classList.contains('visible')) {
                toggleCalculator();
            }
            
            if (isReviewingFromResults) {
                if (currentQuestionIndex < passageTexts.length - 1) {
                    loadQuestion(currentQuestionIndex + 1, true);
                }
            }
            else if (!isReviewingFromResults) {
                 recordTimeSpent(currentQuestionIndex);
                 if (currentQuestionIndex === passageTexts.length - 1) {
                     showReviewScreen();
                 } else if (currentQuestionIndex < passageTexts.length - 1) {
                     loadQuestion(currentQuestionIndex + 1);
                 }
            }
        }

        function showPrevQuestion() {
            // Hide calculator if it's open
            if (calculatorUI.classList.contains('visible')) {
                toggleCalculator();
            }
            
             if (isReviewingFromResults) {
                 if (currentQuestionIndex > 0) {
                     loadQuestion(currentQuestionIndex - 1, true);
                 }
             }
             else if (currentQuestionIndex > 0 && !isReviewingFromResults) {
                 recordTimeSpent(currentQuestionIndex);
                 loadQuestion(currentQuestionIndex - 1);
            }
        }

        function showSetupScreen() {
            userName = '';
            userEmail = '';
            userGoal = '';
            userFocusArea = '';
            
            // Check for Firebase auth user
            if (firebase.auth && firebase.auth().currentUser) {
                const currentUser = firebase.auth().currentUser;
                userName = currentUser.displayName || currentUser.email || '';
                userEmail = currentUser.email || '';
            }
            
            setupScreen.classList.remove('hidden');
            practiceSessionScreen.classList.add('hidden');
            reviewScreen.classList.add('hidden');
            reviewScreen.classList.remove('flex');
            resultsScreen.classList.add('hidden');
            appContainer.classList.remove('flex', 'flex-col');
            // currentlyDisplayedPassageIndex = -1; // No longer needed with this structure
            
            if (setupQuestionCountEl) setupQuestionCountEl.textContent = "30";
            if (setupTimeLimitEl) setupTimeLimitEl.textContent = `31 minutes`;
            if (goalInput) {
                goalInput.max = 30;
                goalInput.value = userGoal;
                const goalLabel = document.querySelector('label[for="goal"]');
                if (goalLabel) goalLabel.textContent = `Goal (Score out of 30):`;
            }
            if (focusAreaInput) {
                focusAreaInput.value = userFocusArea;
            }
        }

        // Ensure we call updateTimerVisibility when returning to practice screen
        function showPracticeSessionScreen() {
            setupScreen.classList.add('hidden');
            practiceSessionScreen.classList.remove('hidden');
            practiceSessionScreen.classList.add('flex');
            reviewScreen.classList.add('hidden');
            resultsScreen.classList.add('hidden');
            appContainer.classList.add('flex', 'flex-col');
            // currentlyDisplayedPassageIndex = -1; // No longer needed with this structure
            updateTimerVisibility();
        }

        // Ensure the timer visuals are maintained when switching between screens
        function updateTimerVisibility() {
            if (timerInterval) {
                timerEl.classList.remove('text-gray-300');
                timerEl.classList.add('text-white', 'bg-opacity-20', 'bg-white');
            } else {
                timerEl.classList.add('text-gray-300');
                timerEl.classList.remove('text-white', 'bg-opacity-20', 'bg-white');
            }
        }

        // Review screen - keep timer running
        function showReviewScreen(filterFlagged = false) {
            recordTimeSpent(currentQuestionIndex);
            // Don't stop timer here - let it continue running
            updateTimerVisibility();
            practiceSessionScreen.classList.add('hidden');
            reviewScreen.classList.remove('hidden');
            reviewScreen.classList.add('flex');
            resultsScreen.classList.add('hidden');
            setupScreen.classList.add('hidden');
            appContainer.classList.add('flex', 'flex-col');
            
            // Hide calculator if it's visible
            if (calculatorUI.classList.contains('visible')) {
                toggleCalculator();
            }
            
            reviewGrid.innerHTML = '';
            questions.forEach((_, index) => {
                 if (filterFlagged && !flaggedQuestions[index]) {
                     return;
                 }
                const button = document.createElement('button');
                button.textContent = index + 1;
                button.className = 'review-grid-button';
                button.dataset.questionIndex = index;
                if (userAnswers[index] !== null && userAnswers[index] !== undefined) {
                    button.classList.add('review-grid-button-answered');
                } else {
                     button.classList.add('review-grid-button-unanswered');
                }
                if (flaggedQuestions[index]) {
                    button.classList.add('review-flagged');
                }
                // Using event delegation, so no individual onclick handler
                reviewGrid.appendChild(button);
            });
             filterFlaggedButton.textContent = filterFlagged ? 'Show All Questions' : 'Show Flagged Only';
        }

        function populateNavigator() {
            navigatorGrid.innerHTML = '';
            questions.forEach((_, index) => {
                const button = document.createElement('button');
                button.textContent = index + 1;
                button.classList.add('py-2', 'px-1', 'border', 'border-gray-300', 'rounded-md', 'text-center', 'transition', 'duration-150', 'ease-in-out', 'text-sm', 'hover:bg-gray-100');
                button.dataset.questionIndex = index;
                if (userAnswers[index]) button.classList.add('nav-answered');
                if (index === currentQuestionIndex) button.classList.add('nav-current');
                if (flaggedQuestions[index]) button.classList.add('nav-flagged');
                button.onclick = () => {
                    navigatorModal.classList.remove('flex');
                    navigatorModal.classList.add('hidden');
                    // Hide calculator if it's open
                    if (calculatorUI.classList.contains('visible')) {
                        toggleCalculator();
                    }
                    const targetIndex = parseInt(button.dataset.questionIndex, 10);
                    loadQuestion(targetIndex, isReviewingFromResults);
                };
                navigatorGrid.appendChild(button);
            });
        }

        function updateNavigatorButtons() {
            if (!navigatorGrid) return;
            const buttons = navigatorGrid.querySelectorAll('button');
            buttons.forEach(button => {
                const index = parseInt(button.dataset.questionIndex, 10);
                button.classList.remove('nav-answered', 'nav-current', 'nav-flagged');
                if (userAnswers[index]) button.classList.add('nav-answered');
                if (index === currentQuestionIndex) button.classList.add('nav-current');
                if (flaggedQuestions[index]) button.classList.add('nav-flagged');
            });
        }

         function updateNavigatorHighlight() {
             if (!navigatorGrid) return;
             const buttons = navigatorGrid.querySelectorAll('button');
             buttons.forEach(button => {
                 const index = parseInt(button.dataset.questionIndex, 10);
                 button.classList.remove('nav-current');
                 if (index === currentQuestionIndex) button.classList.add('nav-current');
             });
         }

        function showResultsScreen() {
            // Correctly hide practice/review screens and show results screen
            practiceSessionScreen.classList.add('hidden');
            reviewScreen.classList.add('hidden');
            reviewScreen.classList.remove('flex');
            resultsScreen.classList.remove('hidden');
            resultsScreen.classList.add('flex'); // Assuming flex is desired for resultsScreen
            setupScreen.classList.add('hidden');
            appContainer.classList.add('flex', 'flex-col'); // Ensure app container has flex if needed

            stopTimer(); // Should be called to stop the timer
            calculateScore(); // Ensure score and detailedPassageScores are up-to-date

            const scoreEl = document.getElementById('score'); // User's score
            const totalScorePossibleEl = document.getElementById('total-score-possible'); // Max possible score
            const timeTakenEl = document.getElementById('time-taken'); // Time taken display
            const resultsDetailsGridEl = document.getElementById('results-details-grid'); // For detailed breakdown

            if (scoreEl) scoreEl.textContent = score;
            if (totalScorePossibleEl) totalScorePossibleEl.textContent = maxScore; 
            if (timeTakenEl && practiceSessionStartTime && practiceSessionEndTime) {
                 timeTakenEl.textContent = formatTimeDifference(practiceSessionEndTime - practiceSessionStartTime);
            } else if (timeTakenEl) {
                timeTakenEl.textContent = "N/A"; // Fallback if times are not set
            }

            if (resultsDetailsGridEl) {
                resultsDetailsGridEl.innerHTML = ''; // Clear previous results
                if (window.detailedPassageScores && window.detailedPassageScores.length > 0) {
                    window.detailedPassageScores.forEach((item, index) => {
                        const passageResultDiv = document.createElement('div');
                        passageResultDiv.classList.add('passage-result-summary', 'p-3', 'border', 'rounded-md', 'bg-gray-50', 'text-sm');
                        passageResultDiv.style.marginBottom = '10px';
                        passageResultDiv.style.cursor = 'pointer';
                        
                        // Add click handler to review the question
                        passageResultDiv.addEventListener('click', () => {
                            revisitQuestionFromResults(index);
                        });
                        
                        // Using string concatenation to avoid template literal issues
                        const questionType = item.isMCQ ? ' (MCQ)' : '';
                        passageResultDiv.innerHTML = 
                            '<h4 class="font-semibold text-md mb-1">Question ' + (index + 1) + questionType + '</h4>' +
                            (item.isMCQ 
                                ? '<p>' + (item.correctCount === 1 ? 'Correct' : 'Incorrect') + '</p>'
                                : '<p>Correct Statements: ' + item.correctCount + ' / ' + item.totalStatements + '</p>') +
                            '<p>Points Awarded: <span class="font-bold">' + item.points + '</span></p>';
                        
                        resultsDetailsGridEl.appendChild(passageResultDiv);
                    });
                } else {
                    resultsDetailsGridEl.innerHTML = '<p class="text-center text-gray-600 col-span-full">Could not load detailed score breakdown.</p>';
                }
            }
            
            // Update reflection UI if needed
            const reflectionTextEl = document.getElementById('reflection-text');
            const focusRatingEl = document.getElementById('focus-rating');
            if (reflectionTextEl) reflectionTextEl.value = ''; // Clear previous reflection
            if (focusRatingEl) focusRatingEl.value = ''; // Clear previous rating

            const submitButton = document.getElementById('submit-performance-button');
            if (submitButton) {
                 submitButton.disabled = false;
                 submitButton.textContent = 'Submit Reflections';
                 submitButton.classList.remove('bg-green-500');
            }
            // Ensure other buttons like download PDF are correctly handled
        }


        function revisitQuestionFromResults(index) {
            resultsScreen.classList.add('hidden');
            resultsScreen.classList.remove('flex');
            showPracticeSessionScreen();
            loadQuestion(index, true);
        }

        // Only stop timer when showing final results
        function endPracticeSessionAndShowResults() {
            stopTimer();
            practiceSessionEndTime = practiceSessionEndTime || new Date(); // Ensure end time is set

            const currentTotalScore = calculateScore(); // Call once and store

            const performanceData = {
                studentName: userName || 'Anonymous',
                studentEmail: userEmail || '',
                examName: "DM Test 1",
                score: currentTotalScore,
                maxScore: maxScore, // Use global maxScore (16)
                detailedPassageScores: window.detailedPassageScores || [], // Add this for granular data
                numberOfPassages: passageTexts.length,
                timeTaken: formatTimeDifference(practiceSessionEndTime - practiceSessionStartTime),
                answers: userAnswers,
                questionTimes: questionTimes,
                flaggedQuestions: flaggedQuestions,
                goal: userGoal || '',
                focusArea: userFocusArea || '', // Corrected key name
                focusRating: '', 
                reflection: '',  
                submissionTimestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                isReflection: false // Explicitly false for initial submission
            };

            submitDataToFirebase(performanceData);
            showResultsScreen();
        }

        // Function to calculate the score
        function calculateScore() {
            score = 0;
            window.detailedPassageScores = [];
            const numPassages = passageTexts.length; // Should be 8

            for (let i = 0; i < numPassages; i++) {
                const statementsForPassage = questionsByPassage[i];
                const isMCQ = statementsForPassage.length === 1 && statementsForPassage[0].type === 'mcq';
                
                if (isMCQ) {
                    // MCQ scoring - 2 points for correct answer
                    const mcqData = statementsForPassage[0];
                    const userAnswer = userAnswers[i] && userAnswers[i][0] ? userAnswers[i][0] : null;
                    const isCorrect = userAnswer === mcqData.correctAnswer;
                    const passageScore = isCorrect ? 2 : 0;
                    score += passageScore;
                    
                    window.detailedPassageScores.push({
                        passageIndex: i,
                        correctCount: isCorrect ? 1 : 0,
                        totalStatements: 1,
                        points: passageScore,
                        isMCQ: true
                    });
                } else {
                    // Syllogism scoring - existing logic
                    let correctCountForPassage = 0;
                    let passageScore = 0;
                    const numStatementsInPassage = statementsForPassage.length; // Should be 5

                    if (userAnswers[i] && userAnswers[i].length === numStatementsInPassage) {
                        for (let j = 0; j < numStatementsInPassage; j++) {
                            if (userAnswers[i][j] && statementsForPassage[j].correctAnswer &&
                                userAnswers[i][j].toUpperCase() === statementsForPassage[j].correctAnswer.toUpperCase()) {
                                correctCountForPassage++;
                            }
                        }
                    }

                    if (correctCountForPassage === 5) {
                        passageScore = 2;
                    } else if (correctCountForPassage === 4) {
                        passageScore = 1;
                    } else {
                        passageScore = 0;
                    }
                    score += passageScore;
                    window.detailedPassageScores.push({
                        passageIndex: i,
                        correctCount: correctCountForPassage,
                        totalStatements: numStatementsInPassage,
                        points: passageScore,
                        isMCQ: false
                    });
                }
            }
            return score;
        }

        // Function to submit data to Firebase
        function submitDataToFirebase(data) {
            // Only submit if Firebase is initialized
            if (typeof firebase !== 'undefined' && firebase.firestore) {
                try {
                    const db = firebase.firestore();
                    let userId = ''; 
                    if (firebase.auth && firebase.auth().currentUser) {
                        userId = firebase.auth().currentUser.uid; 
                    }
                    
                    const dataToSubmit = {
                        ...data, 
                        userId: userId 
                    };

                    db.collection("performanceSubmissions").add(dataToSubmit) 
                      .then(() => {
                          console.log("Performance data submitted to Firebase with userId");
                          
                          setTimeout(() => {
                              const successNotice = document.createElement('div');
                              successNotice.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded shadow-lg z-50';
                              // Using string concatenation with single quotes for HTML attributes
                              successNotice.innerHTML = 
                                '<div class="flex items-center">' +
                                  '<svg class="h-6 w-6 text-green-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">' +
                                    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>' +
                                  '</svg>' +
                                  '<span class="font-medium">Success!</span>' +
                                  '<span class="ml-2">Your test results have been submitted.</span>' +
                                '</div>';
                              document.body.appendChild(successNotice);
                              
                              setTimeout(() => {
                                  successNotice.classList.add('opacity-0', 'transition-opacity', 'duration-500');
                                  setTimeout(() => {
                                      if (document.body.contains(successNotice)) {
                                          document.body.removeChild(successNotice);
                                      }
                                  }, 500);
                              }, 5000);
                          }, 500); 
                      })
                      .catch((error) => {
                          console.error("Error submitting to Firebase:", error);
                          
                          setTimeout(() => {
                              const errorNotice = document.createElement('div');
                              errorNotice.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded shadow-lg z-50';
                              // Using string concatenation with single quotes for HTML attributes
                              errorNotice.innerHTML = 
                                '<div class="flex items-center">' +
                                  '<svg class="h-6 w-6 text-red-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">' +
                                    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>' +
                                  '</svg>' +
                                  '<span class="font-medium">Error!</span>' +
                                  '<span class="ml-2">Could not submit your results. You can try adding a reflection.</span>' +
                                '</div>';
                              document.body.appendChild(errorNotice);
                              
                              setTimeout(() => {
                                  errorNotice.classList.add('opacity-0', 'transition-opacity', 'duration-500');
                                  setTimeout(() => {
                                     if (document.body.contains(errorNotice)) {
                                         document.body.removeChild(errorNotice);
                                     }
                                  }, 500);
                              }, 5000);
                          }, 500);
                      });
                } catch (error) {
                    console.error("Error accessing Firebase:", error);
                }
            } else {
                console.error("Firebase is not initialized");
            }
        }

        function handleEndPracticeSessionFooterClick() {
             recordTimeSpent(currentQuestionIndex);
             // Remove stopTimer() call to keep timer running
             showReviewScreen();
         }

        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const reflection = reflectionText.value.trim();
            const focusRatingValue = focusRatingInput.value; // Renamed to avoid conflict
            const finalScore = score; // Use global score variable
            const totalScorePossible = maxScore; // Use global maxScore
            const timeTakenString = timeTakenEl.textContent; // Get from element, already formatted

            let y = 15;
            const lineHeight = 7;
            const pageHeight = doc.internal.pageSize.height;
            const margin = 15;

            doc.setFontSize(18);
            doc.text("UCAT Decision Making Test 1 Results", margin, y); // Updated title
            y += lineHeight * 1.5;
            doc.setFontSize(12);
            // Using string concatenation
            doc.text('Name: ' + (userName || 'N/A'), margin, y); y += lineHeight;
            doc.text('Goal: ' + (userGoal || 'N/A') + ' / ' + totalScorePossible, margin, y); y += lineHeight;
            doc.text('Focus Area: ' + (userFocusArea || 'N/A'), margin, y); y += lineHeight;
            doc.text('Final Score: ' + finalScore + ' / ' + totalScorePossible, margin, y); y += lineHeight;
            doc.text('Time Taken: ' + timeTakenString, margin, y); y += lineHeight * 1.5;
            
            doc.setFontSize(14);
            doc.text("Focus Rating (1-5):", margin, y); y += lineHeight;
            doc.setFontSize(10);
            doc.text(focusRatingValue || 'N/A', margin, y); y += lineHeight * 1.5;
            
            doc.setFontSize(14);
            doc.text("Main Takeaway:", margin, y); y += lineHeight;
            doc.setFontSize(10);
            const reflectionLines = doc.splitTextToSize(reflection || 'No reflection provided.', doc.internal.pageSize.width - margin * 2);
            doc.text(reflectionLines, margin, y);
            y += reflectionLines.length * (lineHeight * 0.7) + lineHeight;
            
            doc.setFontSize(14);
            doc.text("Detailed Passage Results:", margin, y); y += lineHeight * 1.5; // Updated heading
            doc.setFontSize(10);

            if (window.detailedPassageScores && window.detailedPassageScores.length > 0) {
                window.detailedPassageScores.forEach((detail, passageIdx) => {
                    if (y + (lineHeight * 5) > pageHeight - margin) { // Estimate space needed for a passage
                        doc.addPage();
                        y = margin;
                    }
                    doc.setFontSize(11);
                    doc.text('Passage ' + (passageIdx + 1) + ':', margin, y); y += lineHeight;
                    doc.setFontSize(10);
                    doc.text('  Correct Statements: ' + detail.correctCount + ' / ' + detail.totalStatements, margin + 5, y); y += lineHeight;
                    doc.text('  Points Awarded: ' + detail.points, margin + 5, y); y += lineHeight * 0.5;

                    // Optionally, add individual statement details if needed
                    // questionsByPassage[passageIdx].forEach((statement, stmtIdx) => { ... });
                    y += lineHeight * 0.5; // Extra spacing between passages
                });
            } else {
                doc.text("No detailed passage scores available.", margin, y); y+= lineHeight;
            }
            doc.save('ucat_dm_test1_results_' + (userName.replace(/[^a-zA-Z0-9]/g, '_') || 'user') + '.pdf');
        }
        
        // Function to submit performance data to server
        async function submitPerformanceData() {
            // Prevent multiple submissions
            if (isSubmittingReflection) {
                console.log("Submission already in progress, ignoring duplicate call");
                return;
            }
            
            try {
                isSubmittingReflection = true;
                
                // Get additional reflection data
                const focusRating = document.getElementById('focus-rating').value || '';
                const reflection = document.getElementById('reflection-text').value || '';
                
                if (typeof firebase !== 'undefined' && firebase.firestore) {
                    const db = firebase.firestore();
                    
                    // Get current authenticated user data if available
                    let userDisplayName = '';
                    let userId = ''; // <--- Add this
                    
                    if (firebase.auth && firebase.auth().currentUser) {
                        const currentUser = firebase.auth().currentUser;
                        userDisplayName = currentUser.displayName || '';
                        userId = currentUser.uid; // <--- Get the UID
                        // Note: we're already storing userEmail from when the test started
                    }
                    
                    // Instead of querying for existing document, create a new one with both test results and reflection
                    const performanceData = {
                        studentName: userName || userDisplayName || 'Anonymous',
                        studentEmail: userEmail || '',
                        userId: userId, // <--- Add userId here
                        examName: "DM Test 1",
                        score: score, // Use global score variable
                        maxScore: maxScore, // Use global maxScore
                        detailedPassageScores: window.detailedPassageScores || [], // Include detailed scores
                        numberOfPassages: passageTexts.length, // Include number of passages
                        timeTaken: timeTakenEl.textContent, // Get formatted time
                        answers: userAnswers, // Raw answers
                        questionTimes: questionTimes, // Time per passage
                        flaggedQuestions: flaggedQuestions, // Flagged per passage
                        goal: userGoal || '',
                        focusArea: userFocusArea || '',
                        focusRating: focusRating,
                        reflection: reflection,
                        submissionTimestamp: new Date().toISOString(),
                        userAgent: navigator.userAgent,
                        isReflection: true 
                    };
                    
                    // Add as a new document
                    await db.collection("performanceSubmissions").add(performanceData);
                    
                    // Show success message
                    const successNotice = document.createElement('div');
                    successNotice.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded shadow-lg z-50';
                    successNotice.innerHTML = `
                        <div class="flex items-center">
                            <svg class="h-6 w-6 text-green-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            <span class="font-medium">Success!</span>
                            <span class="ml-2">Your reflection has been saved.</span>
                        </div>
                    `;
                    document.body.appendChild(successNotice);
                    
                    // Remove the notice after 5 seconds
                    setTimeout(() => {
                        successNotice.classList.add('opacity-0', 'transition-opacity', 'duration-500');
                        setTimeout(() => {
                            if (document.body.contains(successNotice)) {
                                document.body.removeChild(successNotice);
                            }
                        }, 500);
                    }, 5000);
                    
                    // Update the button
                    document.getElementById('submit-performance-button').disabled = true;
                    document.getElementById('submit-performance-button').textContent = 'Reflection Saved ✓';
                    document.getElementById('submit-performance-button').classList.add('bg-green-500');
                } else {
                    alert('Firebase is not initialized. Please configure Firebase first.');
                    console.error('Firebase or Firestore is not available.');
                }
            } catch (error) {
                console.error('Error saving reflection:', error);
                alert('An error occurred while saving your reflection. Please try again.');
            } finally {
                // Reset the submission flag after a delay, just in case
                setTimeout(() => {
                    isSubmittingReflection = false;
                }, 2000);
            }
        }
        
        // --- Calculator Functions ---
        function updateCalcDisplay() {
            // Ensure display doesn't overflow, use scientific notation for very long numbers
            if (calcCurrentInput === 'Error') {
                calcDisplay.textContent = 'Error';
            } else if (calcCurrentInput.length > 12) {
                // For long numbers, try scientific notation
                try {
                    const num = parseFloat(calcCurrentInput);
                    if (isFinite(num)) {
                        calcDisplay.textContent = num.toExponential(6);
                    } else {
                        calcDisplay.textContent = 'Error';
                    }
                } catch (e) {
                    calcDisplay.textContent = calcCurrentInput.substring(0, 12);
                }
            } else {
                calcDisplay.textContent = calcCurrentInput;
            }
            
            // Show/hide memory indicator
            const memIndicator = document.getElementById('calc-memory-indicator');
            if (calcMemory !== 0) {
                memIndicator.style.display = 'block';
            } else {
                memIndicator.style.display = 'none';
            }
        }

        // Add specific event handler for equals button
        document.querySelector('.calc-button.equals').addEventListener('click', (e) => {
            console.log('Equals button clicked');
            calculate();
            e.stopPropagation(); // Prevent event bubbling
        });

        calcButtons.forEach(button => {
            button.addEventListener('click', () => {
                const value = button.dataset.calcValue;
                const action = button.dataset.calcAction;
                
                console.log('Button clicked:', button.textContent, 'value:', value, 'action:', action);

                if (value !== undefined) { 
                    if (value === '.') { inputDecimal(); } 
                    else { inputDigit(value); }
                } else if (action) { 
                    if (['+', '-', '*', '/'].includes(action)) { handleOperator(action); } 
                    else if (action === 'equals') { 
                        console.log('Equals action detected');
                        calculate(); 
                    } 
                    else if (action === 'clear') { clearCalculator(); } 
                    else if (['m+', 'm-', 'mrc'].includes(action)) { handleMemory(action); } 
                    else if (['sqrt', 'percent', 'negate', 'backspace'].includes(action)) { handleSpecialFunction(action); }
                }
            });
        });

        function clearCalculator() {
            calcCurrentInput = '0';
            calcPreviousInput = '';
            calcOperator = null;
            calcShouldResetDisplay = false;
            calcMrcPressedOnce = false; 
            updateCalcDisplay();
        }
        
        function inputDigit(digit) {
            if (calcCurrentInput === 'Error') calcCurrentInput = '0'; // Clear error on new digit
            if (calcShouldResetDisplay) {
                calcCurrentInput = digit;
                calcShouldResetDisplay = false;
            } else {
                // Prevent excessively long numbers before decimal
                if (calcCurrentInput.includes('.') && calcCurrentInput.split('.')[1].length >= 8) return; // Limit to 8 decimal places
                if (!calcCurrentInput.includes('.') && calcCurrentInput.length >= 10 && calcCurrentInput !== '0') return; // Limit to 10 integer digits

                calcCurrentInput = calcCurrentInput === '0' ? digit : calcCurrentInput + digit;
            }
            updateCalcDisplay();
            calcMrcPressedOnce = false; 
        }

        function inputDecimal() {
            if (calcCurrentInput === 'Error') calcCurrentInput = '0';
            if (calcShouldResetDisplay) {
                calcCurrentInput = '0.';
                calcShouldResetDisplay = false;
            } else if (!calcCurrentInput.includes('.')) {
                calcCurrentInput += '.';
            }
            updateCalcDisplay();
            calcMrcPressedOnce = false;
        }

        function handleOperator(nextOperator) {
            if (calcCurrentInput === 'Error') return;
            const inputValue = parseFloat(calcCurrentInput);
            if (calcOperator && !calcShouldResetDisplay) { 
                calculate();
                if (calcCurrentInput === 'Error') return; // Stop if calculation resulted in error
                calcPreviousInput = calcCurrentInput; 
            } else {
                calcPreviousInput = calcCurrentInput;
            }
            calcOperator = nextOperator;
            calcShouldResetDisplay = true;
            calcMrcPressedOnce = false;
        }

        function calculate() {
            if (!calcOperator || calcPreviousInput === '' || calcCurrentInput === 'Error') return;
            const prev = parseFloat(calcPreviousInput);
            const current = parseFloat(calcCurrentInput);
            if (isNaN(prev) || isNaN(current)) {
                calcCurrentInput = 'Error'; // Should not happen if inputs are validated
                updateCalcDisplay();
                return;
            }

            let result = 0;
            switch (calcOperator) {
                case '+': result = prev + current; break;
                case '-': result = prev - current; break;
                case '*': result = prev * current; break;
                case '/': 
                    if (current === 0) {
                        result = 'Error';
                    } else {
                        result = prev / current;
                    }
                    break;
                default: return;
            }

            if (result === 'Error') {
                calcCurrentInput = 'Error';
            } else {
                // Check if result is a valid number and not Infinity or NaN
                if (!isFinite(result)) {
                    calcCurrentInput = 'Error';
                } else {
                    // Format result: if it's a very small or large number, handle differently
                    try {
                        // Handle large numbers better - use toFixed for numbers that are too large
                        if (Math.abs(result) > 1e10) {
                            let resultStr = result.toExponential(6);
                            calcCurrentInput = resultStr;
                        } else if (Math.abs(result) < 1e-6 && result !== 0) {
                            // Small numbers in scientific notation
                            let resultStr = result.toExponential(6);
                            calcCurrentInput = resultStr;
                        } else {
                            // Normal sized numbers - keep precision but remove trailing zeros
                            let resultStr = parseFloat(result.toPrecision(10)).toString();
                            calcCurrentInput = resultStr;
                        }
                    } catch (e) {
                        // Fallback if formatting fails
                        calcCurrentInput = String(result);
                    }
                    
                    // Additional safety - if we end up with an invalid display value, show Error
                    if (calcCurrentInput === 'NaN' || calcCurrentInput === 'Infinity' || calcCurrentInput === '-Infinity') {
                        calcCurrentInput = 'Error';
                    }
                }
            }
            calcOperator = null;
            calcShouldResetDisplay = true; 
            updateCalcDisplay();
        }

        function handleMemory(action) {
            const currentValue = parseFloat(calcCurrentInput);
            if (calcCurrentInput === 'Error' && action !== 'mrc') return;

            switch (action) {
                case 'm+':
                    if (!isNaN(currentValue)) calcMemory += currentValue;
                    updateCalcDisplay();
                    break;
                case 'm-':
                    if (!isNaN(currentValue)) calcMemory -= currentValue;
                    updateCalcDisplay();
                    break;
                case 'mrc':
                    if (calcMrcPressedOnce) { 
                        calcMemory = 0;
                        calcMrcPressedOnce = false;
                        // Optionally, could also clear display to 0 here
                    } else { 
                        calcCurrentInput = String(parseFloat(calcMemory.toPrecision(10))); // Show memory with precision
                        calcMrcPressedOnce = true;
                        calcShouldResetDisplay = true; 
                    }
                    break;
            }
            if (action !== 'mrc') { // For M+ and M-, display doesn't change immediately
                calcShouldResetDisplay = true; // Next number input should overwrite current display
                calcMrcPressedOnce = false; 
            } else {
                updateCalcDisplay(); // For MRC, update display immediately
            }
        }

        function handleSpecialFunction(func) {
            if (calcCurrentInput === 'Error' && func !== 'clear') return;
            const currentValue = parseFloat(calcCurrentInput);

            switch (func) {
                case 'sqrt':
                    if (currentValue < 0 || isNaN(currentValue)) {
                        calcCurrentInput = 'Error';
                    } else {
                        try {
                            const sqrtResult = Math.sqrt(currentValue);
                            if (!isFinite(sqrtResult)) {
                                calcCurrentInput = 'Error';
                            } else {
                                calcCurrentInput = String(parseFloat(sqrtResult.toPrecision(10)));
                            }
                        } catch (e) {
                            calcCurrentInput = 'Error';
                        }
                    }
                    break;
                case 'percent':
                    if (isNaN(currentValue)) { calcCurrentInput = 'Error'; break; }
                    if (calcPreviousInput !== '' && calcOperator) {
                        const prev = parseFloat(calcPreviousInput);
                        if (isNaN(prev)) { calcCurrentInput = 'Error'; break; }
                        
                        try {
                            const percentResult = prev * (currentValue / 100);
                            if (!isFinite(percentResult)) {
                                calcCurrentInput = 'Error';
                            } else {
                                calcCurrentInput = String(parseFloat(percentResult.toPrecision(10)));
                            }
                        } catch (e) {
                            calcCurrentInput = 'Error';
                        }
                    } else { 
                        try {
                            const percentResult = currentValue / 100;
                            if (!isFinite(percentResult)) {
                                calcCurrentInput = 'Error';
                            } else {
                                calcCurrentInput = String(parseFloat(percentResult.toPrecision(10)));
                            }
                        } catch (e) {
                            calcCurrentInput = 'Error';
                        }
                    }
                    break;
                case 'negate':
                     if (calcCurrentInput !== '0' && !isNaN(currentValue)) { 
                        calcCurrentInput = String(currentValue * -1);
                    }
                    break;
                case 'backspace':
                    if (calcCurrentInput === 'Error' || calcShouldResetDisplay) {
                        calcCurrentInput = '0';
                        calcShouldResetDisplay = false;
                    } else if (calcCurrentInput.length > 1) {
                        calcCurrentInput = calcCurrentInput.slice(0, -1);
                    } else {
                        calcCurrentInput = '0';
                    }
                    break;
                case 'clear':
                    clearCalculator();
                    return; // Skip further processing
            }
            updateCalcDisplay();
            if (func !== 'backspace' && func !== 'negate' && func !== 'clear') { 
                calcShouldResetDisplay = true;
            }
            calcMrcPressedOnce = false;
        }


        function toggleCalculator() {
            const isVisible = calculatorUI.classList.toggle('visible');
            calculatorToggleButton.classList.toggle('active', isVisible);
            if (isVisible) {
                clearCalculator(); 
            }
        }
        
        // Draggable Calculator Logic
        function makeDraggable(element, handle) {
            let currentX, currentY;

            handle.onmousedown = function(event) {
                event.preventDefault();
                isDraggingCalculator = true;
                calculatorUI.style.cursor = 'grabbing';

                // Get the initial mouse cursor position
                currentX = event.clientX;
                currentY = event.clientY;

                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            };

            function elementDrag(event) {
                event.preventDefault();
                if (!isDraggingCalculator) return;

                // Calculate the new cursor position
                const dx = currentX - event.clientX;
                const dy = currentY - event.clientY;
                currentX = event.clientX;
                currentY = event.clientY;

                // Set the element's new position
                let newTop = element.offsetTop - dy;
                let newLeft = element.offsetLeft - dx;

                // Constrain within app-container (optional, can be complex)
                const appRect = appContainer.getBoundingClientRect();
                const calcRect = element.getBoundingClientRect();
                
                // Simple boundary check (relative to viewport for now, as appContainer might scroll)
                // For more robust boundary, calculate relative to appContainer's scroll position
                if (newLeft < 0) newLeft = 0;
                if (newTop < 0) newTop = 0;
                if (newLeft + calcRect.width > window.innerWidth) newLeft = window.innerWidth - calcRect.width;
                if (newTop + calcRect.height > window.innerHeight) newTop = window.innerHeight - calcRect.height;


                element.style.top = newTop + "px";
                element.style.left = newLeft + "px";
            }

            function closeDragElement() {
                isDraggingCalculator = false;
                calculatorUI.style.cursor = 'grab';
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }


        // --- Event Listeners ---
        startButton.addEventListener('click', () => {
            console.log("Start button event listener triggered, calling window.startTest()");
            window.startTest();
        });

        nextButton.addEventListener('click', showNextQuestion);
        prevButton.addEventListener('click', showPrevQuestion);
        endPracticeSessionButton.addEventListener('click', endPracticeSessionAndShowResults);
        endPracticeSessionButtonFooter.addEventListener('click', handleEndPracticeSessionFooterClick);
        backToResultsButton.addEventListener('click', () => { isReviewingFromResults = false; showResultsScreen(); });
        navigatorButton.addEventListener('click', () => { 
            // Hide calculator if it's open
            if (calculatorUI.classList.contains('visible')) {
                toggleCalculator(); 
            }
            recordTimeSpent(currentQuestionIndex); 
            updateNavigatorButtons(); 
            navigatorModal.classList.remove('hidden'); 
            navigatorModal.classList.add('flex'); 
        });
        closeModalButton.addEventListener('click', () => { navigatorModal.classList.remove('flex'); navigatorModal.classList.add('hidden'); if (!isReviewingFromResults) questionStartTime = Date.now(); });
        navigatorModal.addEventListener('click', (event) => { if (event.target === navigatorModal) closeModalButton.click(); });
        flagButton.addEventListener('click', toggleFlag);
        filterFlaggedButton.addEventListener('click', () => { isFilteringFlagged = !isFilteringFlagged; showReviewScreen(isFilteringFlagged); });
        downloadPdfButton.addEventListener('click', generatePDF);
        document.getElementById('submit-performance-button').addEventListener('click', submitPerformanceData);

        calculatorToggleButton.addEventListener('click', toggleCalculator);
        closeCalculatorButton.addEventListener('click', toggleCalculator);
        makeDraggable(calculatorUI, calculatorDragHeader);

        // Add a direct event listener for the equals button to ensure it works
        const equalsButton = document.querySelector('.calc-button.equals');
        if (equalsButton) {
            equalsButton.addEventListener('click', function(e) {
                console.log('Equals button clicked directly');
                calculate();
            });
        }

        // Add direct event listeners for all calculator buttons to ensure they work
        calcButtons.forEach(button => {
            button.addEventListener('click', function() {
                const value = button.dataset.calcValue;
                const action = button.dataset.calcAction;
                console.log('Calculator button clicked:', button.textContent, 'Value:', value, 'Action:', action);
                
                if (value !== undefined) { 
                    if (value === '.') { inputDecimal(); } 
                    else { inputDigit(value); }
                } else if (action) { 
                    if (['+', '-', '*', '/'].includes(action)) { handleOperator(action); } 
                    else if (action === 'equals') { 
                        console.log('Equals action triggered');
                        calculate(); 
                    } 
                    else if (action === 'clear') { clearCalculator(); } 
                    else if (['m+', 'm-', 'mrc'].includes(action)) { handleMemory(action); } 
                    else if (['sqrt', 'percent', 'negate', 'backspace'].includes(action)) { handleSpecialFunction(action); }
                }
            });
        });

        function handleKeyboardShortcuts(e) {
             const isPracticeSessionVisible = !practiceSessionScreen.classList.contains('hidden');
             const isModalVisible = navigatorModal.classList.contains('flex');
             const isInputFocused = document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA');
             const isCalcVisible = calculatorUI.classList.contains('visible');

             if (isCalcVisible && !isInputFocused) { 
                if (e.key >= '0' && e.key <= '9') { e.preventDefault(); inputDigit(e.key); return; }
                if (e.key === '.') { e.preventDefault(); inputDecimal(); return; }
                if (e.key === '+' || e.key === '-' || e.key === '*' || e.key === '/') { e.preventDefault(); handleOperator(e.key); return; }
                if (e.key === 'Enter' || e.key === '=') { e.preventDefault(); calculate(); return; }
                if (e.key === 'Backspace') { e.preventDefault(); handleSpecialFunction('backspace'); return; }
                if (e.key === 'Escape') { e.preventDefault(); toggleCalculator(); return; } 
                if (e.key.toLowerCase() === 'p') { // M+ in UCAT calc is often just '+' or a dedicated M+ key
                    e.preventDefault(); 
                    // Check if the 'm+' button exists and click it
                    const mPlusButton = document.querySelector('.calc-button[data-calc-action=\"m+\"]');
                    if (mPlusButton) mPlusButton.click();
                    return; 
                }
                if (e.key.toLowerCase() === 'm') { // M- in UCAT calc
                    e.preventDefault(); 
                    const mMinusButton = document.querySelector('.calc-button[data-calc-action=\"m-\"]');
                    if (mMinusButton) mMinusButton.click();
                    return; 
                }
                if (e.key.toLowerCase() === 'r' && !e.altKey && !e.metaKey && !e.ctrlKey) { // MRC in UCAT calc. Changed 'c' to 'r' to avoid conflict with Alt+C for calculator.
                    e.preventDefault(); 
                    const mrcButton = document.querySelector('.calc-button[data-calc-action=\"mrc\"]');
                    if (mrcButton) mrcButton.click();
                    return; 
                } 
                 // Removed 'x' for sqrt as UCAT calc doesn't typically use 'x' for sqrt
             }
             
             if (isModalVisible || isInputFocused) return; 
             if (!isPracticeSessionVisible) return; 
             
             const key = e.key.toLowerCase();
             const altOrOption = e.altKey || e.metaKey; 
             const code = e.code.toLowerCase(); 

             if (altOrOption) {
                 switch (code) { 
                     case 'keyn': e.preventDefault(); if (!nextButton.disabled) nextButton.click(); return;
                     case 'keyp': e.preventDefault(); if (!prevButton.disabled) prevButton.click(); return;
                     case 'keyf': e.preventDefault(); if (!isReviewingFromResults && !flagButton.disabled) flagButton.click(); return;
                     case 'keyc': e.preventDefault(); toggleCalculator(); return; 
                     default: return; 
                 }
             } else { 
                 // Check if current question is MCQ
                 const statementsForPassage = questionsByPassage[currentQuestionIndex];
                 const isMCQ = statementsForPassage && statementsForPassage.length === 1 && statementsForPassage[0].type === 'mcq';
                 
                 if (isMCQ && ['a', 'b', 'c', 'd'].includes(key) && !isReviewingFromResults && !isCalcVisible) {
                     e.preventDefault();
                     const optionIndex = ['a', 'b', 'c', 'd'].indexOf(key);
                     const optionValue = ['A', 'B', 'C', 'D'][optionIndex];
                     const mcqData = statementsForPassage[0];
                     if (optionIndex < mcqData.options.length) {
                         handleMCQSelect(currentQuestionIndex, optionIndex, optionValue);
                     }
                     return;
                 } else if (!isMCQ && ['y', 'n'].includes(key) && !isReviewingFromResults && !isCalcVisible) {
                    e.preventDefault();
                    const selectedRow = document.querySelector('.statement-row.selected');
                    if (selectedRow) {
                        const buttonToClick = key === 'y' ? document.getElementById('yes-button') : document.getElementById('no-button');
                        if (buttonToClick) buttonToClick.click();
                    }
                 }
                 return;
             }
        }
        document.addEventListener('keydown', handleKeyboardShortcuts);

        // --- Initial Load ---
        // Only initialize the setup screen if we're not in review mode
        if (!urlParams.has('review')) {
            showSetupScreen();
        }

        updateCalcDisplay(); 

        // Update the review grid button click handler to not restart the timer
        reviewGrid.addEventListener('click', (e) => {
            if (e.target.classList.contains('review-grid-button')) {
                reviewScreen.classList.add('hidden');
                reviewScreen.classList.remove('flex');
                showPracticeSessionScreen();
                const index = parseInt(e.target.dataset.questionIndex);
                if (!isNaN(index) && index >= 0 && index < questions.length) {
                    // Hide calculator if it's open
                    if (calculatorUI.classList.contains('visible')) {
                        toggleCalculator();
                    }
                    loadQuestion(index);
                    updateTimerVisibility();
                }
            }
        });

        // Add keyboard event listeners for Enter key on the appropriate pages
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !event.ctrlKey && !event.shiftKey && !event.altKey && !event.metaKey) {
                const isInputOrTextareaFocused = document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA';
                
                // Only handle Enter key if no input or textarea is focused
                if (!isInputOrTextareaFocused) {
                    // Check which screen is active
                    if (!setupScreen.classList.contains('hidden')) {
                        // Begin test button on setup screen
                        startButton.click();
                        event.preventDefault();
                    } else if (!reviewScreen.classList.contains('hidden')) {
                        // End practice session button on review screen
                        endPracticeSessionButton.click();
                        event.preventDefault();
                    }
                }
            }
        });

        // Make sure the submit button has the right event listener
        const submitPerformanceBtn = document.getElementById('submit-performance-button');
        if (submitPerformanceBtn) {
            // Remove any existing listeners (just in case)
            submitPerformanceBtn.removeEventListener('click', submitPerformanceData);
            // Add the listener
            submitPerformanceBtn.addEventListener('click', submitPerformanceData);
        }

        // Function to handle loading a past test for review
        function loadPastTestForReview(resultId) {
            setupScreen.classList.add('hidden');
            
            // Show a loading indicator
            const loadingEl = document.createElement('div');
            loadingEl.className = 'fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center z-50';
            loadingEl.innerHTML = `
                <div class="text-center p-6 bg-white shadow-xl rounded-lg">
                    <div class="spinner mx-auto mb-4"></div>
                    <p class="text-gray-700 font-medium">Loading your test results...</p>
                </div>
            `;
            document.body.appendChild(loadingEl);
            
            // Fetch the result from Firestore
            db.collection("performanceSubmissions").doc(resultId)
                .get()
                .then((doc) => {
                    if (!doc.exists) {
                        alert("The requested test result could not be found.");
                        window.location.href = "student_dashboard.html";
                        return;
                    }
                    
                    const resultData = doc.data();
                    
                    // Store the data in the appropriate variables
                    userName = resultData.studentName || '';
                    userGoal = resultData.goal || '';
                    userFocusArea = resultData.focusArea || '';
                    userAnswers = resultData.answers || new Array(questions.length).fill(null);
                    questionTimes = resultData.questionTimes || new Array(questions.length).fill(0);
                    flaggedQuestions = resultData.flaggedQuestions || new Array(questions.length).fill(false);
                    practiceSessionStartTime = new Date(resultData.submissionTimestamp || Date.now());
                    practiceSessionEndTime = new Date(practiceSessionStartTime.getTime() + 26 * 60 * 1000); // Estimate end time
                    isReviewingFromResults = true;
                    
                    // Remove loading indicator
                    document.body.removeChild(loadingEl);
                    
                    // Show the results screen with the data
                    showResultsScreen();
                    
                    // Add a "Return to Results" button to the header
                    const headerBar = document.querySelector('.header-bar');
                    if (headerBar) {
                        const returnButtonContainer = document.createElement('div');
                        returnButtonContainer.className = 'absolute left-4';
                        returnButtonContainer.innerHTML = `
                            <button id="return-to-dashboard-results" class="bg-blue-500 text-white px-3 py-1 rounded text-sm flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                                </svg>
                                Return to Results
                            </button>
                        `;
                        headerBar.style.position = 'relative';
                        headerBar.appendChild(returnButtonContainer);
                        
                        // Add event listener to the return button
                        document.getElementById('return-to-dashboard-results').addEventListener('click', () => {
                            window.location.href = "student_dashboard.html";
                        });
                    }
                })
                .catch((error) => {
                    console.error("Error loading test result:", error);
                    alert("There was an error loading the test result. Please try again.");
                    window.location.href = "student_dashboard.html";
                });
        }
        
        // Add a direct click event listener to the Start button to ensure it works
        document.getElementById('start-button').addEventListener('click', function() {
            console.log("Start button clicked via direct listener");
            // Get user info from Firebase Auth if available
            if (firebase.auth && firebase.auth().currentUser) {
                const currentUser = firebase.auth().currentUser;
                userName = currentUser.displayName || currentUser.email || '';
                // Store email to be used later in submission
                userEmail = currentUser.email || '';
                console.log("Using user info from Firebase:", userName, userEmail);
            } else {
                userName = '';
                userEmail = '';
                console.log("No user logged in - using empty user info");
            }
            
            userGoal = goalInput.value.trim();
            userFocusArea = focusAreaInput.value.trim();
            timeLeft = 9 * 60; // 9 minutes for 8 questions
            userAnswers = new Array(passageTexts.length).fill(null).map(() => new Array(5).fill(null));
            questionTimes = new Array(passageTexts.length).fill(0);
            flaggedQuestions = new Array(passageTexts.length).fill(false);
            questionStartTime = null;
            currentQuestionIndex = 0;
            isReviewingFromResults = false;
            isFilteringFlagged = false;
            // currentlyDisplayedPassageIndex = -1; // No longer needed with this structure
            practiceSessionEndTime = null;
            showPracticeSessionScreen();
            startTimer();
            loadQuestion(0);
            populateNavigator();
        });
        
        // Function to initialize the application - moved to the end to ensure all functions are defined
        function initializeApp() {
            // Initialize arrays with passageTexts.length
            userAnswers = new Array(passageTexts.length).fill(null).map(() => new Array(5).fill(null));
            questionTimes = new Array(passageTexts.length).fill(0);
            flaggedQuestions = new Array(passageTexts.length).fill(false);
            
            // Check for review mode and initialize appropriate screen
            if (reviewParam) {
                // We're in review mode - load the past test data
                loadPastTestForReview(reviewParam);
            } else {
                // Regular test mode - continue with normal setup
                showSetupScreen();
            }
        }
        
        // Actually initialize the app now that all functions and DOM elements are defined
        initializeApp();

        // Initialize drag and drop functionality (Copied from DM sylls 1.html and adapted)
        function initDragAndDrop() {
            const yesButton = document.getElementById('yes-button');
            const noButton = document.getElementById('no-button');
            const statementRows = document.querySelectorAll('.statement-row'); // These are the droppable targets
            
            if (!yesButton || !noButton) return;
            
            let draggedValue = null; // Will be "Yes" or "No"
            
            [yesButton, noButton].forEach(button => {
                button.setAttribute('draggable', true);
                
                button.addEventListener('dragstart', function(e) {
                    draggedValue = this.textContent; // "Yes" or "No"
                    e.dataTransfer.setData('text/plain', draggedValue);
                    this.classList.add('opacity-50');
                });
                
                button.addEventListener('dragend', function() {
                    this.classList.remove('opacity-50');
                });
                
                // Click functionality as an alternative
                button.addEventListener('click', function() {
                    const selectedRow = document.querySelector('.statement-row.selected');
                    if (selectedRow) {
                        const statementIndex = parseInt(selectedRow.dataset.statementIndex);
                        const answerBox = selectedRow.querySelector('.statement-answer-box');
                        
                        answerBox.textContent = this.textContent; // "Yes" or "No"
                        selectedRow.classList.remove('selected', 'border-blue-500', 'bg-blue-50');
                        
                        if (!userAnswers[currentQuestionIndex]) { // currentQuestionIndex is passage index
                            userAnswers[currentQuestionIndex] = new Array(5).fill(null);
                        }
                        userAnswers[currentQuestionIndex][statementIndex] = (this.textContent === "Yes" ? "Y" : "N");
                        updateNavigatorButtons(); // Update based on passage completion
                    }
                });
            });
            
            statementRows.forEach(row => {
                // Click to select a row (for click-based Yes/No selection)
                row.addEventListener('click', function() {
                    document.querySelectorAll('.statement-row.selected').forEach(el => {
                        el.classList.remove('selected', 'border-blue-500', 'bg-blue-50');
                    });
                    this.classList.add('selected', 'border-blue-500', 'bg-blue-50');
                });

                row.addEventListener('dragover', function(e) {
                    e.preventDefault(); // Necessary to allow dropping
                    this.classList.add('border-blue-500', 'bg-blue-50'); // Highlight on hover
                });
                
                row.addEventListener('dragleave', function() {
                    if (!this.classList.contains('selected')) { // Don't remove if it's the selected row for clicking
                        this.classList.remove('border-blue-500', 'bg-blue-50');
                    }
                });
                
                row.addEventListener('drop', function(e) {
                    e.preventDefault();
                    if (!this.classList.contains('selected')) {
                         this.classList.remove('border-blue-500', 'bg-blue-50');
                    }
                    
                    const value = e.dataTransfer.getData('text/plain'); // "Yes" or "No"
                    const answerBox = this.querySelector('.statement-answer-box');
                    answerBox.textContent = value;
                    
                    const statementIndex = parseInt(this.dataset.statementIndex);
                    if (!userAnswers[currentQuestionIndex]) { // currentQuestionIndex is passage index
                        userAnswers[currentQuestionIndex] = new Array(5).fill(null);
                    }
                    userAnswers[currentQuestionIndex][statementIndex] = (value === "Yes" ? "Y" : "N");
                    updateNavigatorButtons(); // Update based on passage completion
                });
            });
        }

    }); // Closing bracket for DOMContentLoaded
    </script>
</body>
</html>