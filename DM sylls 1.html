<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UCAT DM Practice - MedwithPurpose</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        /* Custom styles for better UI/UX */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent scrolling on body */
        }
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f0f2f5; /* Light background */
        }
        #app-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 2rem); /* Full height minus padding */
            width: 100%;
            max-width: 1200px; /* Optional: Max width for larger screens */
            background-color: #ffffff;
            border: 1px solid #d1d5db; /* Border */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-radius: 0.375rem; /* Slightly rounded corners */
            margin: 1rem; /* Add some margin */
            overflow: hidden; /* Prevent content overflow from container */
            position: relative; /* For calculator positioning */
        }
        /* Header and Footer */
        .header-bar, .footer-bar {
            flex-shrink: 0; /* Prevent shrinking */
            background-color: #005A8C; /* Slightly darker blue for top bar */
            color: white; /* Set default text color to white */
            padding: 0.75rem 1.5rem; /* Padding */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Secondary toolbar styling */
        .secondary-toolbar {
            flex-shrink: 0;
            background-color: #007BBD;
            color: white;
            padding: 0.5rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #005A8C;
            z-index: 19;
        }

        /* Buttons in secondary toolbar */
        .secondary-toolbar-button {
            background-color: transparent;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.6);
            padding: 0.3rem 0.7rem;
            font-size: 0.8rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s ease, border-color 0.2s ease;
            margin-left: 0.5rem; /* Spacing between buttons */
        }
        .secondary-toolbar-button:hover:not(:disabled) {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: white;
        }
        .secondary-toolbar-button.active { /* For calculator button when active */
            background-color: rgba(255, 255, 255, 0.2);
            border-color: white;
        }

        /* Specific text colors within header/footer */
        .header-bar span, .header-bar div {
             color: white;
        }

        /* Footer Button Styling */
        .footer-bar button {
            background-color: transparent;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.5); /* Subtle white border */
            padding: 0.4rem 0.8rem; /* Adjust padding */
            font-size: 0.8rem; /* Adjust font size */
            border-radius: 0.375rem;
             transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        .footer-bar button:hover:not(:disabled) {
            background-color: rgba(255, 255, 255, 0.15); /* Slight white background on hover */
            border-color: white;
        }
         .footer-bar button:disabled {
             opacity: 0.5;
             cursor: not-allowed;
             border-color: rgba(255, 255, 255, 0.3);
         }
         /* Keep primary button distinct */
         .footer-bar button#next-button {
             background-color: #ffffff; /* White background */
             color: #006DAA; /* Blue text */
             border: 1px solid white;
             font-weight: 500;
         }
         .footer-bar button#next-button:hover:not(:disabled) {
             background-color: #f0f0f0; /* Slightly off-white on hover */
         }
         /* Flag button specific style */
         #flag-button {
             background-color: transparent;
             border: 1px solid white;
             color: white;
             transition: background-color 0.2s ease, color 0.2s ease; /* Add transition */
         }
         #flag-button:hover {
             background-color: white;
             color: #006DAA;
         }
         /* Style for when a question IS flagged */
          #flag-button.flagged {
             background-color: #facc15; /* Yellow-400 */
             border-color: #facc15;
             color: #422006; /* Dark brown text for contrast */
          }
          #flag-button.flagged:hover {
             background-color: #f59e0b; /* Amber-500 */
             border-color: #f59e0b;
          }

        /* Main Content Area - Single Column Layout */
        .main-content-area {
            flex-grow: 1; /* Take remaining vertical space */
            display: flex;
            flex-direction: column; /* Stack premises and questions */
            overflow-y: auto; /* Allow scrolling for the whole area */
            padding: 1rem 1.5rem; /* Padding */
        }

        /* Premises Section */
        .premises-section {
            margin-bottom: 1.5rem; /* Space below premises */
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            background-color: #f9fafb;
            flex-shrink: 0; /* Prevent premises from shrinking too much */
        }
        .premises-section h3 {
            margin-bottom: 0.5rem;
        }

        /* Statements Section Wrapper (NEW) */
        .statements-wrapper {
            flex-grow: 1; /* Allow this section to take remaining space */
            display: flex; /* Use flexbox for side-by-side layout */
            gap: 1.5rem; /* Gap between statements and draggable options */
            overflow: hidden; /* Prevent internal overflow issues */
        }


        /* Statements Section (List on the Left) */
        .statements-section {
             flex-grow: 1; /* Allow statements list to take available space */
             display: flex;
             flex-direction: column;
             overflow-y: auto; /* Allow scrolling only for statements list */
             padding-right: 0.5rem; /* Padding before options */
        }
        .statements-section h4 {
            margin-bottom: 0.25rem;
             position: sticky; /* Make header sticky */
             top: 0;
             background-color: white; /* Background to cover scrolling content */
             z-index: 10;
             padding-bottom: 0.25rem;
        }
        .statements-section p.instructions {
             margin-bottom: 1rem;
             position: sticky;
             top: 2rem; /* Adjust based on h4 height */
             background-color: white;
             z-index: 10;
             padding-bottom: 0.5rem;
        }

        /* Styling for individual statement rows */
        .statement-row {
            display: flex;
            align-items: center; /* Vertically align items */
            gap: 1rem; /* Space between text and answer box */
            margin-bottom: 0.75rem;
            padding: 0.5rem;
            border-radius: 0.375rem;
            background-color: #ffffff;
            border: 1px solid #d1d5db;
            transition: border-color 0.2s ease, background-color 0.2s ease; /* Add transition */
        }

        /* Style when dragging over the statement row */
        .statement-row.drag-over {
            border-color: #3b82f6; /* Solid blue border */
            background-color: #eff6ff; /* Lighter blue background */
        }

        /* Styling for statement text */
        .statement-text {
            flex-grow: 1; /* Take available space */
            font-size: 0.9rem;
            color: #374151;
            padding: 0.25rem; /* Add slight padding */
            pointer-events: none; /* Prevent text from interfering with drop */
        }

        /* Styling for the answer box (visual indicator within the row) */
        .statement-answer-box {
            flex-shrink: 0; /* Prevent shrinking */
            width: 6rem; /* Wider box */
            height: 2.5rem; /* Taller box */
            border: 2px solid transparent; /* Initially transparent border */
            border-radius: 0.375rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            color: #6b7280; /* Default text color */
            background-color: #f3f4f6; /* Light grey background */
            transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
            pointer-events: none; /* Prevent box from interfering with row drop */
        }

        /* Style for answered boxes */
        .statement-answer-box.answered-yes {
            background-color: #dcfce7; /* Green-100 */
            border: 2px solid #22c55e; /* Green-500 */
            color: #15803d; /* Green-700 */
        }
        .statement-answer-box.answered-no {
            background-color: #fee2e2; /* Red-100 */
            border: 2px solid #ef4444; /* Red-500 */
            color: #b91c1c; /* Red-700 */
        }

        /* Styling for the draggable Yes/No options sidebar (NEW) */
        #draggable-options-sidebar {
            flex-shrink: 0; /* Prevent shrinking */
            width: 8rem; /* Fixed width for the sidebar */
            padding-top: 4rem; /* Align roughly with start of statements */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem; /* Space between Yes and No */
        }

        /* Styling for draggable Yes/No elements */
        .draggable-option {
            padding: 0.6rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: grab; /* Indicate draggable */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.1s ease;
            text-align: center;
            width: 80%; /* Make buttons fill sidebar width */
        }
        .draggable-option:active {
             cursor: grabbing;
             transform: scale(0.95);
        }
        .draggable-option-yes {
            background-color: #86efac; /* Green-300 */
            border: 1px solid #22c55e; /* Green-500 */
            color: #14532d; /* Green-900 */
        }
        .draggable-option-no {
            background-color: #fca5a5; /* Red-300 */
            border: 1px solid #ef4444; /* Red-500 */
            color: #7f1d1d; /* Red-900 */
        }

        /* Style for navigator buttons */
        .nav-answered { background-color: #a7f3d0; }
        .nav-current { border: 2px solid #3b82f6 !important; font-weight: bold; }
        .nav-flagged, .review-flagged { border: 2px solid #f59e0b !important; position: relative; }

        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 0.5rem; }
        .modal.flex { display: flex; }

        /* General Button Styling (outside footer) */
        button, .button {
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            border-radius: 0.375rem;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            cursor: pointer;
        }
        button:active, .button:active { transform: scale(0.98); }
        button:disabled { opacity: 0.6; cursor: not-allowed; }

        .primary-button { background-color: #3b82f6; color: white; border: 1px solid transparent; }
        .primary-button:hover:not(:disabled) { background-color: #2563eb; }
        .secondary-button { background-color: white; color: #374151; border: 1px solid #d1d5db; }
        .secondary-button:hover:not(:disabled) { background-color: #f9fafb; }
        .danger-button { background-color: #ef4444; color: white; border: 1px solid transparent; }
        .danger-button:hover:not(:disabled) { background-color: #dc2626; }
        .subtle-button { background-color: #f3f4f6; color: #374151; border: 1px solid transparent; }
        .subtle-button:hover:not(:disabled) { background-color: #e5e7eb; }

        /* --- Result Styling --- */
       .correct-answer { background-color: #dcfce7; border-left: 4px solid #22c55e; }
       .partially-correct-answer { background-color: #fef9c3; border-left: 4px solid #eab308; }
       .incorrect-answer { background-color: #fee2e2; border-left: 4px solid #ef4444; }
       .result-item-clickable { cursor: pointer; transition: background-color 0.2s ease-in-out; border: 1px solid #e5e7eb; border-radius: 0.5rem; margin-bottom: 0.5rem; padding: 0.75rem; }
       .result-item-clickable:hover { background-color: #f0f0f0; }
       .correct-indicator-text { color: #16a34a; font-weight: 600;}
       .incorrect-indicator-text { color: #dc2626; font-weight: 600;}
       .result-statement { font-size: 0.8rem; margin-left: 1rem; margin-bottom: 0.25rem; padding-left: 0.5rem; border-left: 2px solid #e5e7eb; }
       .result-statement.correct { border-left-color: #22c55e; }
       .result-statement.incorrect { border-left-color: #ef4444; }
       /* --- END Result Styling --- */

        /* --- Results Overview Grid (New) --- */
        #results-overview-grid {
            /* Styles for the grid container itself are in Tailwind classes */
        }
        .result-summary-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            background-color: #fff;
            border: 1px solid #e5e7eb; /* Tailwind gray-200 */
            border-radius: 0.5rem; /* Tailwind rounded-lg */
            padding: 0.75rem; /* Tailwind p-3 */
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); /* Subtle shadow */
            cursor: pointer;
        }
        .result-summary-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .result-summary-item.flagged-result {
            border-left-width: 4px;
            border-left-color: #f59e0b; /* Tailwind amber-500 */
        }
        .result-summary-points {
            font-size: 1.125rem; /* Tailwind text-lg */
            font-weight: 600; /* Tailwind font-semibold */
            margin-bottom: 0.25rem;
        }
        .result-summary-points.correct-2pts { color: #16a34a; } /* Tailwind green-600 */
        .result-summary-points.correct-1pt { color: #ca8a04; } /* Tailwind yellow-600 */
        .result-summary-points.incorrect-0pts { color: #dc2626; } /* Tailwind red-600 */
        
        .result-summary-qnum {
            font-size: 0.875rem; /* Tailwind text-sm */
            color: #4b5563; /* Tailwind gray-600 */
            margin-bottom: 0.5rem;
        }
        .result-summary-statements {
            font-size: 0.75rem; /* Tailwind text-xs */
            color: #6b7280; /* Tailwind gray-500 */
            line-height: 1.2;
        }
         /* Tooltip for statement summary on hover (simple version) */
        .result-summary-item .tooltip-text {
            visibility: hidden;
            width: 180px;
            background-color: #374151; /* Tailwind gray-700 */
            color: #fff;
            text-align: left;
            padding: 8px;
            border-radius: 6px;
            position: absolute;
            z-index: 1;
            bottom: 110%; /* Position above the item */
            left: 50%;
            margin-left: -90px; /* Use half of the width to center */
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 0.75rem;
            line-height: 1.3;
        }
        .result-summary-item:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        .result-summary-item .tooltip-text::after { /* Arrow */
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #374151 transparent transparent transparent;
        }
        /* --- END Results Overview Grid --- */

        /* Style for explanation box */
        .explanation-box { background-color: #fef3c7; border: 1px solid #fcd34d; padding: 0.75rem; margin-top: 1rem; border-radius: 0.375rem; font-size: 0.875rem; color: #78350f; }

        /* Review Grid Button Styles */
        .review-grid-button { padding: 0.5rem 0.25rem; border: 1px solid #d1d5db; border-radius: 0.375rem; text-align: center; transition: background-color 0.2s ease, border-color 0.2s ease; font-size: 0.875rem; line-height: 1.25rem; cursor: pointer; }
        .review-grid-button-answered { background-color: #dcfce7; border-color: #86efac; color: #15803d; }
        .review-grid-button-unanswered { background-color: #f3f4f6; border-color: #d1d5db; color: #4b5563; }
         .review-grid-button:hover { filter: brightness(95%); }

        /* Calculator Styles */
        #calculator-ui {
            display: none; 
            position: absolute;
            top: 100px; 
            left: 50%;
            width: 225px; 
            background-color: #007BBD; 
            border: 2px solid #005A8C; 
            border-radius: 8px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
            padding: 12px; 
            z-index: 1000; 
            cursor: grab; 
        }
        #calculator-ui.visible { display: block; }
        .calculator-header {
            display: flex; justify-content: space-between; align-items: center;
            color: white; margin-bottom: 8px; font-size: 0.8rem; padding: 0 3px;
        }
        .calculator-header .title { font-weight: 600; }
        .calculator-header .close-calc-btn {
            background: none; border: none; color: white; font-size: 1.1rem; cursor: pointer;
        }
        .calculator-decorative-text {
            color: rgba(255, 255, 255, 0.7); 
            font-size: 0.6rem;
            text-align: center;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        #calc-display-container {
            background-color: #E2E8F0; border: 2px inset #A0AEC0; 
            border-radius: 4px; padding: 4px 6px; 
            margin-bottom: 12px; text-align: right; min-height: 36px; 
            display: flex; align-items: center; justify-content: flex-end;
            position: relative; /* For memory indicator */
        }
        #calc-memory-indicator {
            position: absolute;
            left: 6px;
            top: 50%;
            transform: translateY(-50%);
            color: #4A5568; /* Darker color for M */
            font-weight: bold;
            font-size: 0.9rem; /* Slightly smaller M */
            display: none; /* Hidden by default */
        }
        #calc-display {
            font-family: 'Courier New', Courier, monospace; font-size: 1.6rem; 
            color: #2D3748; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 100%;
        }
        .calc-buttons-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px; 
        }
        .calc-button {
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 4px;
            padding: 10px 0; 
            font-size: 0.9rem; 
            font-weight: 500; cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            display: flex; align-items: center; justify-content: center;
        }
        .calc-button:active { transform: scale(0.95); }

        .calc-button-num {
            background-color: #FFFFFF; 
            color: #1A202C; 
        }
        .calc-button-num:hover { background-color: #F7FAFC; }

        .calc-button-red {
            background-color: #C53030; 
            color: white;
            border-color: #9B2C2C; 
        }
        .calc-button-red:hover { background-color: #E53E3E; }
        
        .calc-button.equals { 
            grid-row: span 2; /* Make equals button span two rows */
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            #app-container { height: auto; margin: 0.5rem; }
            .main-content-area { padding: 0.75rem; }
            .premises-section { padding: 0.75rem; }
            .statements-wrapper { flex-direction: column; gap: 1rem; } /* Stack statements and options */
            .statements-section { padding-right: 0; overflow-y: visible; } /* Remove padding, disable scroll */
            #draggable-options-sidebar {
                width: 100%;
                padding-top: 0;
                flex-direction: row; /* Options side-by-side */
                justify-content: space-around; /* Space out options */
                padding: 0.75rem 0;
                border-top: 1px solid #e5e7eb; /* Add separator */
            }
            .draggable-option { width: 40%; padding: 0.5rem 1rem; font-size: 0.85rem;}

            .statement-row { gap: 0.5rem; padding: 0.4rem; }
            .statement-text { font-size: 0.85rem; }
            .statement-answer-box { width: 5rem; height: 2.2rem; font-size: 0.8rem; }

            .header-bar, .footer-bar, .secondary-toolbar { padding: 0.5rem 1rem; }
            .header-bar span, .footer-bar button, .secondary-toolbar-button { font-size: 0.8rem; }
            button, .button { padding: 0.4rem 0.8rem; }
            .footer-bar button { padding: 0.3rem 0.6rem; font-size: 0.75rem; }
            .grid-cols-5 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
            #review-grid { grid-template-columns: repeat(5, minmax(0, 1fr)); }
            .review-grid-button { font-size: 0.8rem; }
            #calculator-ui { width: 210px; top: 90px; padding: 10px;} 
            .calc-button { padding: 8px 0; font-size: 0.8rem;}
            #calc-display { font-size: 1.4rem; }
        }
         @media (max-width: 480px) {
             .main-content-area { padding: 0.5rem; }
             .grid-cols-5 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
             #review-grid { grid-template-columns: repeat(4, minmax(0, 1fr)); }
             .header-bar span, .footer-bar button, .secondary-toolbar-button { font-size: 0.75rem; }
             button, .button { padding: 0.3rem 0.6rem; }
             .footer-bar button { padding: 0.25rem 0.5rem; font-size: 0.7rem; }
             .statement-row { flex-direction: column; align-items: stretch; gap: 0.4rem; } /* Stack text and box */
             .statement-answer-box { width: auto; } /* Full width */
             #draggable-options-sidebar { gap: 0.5rem; }
             .draggable-option { width: 45%; padding: 0.4rem 0.8rem; font-size: 0.8rem; }
             .review-grid-button { font-size: 0.75rem; }
             #calculator-ui { width: 90%; max-width: 200px; top: 85px; padding: 8px; } 
             .calc-button { padding: 7px 0; font-size: 0.75rem;}
             #calc-display { font-size: 1.3rem; }
         }

    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    </head>
<body>

    <div id="app-container">

        <div id="setup-screen" class="p-6 md:p-8 flex flex-col justify-center items-center h-full">
             <div class="text-center mb-6">
                 <img src="https://ik.imagekit.io/mwp/MWP%20Color%20no%20background.png?updatedAt=1745982959141"
                      alt="MedwithPurpose Logo"
                      class="mx-auto h-20 w-auto mb-4"
                      onerror="this.style.display='none'; this.onerror=null;">
                 <h1 class="text-2xl md:text-3xl font-bold text-blue-600">UCAT Decision Making Practice</h1>
                 <p class="text-gray-600 mt-2">Practice the UCAT Decision Making section.</p>
                  <p class="text-sm text-gray-500 mt-4">
                       This section contains <strong id="setup-question-count">5 questions</strong>, each with 5 statements. Maximum score is <strong id="setup-max-score">10 points</strong>.
                  </p>
             </div>
             <div class="space-y-4 w-full max-w-md">
                 <div>
                     <label for="goal" class="block text-sm font-medium text-gray-700">Goal (Score out of 10):</label>
                     <input type="number" id="goal" name="goal" min="0" max="10" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="e.g., 8">
                 </div>
                 <div>
                     <label for="focus-area" class="block text-sm font-medium text-gray-700">Area of Focus / Intention For Practice:</label>
                     <input type="text" id="focus-area" name="focus-area" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="e.g., Syllogisms, Logic Puzzles">
                 </div>
             </div>
             <div class="mt-8 text-center">
                 <button id="start-button" class="primary-button text-lg px-8 py-3">
                     Start Practice
                 </button>
                 <button onclick="window.location.href = 'student_dashboard.html';" class="secondary-button text-md px-6 py-2 mt-4">
                     Return to Dashboard
                 </button>
             </div>
        </div>

        <div id="exam-screen" class="hidden flex flex-col h-full">
            <div class="header-bar">
                <span id="exam-title" class="font-semibold">Decision Making</span>
                <div class="flex items-center space-x-4">
                     <div id="timer" class="font-semibold">06:00</div>
                     <span class="text-sm">Question <span id="question-number-info">1</span> of 5</span>
                </div>
            </div>
            <div class="secondary-toolbar">
                <div> 
                    <button id="calculator-toggle-button" class="secondary-toolbar-button">Calculator (Alt+C)</button>
                </div>
                <div> 
                    <button id="flag-button" class="secondary-toolbar-button">Flag for Review</button>
                </div>
            </div>

            <div class="main-content-area">
                <div class="premises-section">
                    <h3 class="text-lg font-semibold">Premises</h3>
                    <div id="premises-text" class="text-sm text-gray-700 leading-relaxed whitespace-pre-wrap">
                        </div>
                </div>

                <div class="statements-wrapper">
                    <div class="statements-section">
                        <h4 class="text-md font-semibold">Statements (Question <span id="question-number">1</span>)</h4>
                        <p class="text-xs text-gray-500 instructions">Drag 'Yes' or 'No' onto the statement row.</p>
                        <div id="statements-list">
                            </div>
                    </div> <div id="draggable-options-sidebar">
                        <div id="draggable-yes" class="draggable-option draggable-option-yes" draggable="true">Yes</div>
                        <div id="draggable-no" class="draggable-option draggable-option-no" draggable="true">No</div>
                     </div>
                </div> <div id="review-explanation-container" class="mt-4"></div>

            </div> <div class="footer-bar">
                 <button id="back-to-results-button" class="hidden mr-auto">← Back to Results</button>
                 <button id="end-exam-button-footer">End Practice</button>
                 <div class="flex items-center space-x-2 ml-auto">
                     <button id="prev-button" disabled>← Previous (Alt+P)</button>
                     <button id="navigator-button">Navigator</button>
                     <button id="next-button">Next (Alt+N) →</button>
                 </div>
            </div>
        </div>

        <div id="review-screen" class="hidden p-6 md:p-8 flex flex-col items-center h-full overflow-y-auto">
             <div class="w-full max-w-3xl mb-4 flex justify-between items-center">
                 <h2 class="text-2xl font-bold text-blue-600">Review Your Answers</h2>
                 <button id="filter-flagged-button" class="secondary-button text-sm">Show Flagged Only</button>
             </div>
             <p class="text-center text-gray-600 mb-6">Click on a question number to review it. Green indicates answered, Yellow border indicates flagged.</p>
            <div id="review-grid" class="grid grid-cols-5 gap-3 mb-6 w-full max-w-xl"> </div>
            <div class="mt-auto pt-6">
                <button id="end-exam-button" class="danger-button text-lg px-8 py-3">
                    End Practice & See Results
                </button>
            </div>
        </div>

        <div id="results-screen" class="hidden p-6 md:p-8 flex flex-col h-full">
             <div class="text-center mb-6 flex-shrink-0">
                 <img src="https://ik.imagekit.io/mwp/MWP%20Color%20no%20background.png?updatedAt=1745982959141"
                      alt="MedwithPurpose Logo"
                      class="mx-auto h-16 w-auto mb-4"
                      onerror="this.style.display='none'; this.onerror=null;">
                  <h2 class="text-2xl md:text-3xl font-bold text-blue-600">Practice Results</h2>
             </div>
            <div class="bg-blue-50 p-4 rounded-lg mb-6 text-center flex-shrink-0">
                 <p class="text-lg font-semibold">Your Score: <span id="score" class="text-blue-700">0</span> / <span id="total-score-possible">10</span> Points</p>
                 <p class="text-gray-600">Time Taken: <span id="time-taken">N/A</span></p>
            </div>

            <h3 class="text-xl font-semibold mb-1 text-center flex-shrink-0">Detailed Results Overview</h3>
            <p class="text-sm text-gray-500 mb-4 text-center flex-shrink-0">Click on a question box below to review it. Hover for statement summary.</p>
            
            <div id="results-overview-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-6 overflow-y-auto flex-grow px-2 py-1">
                <!-- Question summary boxes will be populated here by JavaScript -->
            </div>
            
            <div class="mt-auto flex-shrink-0 border-t pt-4">
                 <div class="mb-4">
                     <label for="focus-rating" class="block text-md font-semibold text-gray-700 mb-1">My focus out of 5 (1 very low, 5 very high):</label>
                     <input type="number" id="focus-rating" name="focus-rating" min="1" max="5" class="mt-1 block w-20 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="1-5">
                 </div>
                 <div>
                     <label for="reflection-text" class="block text-md font-semibold text-gray-700 mb-1">Main takeaway from this practice:</label>
                     <textarea id="reflection-text" name="reflection-text" rows="3" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Reflect on your performance, strategies, or areas for improvement..."></textarea>
                 </div>
            </div>
             <div class="mt-6 text-center flex-shrink-0 flex justify-center space-x-4">
                <button onclick="window.location.href = 'practice.html#dm-content';" class="secondary-button px-6 py-2">
                    Back to DM Worksheets
                </button>
                <button onclick="window.location.href = 'student_dashboard.html';" class="secondary-button px-6 py-2">
                    Return to Dashboard
                </button>
                <button id="download-pdf-button" class="primary-button px-6 py-2">
                    Download Results PDF
                </button>
            </div>
        </div>

        <div id="navigator-modal" class="modal">
            <div class="modal-content bg-white p-6 rounded-lg shadow-xl">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">Question Navigator</h3>
                    <button id="close-modal-button" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
                </div>
                 <p class="text-sm text-gray-600 mb-4">Click a number to jump. Green: answered, Yellow border: flagged.</p>
                <div id="navigator-grid" class="grid grid-cols-5 gap-3">
                    </div>
            </div>
        </div>
        
        <div id="calculator-ui">
            <div class="calculator-header" id="calculator-drag-header">
                <span class="title">Calculator</span>
                <button class="close-calc-btn" id="close-calculator-button">×</button>
            </div>
            <div class="calculator-decorative-text">TEXAS INSTRUMENTS TI-108</div>
            <div id="calc-display-container">
                <span id="calc-memory-indicator">M</span>
                <div id="calc-display">0</div>
            </div>
            <div class="calc-buttons-grid">
                <button class="calc-button calc-button-red" data-calc-action="negate">+/-</button>
                <button class="calc-button calc-button-red" data-calc-action="sqrt">√</button>
                <button class="calc-button calc-button-red" data-calc-action="percent">%</button>
                <button class="calc-button calc-button-red operator" data-calc-value="/">÷</button>
                
                <button class="calc-button calc-button-red" data-calc-action="mrc">MRC</button>
                <button class="calc-button calc-button-red" data-calc-action="m-">M-</button>
                <button class="calc-button calc-button-red" data-calc-action="m+">M+</button>
                <button class="calc-button calc-button-red operator" data-calc-value="*">×</button>

                <button class="calc-button calc-button-num" data-calc-value="7">7</button>
                <button class="calc-button calc-button-num" data-calc-value="8">8</button>
                <button class="calc-button calc-button-num" data-calc-value="9">9</button>
                <button class="calc-button calc-button-red operator" data-calc-value="-">-</button>

                <button class="calc-button calc-button-num" data-calc-value="4">4</button>
                <button class="calc-button calc-button-num" data-calc-value="5">5</button>
                <button class="calc-button calc-button-num" data-calc-value="6">6</button>
                <button class="calc-button calc-button-red operator" data-calc-value="+">+</button>
                
                <button class="calc-button calc-button-num" data-calc-value="1">1</button>
                <button class="calc-button calc-button-num" data-calc-value="2">2</button>
                <button class="calc-button calc-button-num" data-calc-value="3">3</button>
                <button class="calc-button calc-button-red equals" data-calc-action="equals">=</button>

                <button class="calc-button calc-button-red" data-calc-action="clear">ON/C</button>
                <button class="calc-button calc-button-num" data-calc-value="0">0</button>
                <button class="calc-button calc-button-num" data-calc-value=".">.</button>
            </div>
        </div>

    </div>

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyASKsaFFTZ-finv2d5egR9K_mZNstEwdns", // Using the one from VR/QR files
          authDomain: "mwp-qr-test-page.firebaseapp.com",
          projectId: "mwp-qr-test-page",
          storageBucket: "mwp-qr-test-page.appspot.com",
          messagingSenderId: "309084045110",
          appId: "1:309084045110:web:b09ca0fdff84b094963d97",
          measurementId: "G-4M3ED641M9"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); // Initialize Firestore
        const auth = firebase.auth();    // Initialize Auth

        let currentUserId = null; // To store anonymous user ID

        // Anonymous Authentication
        auth.onAuthStateChanged((user) => {
          if (user) {
            // User is signed in anonymously.
            currentUserId = user.uid;
            console.log("Anonymous user signed in with UID:", currentUserId);
          } else {
            // User is signed out.
            currentUserId = null;
            console.log("User signed out.");
            // Optionally, attempt to sign in again if needed, or handle state where user isn't signed in
            auth.signInAnonymously().catch((error) => {
                console.error("Error signing in anonymously:", error);
            });
          }
        });

        // Attempt initial anonymous sign-in if no user detected (might be redundant with onAuthStateChanged but ensures an attempt)
        if (!auth.currentUser) {
            auth.signInAnonymously().catch((error) => {
                console.error("Error signing in anonymously on load:", error);
            });
        }

        // --- Data ---
        const premisesData = [
            "All oranges in the bowl are sweet.\\nThis fruit is an orange in the bowl.",
            "No penguin can fly.",
            "Every burger on the menu contains bread.",
            "Some books in the library are new.",
            "All dogs at the shelter are vaccinated."
        ];

        const questionsData = [
            { premiseIndex: 0, statements: ["This fruit is sweet.","Some sweet fruits in the bowl are oranges.","No non-sweet fruits in the bowl are oranges.","All sweet fruits in the bowl are oranges.","Some fruits in the bowl are not sweet."], correctAnswers: ['Y','N','Y','N','N'], explanation: "Explanation for Q1: Based on the premises, if all oranges in the bowl are sweet and this fruit is an orange from that bowl, it must be sweet. The other conclusions need careful evaluation against the given premises." },
            { premiseIndex: 1, statements: ["Some penguins can fly.","If something can fly, it is not a penguin.","All penguins cannot fly.","Some creatures that cannot fly are penguins.","All creatures that cannot fly are penguins."], correctAnswers: ['N','Y','Y','N','N'], explanation: "Explanation for Q2: The premise directly states 'No penguin can fly.' Evaluate each conclusion based on this absolute statement." },
            { premiseIndex: 2, statements: ["Some bread items on the menu are burgers.","All bread items on the menu are burgers.","Some burgers on the menu do not contain bread.","No burgers on the menu lack bread.","Some menu items lack bread."], correctAnswers: ['N','N','N','Y','N'], explanation: "Explanation for Q3: 'Every burger on the menu contains bread' is the key premise. Consider what this implies about burgers and bread items." },
            { premiseIndex: 3, statements: ["All books in the library are new.","Some books in the library are not new.","At least one new item in the library is a book.","No new items in the library are books.","There is at least one book in the library."], correctAnswers: ['N','N','Y','N','Y'], explanation: "Explanation for Q4: 'Some books in the library are new' means at least one book is new, but not necessarily all. It also implies the existence of books in the library." },
            { premiseIndex: 4, statements: ["Some vaccinated animals at the shelter are dogs.","Some dogs at the shelter are not vaccinated.","All vaccinated animals at the shelter are dogs.","No dogs at the shelter are unvaccinated.","Some animals at the shelter are not vaccinated."], correctAnswers: ['N','N','N','Y','N'], explanation: "Explanation for Q5: 'All dogs at the shelter are vaccinated' is a specific statement. Evaluate how this impacts conclusions about vaccinated animals and dogs at the shelter." }
        ];

        // --- State ---
        let currentQuestionIndex = 0;
        let userAnswers = Array(questionsData.length).fill(null).map(() => Array(5).fill(null));
        let examStartTime;
        let examEndTime;
        let userName = '';
        let userGoal = '';
        let userFocusArea = '';
        let isReviewingFromResults = false;
        let flaggedQuestions = new Array(questionsData.length).fill(false);
        let isFilteringFlagged = false;
        let currentlyDisplayedPremiseIndex = -1;
        let questionTimings = new Array(questionsData.length).fill(0);
        let currentQuestionStartTime;
        let lastQuestionIndexForTiming = -1;

        // Timer variables
        const totalTimeAllowedInSeconds = 360; // 6 minutes
        let timeLeft = totalTimeAllowedInSeconds;
        let timerInterval = null;

        // --- Elements ---
        const appContainer = document.getElementById('app-container');
        const setupScreen = document.getElementById('setup-screen');
        const examScreen = document.getElementById('exam-screen');
        const reviewScreen = document.getElementById('review-screen');
        const resultsScreen = document.getElementById('results-screen');
        const navigatorModal = document.getElementById('navigator-modal');
        const startButton = document.getElementById('start-button');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const navigatorButton = document.getElementById('navigator-button');
        const closeModalButton = document.getElementById('close-modal-button');
        const endExamButton = document.getElementById('end-exam-button');
        const endExamButtonFooter = document.getElementById('end-exam-button-footer');
        const backToResultsButton = document.getElementById('back-to-results-button');
        const flagButton = document.getElementById('flag-button');
        const premisesTextEl = document.getElementById('premises-text');
        const questionNumberEl = document.getElementById('question-number');
        const questionNumberInfoEl = document.getElementById('question-number-info');
        const statementsListContainer = document.getElementById('statements-list');
        const draggableYes = document.getElementById('draggable-yes'); // Draggable Yes
        const draggableNo = document.getElementById('draggable-no');   // Draggable No
        const reviewGrid = document.getElementById('review-grid');
        const navigatorGrid = document.getElementById('navigator-grid');
        const scoreEl = document.getElementById('score');
        const totalScorePossibleEl = document.getElementById('total-score-possible');
        const timeTakenEl = document.getElementById('time-taken');
        const resultsDetails = document.getElementById('results-details');
        const focusAreaInput = document.getElementById('focus-area');
        const examTitleEl = document.getElementById('exam-title');
        const filterFlaggedButton = document.getElementById('filter-flagged-button');
        const setupQuestionCountEl = document.getElementById('setup-question-count');
        const setupMaxScoreEl = document.getElementById('setup-max-score');
        const reviewExplanationContainer = document.getElementById('review-explanation-container');
        const reflectionText = document.getElementById('reflection-text');
        const downloadPdfButton = document.getElementById('download-pdf-button');
        const focusRatingInput = document.getElementById('focus-rating');
        const timerDisplay = document.getElementById('timer');
        const goalInput = document.getElementById('goal');
        const calculatorToggleButton = document.getElementById('calculator-toggle-button');
        const calculatorUI = document.getElementById('calculator-ui');
        const closeCalculatorButton = document.getElementById('close-calculator-button');
        const calculatorDragHeader = document.getElementById('calculator-drag-header');
        const calcDisplay = document.getElementById('calc-display');
        const calcButtons = document.querySelectorAll('.calc-button');
        const calcMemoryIndicator = document.getElementById('calc-memory-indicator');

        // Calculator variables
        let calcCurrentInput = '0';
        let calcPreviousInput = '';
        let calcOperator = null;
        let calcShouldResetDisplay = false;
        let calcMemory = 0;
        let calcMrcPressedOnce = false;

        // Calculator functions
        function toggleCalculator() {
            const isVisible = calculatorUI.classList.toggle('visible');
            calculatorToggleButton.classList.toggle('active', isVisible);
        }

        function updateCalcDisplay() {
            // Ensure display doesn't overflow, use scientific notation for very long numbers
            if (calcCurrentInput === 'Error') {
                calcDisplay.textContent = 'Error';
            } else if (calcCurrentInput.length > 12) {
                // For long numbers, try scientific notation
                try {
                    const num = parseFloat(calcCurrentInput);
                    if (isFinite(num)) {
                        calcDisplay.textContent = num.toExponential(6);
                    } else {
                        calcDisplay.textContent = 'Error';
                    }
                } catch (e) {
                    calcDisplay.textContent = calcCurrentInput.substring(0, 12);
                }
            } else {
                calcDisplay.textContent = calcCurrentInput;
            }
            
            // Show/hide memory indicator
            if (calcMemory !== 0) {
                calcMemoryIndicator.style.display = 'block';
            } else {
                calcMemoryIndicator.style.display = 'none';
            }
        }

        function clearCalculator() {
            calcCurrentInput = '0';
            calcPreviousInput = '';
            calcOperator = null;
            calcShouldResetDisplay = false;
            calcMrcPressedOnce = false; 
            updateCalcDisplay();
        }
        
        function inputDigit(digit) {
            if (calcCurrentInput === 'Error') calcCurrentInput = '0'; // Clear error on new digit
            if (calcShouldResetDisplay) {
                calcCurrentInput = digit;
                calcShouldResetDisplay = false;
            } else {
                // Prevent excessively long numbers before decimal
                if (calcCurrentInput.includes('.') && calcCurrentInput.split('.')[1].length >= 8) return; // Limit to 8 decimal places
                if (!calcCurrentInput.includes('.') && calcCurrentInput.length >= 10 && calcCurrentInput !== '0') return; // Limit to 10 integer digits

                calcCurrentInput = calcCurrentInput === '0' ? digit : calcCurrentInput + digit;
            }
            updateCalcDisplay();
            calcMrcPressedOnce = false; 
        }

        function inputDecimal() {
            if (calcCurrentInput === 'Error') calcCurrentInput = '0';
            if (calcShouldResetDisplay) {
                calcCurrentInput = '0.';
                calcShouldResetDisplay = false;
            } else if (!calcCurrentInput.includes('.')) {
                calcCurrentInput += '.';
            }
            updateCalcDisplay();
            calcMrcPressedOnce = false;
        }

        function handleOperator(nextOperator) {
            if (calcCurrentInput === 'Error') return;
            const inputValue = parseFloat(calcCurrentInput);
            if (calcOperator && !calcShouldResetDisplay) { 
                calculate();
                if (calcCurrentInput === 'Error') return; // Stop if calculation resulted in error
                calcPreviousInput = calcCurrentInput; 
            } else {
                calcPreviousInput = calcCurrentInput;
            }
            calcOperator = nextOperator;
            calcShouldResetDisplay = true;
            calcMrcPressedOnce = false;
        }

        function calculate() {
            if (!calcOperator || calcPreviousInput === '' || calcCurrentInput === 'Error') return;
            const prev = parseFloat(calcPreviousInput);
            const current = parseFloat(calcCurrentInput);
            if (isNaN(prev) || isNaN(current)) {
                calcCurrentInput = 'Error'; // Should not happen if inputs are validated
                updateCalcDisplay();
                return;
            }

            let result = 0;
            switch (calcOperator) {
                case '+': result = prev + current; break;
                case '-': result = prev - current; break;
                case '*': result = prev * current; break;
                case '/': 
                    if (current === 0) {
                        result = 'Error';
                    } else {
                        result = prev / current;
                    }
                    break;
                default: return;
            }

            if (result === 'Error') {
                calcCurrentInput = 'Error';
            } else {
                // Check if result is a valid number and not Infinity or NaN
                if (!isFinite(result)) {
                    calcCurrentInput = 'Error';
                } else {
                    // Format result: if it's a very small or large number, handle differently
                    try {
                        // Handle large numbers better - use toFixed for numbers that are too large
                        if (Math.abs(result) > 1e10) {
                            let resultStr = result.toExponential(6);
                            calcCurrentInput = resultStr;
                        } else if (Math.abs(result) < 1e-6 && result !== 0) {
                            // Small numbers in scientific notation
                            let resultStr = result.toExponential(6);
                            calcCurrentInput = resultStr;
                        } else {
                            // Normal sized numbers - keep precision but remove trailing zeros
                            let resultStr = parseFloat(result.toPrecision(10)).toString();
                            calcCurrentInput = resultStr;
                        }
                    } catch (e) {
                        // Fallback if formatting fails
                        calcCurrentInput = String(result);
                    }
                    
                    // Additional safety - if we end up with an invalid display value, show Error
                    if (calcCurrentInput === 'NaN' || calcCurrentInput === 'Infinity' || calcCurrentInput === '-Infinity') {
                        calcCurrentInput = 'Error';
                    }
                }
            }
            
            updateCalcDisplay();
            calcOperator = null;
            calcShouldResetDisplay = true;
            calcMrcPressedOnce = false;
        }

        function handleSpecialFunction(action) {
            if (calcCurrentInput === 'Error') {
                if (action !== 'clear') return;
            }
            
            const num = parseFloat(calcCurrentInput);
            
            switch(action) {
                case 'negate':
                    if (calcCurrentInput === '0') return;
                    calcCurrentInput = calcCurrentInput.startsWith('-') ? 
                        calcCurrentInput.substring(1) : 
                        '-' + calcCurrentInput;
                    break;
                case 'sqrt':
                    if (num < 0) {
                        calcCurrentInput = 'Error';
                    } else {
                        const result = Math.sqrt(num);
                        calcCurrentInput = result.toString();
                    }
                    break;
                case 'percent':
                    if (calcPreviousInput && calcOperator) {
                        // Percent in context of another operation
                        const prev = parseFloat(calcPreviousInput);
                        calcCurrentInput = (num * prev / 100).toString();
                    } else {
                        // Just convert to percentage form
                        calcCurrentInput = (num / 100).toString();
                    }
                    break;
                case 'backspace':
                    if (calcCurrentInput.length === 1 || 
                        (calcCurrentInput.length === 2 && calcCurrentInput.startsWith('-'))) {
                        calcCurrentInput = '0';
                    } else {
                        calcCurrentInput = calcCurrentInput.slice(0, -1);
                    }
                    break;
                case 'clear':
                    clearCalculator();
                    return; // Already updates display
            }
            
            updateCalcDisplay();
            calcShouldResetDisplay = false;
            calcMrcPressedOnce = false;
        }

        function handleMemory(action) {
            if (calcCurrentInput === 'Error' && action !== 'mrc') return;
            
            const num = parseFloat(calcCurrentInput);
            
            switch(action) {
                case 'm+':
                    calcMemory += num;
                    calcShouldResetDisplay = true;
                    break;
                case 'm-':
                    calcMemory -= num;
                    calcShouldResetDisplay = true;
                    break;
                case 'mrc':
                    if (!calcMrcPressedOnce) {
                        // First press: show memory
                        calcCurrentInput = calcMemory.toString();
                        calcMrcPressedOnce = true;
                    } else {
                        // Second press: clear memory
                        calcMemory = 0;
                        calcMrcPressedOnce = false;
                    }
                    break;
            }
            
            updateCalcDisplay();
        }

        // Make calculator draggable
        let isDragging = false;
        let dragOffsetX = 0;
        let dragOffsetY = 0;

        function makeDraggable(element, handle) {
            handle.onmousedown = function(event) {
                event.preventDefault();
                isDragging = true;
                element.style.cursor = 'grabbing';
                const rect = element.getBoundingClientRect();
                dragOffsetX = event.clientX - rect.left;
                dragOffsetY = event.clientY - rect.top;
                
                // Add event listeners for dragging
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', () => {
                    isDragging = false;
                    element.style.cursor = 'grab';
                    document.removeEventListener('mousemove', handleMouseMove);
                }, { once: true });
            };
        }

        function handleMouseMove(e) {
            if (!isDragging) return;
            
            const x = e.clientX - dragOffsetX;
            const y = e.clientY - dragOffsetY;
            
            // Keep the calculator within the app container
            const container = appContainer.getBoundingClientRect();
            const calculator = calculatorUI.getBoundingClientRect();
            
            const maxX = container.width - calculator.width;
            const maxY = container.height - calculator.height;
            
            const boundedX = Math.max(0, Math.min(maxX, x - container.left));
            const boundedY = Math.max(0, Math.min(maxY, y - container.top));
            
            calculatorUI.style.left = `${boundedX}px`;
            calculatorUI.style.top = `${boundedY}px`;
            calculatorUI.style.transform = 'none'; // Remove default transform once positioned manually
        }

        // --- Functions ---

        function formatTimeDifference(milliseconds) {
            if (!milliseconds || milliseconds < 0) return "0 min 00 sec";
            const totalSeconds = Math.round(milliseconds / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes} min ${seconds < 10 ? '0' : ''}${seconds} sec`;
        }

        function toggleFlag() {
            if (isReviewingFromResults) return;
            const index = currentQuestionIndex;
            flaggedQuestions[index] = !flaggedQuestions[index];
            updateFlagButtonAppearance();
            updateNavigatorButtons();
        }

        function updateFlagButtonAppearance() {
            const isFlagged = flaggedQuestions[currentQuestionIndex];
            flagButton.textContent = isFlagged ? 'Unflag' : 'Flag for Review';
            flagButton.classList.toggle('flagged', isFlagged);
        }

        function recordQuestionTime() {
            if (currentQuestionStartTime && lastQuestionIndexForTiming !== -1 && lastQuestionIndexForTiming < questionsData.length && !isReviewingFromResults) {
                const timeSpent = new Date().getTime() - currentQuestionStartTime;
                questionTimings[lastQuestionIndexForTiming] += timeSpent; // Accumulate time if revisited before finishing
            }
        }

        /** Loads a question (premises and statements) */
        function loadQuestion(index, reviewMode = false) {
            if (index < 0 || index >= questionsData.length) return;

            if (!reviewMode) {
                recordQuestionTime(); // Record time for the question we are leaving
                currentQuestionStartTime = new Date().getTime(); // Start timer for the new question
                lastQuestionIndexForTiming = index; // Update the last question index for timing
            }

            const question = questionsData[index];
            const newPremiseIndex = question.premiseIndex;
            const mainContentArea = document.querySelector('.main-content-area'); 

            // Load premises
            if (newPremiseIndex !== currentlyDisplayedPremiseIndex || reviewMode) {
                premisesTextEl.innerHTML = premisesData[newPremiseIndex].replace(/\n/g, '<br><br>');
                currentlyDisplayedPremiseIndex = newPremiseIndex;
            }

            currentQuestionIndex = index;
            isReviewingFromResults = reviewMode; // Ensure this state is set

            questionNumberEl.textContent = index + 1;
            questionNumberInfoEl.textContent = `${index + 1} of ${questionsData.length}`;
            if (mainContentArea) mainContentArea.scrollTop = 0; 

            statementsListContainer.innerHTML = ''; 
            reviewExplanationContainer.innerHTML = ''; 

            question.statements.forEach((statementText, statementIndex) => {
                const statementRow = document.createElement('div');
                statementRow.classList.add('statement-row');
                statementRow.dataset.qIndex = index; 
                statementRow.dataset.sIndex = statementIndex;

                const textBox = document.createElement('div');
                textBox.classList.add('statement-text');
                textBox.textContent = `${statementIndex + 1}. ${statementText}`;
                statementRow.appendChild(textBox);

                const answerBox = document.createElement('div');
                answerBox.classList.add('statement-answer-box');
                answerBox.id = `q${index}-s${statementIndex}-answerbox`; 
                statementRow.appendChild(answerBox);

                const currentAnswerForStatement = userAnswers[index] ? userAnswers[index][statementIndex] : null;
                updateAnswerBox(answerBox, currentAnswerForStatement); // Pass the specific answer for this statement

                if (!reviewMode) {
                    statementRow.addEventListener('dragover', handleDragOver);
                    statementRow.addEventListener('dragleave', handleDragLeave);
                    statementRow.addEventListener('drop', handleDrop);
                } else {
                    const correctAnswer = question.correctAnswers[statementIndex];
                    answerBox.classList.remove('answered-yes', 'answered-no'); // Clear normal answer styles
                    if (currentAnswerForStatement === correctAnswer) {
                        answerBox.classList.add('answered-yes'); // Show correct as green
                        answerBox.textContent = currentAnswerForStatement === 'Y' ? 'Yes (Correct)' : 'No (Correct)';
                    } else {
                        answerBox.classList.add('answered-no'); // Show incorrect as red
                        answerBox.textContent = currentAnswerForStatement === 'Y' ? `Yes (Incorrect, Ans: ${correctAnswer})` : (currentAnswerForStatement === 'N' ? `No (Incorrect, Ans: ${correctAnswer})` : `N/A (Ans: ${correctAnswer})`);
                    }
                }
                statementsListContainer.appendChild(statementRow);
            });

            if (reviewMode && question.explanation) {
                 const explanationDiv = document.createElement('div');
                 explanationDiv.classList.add('explanation-box', 'mt-3'); // Added margin-top for spacing
                 explanationDiv.innerHTML = `<strong class="font-semibold">Explanation:</strong> ${question.explanation}`;
                 reviewExplanationContainer.appendChild(explanationDiv);
            }

            prevButton.disabled = index === 0;
            if (reviewMode) {
                nextButton.textContent = 'Next →';
                nextButton.disabled = index === questionsData.length - 1;
                backToResultsButton.classList.remove('hidden');
                endExamButtonFooter.classList.add('hidden');
                examTitleEl.textContent = "Reviewing Question";
                flagButton.disabled = true;
                flagButton.classList.remove('flagged'); // Ensure flag isn't stuck visually
                if(flaggedQuestions[index]) flagButton.classList.add('flagged'); // Re-apply if it was flagged
                
                draggableYes.setAttribute('draggable', 'false'); 
                draggableNo.setAttribute('draggable', 'false');
                draggableYes.style.cursor = 'default';
                draggableNo.style.cursor = 'default';
                 document.getElementById('draggable-options-sidebar').style.display = 'none'; 
            } else {
                if (index === questionsData.length - 1) {
                    nextButton.textContent = 'Finish & Review';
                } else {
                    nextButton.textContent = 'Next (Alt+N) →';
                }
                nextButton.disabled = false; // Generally enabled unless specific conditions met later
                backToResultsButton.classList.add('hidden');
                endExamButtonFooter.classList.remove('hidden');
                examTitleEl.textContent = "Decision Making";
                flagButton.disabled = false;
                draggableYes.setAttribute('draggable', 'true'); 
                draggableNo.setAttribute('draggable', 'true');
                draggableYes.style.cursor = 'grab';
                draggableNo.style.cursor = 'grab';
                document.getElementById('draggable-options-sidebar').style.display = 'flex'; 
            }
            updateFlagButtonAppearance(); // Call this after reviewMode logic might change flag state
            updateNavigatorHighlight();
        }


        /** Updates the visual state of an answer box */
        function updateAnswerBox(answerBoxElement, answer) {
            answerBoxElement.classList.remove('answered-yes', 'answered-no', 'border-red-500', 'border-green-500', 'border-2'); // Clear previous styles
            answerBoxElement.textContent = ''; // Clear text
            if (answer === 'Y') {
                answerBoxElement.classList.add('answered-yes');
                answerBoxElement.textContent = 'Yes';
            } else if (answer === 'N') {
                answerBoxElement.classList.add('answered-no');
                answerBoxElement.textContent = 'No';
            } else {
                // Optional: Add placeholder text if needed
                 answerBoxElement.textContent = '...'; // Placeholder for empty
            }
        }

        // --- Drag and Drop Handlers ---

        function handleDragStart(event) {
            // Ensure the event target is the draggable element itself
            if (!event.target.classList.contains('draggable-option')) return;

            const value = event.target.id === 'draggable-yes' ? 'Y' : 'N';
            event.dataTransfer.setData('text/plain', value);
            event.dataTransfer.effectAllowed = 'copy';
             event.target.style.opacity = '0.7';
        }

        function handleDragEnd(event) {
             // Ensure the event target is the draggable element itself
            if (!event.target.classList.contains('draggable-option')) return;
             event.target.style.opacity = '1';
        }

        function handleDragOver(event) {
            // Allow drop only on statement rows
            const targetRow = event.target.closest('.statement-row');
            if (targetRow && !isReviewingFromResults) {
                event.preventDefault();
                event.dataTransfer.dropEffect = 'copy';
                targetRow.classList.add('drag-over'); // Add visual feedback to the row
            }
        }

        function handleDragLeave(event) {
             // Remove visual feedback from the row
            const targetRow = event.target.closest('.statement-row');
            if (targetRow) {
                targetRow.classList.remove('drag-over');
            }
        }

        function handleDrop(event) {
            event.preventDefault();
            const targetRow = event.target.closest('.statement-row');

            if (!targetRow || isReviewingFromResults) return; // Ensure drop is on a row and not in review

            targetRow.classList.remove('drag-over'); // Remove visual feedback

            const droppedValue = event.dataTransfer.getData('text/plain');
            const questionIndex = parseInt(targetRow.dataset.qIndex, 10);
            const statementIndex = parseInt(targetRow.dataset.sIndex, 10);

            if (questionIndex !== currentQuestionIndex) return; // Ensure drop is on current question

            // Store the answer
            if (!userAnswers[questionIndex]) {
                userAnswers[questionIndex] = Array(5).fill(null);
            }
            userAnswers[questionIndex][statementIndex] = droppedValue;

            // Update the target answer box visually within the row
            const answerBox = targetRow.querySelector('.statement-answer-box');
            if (answerBox) {
                updateAnswerBox(answerBox, droppedValue);
            }

            // Check if all statements for this question are answered
            const allAnswered = userAnswers[questionIndex].every(ans => ans !== null);
            updateNavigatorButtons(allAnswered);
        }

        // Add drag listeners to draggable options
        draggableYes.addEventListener('dragstart', handleDragStart);
        draggableNo.addEventListener('dragstart', handleDragStart);
        draggableYes.addEventListener('dragend', handleDragEnd); // Restore style on drag end
        draggableNo.addEventListener('dragend', handleDragEnd);


        function showNextQuestion() {
            // Hide calculator if it's open
            if (calculatorUI.classList.contains('visible')) {
                toggleCalculator();
            }
            
            if (isReviewingFromResults) {
                if (currentQuestionIndex < questionsData.length - 1) {
                    loadQuestion(currentQuestionIndex + 1, true);
                }
            } else {
                if (currentQuestionIndex === questionsData.length - 1) {
                    showReviewScreen();
                } else if (currentQuestionIndex < questionsData.length - 1) {
                    loadQuestion(currentQuestionIndex + 1);
                }
            }
        }

        function showPrevQuestion() {
            // Hide calculator if it's open
            if (calculatorUI.classList.contains('visible')) {
                toggleCalculator();
            }
            
             if (isReviewingFromResults) {
                 if (currentQuestionIndex > 0) {
                     loadQuestion(currentQuestionIndex - 1, true);
                 }
             }
             else if (currentQuestionIndex > 0) {
                loadQuestion(currentQuestionIndex - 1);
            }
        }

        function showSetupScreen() {
            setupScreen.classList.remove('hidden');
            examScreen.classList.add('hidden');
            reviewScreen.classList.add('hidden');
            resultsScreen.classList.add('hidden');
            appContainer.classList.remove('flex', 'flex-col');
            currentlyDisplayedPremiseIndex = -1;
            if (setupQuestionCountEl) setupQuestionCountEl.textContent = questionsData.length;
            if (setupMaxScoreEl) setupMaxScoreEl.textContent = questionsData.length * 2;
        }

        function showExamScreen() {
            setupScreen.classList.add('hidden');
            examScreen.classList.remove('hidden');
            examScreen.classList.add('flex');
            reviewScreen.classList.add('hidden');
            resultsScreen.classList.add('hidden');
            // appContainer.classList.add('flex', 'flex-col'); // Not strictly necessary based on CSS
            currentlyDisplayedPremiseIndex = -1;
            // examStartTime = new Date(); // REMOVED FROM HERE
            if (timerDisplay) timerDisplay.classList.remove('hidden');
            if (document.getElementById('draggable-options-sidebar')) {
                 document.getElementById('draggable-options-sidebar').style.display = 'flex';
            }
            appContainer.scrollTop = 0;
        }

        function showReviewScreen(filterFlagged = false) {
            recordQuestionTime(); // Record time for the current question before showing review screen
            currentQuestionStartTime = null; // Stop question timer
            lastQuestionIndexForTiming = -1;
            stopTimer(); // Stop the main exam timer

            // Hide calculator if it's visible
            if (calculatorUI.classList.contains('visible')) {
                toggleCalculator();
            }

            examScreen.classList.add('hidden');
            reviewScreen.classList.remove('hidden');
            reviewScreen.classList.add('flex');
            resultsScreen.classList.add('hidden');
            setupScreen.classList.add('hidden');
            appContainer.classList.add('flex', 'flex-col');

            reviewGrid.innerHTML = ''; // Clear previous review buttons
            questionsData.forEach((_, index) => {
                 if (filterFlagged && !flaggedQuestions[index]) {
                     return;
                 }

                const button = document.createElement('button');
                button.textContent = index + 1;
                button.className = 'review-grid-button'; // Use specific class for review grid

                const isAnswered = userAnswers[index] && userAnswers[index].some(ans => ans !== null);

                if (isAnswered) {
                    button.classList.add('review-grid-button-answered');
                } else {
                     button.classList.add('review-grid-button-unanswered');
                }

                if (flaggedQuestions[index]) {
                    button.classList.add('review-flagged');
                }

                button.onclick = () => {
                    reviewScreen.classList.add('hidden');
                    reviewScreen.classList.remove('flex');
                    showExamScreen();
                    loadQuestion(index); // Load in normal mode for review from review screen
                };
                reviewGrid.appendChild(button);
            });

             filterFlaggedButton.textContent = filterFlagged ? 'Show All Questions' : 'Show Flagged Only';
        }

        function populateNavigator() {
            navigatorGrid.innerHTML = '';
            questionsData.forEach((_, index) => {
                const button = document.createElement('button');
                button.textContent = index + 1;
                button.className = 'review-grid-button';

                const isAnswered = userAnswers[index] && userAnswers[index].some(ans => ans !== null);

                if (isAnswered) {
                    button.classList.add('review-grid-button-answered');
                } else {
                     button.classList.add('review-grid-button-unanswered');
                }

                if (flaggedQuestions[index]) {
                    button.classList.add('review-flagged');
                }

                button.onclick = () => {
                    reviewScreen.classList.add('hidden');
                    reviewScreen.classList.remove('flex');
                    showExamScreen();
                    loadQuestion(index); // Load in normal mode for review
                };
                navigatorGrid.appendChild(button);
            });
        }

        function showResultsScreen() {
            examEndTime = new Date();
            // Note: Time for the *last question viewed before clicking "End Practice & See Results"*
            // is recorded either in showReviewScreen (if they went there first)
            // or in endExamAndShowResults (if they clicked end from the exam screen directly).

            examScreen.classList.add('hidden');
            reviewScreen.classList.add('hidden');
            resultsScreen.classList.remove('hidden');
            resultsScreen.classList.add('flex');
            setupScreen.classList.add('hidden');
            appContainer.classList.add('flex', 'flex-col');

            let totalScore = 0;
            const resultsOverviewGrid = document.getElementById('results-overview-grid');
            resultsOverviewGrid.innerHTML = ''; // Clear previous results

            questionsData.forEach((qData, index) => {
                const userAnsArray = userAnswers[index] || Array(5).fill(null);
                const correctAnsArray = qData.correctAnswers;
                let correctStatements = 0;

                userAnsArray.forEach((userAns, statementIndex) => {
                    if (userAns !== null && userAns === correctAnsArray[statementIndex]) {
                        correctStatements++;
                    }
                });

                let points = 0;
                let pointsClass = 'incorrect-0pts';

                if (correctStatements === 5) {
                    points = 2;
                    pointsClass = 'correct-2pts';
                } else if (correctStatements === 4) {
                    points = 1;
                    pointsClass = 'correct-1pt';
                }
                totalScore += points;

                const timeForQuestionMs = questionTimings[index] || 0;
                const timeForQuestionSec = Math.round(timeForQuestionMs / 1000);

                const resultItem = document.createElement('div');
                resultItem.classList.add('result-summary-item', 'relative');
                if (correctStatements === 5) {
                    resultItem.style.backgroundColor = '#dcfce7';
                    resultItem.style.borderColor = '#22c55e';
                } else if (correctStatements === 4) {
                    resultItem.style.backgroundColor = '#fef3c7';
                    resultItem.style.borderColor = '#f59e0b';
                } else {
                    resultItem.style.backgroundColor = '#fee2e2';
                    resultItem.style.borderColor = '#ef4444';
                }
                resultItem.style.borderWidth = '1px';
                resultItem.style.borderStyle = 'solid';
                resultItem.dataset.index = index;
                resultItem.title = `Click to review Question ${index + 1}`;

                let statementsTooltipHtml = '<div class="tooltip-text">';
                qData.statements.forEach((stmtText, stmtIndex) => {
                    const userAns = userAnsArray[stmtIndex];
                    const correctAns = correctAnsArray[stmtIndex];
                    const isStmtCorrect = userAns === correctAns;
                    statementsTooltipHtml += `<p class=\'${isStmtCorrect ? "text-green-300" : (userAns ? "text-red-300" : "text-gray-400")}\'>${stmtIndex + 1}. Your: ${userAns || '-'} | Ans: ${correctAns}</p>`;
                });
                statementsTooltipHtml += '</div>';

                resultItem.innerHTML = `
                    <p class="result-summary-points ${pointsClass}">${points}pt</p>
                    <p class="result-summary-qnum">Q${index + 1} ${flaggedQuestions[index] ? '&#128681;' : ''}</p> 
                    <p class="result-summary-statements">(${correctStatements}/5 correct)</p>
                    <p class="text-xs text-gray-500 mt-1">Time: ${timeForQuestionSec}s</p>
                    ${statementsTooltipHtml}
                `;

                resultItem.addEventListener('click', () => {
                    revisitQuestionFromResults(index);
                });
                resultsOverviewGrid.appendChild(resultItem);
            });

            scoreEl.textContent = totalScore;
            totalScorePossibleEl.textContent = questionsData.length * 2;
            const timeDiff = examEndTime - examStartTime;
            timeTakenEl.textContent = formatTimeDifference(timeDiff);
        }

        function revisitQuestionFromResults(index) {
            resultsScreen.classList.add('hidden');
            resultsScreen.classList.remove('flex');
            showExamScreen();
            loadQuestion(index, true); // Load in review mode
        }

        function endExamAndShowResults() {
            recordQuestionTime(); 
            stopTimer(); 
            examEndTime = new Date();
            
            // Hide calculator if it's visible
            if (calculatorUI.classList.contains('visible')) {
                toggleCalculator();
            }
            
            saveResultsToFirebase(); // CALL THE SAVE FUNCTION HERE
            showResultsScreen();
            reviewScreen.classList.add('hidden'); 
        }
         function handleEndExamFooterClick() {
            showReviewScreen();
         }

        // --- PDF Generation Function ---
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const reflection = reflectionText.value.trim();
            const focusRating = focusRatingInput.value;
            const finalScore = scoreEl.textContent;
            const totalPossible = totalScorePossibleEl.textContent;
            const timeTaken = timeTakenEl.textContent;

            let y = 15; // Initial Y position
            const lineHeight = 7;
            const pageHeight = doc.internal.pageSize.height;
            const margin = 15;
            const contentWidth = doc.internal.pageSize.width - margin * 2;

            // Title
            doc.setFontSize(18);
            doc.text("UCAT Decision Making Results", margin, y);
            y += lineHeight * 1.5;

            // Summary
            doc.setFontSize(12);
            doc.text(`Name: ${userName || 'N/A'}`, margin, y); y += lineHeight;
            doc.text(`Goal: ${userGoal || 'N/A'} / ${totalPossible} points`, margin, y); y += lineHeight;
            doc.text(`Focus Area: ${userFocusArea || 'N/A'}`, margin, y); y += lineHeight;
            doc.text(`Final Score: ${finalScore} / ${totalPossible} points`, margin, y); y += lineHeight;
            doc.text(`Time Taken: ${timeTaken}`, margin, y); y += lineHeight * 1.5;

            // Focus Rating
            doc.setFontSize(14); doc.text("Focus Rating (1-5):", margin, y); y += lineHeight;
            doc.setFontSize(10); doc.text(focusRating || 'N/A', margin, y); y += lineHeight * 1.5;

            // Reflection
            doc.setFontSize(14); doc.text("Main Takeaway:", margin, y); y += lineHeight;
            doc.setFontSize(10);
            const reflectionLines = doc.splitTextToSize(reflection || 'No reflection provided.', contentWidth);
            doc.text(reflectionLines, margin, y);
            y += reflectionLines.length * (lineHeight * 0.7) + lineHeight;

            // Detailed Results Header
            doc.setFontSize(14); doc.text("Detailed Results:", margin, y); y += lineHeight * 1.5;

            // Loop through questions
            questionsData.forEach((qData, index) => {
                 if (y + lineHeight * 12 > pageHeight - margin) { // Adjusted estimate for space with explanation
                     doc.addPage(); y = margin;
                 }

                const userAnsArray = userAnswers[index] || Array(5).fill(null);
                const correctAnsArray = qData.correctAnswers;
                let correctStatements = 0;
                userAnsArray.forEach((userAns, stmtIndex) => { if (userAns !== null && userAns === correctAnsArray[stmtIndex]) correctStatements++; });
                let points = (correctStatements === 5) ? 2 : ((correctStatements === 4) ? 1 : 0);

                doc.setFontSize(12); doc.text(`Question ${index + 1} (Points: ${points}/2)`, margin, y); y += lineHeight * 0.8;
                doc.setFontSize(9); doc.text(`(${correctStatements}/5 statements correct) ${flaggedQuestions[index] ? '(Flagged)' : ''}`, margin, y); y += lineHeight * 1.2;

                // Premises
                doc.setFontSize(10); doc.setFont(undefined, 'bold'); doc.text("Premises:", margin, y); y += lineHeight * 0.8;
                doc.setFont(undefined, 'normal'); doc.setFontSize(9);
                const premiseLines = doc.splitTextToSize(premisesData[qData.premiseIndex], contentWidth);
                doc.text(premiseLines, margin, y); y += premiseLines.length * (lineHeight * 0.7) + lineHeight*0.5;

                // Statements
                doc.setFontSize(10); doc.setFont(undefined, 'bold'); doc.text("Statements:", margin, y); y += lineHeight * 0.8;
                doc.setFont(undefined, 'normal'); doc.setFontSize(9);

                qData.statements.forEach((stmtText, stmtIndex) => {
                    if (y + lineHeight * 2 > pageHeight - margin) { doc.addPage(); y = margin; doc.setFontSize(9); }
                    const userAns = userAnsArray[stmtIndex];
                    const correctAns = correctAnsArray[stmtIndex];
                    const isStmtCorrect = userAns === correctAns;
                    const status = isStmtCorrect ? "Correct" : (userAns ? "Incorrect" : "Not Answered");
                    const statementLine1 = `${stmtIndex + 1}. ${stmtText}`;
                    const statementLine2 = `   Your: ${userAns || 'N/A'} | Correct: ${correctAns} | Status: ${status}`;
                    const lines1 = doc.splitTextToSize(statementLine1, contentWidth - 5); doc.text(lines1, margin + 5, y); y += lines1.length * (lineHeight * 0.7);
                    const lines2 = doc.splitTextToSize(statementLine2, contentWidth - 5); doc.text(lines2, margin + 5, y); y += lines2.length * (lineHeight * 0.7) + lineHeight * 0.3;
                });

                 // Explanation (if available)
                 if (qData.explanation) {
                     if (y + lineHeight * 3 > pageHeight - margin) { doc.addPage(); y = margin; } // Check space for explanation header + text
                     doc.setFontSize(10); doc.setFont(undefined, 'bold'); doc.text("Explanation:", margin, y); y += lineHeight * 0.8;
                     doc.setFont(undefined, 'normal'); doc.setFontSize(9);
                     const explanationLines = doc.splitTextToSize(qData.explanation, contentWidth);
                     doc.text(explanationLines, margin, y);
                     y += explanationLines.length * (lineHeight * 0.7);
                 }

                 y += lineHeight; // Extra space after each question block
            });

            doc.save(`ucat_dm_results_${userName || 'user'}.pdf`);
        }

        // --- NEW FUNCTION TO SAVE RESULTS TO FIREBASE ---
        function saveResultsToFirebase() {
            if (!db) {
                console.error("Firestore (db) is not initialized.");
                return;
            }
            // We will proceed even if currentUserId is null for now, relying on userName
            // if (!currentUserId && !userName) { 
            //     console.warn("No user identifier (anonymous UID or name) available. Skipping Firestore save.");
            //     return;
            // }

            const worksheetName = "DM Syllogisms Worksheet 1"; 
            const totalScore = parseInt(scoreEl.textContent, 10);
            const totalPossible = parseInt(totalScorePossibleEl.textContent, 10);
            const timeTakenString = timeTakenEl.textContent;
            const reflection = reflectionText.value.trim();
            const focusRatingVal = focusRatingInput.value;

            const detailedAnswers = questionsData.map((qData, index) => {
                const userAnsArray = userAnswers[index] || Array(5).fill(null);
                const correctAnsArray = qData.correctAnswers;
                let correctStatements = 0;
                userAnsArray.forEach((userAns, stmtIndex) => {
                    if (userAns === correctAnsArray[stmtIndex]) {
                        correctStatements++;
                    }
                });
                let points = 0;
                if (correctStatements === 5) points = 2;
                else if (correctStatements === 4) points = 1;

                return {
                    questionIndex: index,
                    premise: premisesData[qData.premiseIndex],
                    statements: qData.statements,
                    userAnswers: userAnsArray,
                    correctAnswers: correctAnsArray,
                    explanation: qData.explanation || "", // Ensure explanation is not undefined
                    points: points,
                    timeTakenMs: questionTimings[index] || 0,
                    isFlagged: flaggedQuestions[index] || false
                };
            });

            const performanceData = {
                studentName: userName || (currentUserId ? 'Anonymous User' : 'Unknown User'), 
                userId: currentUserId || null, 
                studentEmail: null, 
                examName: worksheetName,
                score: totalScore,
                totalPossibleScore: totalPossible,
                timeTaken: timeTakenString,
                goal: userGoal || '',
                focusArea: userFocusArea || '',
                focusRating: focusRatingVal || '',
                reflection: reflection || '',
                questions: detailedAnswers, 
                submissionTimestamp: firebase.firestore.FieldValue.serverTimestamp(),
                userAgent: navigator.userAgent
            };

            db.collection("performanceSubmissions").add(performanceData)
                .then((docRef) => {
                    console.log("Results saved to Firestore with ID: ", docRef.id);
                })
                .catch((error) => {
                    console.error("Error saving results to Firebase: ", error);
                });
        }
        // --- END OF SAVE RESULTS FUNCTION ---

        // --- Event Listeners ---
        startButton.addEventListener('click', () => {
            // userName = nameInput.value.trim(); // Ensure this is commented out or removed
            userGoal = goalInput.value.trim();
            userFocusArea = focusAreaInput.value.trim();

            // Initialize userName based on Firebase auth or default
            if (currentUserId) {
                userName = "User " + currentUserId.substring(0, 6); // Example: User abc123
            } else {
                userName = "User";
            }

            // Optional: If you still want a goal to be mandatory
            if (!userGoal) {
                 alert("Please enter your goal for this session.");
                 goalInput.focus();
                 return;
            }

            userAnswers = Array(questionsData.length).fill(null).map(() => Array(5).fill(null));
            flaggedQuestions = new Array(questionsData.length).fill(false);
            questionTimings = new Array(questionsData.length).fill(0);
            currentQuestionIndex = 0;
            isReviewingFromResults = false;
            isFilteringFlagged = false;
            // currentlyDisplayedPremiseIndex = -1; // Reset in showExamScreen
            lastQuestionIndexForTiming = -1; 
            currentQuestionStartTime = null; 
            examEndTime = null; // Reset exam end time

            showExamScreen();
            loadQuestion(0);
            populateNavigator();
            startTimer(); 
        });

        nextButton.addEventListener('click', showNextQuestion);
        prevButton.addEventListener('click', showPrevQuestion);
        endExamButton.addEventListener('click', endExamAndShowResults);
        endExamButtonFooter.addEventListener('click', handleEndExamFooterClick);
        backToResultsButton.addEventListener('click', () => { isReviewingFromResults = false; showResultsScreen(); });
        navigatorButton.addEventListener('click', () => { updateNavigatorButtons(); navigatorModal.classList.remove('hidden'); navigatorModal.classList.add('flex'); });
        closeModalButton.addEventListener('click', () => { navigatorModal.classList.remove('flex'); navigatorModal.classList.add('hidden'); });
        navigatorModal.addEventListener('click', (event) => { if (event.target === navigatorModal) closeModalButton.click(); });
        flagButton.addEventListener('click', toggleFlag);
        filterFlaggedButton.addEventListener('click', () => { isFilteringFlagged = !isFilteringFlagged; showReviewScreen(isFilteringFlagged); });
        downloadPdfButton.addEventListener('click', generatePDF);

        // Calculator event listeners
        calculatorToggleButton.addEventListener('click', toggleCalculator);
        closeCalculatorButton.addEventListener('click', toggleCalculator);
        makeDraggable(calculatorUI, calculatorDragHeader);

        // Add calculator button click handlers
        calcButtons.forEach(button => {
            button.addEventListener('click', () => {
                const value = button.dataset.calcValue;
                const action = button.dataset.calcAction;
                
                if (value !== undefined) { 
                    if (value === '.') { inputDecimal(); } 
                    else { inputDigit(value); }
                } else if (action) { 
                    if (['+', '-', '*', '/'].includes(action)) { handleOperator(action); } 
                    else if (action === 'equals') { calculate(); } 
                    else if (action === 'clear') { clearCalculator(); } 
                    else if (['m+', 'm-', 'mrc'].includes(action)) { handleMemory(action); } 
                    else if (['sqrt', 'percent', 'negate', 'backspace'].includes(action)) { handleSpecialFunction(action); }
                }
            });
        });

        // Initialize calculator display
        updateCalcDisplay();

        // Keyboard shortcuts (Removed Y/N and 1-5 shortcuts as they conflict with D&D)
        function handleKeyboardShortcuts(e) {
             const isExamVisible = !examScreen.classList.contains('hidden');
             const isModalVisible = navigatorModal.classList.contains('flex');
             const isInputFocused = document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA');
             const isCalcVisible = calculatorUI.classList.contains('visible');

             if (isModalVisible || isInputFocused) return;
             if (!isExamVisible) return;

             // Handle calculator keyboard shortcuts when calculator is visible
             if (isCalcVisible && !isInputFocused) {
                 if (e.key >= '0' && e.key <= '9') { 
                     e.preventDefault(); 
                     inputDigit(e.key); 
                     return; 
                 }
                 if (e.key === '.') { 
                     e.preventDefault(); 
                     inputDecimal(); 
                     return; 
                 }
                 if (e.key === '+' || e.key === '-' || e.key === '*' || e.key === '/') { 
                     e.preventDefault(); 
                     handleOperator(e.key); 
                     return; 
                 }
                 if (e.key === 'Enter' || e.key === '=') { 
                     e.preventDefault(); 
                     calculate(); 
                     return; 
                 }
                 if (e.key === 'Escape') { 
                     e.preventDefault(); 
                     toggleCalculator(); 
                     return; 
                 }
                 if (e.key === 'Backspace') { 
                     e.preventDefault(); 
                     handleSpecialFunction('backspace'); 
                     return; 
                 }
             }

             const altOrOption = e.altKey;
             const code = e.code.toLowerCase();

             if (altOrOption) {
                 switch (code) {
                     case 'keyn': e.preventDefault(); if (!nextButton.disabled) nextButton.click(); break;
                     case 'keyp': e.preventDefault(); if (!prevButton.disabled) prevButton.click(); break;
                     case 'keyf': e.preventDefault(); if (!isReviewingFromResults && !flagButton.disabled) flagButton.click(); break;
                     case 'keyc': e.preventDefault(); toggleCalculator(); break;
                 }
             }
        }
        document.addEventListener('keydown', handleKeyboardShortcuts);

        // --- Timer Functions ---
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            const formattedMinutes = String(minutes).padStart(2, '0');
            const formattedSeconds = String(remainingSeconds).padStart(2, '0');
            return `${formattedMinutes}:${formattedSeconds}`;
        }

        function updateTimerDisplay() {
            if (timerDisplay) { // timerDisplay should be defined globally by now
                timerDisplay.textContent = formatTime(timeLeft);
            }
            // Correction: timeLeft should be decremented *before* checking if it's <= 0 for the last tick
            if (timeLeft < 0) { // Check if time actually ran out
                endExamDueToTimeUp();
                return; // Stop further execution if time is up
            }
             if (timeLeft === 0 && timerDisplay) { // Ensure last 00:00 is displayed
                timerDisplay.textContent = formatTime(timeLeft);
            }
            timeLeft--;
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timeLeft = totalTimeAllowedInSeconds;
            examStartTime = new Date(); // ADDED HERE
            if (timerDisplay) timerDisplay.textContent = formatTime(timeLeft); // Initial display update
            timerInterval = setInterval(updateTimerDisplay, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            timerInterval = null;
        }

        function endExamDueToTimeUp() {
            stopTimer();
            if (!resultsScreen.classList.contains('hidden')) return; 
            
            alert("Time's up! The practice will now end.");
            recordQuestionTime(); 
            examEndTime = new Date(); 
            
            // examScreen.classList.add('hidden'); // Handled by showResultsScreen indirectly
            // reviewScreen.classList.add('hidden');
            // resultsScreen.classList.remove('hidden');
            // if (timerDisplay) timerDisplay.classList.add('hidden');
            // appContainer.scrollTop = 0;
            saveResultsToFirebase(); // Call before showing results
            showResultsScreen(); 
        }
        // End Timer Functions

        // --- Initial Load ---
        // showSetupScreen(); // Original initial load

        // --- MODIFIED Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            checkForReviewMode();
        });

        // --- NEW FUNCTION to check for and load review mode ---
        function checkForReviewMode() {
            const reviewSubmissionId = localStorage.getItem('reviewSubmissionId');
            const isReviewHash = window.location.hash === '#review';

            if (reviewSubmissionId && isReviewHash) {
                console.log("Review mode detected. Submission ID:", reviewSubmissionId);
                // Potentially show a loading indicator here
                // Disable normal setup/start
                if(setupScreen) setupScreen.classList.add('hidden');
                if(resultsScreen) resultsScreen.classList.add('hidden');
                if(reviewScreen) reviewScreen.classList.add('hidden'); // Ensure this is hidden too
                
                if (!db) {
                    console.error("Firestore (db) is not initialized. Cannot load review data.");
                    alert("Error: Could not connect to load review data.");
                    showSetupScreen(); // Fallback to normal mode
                    localStorage.removeItem('reviewSubmissionId'); // Clean up
                    return;
                }

                db.collection("performanceSubmissions").doc(reviewSubmissionId).get()
                    .then(doc => {
                        if (doc.exists) {
                            const submissionData = doc.data();
                            console.log("Submission data fetched for review:", submissionData);
                            
                            // Populate necessary global states from submissionData
                            // This is crucial for loadQuestion and other functions to work with the reviewed attempt's data
                            if (submissionData.questions && Array.isArray(submissionData.questions)) {
                                userAnswers = submissionData.questions.map(q => q.userAnswers || Array(5).fill(null));
                                flaggedQuestions = submissionData.questions.map(q => q.isFlagged || false);
                                // Note: premisesData and questionsData (the structure of questions/statements)
                                // should be the ones inherent to this specific worksheet file.
                                // The submissionData.questions provides the user's interaction with that structure.
                            } else {
                                console.error("Submission data does not have the expected 'questions' array structure.");
                                alert("Error: Could not load review data due to unexpected format.");
                                showSetupScreen(); // Fallback
                                localStorage.removeItem('reviewSubmissionId');
                                return;
                            }
                            userName = submissionData.studentName || 'Review User'; // Or some indicator
                            // examStartTime, examEndTime, questionTimings might not be directly needed for simple review of answers,
                            // but could be displayed if desired.

                            // Modify UI for review mode
                            showExamScreen(); // This sets up the basic exam layout
                            
                            // Update footer for review mode
                            const nextBtn = document.getElementById('next-button');
                            const prevBtn = document.getElementById('prev-button');
                            const endExamFoot = document.getElementById('end-exam-button-footer');
                            const navigatorBtn = document.getElementById('navigator-button');
                            const backToDashResultsButton = document.createElement('button');

                            if(nextBtn) nextBtn.textContent = 'Next Question →';
                            if(endExamFoot) endExamFoot.style.display = 'none'; // Hide regular end practice button
                            if(navigatorBtn) navigatorBtn.style.display = 'none'; // Hide navigator in review mode
                            if(flagButton) flagButton.style.display = 'none'; // Hide flag button in review
                            if(timerDisplay) timerDisplay.style.display = 'none'; // Hide timer
                            if(document.getElementById('draggable-options-sidebar')) document.getElementById('draggable-options-sidebar').style.display = 'none';


                            backToDashResultsButton.textContent = '← Back to Dashboard Results';
                            backToDashResultsButton.className = 'secondary-button'; // Use existing styling
                            backToDashResultsButton.onclick = () => {
                                if(localStorage.getItem('returnToDashboardResults')) {
                                    localStorage.removeItem('reviewSubmissionId');
                                    localStorage.removeItem('returnToDashboardResults');
                                    window.location.href = 'student_dashboard.html#results';
                                } else {
                                     window.location.href = 'student_dashboard.html'; // Fallback
                                }
                            };
                            const footerBar = document.querySelector('.footer-bar');
                            if (footerBar) {
                                const existingBackToResults = footerBar.querySelector('#back-to-dashboard-results-review');
                                if (existingBackToResults) existingBackToResults.remove();
                                backToDashResultsButton.id = 'back-to-dashboard-results-review';
                                footerBar.insertBefore(backToDashResultsButton, footerBar.firstChild);
                            }

                            currentQuestionIndex = 0; // Start review from the first question
                            loadQuestion(currentQuestionIndex, true); // Load in review mode (true)

                            // Clear the localStorage item now that it's used, or on page unload
                            // For simplicity, clearing it here. Could also do it in an onbeforeunload handler.
                            // localStorage.removeItem('reviewSubmissionId'); 
                            // Actually, let's keep it until they navigate away, so refresh works.
                            // The `returnToDashboardResults` flag will help manage this.

                        } else {
                            console.error("No such submission document! ID:", reviewSubmissionId);
                            alert("Could not find the submission to review. It may have been deleted.");
                            showSetupScreen(); // Fallback
                            localStorage.removeItem('reviewSubmissionId');
                        }
                    }).catch(error => {
                        console.error("Error getting submission document:", error);
                        alert("Error fetching review data. Please try again.");
                        showSetupScreen(); // Fallback
                        localStorage.removeItem('reviewSubmissionId');
                    });
            } else {
                // Not in review mode, normal startup
                if(reviewSubmissionId) localStorage.removeItem('reviewSubmissionId'); // Clean up if hash is wrong
                if(localStorage.getItem('returnToDashboardResults')) localStorage.removeItem('returnToDashboardResults');
                showSetupScreen();
            }
        }

    </script>
</body>
</html>

