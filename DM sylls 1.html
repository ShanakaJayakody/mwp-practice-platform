<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UCAT DM Syllogisms Worksheet 1 - MedwithPurpose</title>
    <link rel="icon" href="https://ik.imagekit.io/mwp/2.svg?updatedAt=1745982956185" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Firebase SDK -->
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
    <style id="m3-styles">
        /* M3 Base Styles */
        :root {
          /* Brand Colors - DM Theme (Indigo/Purple) */
          --md-sys-color-primary: #6750A4; /* M3 Purple */
          --md-sys-color-on-primary: #FFFFFF;
          --md-sys-color-primary-container: #EADDFF;
          --md-sys-color-on-primary-container: #21005D;

          --md-sys-color-secondary: #625B71; /* M3 Neutral Purple-ish */
          --md-sys-color-on-secondary: #FFFFFF;
          --md-sys-color-secondary-container: #E8DEF8;
          --md-sys-color-on-secondary-container: #1D192B;

          --md-sys-color-tertiary: #7D5260; /* M3 Tertiary Pink-ish */
          --md-sys-color-on-tertiary: #FFFFFF;
          --md-sys-color-tertiary-container: #FFD8E4;
          --md-sys-color-on-tertiary-container: #31111D;

          /* Neutral Colors */
          --md-sys-color-background: #F8F9FA; 
          --md-sys-color-on-background: #1A1C1E;
          --md-sys-color-surface: #FFFFFF; 
          --md-sys-color-on-surface: #1A1C1E;
          --md-sys-color-surface-variant: #E7E0EC;
          --md-sys-color-on-surface-variant: #49454F;
          --md-sys-color-surface-container-lowest: #FFFFFF;
          --md-sys-color-surface-container-low: #F7F2FA;
          --md-sys-color-surface-container: #F3EDF7;
          --md-sys-color-surface-container-high: #ECE6F0;
          --md-sys-color-surface-container-highest: #E6E0E9;

          --md-sys-color-outline: #79747E;
          --md-sys-color-outline-variant: #CAC4D0;

          /* Utility Colors */
          --md-sys-color-error: #B3261E; 
          --md-sys-color-on-error: #FFFFFF;
          --md-sys-color-error-container: #F9DEDC;
          --md-sys-color-on-error-container: #410E0B;
          --md-sys-color-scrim: #000000;
          --md-sys-color-scrim-rgb: 0,0,0;

          /* Shape */
          --md-sys-shape-corner-none: 0px;
          --md-sys-shape-corner-extra-small: 4px;
          --md-sys-shape-corner-small: 8px;
          --md-sys-shape-corner-medium: 12px;
          --md-sys-shape-corner-large: 16px;
          --md-sys-shape-corner-extra-large: 28px;
          --md-sys-shape-corner-full: 9999px;

          /* Typography - Using Inter as base */
          --md-sys-typescale-font-family-name: 'Inter', sans-serif;
          --md-sys-typescale-display-large-font-size: 3.5625rem; 
          --md-sys-typescale-display-large-line-height: 4rem; 
          --md-sys-typescale-display-large-font-weight: 400;
          --md-sys-typescale-headline-large-font-size: 2rem; 
          --md-sys-typescale-headline-large-line-height: 2.5rem; 
          --md-sys-typescale-headline-large-font-weight: 700; 
          --md-sys-typescale-title-large-font-size: 1.375rem; 
          --md-sys-typescale-title-large-line-height: 1.75rem; 
          --md-sys-typescale-title-large-font-weight: 700;
          --md-sys-typescale-body-large-font-size: 1rem; 
          --md-sys-typescale-body-large-line-height: 1.5rem; 
          --md-sys-typescale-body-large-font-weight: 400;
          --md-sys-typescale-label-large-font-size: 0.875rem; 
          --md-sys-typescale-label-large-line-height: 1.25rem; 
          --md-sys-typescale-label-large-font-weight: 600;
        }

        .m3-button {
          font-family: var(--md-sys-typescale-label-large-font-family-name);
          font-size: var(--md-sys-typescale-label-large-font-size);
          font-weight: var(--md-sys-typescale-label-large-font-weight);
          line-height: var(--md-sys-typescale-label-large-line-height);
          padding: 0.625rem 1.5rem; 
          border-radius: var(--md-sys-shape-corner-full);
          border: none;
          cursor: pointer;
          text-align: center;
          text-decoration: none;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          min-height: 2.5rem; 
          transition: background-color 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease;
        }
        .m3-button:hover:not(:disabled) { box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06); }
        .m3-button:active:not(:disabled) { transform: scale(0.97); box-shadow: none; }
        .m3-button:disabled { cursor: not-allowed; box-shadow: none; }
        .m3-button .material-symbols-outlined { font-size: 1.125rem; margin-right: 0.5rem; }
        .m3-button.icon-only .material-symbols-outlined { margin-right: 0; }

        .m3-button-filled {
          background-color: var(--md-sys-color-primary);
          color: var(--md-sys-color-on-primary);
        }
        .m3-button-filled:hover:not(:disabled) { background-color: color-mix(in srgb, var(--md-sys-color-primary) 92%, var(--md-sys-color-on-primary) 8%); }
        .m3-button-filled:disabled {
          background-color: color-mix(in srgb, var(--md-sys-color-on-surface) 12%, transparent);
          color: color-mix(in srgb, var(--md-sys-color-on-surface) 38%, transparent);
        }
        .m3-button-filled-error {
          background-color: var(--md-sys-color-error);
          color: var(--md-sys-color-on-error);
        }
        .m3-button-filled-error:hover:not(:disabled) { background-color: color-mix(in srgb, var(--md-sys-color-error) 92%, var(--md-sys-color-on-error) 8%);}

        .m3-button-outlined {
          background-color: transparent;
          color: var(--md-sys-color-primary);
          border: 1px solid var(--md-sys-color-outline);
        }
        .m3-button-outlined:hover:not(:disabled) { background-color: color-mix(in srgb, var(--md-sys-color-primary) 8%, transparent); }
        .m3-button-outlined:disabled {
          border-color: color-mix(in srgb, var(--md-sys-color-on-surface) 12%, transparent);
          color: color-mix(in srgb, var(--md-sys-color-on-surface) 38%, transparent);
        }

        .m3-button-text {
          background-color: transparent;
          color: var(--md-sys-color-primary);
          padding: 0.625rem 0.75rem; 
        }
        .m3-button-text:hover:not(:disabled) { background-color: color-mix(in srgb, var(--md-sys-color-primary) 8%, transparent); }
        .m3-button-text:disabled { color: color-mix(in srgb, var(--md-sys-color-on-surface) 38%, transparent); }
        
        .m3-icon-button {
          display: inline-flex; align-items: center; justify-content: center;
          width: 2.5rem; height: 2.5rem; 
          padding: 0.5rem; 
          border-radius: var(--md-sys-shape-corner-full);
          background-color: transparent;
          color: var(--md-sys-color-on-surface-variant);
          border: none; cursor: pointer;
        }
        .m3-icon-button .material-symbols-outlined { font-size: 1.5rem; margin: 0; }
        .m3-icon-button:hover:not(:disabled) { background-color: color-mix(in srgb, currentColor 12%, transparent); }
        .m3-icon-button:disabled { color: color-mix(in srgb, var(--md-sys-color-on-surface) 38%, transparent); background-color: transparent; }
        .m3-icon-button.selected {
            background-color: color-mix(in srgb, var(--md-sys-color-primary) 12%, transparent);
            color: var(--md-sys-color-primary);
        }
        .m3-icon-button.selected .material-symbols-outlined {
            font-variation-settings: 'FILL' 1;
        }

        .m3-dialog-scrim {
          position: fixed; top: 0; left: 0; width: 100%; height: 100%;
          background-color: rgba(var(--md-sys-color-scrim-rgb), 0.4);
          display: flex; align-items: center; justify-content: center;
          z-index: 100;
        }
        .m3-dialog {
          background-color: var(--md-sys-color-surface-container-high);
          color: var(--md-sys-color-on-surface);
          border-radius: var(--md-sys-shape-corner-extra-large);
          padding: 1.5rem;
          width: calc(100% - 3.5rem);
          max-width: 35rem;
          box-shadow: 0px 8px 12px 6px rgba(0,0,0,0.15), 0px 4px 8px rgba(0,0,0,0.3);
          display: flex; flex-direction: column;
          max-height: calc(100% - 3.5rem);
        }
        .m3-dialog-title {
          font-family: var(--md-sys-typescale-font-family-name);
          font-size: 1.5rem; 
          font-weight: 600;
          line-height: 2rem; 
          color: var(--md-sys-color-on-surface);
          margin-bottom: 1rem; 
        }
        .m3-dialog-content {
          font-family: var(--md-sys-typescale-body-large-font-family-name);
          color: var(--md-sys-color-on-surface-variant);
          margin-bottom: 1.5rem; 
          overflow-y: auto;
        }
        .m3-dialog-actions { display: flex; justify-content: flex-end; gap: 0.5rem; }

        /* Typography helpers */
        .m3-body-large {
          font-family: var(--md-sys-typescale-body-large-font-family-name);
          font-size: var(--md-sys-typescale-body-large-font-size);
          font-weight: var(--md-sys-typescale-body-large-font-weight);
          line-height: var(--md-sys-typescale-body-large-line-height);
          color: var(--md-sys-color-on-surface);
        }
        .m3-title-large {
          font-family: var(--md-sys-typescale-title-large-font-family-name);
          font-size: var(--md-sys-typescale-title-large-font-size);
          font-weight: var(--md-sys-typescale-title-large-font-weight);
          line-height: var(--md-sys-typescale-title-large-line-height);
          color: var(--md-sys-color-on-surface);
        }
        .m3-label-large {
          font-family: var(--md-sys-typescale-label-large-font-family-name);
          font-size: var(--md-sys-typescale-label-large-font-size);
          font-weight: var(--md-sys-typescale-label-large-font-weight);
          line-height: var(--md-sys-typescale-label-large-line-height);
        }

        /* Material Symbols base style */
        .material-symbols-outlined {
          font-family: 'Material Symbols Outlined';
          font-weight: normal; font-style: normal;
          font-size: 24px; line-height: 1;
          letter-spacing: normal; text-transform: none;
          display: inline-block; white-space: nowrap; word-wrap: normal;
          direction: ltr;
          -webkit-font-smoothing: antialiased;
          text-rendering: optimizeLegibility;
          -moz-osx-font-smoothing: grayscale;
          font-feature-settings: 'liga';
        }
    </style>
    <style>
        /* Custom styles for better UI/UX */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent scrolling on body */
        }
        body {
            font-family: var(--md-sys-typescale-font-family-name); /* M3 Base Font */
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--md-sys-color-background); /* M3 */
        }
        #app-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 2rem); /* Full height minus padding */
            width: 100%;
            background-color: var(--md-sys-color-surface-container-low); /* M3 */
            border: 1px solid var(--md-sys-color-outline-variant); /* M3 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); /* Softer shadow consistent with M3 elevation 1 */
            border-radius: var(--md-sys-shape-corner-large); /* M3 */
            margin: 1rem; /* Add some margin */
            overflow: hidden; /* Prevent content overflow from container */
            position: relative; /* For calculator positioning */
        }
        /* Header and Footer */
        .header-bar { /* Topmost bar */
            flex-shrink: 0;
            background-color: var(--md-sys-color-primary); /* M3 */
            color: var(--md-sys-color-on-primary); /* M3 */
            padding: 0.75rem 1.5rem; /* Increased padding slightly */
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 20; /* Ensure it's above the secondary bar if overlapping */
        }

        .secondary-toolbar { /* New toolbar for calculator and flag */
            flex-shrink: 0;
            background-color: var(--md-sys-color-surface-container-high); /* M3 Surface variant */
            color: var(--md-sys-color-on-surface-variant); /* M3 */
            padding: 0.5rem 1.5rem; /* Consistent padding */
            display: flex;
            justify-content: flex-end; /* Only flag button on right for Syllogisms */
            align-items: center;
            border-bottom: 1px solid var(--md-sys-color-outline-variant); /* M3 */
            z-index: 19;
        }

        /* Specific text colors within header/footer */
        .header-bar span, .header-bar div, .secondary-toolbar span, .secondary-toolbar div {
             color: inherit; /* M3: inherit from parent */
        }
        #timer {
             background-color: color-mix(in srgb, var(--md-sys-color-on-primary) 15%, transparent); /* M3 subtle bg on primary */
             color: var(--md-sys-color-on-primary); /* M3 */
             font-family: var(--md-sys-typescale-label-large-font-family-name);
             font-size: var(--md-sys-typescale-label-large-font-size);
             font-weight: var(--md-sys-typescale-label-large-font-weight);
             padding: 0.375rem 0.75rem; 
             border-radius: var(--md-sys-shape-corner-small); 
        }
        
        /* Buttons in secondary toolbar - to become M3 text or icon buttons */
        .secondary-toolbar-button {\n            font-family: var(--md-sys-typescale-label-large-font-family-name);\n            font-size: var(--md-sys-typescale-label-large-font-size);\n            font-weight: var(--md-sys-typescale-label-large-font-weight);\n            padding: 0.5rem 0.75rem; \n            border-radius: var(--md-sys-shape-corner-full);\n            background-color: transparent;\n            color: var(--md-sys-color-on-surface-variant); /* M3 */\n            border: none; \n            transition: background-color 0.2s ease;\n            margin-left: 0.5rem; \n            display: inline-flex;\n            align-items: center;\n            cursor:pointer;\n        }\n        .secondary-toolbar-button:hover:not(:disabled) {\n            background-color: color-mix(in srgb, var(--md-sys-color-on-surface-variant) 8%, transparent); /* M3 hover */\n        }\n        .secondary-toolbar-button.active { \n            background-color: color-mix(in srgb, var(--md-sys-color-secondary-container) 60%, transparent);\n            color: var(--md-sys-color-on-secondary-container);\n        }\n         .secondary-toolbar-button .material-symbols-outlined {\n            margin-right: 0.25rem;\n            font-size: 1.25rem; /* 20px */\n         }\n


         /* Footer Button Styling */
        .footer-bar {
            flex-shrink: 0;
            background-color: var(--md-sys-color-surface-container); /* M3 surface for footer */
            color: var(--md-sys-color-on-surface); /* M3 */
            padding: 0.75rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid var(--md-sys-color-outline-variant);
        }
        .footer-bar button {
            font-family: var(--md-sys-typescale-label-large-font-family-name);
            font-size: var(--md-sys-typescale-label-large-font-size);
            font-weight: var(--md-sys-typescale-label-large-font-weight);
            padding: 0.5rem 1rem; 
            border-radius: var(--md-sys-shape-corner-full);
            transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
            min-height: 2.25rem; /* 36px */
            display: inline-flex;
            align-items: center;
            cursor: pointer;
        }
        .footer-bar button:not(#next-button):not(#end-practice-session-button-footer) {
            background-color: transparent;
             color: var(--md-sys-color-primary);
             border: none;
        }
        .footer-bar button:not(#next-button):not(#end-practice-session-button-footer):hover:not(:disabled) {
             background-color: color-mix(in srgb, var(--md-sys-color-primary) 8%, transparent);
        }
        
        .footer-bar button:disabled {\n             opacity: 1; \n             cursor: not-allowed;\n             background-color: color-mix(in srgb, var(--md-sys-color-on-surface) 12%, transparent) !important; \n             color: color-mix(in srgb, var(--md-sys-color-on-surface) 38%, transparent) !important;\n             border-color: transparent !important; \n         }\n         .footer-bar button#next-button:disabled {\n            border: none !important;\n         }\n

         .footer-bar button#next-button {\n             background-color: var(--md-sys-color-primary); \n             color: var(--md-sys-color-on-primary); \n             border: none;\n         }\n         .footer-bar button#next-button:hover:not(:disabled) {\n             background-color: color-mix(in srgb, var(--md-sys-color-primary) 92%, var(--md-sys-color-on-primary) 8%); \n         }\n         #flag-button {\n             /* Uses .secondary-toolbar-button styles */\n         }\n         #flag-button.flagged {\n             background-color: var(--md-sys-color-tertiary-container) !important; \n             color: var(--md-sys-color-on-tertiary-container) !important;\n          }\n          #flag-button.flagged .material-symbols-outlined {\n             font-variation-settings: \'FILL\' 1;\n          }\n

        /* Main Content Area */
        .main-content-area {
            flex-grow: 1; 
            display: flex; /* For two-column layout */
            overflow: hidden; 
            padding: 1rem; 
            gap: 1rem; /* Gap between columns */
            background-color: var(--md-sys-color-surface); /* M3 */
        }
        .passage-column, .question-column {
            flex: 1; /* Each column takes half the space */
            overflow-y: auto;
            padding: 1rem;
            border: none; 
            border-radius: var(--md-sys-shape-corner-medium); /* M3 */
            background-color: var(--md-sys-color-surface-container-lowest); /* M3 */
             height: 100%; 
             position: relative; 
            color: var(--md-sys-color-on-surface); /* M3 text color */
            font-family: var(--md-sys-typescale-body-large-font-family-name);
            font-size: var(--md-sys-typescale-body-large-font-size);
            line-height: var(--md-sys-typescale-body-large-line-height);
        }
        .question-column h4 { /* Question X */
            font-family: var(--md-sys-typescale-title-large-font-family-name);
            font-size: var(--md-sys-typescale-title-large-font-size);
            font-weight: var(--md-sys-typescale-title-large-font-weight);
            color: var(--md-sys-color-on-surface-variant);
            margin-bottom: 0.75rem;
        }
        .question-column p#question-text { /* Question text itself */
            font-size: 1.125rem; 
            line-height: 1.625rem;
            margin-bottom: 1.25rem;
        }
        .passage-column p, .passage-column div { /* Passage text */
             font-size: var(--md-sys-typescale-body-large-font-size);
             line-height: var(--md-sys-typescale-body-large-line-height);
             color: var(--md-sys-color-on-surface-variant);
        }
        .passage-column h3 {\n            font-family: var(--md-sys-typescale-title-large-font-family-name);\n            font-size: 1.25rem; /* Slightly smaller for passage title */\n            font-weight: 600;\n            color: var(--md-sys-color-on-surface);\n            margin-bottom: 0.75rem;\n        }\n

        /* Syllogism Yes/No Buttons */
        .syllogism-options {\n            display: flex;\n            gap: 1rem;\n            margin-top: 1.5rem;\n        }\n        .syllogism-button {\n            /* Use M3 Filled Button styles */\n            flex-grow: 1;\n            font-family: var(--md-sys-typescale-label-large-font-family-name);\n            font-size: var(--md-sys-typescale-label-large-font-size);\n            font-weight: var(--md-sys-typescale-label-large-font-weight);\n            padding: 0.75rem 1.5rem; /* M3 standard button padding */\n            border-radius: var(--md-sys-shape-corner-full);\n            border: none;\n            cursor: pointer;\n            text-align: center;\n            transition: background-color 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease;\n        }\n        .syllogism-button.yes {\n            background-color: var(--md-sys-color-primary);\n            color: var(--md-sys-color-on-primary);\n        }\n        .syllogism-button.yes:hover:not(:disabled) { background-color: color-mix(in srgb, var(--md-sys-color-primary) 90%, var(--md-sys-color-on-primary) 10%); }\n        \n        .syllogism-button.no {\n            background-color: var(--md-sys-color-error);\n            color: var(--md-sys-color-on-error);\n        }\n        .syllogism-button.no:hover:not(:disabled) { background-color: color-mix(in srgb, var(--md-sys-color-error) 90%, var(--md-sys-color-on-error) 10%); }\n

        .syllogism-button.selected {\n            box-shadow: 0 0 0 3px var(--md-sys-color-outline-variant), inset 0 2px 4px rgba(0,0,0,0.2);\n            transform: scale(0.98);\n        }\n         .syllogism-button:disabled {\n            background-color: color-mix(in srgb, var(--md-sys-color-on-surface) 12%, transparent) !important;\n            color: color-mix(in srgb, var(--md-sys-color-on-surface) 38%, transparent) !important;\n            cursor: not-allowed;\n            box-shadow: none;\n         }\n

        .nav-answered { background-color: var(--md-sys-color-secondary-container); color: var(--md-sys-color-on-secondary-container); border-color: var(--md-sys-color-secondary);}\n        .nav-current { border: 2px solid var(--md-sys-color-primary) !important; font-weight: bold; background-color: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container); }\n        .nav-flagged, .review-flagged { border: 2px solid var(--md-sys-color-tertiary) !important; position: relative; background-color: var(--md-sys-color-tertiary-container); color: var(--md-sys-color-on-tertiary-container); }\n        
        .modal { /* Scrim part */
            display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; 
            overflow: auto; 
            background-color: rgba(var(--md-sys-color-scrim-rgb), 0.4); /* M3 Scrim */
            align-items: center; justify-content: center; 
        }
        .modal-content { /* Dialog part */
            background-color: var(--md-sys-color-surface-container-high); /* M3 */
            color: var(--md-sys-color-on-surface); /* M3 */
            margin: auto; padding: 1.5rem; /* 24px */ 
            border: none; /* M3 dialogs don\'t usually have borders */
            width: calc(100% - 3.5rem); max-width: 35rem; /* M3 sizing */
            border-radius: var(--md-sys-shape-corner-extra-large); /* 28px M3 */
            box-shadow: 0px 8px 12px 6px rgba(0,0,0,0.15), 0px 4px 8px rgba(0,0,0,0.3); /* M3 Elevation 3 */
        }
        .modal.flex { display: flex; }
        .modal-content .flex.justify-between.items-center h3 {\n            font-family: var(--md-sys-typescale-font-family-name);\n            font-size: 1.5rem; /* 24px */\n            font-weight: 600;\n            color: var(--md-sys-color-on-surface);\n        }\n        .modal-content #close-modal-button { /* Style as M3 Icon button */\n            font-size: 1.5rem; /* Icon size */\n            color: var(--md-sys-color-on-surface-variant);\n            background: transparent; border: none; padding: 0.5rem;\n            border-radius: var(--md-sys-shape-corner-full);\n            cursor:pointer;\n        }\n         .modal-content #close-modal-button:hover {\n            background-color: color-mix(in srgb, var(--md-sys-color-on-surface-variant) 8%, transparent);\n         }\n

        button, .button {
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            border-radius: var(--md-sys-shape-corner-full); 
            padding: 0.625rem 1.5rem; 
            font-family: var(--md-sys-typescale-label-large-font-family-name);
            font-size: var(--md-sys-typescale-label-large-font-size);
            font-weight: var(--md-sys-typescale-label-large-font-weight);
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); cursor: pointer;
            border: none; 
        }
        button:active, .button:active { transform: scale(0.98); }
        button:disabled { 
            opacity: 1; 
            cursor: not-allowed; 
            color: color-mix(in srgb, var(--md-sys-color-on-surface) 38%, transparent) !important;
            background-color: color-mix(in srgb, var(--md-sys-color-on-surface) 12%, transparent) !important;
            border-color: transparent !important;
        }
        .m3-button-outlined:disabled { 
            border: 1px solid color-mix(in srgb, var(--md-sys-color-on-surface) 12%, transparent) !important;
        }

        .primary-button { 
            background-color: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary);
        }
        .primary-button:hover:not(:disabled) { background-color: color-mix(in srgb, var(--md-sys-color-primary) 92%, var(--md-sys-color-on-primary) 8%); }
        
        .secondary-button { 
            background-color: transparent; color: var(--md-sys-color-primary); border: 1px solid var(--md-sys-color-outline);
        }
        .secondary-button:hover:not(:disabled) { background-color: color-mix(in srgb, var(--md-sys-color-primary) 8%, transparent); }
        
        .danger-button { 
            background-color: var(--md-sys-color-error); color: var(--md-sys-color-on-error);
        }
        .danger-button:hover:not(:disabled) { background-color: color-mix(in srgb, var(--md-sys-color-error) 92%, var(--md-sys-color-on-error) 8%); }
        
        .option-label {
            /* This class is not used for DM syllogisms options; .syllogism-button is used instead */
        }

        #results-details-grid {
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); 
            gap: 0.75rem; 
            padding-top: 0.5rem; 
            max-width: 950px; 
            margin-left: auto; 
            margin-right: auto;
        }
        .result-summary-item { display: flex; flex-direction: column; align-items: center; text-align: center; }
        .result-summary-box {
            width: 60px; 
            height: 60px; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: var(--md-sys-shape-corner-medium); 
            font-weight: 600; 
            color: var(--md-sys-color-on-primary); 
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 0.25rem;
        }
        .result-summary-box:hover { transform: translateY(-2px); box-shadow: 0 3px 6px rgba(0,0,0,0.15); }
        .correct-box { background-color: var(--md-sys-color-primary-container); border: 1px solid var(--md-sys-color-primary); color: var(--md-sys-color-on-primary-container); }
        .incorrect-box { background-color: var(--md-sys-color-error-container); border: 1px solid var(--md-sys-color-error); color: var(--md-sys-color-on-error-container); }
        .not-answered-box { background-color: var(--md-sys-color-surface-variant); border: 1px solid var(--md-sys-color-outline); color: var(--md-sys-color-on-surface-variant); }
        .time-display-in-box { font-size: 0.8rem; line-height: 1; }
        .question-number-label { margin-top: 0; font-size: 0.75rem; font-weight: 500; }
        
        .explanation-box {
             background-color: var(--md-sys-color-surface-container-high); 
             border: 1px solid var(--md-sys-color-outline-variant); 
             padding: 0.75rem 1rem; 
             margin-top: 0.75rem; border-radius: var(--md-sys-shape-corner-medium); 
             font-family: var(--md-sys-typescale-body-large-font-family-name);
             color: var(--md-sys-color-on-surface-variant); 
        }
        .review-grid-button {
             padding: 0.5rem 0.25rem; border: 1px solid var(--md-sys-color-outline); 
             border-radius: var(--md-sys-shape-corner-medium); 
             text-align: center; transition: background-color 0.2s ease, border-color 0.2s ease;
             font-family: var(--md-sys-typescale-label-large-font-family-name);
             cursor: pointer;
             background-color: var(--md-sys-color-surface-container);
             color: var(--md-sys-color-on-surface-variant);
        }
        .review-grid-button-answered { background-color: var(--md-sys-color-secondary-container); border-color: var(--md-sys-color-secondary); color: var(--md-sys-color-on-secondary-container); }
        .review-grid-button-unanswered { background-color: var(--md-sys-color-surface-variant); border-color: var(--md-sys-color-outline); color: var(--md-sys-color-on-surface-variant); }
        .review-grid-button:hover { filter: brightness(95%); }

        /* No calculator for DM Syllogisms */
        #calculator-ui { display: none !important; }

        @media (max-width: 1024px) {
            #results-details-grid { 
                grid-template-columns: repeat(auto-fill, minmax(55px, 1fr));
                max-width: 760px;
            }
            .result-summary-box { width: 55px; height: 55px; }
        }
        
        @media (max-width: 768px) {
            #app-container { height: auto; margin: 0.5rem; border-radius:var(--md-sys-shape-corner-medium); }
            .main-content-area { flex-direction: column; padding: 0.5rem; gap: 0.5rem; }
            .passage-column, .question-column { flex-basis: auto; width: 100%; height: auto; max-height: none; padding: 0.75rem; }
            .header-bar, .secondary-toolbar, .footer-bar { padding: 0.5rem 1rem; }
            .header-bar span, .footer-bar button, .secondary-toolbar-button { font-size: var(--md-sys-typescale-label-large-font-size); }
            button, .button { padding: 0.5rem 1rem; }
            .footer-bar button { padding: 0.5rem 0.75rem; }
            #review-grid { grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); } 
            .review-grid-button { font-size: 0.8rem; }
            #results-details-grid { 
                grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); 
                gap: 0.5rem;
                max-width: 450px;
             }
             .result-summary-box { width: 50px; height: 50px; }
            .time-display-in-box { font-size: 0.75rem; }
            .syllogism-options { flex-direction: column; }
        }
         @media (max-width: 480px) {\n             #review-grid { grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); } \n             .header-bar span, .footer-bar button, .secondary-toolbar-button { font-size: 0.8rem; }\n             button, .button { padding: 0.4rem 0.8rem; }\n             .footer-bar button { padding: 0.4rem 0.6rem; }\n             .review-grid-button { font-size: 0.75rem; border-radius: var(--md-sys-shape-corner-small); }\n             #results-details-grid { \n                grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); \n                gap: 0.5rem;\n                max-width: 100%; \n                padding-left: 0.5rem; padding-right: 0.5rem;\n             }\n             .result-summary-box { width: 45px; height: 45px; border-radius: var(--md-sys-shape-corner-small); }\n             .time-display-in-box { font-size: 0.65rem; }\n             .question-number-label { font-size: 0.65rem; }\n             .syllogism-button { font-size: 0.875rem; padding: 0.625rem 1rem; }\n         }\n    </style>
</head> 
<body>
    <div id="app-container">

        <div id="setup-screen" class="p-6 md:p-8 flex flex-col justify-center items-center h-full bg-[var(--md-sys-color-surface)]">
             <div class="text-center mb-6">
                <img src="https://ik.imagekit.io/mwp/MWP%20Color%20no%20background.png?updatedAt=1745982959141"
                     alt="MedwithPurpose Logo" class="mx-auto h-11 w-auto mb-4" onerror="this.style.display='none'; this.onerror=null;">
                <h1 class="text-2xl md:text-3xl font-bold text-[var(--md-sys-color-primary)] m3-headline-large" id="worksheet-title-setup">DM Syllogisms Worksheet 1</h1>
                <p class="text-[var(--md-sys-color-on-surface-variant)] mt-2 m3-body-large">Prepare for the UCAT DM Syllogisms section.</p>
                 <p class="text-sm text-[var(--md-sys-color-on-surface-variant)] mt-4 m3-label-large">
                     This section contains <strong id="setup-question-count">10 questions</strong> and you have <strong id="setup-time-limit">10 minutes</strong> to complete it.
                 </p>
            </div>
            <div class="space-y-4 w-full max-w-md">
                <div>
                    <label for="goal" class="block text-sm font-medium text-[var(--md-sys-color-on-surface-variant)] m3-label-large">Goal (Score out of 10):</label>
                    <input type="number" id="goal" name="goal" min="0" max="10" class="mt-1 block w-full px-3 py-2 border border-[var(--md-sys-color-outline)] rounded-md shadow-sm focus:outline-none focus:ring-[var(--md-sys-color-primary)] focus:border-[var(--md-sys-color-primary)] sm:text-sm bg-[var(--md-sys-color-surface-container-lowest)] text-[var(--md-sys-color-on-surface)] m3-body-large" placeholder="e.g., 8">
                </div>
                <div>
                    <label for="focus-area" class="block text-sm font-medium text-[var(--md-sys-color-on-surface-variant)] m3-label-large">Area of Focus / Intention For Practice:</label>
                    <input type="text" id="focus-area" name="focus-area" class="mt-1 block w-full px-3 py-2 border border-[var(--md-sys-color-outline)] rounded-md shadow-sm focus:outline-none focus:ring-[var(--md-sys-color-primary)] focus:border-[var(--md-sys-color-primary)] sm:text-sm bg-[var(--md-sys-color-surface-container-lowest)] text-[var(--md-sys-color-on-surface)] m3-body-large" placeholder="e.g., Identifying conclusions, Speed">
                </div>
            </div>
            <div class="mt-8 text-center space-y-3">
                <button id="start-button" class="m3-button m3-button-filled text-lg px-8 py-3">Begin</button>
                <button onclick="window.location.href='practice.html'" class="m3-button m3-button-outlined text-lg px-8 py-3">Return to Practice Page</button>
            </div>
        </div>

        <div id="practice-session-screen" class="hidden flex flex-col h-full bg-[var(--md-sys-color-surface-container-low)]">
            <div class="header-bar">
                <span id="practice-session-title" class="m3-title-large" style="color: var(--md-sys-color-on-primary);">DM Syllogisms Worksheet 1</span>
                <div class="flex items-center space-x-4">
                    <div id="timer" class="text-base px-3 py-1 rounded-md">10:00</div>
                    <span class="text-sm m3-label-large" style="color: var(--md-sys-color-on-primary);">Question <span id="question-number-info">1</span> of 10</span>
                </div>
            </div>
            <div class="secondary-toolbar">
                 <div>
                    <label for="reflection-text" class="block text-md font-semibold text-gray-700 mb-1">Main takeaway from this practice:</label>
                    <textarea id="reflection-text" name="reflection-text" rows="3" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Reflect on your performance, strategies, or areas for improvement..."></textarea>
                 </div>
            </div>
              <div class="mt-6 text-center flex-shrink-0 flex flex-col sm:flex-row justify-center items-center space-y-3 sm:space-y-0 sm:space-x-4">
                <button onclick="window.location.href='student_dashboard.html'" class="secondary-button px-6 py-2 w-full sm:w-auto">Return to Dashboard</button>
                <button onclick="window.location.reload()" class="secondary-button px-6 py-2 w-full sm:w-auto">Try Again</button>
                <div class="w-full sm:w-auto relative group">
                    <button id="submit-performance-button" class="primary-button px-6 py-2 w-full">Submit Reflections</button>
                    <div class="absolute left-0 right-0 -top-10 bg-blue-100 text-blue-800 text-xs p-1 rounded border border-blue-200 opacity-0 group-hover:opacity-100 transition-opacity">
                        â†“ Optional: Submit your reflection on this practice session
                    </div>
                </div>
                <button id="download-pdf-button" class="primary-button px-6 py-2 w-full sm:w-auto">Download Results PDF</button>
            </div>
        </div>

        <div id="navigator-modal" class="modal">
            <div class="modal-content bg-white p-6 rounded-lg shadow-xl">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">Question Navigator</h3>
                    <button id="close-modal-button" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
                </div>
                 <p class="text-sm text-gray-600 mb-4">Click a number to jump. Green: answered, Yellow border: flagged.</p>
                <div id="navigator-grid" class="grid grid-cols-4 gap-3"> </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyASKsaFFTZ-finv2d5egR9K_mZNstEwdns",
          authDomain: "mwp-qr-test-page.firebaseapp.com",
          projectId: "mwp-qr-test-page",
          storageBucket: "mwp-qr-test-page.appspot.com", 
          messagingSenderId: "309084045110",
          appId: "1:309084045110:web:b09ca0fdff84b094963d97",
          measurementId: "G-4M3ED641M9"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); // Initialize Firestore

        // Check for review mode from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const reviewParam = urlParams.get('review');
        
        // Check if user is logged in via Firebase
        firebase.auth().onAuthStateChanged(user => {
          if (user) {
                console.log("User is logged in:", user.displayName, user.email);
          } else {
                console.log("No user is logged in");
            }
        });
        
        // Expose startTest function to global window object so it can be called from onclick
        window.startTest = function() {
            console.log("startTest() function called directly");
            
            // Get user info from Firebase Auth if available
            if (firebase.auth && firebase.auth().currentUser) {
                const currentUser = firebase.auth().currentUser;
                userName = currentUser.displayName || currentUser.email || '';
                // Store email to be used later in submission
                userEmail = currentUser.email || '';
                console.log("Using user info from Firebase:", userName, userEmail);
            } else {
                userName = '';
                userEmail = '';
                console.log("No user logged in - using empty user info");
            }
            
            userGoal = document.getElementById('goal').value.trim();
            userFocusArea = document.getElementById('focus-area').value.trim();
            timeLeft = 360; // 6 minutes in seconds
            
            // Make sure arrays are properly initialized with the correct length
            if (userAnswers.length !== questions.length) {
                userAnswers = new Array(questions.length).fill(null);
            } else {
                userAnswers.fill(null);
            }
            
            if (questionTimes.length !== questions.length) {
                questionTimes = new Array(questions.length).fill(0);
            } else {
                questionTimes.fill(0);
            }
            
            if (flaggedQuestions.length !== questions.length) {
                flaggedQuestions = new Array(questions.length).fill(false);
            } else {
                flaggedQuestions.fill(false);
            }
            
            questionStartTime = null;
            currentQuestionIndex = 0;
            isReviewingFromResults = false;
            isFilteringFlagged = false;
            currentlyDisplayedPassageIndex = -1;
            practiceSessionEndTime = null;
            showPracticeSessionScreen();
            startTimer();
            loadQuestion(0);
            populateNavigator();
        };
        
        // --- State Variables ---
        // Define all state variables before any functions are called to avoid reference errors
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let timerInterval;
        let timeLeft = 360; // 6 minutes in seconds 
        let practiceSessionStartTime;
        let practiceSessionEndTime;
        let userName = '';
        let userEmail = '';
        let userGoal = '';
        let userFocusArea = '';
        let isReviewingFromResults = false;
        let questionStartTime = null;
        let questionTimes = [];
        let flaggedQuestions = [];
        let isFilteringFlagged = false;
        let currentlyDisplayedPassageIndex = -1;

        // Calculator State
        let calcCurrentInput = '0';
        let calcPreviousInput = '';
        let calcOperator = null;
        let calcMemory = 0;
        let calcShouldResetDisplay = false; 
        let calcMrcPressedOnce = false; 
        let isDraggingCalculator = false;
        let calculatorOffsetX, calculatorOffsetY;
        
        // Add a debounce flag for submissions
        let isSubmittingReflection = false;
        
        // --- Elements ---
        const appContainer = document.getElementById('app-container');
        const setupScreen = document.getElementById('setup-screen');
        const practiceSessionScreen = document.getElementById('practice-session-screen');
        const reviewScreen = document.getElementById('review-screen');
        const resultsScreen = document.getElementById('results-screen');
        const navigatorModal = document.getElementById('navigator-modal');
        const startButton = document.getElementById('start-button');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const navigatorButton = document.getElementById('navigator-button');
        const closeModalButton = document.getElementById('close-modal-button');
        const endPracticeSessionButton = document.getElementById('end-practice-session-button');
        const endPracticeSessionButtonFooter = document.getElementById('end-practice-session-button-footer');
        const backToResultsButton = document.getElementById('back-to-results-button');
        const flagButton = document.getElementById('flag-button');
        const questionNumberInfoEl = document.getElementById('question-number-info');
        const timerEl = document.getElementById('timer');
        const reviewGrid = document.getElementById('review-grid');
        const navigatorGrid = document.getElementById('navigator-grid');
        const scoreEl = document.getElementById('score');
        const totalQuestionsResultsEl = document.getElementById('total-questions-results');
        const timeTakenEl = document.getElementById('time-taken');
        const resultsDetailsGrid = document.getElementById('results-details-grid');
        const goalInput = document.getElementById('goal');
        const focusAreaInput = document.getElementById('focus-area');
        const practiceSessionTitleEl = document.getElementById('practice-session-title');
        const filterFlaggedButton = document.getElementById('filter-flagged-button');
        const setupQuestionCountEl = document.getElementById('setup-question-count');
        const setupTimeLimitEl = document.getElementById('setup-time-limit');
        const reflectionText = document.getElementById('reflection-text');
        const downloadPdfButton = document.getElementById('download-pdf-button');
        const focusRatingInput = document.getElementById('focus-rating');
        const calculatorToggleButton = document.getElementById('calculator-toggle-button');
        const calculatorUI = document.getElementById('calculator-ui');
        const calcDisplay = document.getElementById('calc-display');
        const calcButtons = document.querySelectorAll('.calc-button');
        const closeCalculatorButton = document.getElementById('close-calculator-button');
        const calculatorDragHeader = document.getElementById('calculator-drag-header');

        // --- Data ---
        const passages = [
            `The table shows the fees for different membership types and activities at a fitness centre.
            
<img src="https://ik.imagekit.io/mwp/qrtest1a" alt="Fitness centre pricing table">`,
            `The table below displays details for 4 different inter-city bus services offered by a transport company.
            
<img src="https://ik.imagekit.io/mwp/qrtest1b" alt="Inter-city bus services table">`,
            `Of the total number of students visiting the university library one day, 3/5 borrowed at least one item. Of those who borrowed items, 1/4 borrowed a non-fiction book. Students who didn't borrow any items obviously didn't borrow non-fiction books.`,
            `A sports-drink powder states that 25 g of powder is needed per 600 mL of water. A coach wants to prepare 7.2 litres of the drink for a tournament, using exactly the recommended concentration.`,
            `David paid a $17.00 library fine for an overdue book. The fine policy states that the initial fine is calculated based on the book type, this amount is then increased by 10% if the book is over a week late, and finally, a 25% administration fee is added to the resulting total. David's book was over a week late.`,
            `The library analysed the types of items borrowed last week. E-books are a format option available only for Fiction and Science category items. The total items borrowed per category were:
Fiction: 800 items
Science: 500 items
History: 300 items
Journals: 400 items

If one-fifth of the Fiction items borrowed were e-books and three-tenths of the Science items borrowed were e-books, how many e-books were borrowed in total last week?`,
            `A university library tracks estimated reading hours generated by books loaned from different subject sections last month. The data is below:

<img src="https://ik.imagekit.io/mwp/qrtest1c" alt="University library reading hours by subject" style="margin-top: 12px;">`,
            `Here is a comparison of two key departments within TechCorp Industries, based on last year's performance data:

<img src="https://ik.imagekit.io/mwp/qrtest1d?updatedAt=1747196268019" alt="TechCorp Industries department comparison" style="margin-top: 12px;">`,
            `The table below shows the results of a survey asking participants about their preferred type of vacation.

<img src="https://ik.imagekit.io/mwp/qrtest1e" alt="Vacation preferences survey results" style="margin-top: 12px;">`,
            `Peter purchased 14 new baseball cards for his collection. This increased the size of his collection by 35%.`,
            `Sarah added 3 new plants to her garden. This increased the number of plants in her garden by 15%.`,
            `At a cinema, movie tickets normally cost $15 each. There is a special offer where you can buy 4 tickets for $50.`,
            `<img src="https://ik.imagekit.io/mwp/qrtest1f" alt="Square patio with central square fountain">`,
            `Alex is a diligent salesperson and has been tracking their monthly sales achieved against the average of their team (as percentages of the monthly target). The team is relatively small - the team only contains 8 members, including Alex.

<img src="https://ik.imagekit.io/mwp/qrtest1i" alt="Alex's sales performance compared to team average" style="margin-top: 12px;">`,
            `The following table shows the fare for multiple different catering services.

<img src="https://ik.imagekit.io/mwp/qrtest1g?updatedAt=1747199491069" alt="Catering services pricing table" style="margin-top: 12px; margin-bottom: 12px;">

For example: an event with Catering Beta for 15 guests requiring 2.5 hours of service, with a Weekend Surcharge rate of x1.4 applied, would cost: 1.4Ã—(175.00+(15Ã—10.50)+(2.5Ã—25.00))=$553.00`,
            `The following table explains the timezone difference across multiple locations.

<img src="https://ik.imagekit.io/mwp/qrtest1h?updatedAt=1747199651751" alt="Timezone difference chart" style="margin-top: 12px;">`
        ];
        const questions = [
            { 
                premises: [
                    "All oranges in the bowl are sweet.",
                    "This fruit is an orange in the bowl."
                ],
                statements: [
                    "This fruit is sweet.",
                    "Some sweet fruits in the bowl are oranges.",
                    "No non-sweet fruits in the bowl are oranges.",
                    "All sweet fruits in the bowl are oranges.",
                    "Some fruits in the bowl are not sweet."
                ],
                correctAnswers: ["Y", "N", "Y", "N", "N"]
            },
            { 
                premises: [
                    "No penguin can fly."
                ],
                statements: [
                    "Some penguins can fly.",
                    "If something can fly, it is not a penguin.",
                    "All penguins cannot fly.",
                    "Some creatures that cannot fly are penguins.",
                    "All creatures that cannot fly are penguins."
                ],
                correctAnswers: ["N", "Y", "Y", "N", "N"]
            },
            { 
                premises: [
                    "Every burger on the menu contains bread."
                ],
                statements: [
                    "Some bread items on the menu are burgers.",
                    "All bread items on the menu are burgers.",
                    "Some burgers on the menu do not contain bread.",
                    "No burgers on the menu lack bread.",
                    "Some menu items lack bread."
                ],
                correctAnswers: ["N", "N", "N", "Y", "N"]
            },
            { 
                premises: [
                    "Some books in the library are new."
                ],
                statements: [
                    "All books in the library are new.",
                    "Some books in the library are not new.",
                    "At least one new item in the library is a book.",
                    "No new items in the library are books.",
                    "There is at least one book in the library."
                ],
                correctAnswers: ["N", "N", "Y", "N", "Y"]
            },
            { 
                premises: [
                    "All dogs at the shelter are vaccinated."
                ],
                statements: [
                    "Some vaccinated animals at the shelter are dogs.",
                    "Some dogs at the shelter are not vaccinated.",
                    "All vaccinated animals at the shelter are dogs.",
                    "No dogs at the shelter are unvaccinated.",
                    "Some animals at the shelter are not vaccinated."
                ],
                correctAnswers: ["N", "N", "N", "Y", "N"]
            }
        ];

        // Now initialize arrays with questions.length
        userAnswers = new Array(questions.length).fill(null);
        questionTimes = new Array(questions.length).fill(0);
        flaggedQuestions = new Array(questions.length).fill(false);

        // Check for review mode and initialize appropriate screen
        if (reviewParam) {
            // We're in review mode - load the past test data
            loadPastTestForReview(reviewParam);
        } else {
            // Regular test mode - continue with normal setup
            showSetupScreen();
        }

        // --- Functions ---
        function startTimer() {
            practiceSessionStartTime = new Date();
            clearInterval(timerInterval);
            timerEl.textContent = formatTimeSeconds(timeLeft);
            timerEl.classList.remove('text-gray-300');
            timerEl.classList.add('text-white', 'bg-opacity-20', 'bg-white');
            timerInterval = setInterval(() => {
                timeLeft--;
                timerEl.textContent = formatTimeSeconds(timeLeft);
                if (timeLeft <= 0) {
                    endPracticeSessionAndShowResults();
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            practiceSessionEndTime = practiceSessionEndTime || new Date();
            timerEl.classList.remove('text-white', 'bg-opacity-20', 'bg-white');
            timerEl.classList.add('text-gray-300');
        }

        function formatTimeSeconds(totalSeconds) {
             if (totalSeconds < 0) totalSeconds = 0;
             const minutes = Math.floor(totalSeconds / 60);
             const seconds = totalSeconds % 60;
             return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }

        function formatTimeDifference(milliseconds) {
            if (!milliseconds || milliseconds < 0) return "0 min 00 sec";
            const totalSeconds = Math.round(milliseconds / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes} min ${seconds < 10 ? '0' : ''}${seconds} sec`;
        }

        function recordTimeSpent(index) {
            if (questionStartTime && index >= 0 && index < questions.length) {
                const timeSpent = Date.now() - questionStartTime;
                questionTimes[index] = (questionTimes[index] || 0) + timeSpent;
            }
            questionStartTime = null;
        }

        function toggleFlag() {
            if (isReviewingFromResults) return;
            const index = currentQuestionIndex;
            flaggedQuestions[index] = !flaggedQuestions[index];
            updateFlagButtonAppearance();
            updateNavigatorButtons();
        }

        function updateFlagButtonAppearance() {
            const isFlagged = flaggedQuestions[currentQuestionIndex];
            flagButton.textContent = isFlagged ? 'Unflag' : 'Flag for Review';
            flagButton.classList.toggle('flagged', isFlagged);
        }

        function loadQuestion(index, reviewMode = false) {
            if (index < 0 || index >= questions.length) return;
            if (!isReviewingFromResults && !reviewMode) {
                recordTimeSpent(currentQuestionIndex);
            }
            const question = questions[index];
            const questionContainer = document.querySelector('.question-column');
            
            // Update layout for syllogism questions
            if (questionContainer) {
                questionContainer.style.width = '100%';
                questionContainer.style.flex = '1';
                questionContainer.style.marginTop = '0';
                
                // Create HTML for premises and statements
                let premisesHtml = '<div class="p-4 bg-gray-50 rounded-md mb-4" style="background-color: #f9fafb; border: 1px solid #e5e7eb; padding: 1.25rem; line-height: 1.5;">';
                premisesHtml += '<h3 class="font-semibold mb-2">Premises</h3>';
                
                question.premises.forEach(premise => {
                    premisesHtml += `<p class="mb-2">${premise}</p>`;
                });
                
                premisesHtml += '</div>';
                
                // Create HTML for statements section with Yes/No buttons on the right
                let statementsHtml = `
                    <h4 class="text-md font-semibold mb-3 bg-white pb-1">Question ${index + 1}</h4>
                    <div class="flex justify-between items-center mb-3">
                        <div>
                            <h5 class="font-medium mb-2">Conclusions</h5>
                            <p class="text-sm text-gray-600">Drag 'Yes' or 'No' onto the statement row.</p>
                        </div>
                        <div class="flex space-x-2">
                            <button id="yes-button" class="drag-button px-6 py-2 bg-green-100 border border-green-500 rounded-md text-green-700 font-medium">Yes</button>
                            <button id="no-button" class="drag-button px-6 py-2 bg-red-100 border border-red-500 rounded-md text-red-700 font-medium">No</button>
                        </div>
                    </div>
                    <div id="statements-container" class="space-y-3"></div>
                    <div id="review-explanation-container"></div>
                `;
                
                questionContainer.innerHTML = premisesHtml + statementsHtml;
            }
            
            currentQuestionIndex = index;
            isReviewingFromResults = reviewMode;
            
            questionNumberInfoEl.textContent = `${index + 1} of ${questions.length}`;
            if (questionContainer) questionContainer.scrollTop = 0;
            
            // Add the statements with answer boxes
            const statementsContainer = document.getElementById('statements-container');
            if (statementsContainer) {
                statementsContainer.innerHTML = '';
                
                question.statements.forEach((statement, i) => {
                    const statementId = `q${index}_statement${i}`;
                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'statement-row flex items-center mb-3 border border-gray-200 rounded-md p-3 bg-white';
                    rowDiv.dataset.statementIndex = i;
                    rowDiv.innerHTML = `
                        <div class="flex-grow statement-text">
                            <span class="font-medium">${i + 1}.</span> ${statement}
                        </div>
                        <div class="flex-shrink-0 ml-4 relative">
                            <div class="statement-answer-box w-16 h-10 border border-gray-300 rounded flex items-center justify-center bg-gray-50" 
                                 data-statement-index="${i}">
                                ${userAnswers[index] && userAnswers[index][i] ? userAnswers[index][i] : '...'}
                            </div>
                        </div>
                    `;
                    
                    statementsContainer.appendChild(rowDiv);
                    
                    // If in review mode, show correct/incorrect indicators
                    if (reviewMode) {
                        const answerBox = rowDiv.querySelector('.statement-answer-box');
                        const userAnswer = userAnswers[index] && userAnswers[index][i] ? userAnswers[index][i] : null;
                        const correctAnswer = question.correctAnswers[i];
                        
                        answerBox.classList.remove('border-gray-300', 'bg-gray-50');
                        
                        if (userAnswer === correctAnswer) {
                            answerBox.classList.add('border-green-500', 'bg-green-50', 'text-green-700');
                        } else {
                            answerBox.classList.add('border-red-500', 'bg-red-50', 'text-red-700');
                            
                            // Show correct answer
                            const correctDiv = document.createElement('div');
                            correctDiv.className = 'mt-1 text-xs text-gray-600';
                            correctDiv.textContent = `Correct answer: ${correctAnswer}`;
                            rowDiv.querySelector('.flex-shrink-0').appendChild(correctDiv);
                        }
                    }
                });
                
                // Add drag and drop functionality if not in review mode
                if (!reviewMode) {
                    initDragAndDrop();
                }
            }
            
            prevButton.disabled = index === 0;
            if (!reviewMode && index === questions.length - 1) {
                 nextButton.textContent = 'Finish & Review';
                 nextButton.disabled = false;
            } else if (!reviewMode) {
                 nextButton.textContent = 'Next (Alt+N) â†’';
                 nextButton.disabled = false;
            } else {
                 nextButton.disabled = index === questions.length - 1;
                 if (!nextButton.disabled) nextButton.textContent = 'Next â†’';
            }
            updateFlagButtonAppearance();
            if (reviewMode) {
                backToResultsButton.classList.remove('hidden');
                endPracticeSessionButtonFooter.classList.add('hidden');
                practiceSessionTitleEl.textContent = "Reviewing Question";
                prevButton.disabled = index === 0;
                navigatorButton.disabled = false;
                flagButton.disabled = true;
            } else {
                backToResultsButton.classList.add('hidden');
                endPracticeSessionButtonFooter.classList.remove('hidden');
                practiceSessionTitleEl.textContent = "Decision Making";
                navigatorButton.disabled = false;
                flagButton.disabled = false;
                prevButton.disabled = index === 0;
            }
            updateNavigatorHighlight();
            if (!isReviewingFromResults) {
                questionStartTime = Date.now();
            }
        }

         // This function is replaced by the drag and drop functionality for Yes/No answers

        function showNextQuestion() {
            // Hide calculator if it's open
            if (calculatorUI.classList.contains('visible')) {
                toggleCalculator();
            }
            
            if (isReviewingFromResults) {
                if (currentQuestionIndex < questions.length - 1) {
                    loadQuestion(currentQuestionIndex + 1, true);
                }
            }
            else if (!isReviewingFromResults) {
                 recordTimeSpent(currentQuestionIndex);
                 if (currentQuestionIndex === questions.length - 1) {
                     showReviewScreen();
                 } else if (currentQuestionIndex < questions.length - 1) {
                     loadQuestion(currentQuestionIndex + 1);
                 }
            }
        }

        function showPrevQuestion() {
            // Hide calculator if it's open
            if (calculatorUI.classList.contains('visible')) {
                toggleCalculator();
            }
            
             if (isReviewingFromResults) {
                 if (currentQuestionIndex > 0) {
                     loadQuestion(currentQuestionIndex - 1, true);
                 }
             }
             else if (currentQuestionIndex > 0 && !isReviewingFromResults) {
                 recordTimeSpent(currentQuestionIndex);
                 loadQuestion(currentQuestionIndex - 1);
            }
        }

        function showSetupScreen() {
            userName = '';
            userEmail = '';
            userGoal = '';
            userFocusArea = '';
            
            // Check for Firebase auth user
            if (firebase.auth && firebase.auth().currentUser) {
                const currentUser = firebase.auth().currentUser;
                userName = currentUser.displayName || currentUser.email || '';
                userEmail = currentUser.email || '';
            }
            
            setupScreen.classList.remove('hidden');
            practiceSessionScreen.classList.add('hidden');
            reviewScreen.classList.add('hidden');
            reviewScreen.classList.remove('flex');
            resultsScreen.classList.add('hidden');
            appContainer.classList.remove('flex', 'flex-col');
            currentlyDisplayedPassageIndex = -1;
            
            if (setupQuestionCountEl) setupQuestionCountEl.textContent = "5"; // Change to 5 questions
            if (setupTimeLimitEl) setupTimeLimitEl.textContent = `6 minutes`; // Change to 6 minutes
            if (goalInput) {
                goalInput.max = 10; // Change max goal to 10
                goalInput.value = userGoal;
                const goalLabel = document.querySelector('label[for="goal"]');
                if (goalLabel) goalLabel.textContent = `Goal (Score out of 10):`; // Change label
            }
            if (focusAreaInput) {
                focusAreaInput.value = userFocusArea;
            }
        }

        // Ensure we call updateTimerVisibility when returning to practice screen
        function showPracticeSessionScreen() {
            setupScreen.classList.add('hidden');
            practiceSessionScreen.classList.remove('hidden');
            practiceSessionScreen.classList.add('flex');
            reviewScreen.classList.add('hidden');
            resultsScreen.classList.add('hidden');
            appContainer.classList.add('flex', 'flex-col');
            currentlyDisplayedPassageIndex = -1;
            updateTimerVisibility();
        }

        // Ensure the timer visuals are maintained when switching between screens
        function updateTimerVisibility() {
            if (timerInterval) {
                timerEl.classList.remove('text-gray-300');
                timerEl.classList.add('text-white', 'bg-opacity-20', 'bg-white');
            } else {
                timerEl.classList.add('text-gray-300');
                timerEl.classList.remove('text-white', 'bg-opacity-20', 'bg-white');
            }
        }

        // Review screen - keep timer running
        function showReviewScreen(filterFlagged = false) {
            recordTimeSpent(currentQuestionIndex);
            // Don't stop timer here - let it continue running
            updateTimerVisibility();
            practiceSessionScreen.classList.add('hidden');
            reviewScreen.classList.remove('hidden');
            reviewScreen.classList.add('flex');
            resultsScreen.classList.add('hidden');
            setupScreen.classList.add('hidden');
            appContainer.classList.add('flex', 'flex-col');
            
            // Hide calculator if it's visible
            if (calculatorUI.classList.contains('visible')) {
                toggleCalculator();
            }
            
            reviewGrid.innerHTML = '';
            questions.forEach((_, index) => {
                 if (filterFlagged && !flaggedQuestions[index]) {
                     return;
                 }
                const button = document.createElement('button');
                button.textContent = index + 1;
                button.className = 'review-grid-button';
                button.dataset.questionIndex = index;
                if (userAnswers[index] !== null && userAnswers[index] !== undefined) {
                    button.classList.add('review-grid-button-answered');
                } else {
                     button.classList.add('review-grid-button-unanswered');
                }
                if (flaggedQuestions[index]) {
                    button.classList.add('review-flagged');
                }
                // Using event delegation, so no individual onclick handler
                reviewGrid.appendChild(button);
            });
             filterFlaggedButton.textContent = filterFlagged ? 'Show All Questions' : 'Show Flagged Only';
        }

        function populateNavigator() {
            navigatorGrid.innerHTML = '';
            questions.forEach((_, index) => {
                const button = document.createElement('button');
                button.textContent = index + 1;
                button.classList.add('py-2', 'px-1', 'border', 'border-gray-300', 'rounded-md', 'text-center', 'transition', 'duration-150', 'ease-in-out', 'text-sm', 'hover:bg-gray-100');
                button.dataset.questionIndex = index;
                if (userAnswers[index]) button.classList.add('nav-answered');
                if (index === currentQuestionIndex) button.classList.add('nav-current');
                if (flaggedQuestions[index]) button.classList.add('nav-flagged');
                button.onclick = () => {
                    navigatorModal.classList.remove('flex');
                    navigatorModal.classList.add('hidden');
                    // Hide calculator if it's open
                    if (calculatorUI.classList.contains('visible')) {
                        toggleCalculator();
                    }
                    const targetIndex = parseInt(button.dataset.questionIndex, 10);
                    loadQuestion(targetIndex, isReviewingFromResults);
                };
                navigatorGrid.appendChild(button);
            });
        }

        function updateNavigatorButtons() {
            if (!navigatorGrid) return;
            const buttons = navigatorGrid.querySelectorAll('button');
            buttons.forEach(button => {
                const index = parseInt(button.dataset.questionIndex, 10);
                button.classList.remove('nav-answered', 'nav-current', 'nav-flagged');
                if (userAnswers[index]) button.classList.add('nav-answered');
                if (index === currentQuestionIndex) button.classList.add('nav-current');
                if (flaggedQuestions[index]) button.classList.add('nav-flagged');
            });
        }

         function updateNavigatorHighlight() {
             if (!navigatorGrid) return;
             const buttons = navigatorGrid.querySelectorAll('button');
             buttons.forEach(button => {
                 const index = parseInt(button.dataset.questionIndex, 10);
                 button.classList.remove('nav-current');
                 if (index === currentQuestionIndex) button.classList.add('nav-current');
             });
         }

        function showResultsScreen() {
            practiceSessionEndTime = practiceSessionEndTime || new Date();
            recordTimeSpent(currentQuestionIndex);
            stopTimer();

            practiceSessionScreen.classList.add('hidden');
            reviewScreen.classList.add('hidden');
            reviewScreen.classList.remove('flex');
            resultsScreen.classList.remove('hidden');
            resultsScreen.classList.add('flex');
            setupScreen.classList.add('hidden');
            appContainer.classList.add('flex', 'flex-col');

            let totalScore = 0;
            resultsDetailsGrid.innerHTML = ''; 

            // Add partially-correct-box style if not already defined
            if (!document.getElementById('partially-correct-style')) {
                const style = document.createElement('style');
                style.id = 'partially-correct-style';
                style.textContent = `
                    .partially-correct-box { 
                        background-color: #fb923c; /* Orange color */
                        border: 2px solid #ea580c;
                        color: white; 
                    }
                `;
                document.head.appendChild(style);
            }

            questions.forEach((qData, index) => {
                // Count correct answers for this question
                let correctCount = 0;
                
                // For debugging
                console.log(`Question ${index + 1} - userAnswers:`, userAnswers[index]);
                console.log(`Question ${index + 1} - correctAnswers:`, qData.correctAnswers);
                
                qData.statements.forEach((statement, statementIndex) => {
                    // In this app, Yes/No answers are stored as "Yes" and "No", but correctAnswers are "Y" and "N"
                    // We need to convert the user's answer to match the format of correctAnswers
                    let userAnswer = userAnswers[index] && userAnswers[index][statementIndex] ? userAnswers[index][statementIndex] : null;
                    const correctAnswer = qData.correctAnswers[statementIndex];
                    
                    // Convert "Yes"/"No" to "Y"/"N" for comparison
                    if (userAnswer === "Yes") userAnswer = "Y";
                    if (userAnswer === "No") userAnswer = "N";
                    
                    console.log(`Q${index + 1}.${statementIndex + 1}: User: "${userAnswer}", Correct: "${correctAnswer}", Match: ${userAnswer === correctAnswer}`);
                    
                    if (userAnswer === correctAnswer) {
                        correctCount++;
                    }
                });
                
                // Apply scoring rules
                let questionScore = 0;
                let boxClass = '';
                
                if (correctCount === 5) {
                    questionScore = 2;
                    boxClass = 'correct-box';
                } else if (correctCount === 4) {
                    questionScore = 1;
                    boxClass = 'partially-correct-box';
                } else {
                    questionScore = 0;
                    boxClass = 'incorrect-box';
                }
                
                totalScore += questionScore;

                const timeSpentMs = questionTimes[index] || 0;
                const timeSpentSec = Math.round(timeSpentMs / 1000);

                const summaryItem = document.createElement('div');
                summaryItem.classList.add('result-summary-item');

                const summaryBox = document.createElement('div');
                summaryBox.classList.add('result-summary-box', boxClass);
                summaryBox.dataset.index = index;
                summaryBox.title = `Click to review Question ${index + 1}`;

                // Show score instead of time in the summary box
                const scoreDisplay = document.createElement('span');
                scoreDisplay.classList.add('time-display-in-box');
                scoreDisplay.textContent = `${correctCount}/5`;
                summaryBox.appendChild(scoreDisplay);

                const numberLabel = document.createElement('div');
                numberLabel.classList.add('question-number-label');
                numberLabel.textContent = `Q${index + 1}`;

                summaryBox.addEventListener('click', () => {
                    revisitQuestionFromResults(index);
                });

                summaryItem.appendChild(summaryBox);
                summaryItem.appendChild(numberLabel);
                resultsDetailsGrid.appendChild(summaryItem);
            });

            scoreEl.textContent = totalScore;
            const timeDiff = practiceSessionEndTime - practiceSessionStartTime;
            timeTakenEl.textContent = formatTimeDifference(timeDiff);
            
            // Update total score possible on results screen (10 points maximum: 5 questions Ã— 2 points)
            const totalScorePossibleEl = document.getElementById('total-score-possible');
            if (totalScorePossibleEl) {
                totalScorePossibleEl.textContent = "10";
            } else {
                const scoreDisplayParent = scoreEl.parentElement;
                if (scoreDisplayParent) {
                     scoreDisplayParent.innerHTML = `Your Score: <span id="score" class="text-blue-700">${totalScore}</span> / 10 Points`;
                }
            }
            
            // Make sure the submit performance button has an event listener
            const submitButton = document.getElementById('submit-performance-button');
            if (submitButton) {
                submitButton.disabled = false;
                submitButton.textContent = 'Submit Reflections';
                submitButton.classList.remove('bg-green-500');
            }
        }


        function revisitQuestionFromResults(index) {
            resultsScreen.classList.add('hidden');
            resultsScreen.classList.remove('flex');
            showPracticeSessionScreen();
            loadQuestion(index, true);
        }

        // Only stop timer when showing final results
        function endPracticeSessionAndShowResults() {
            stopTimer();

            // Gather data to submit to Firebase
            const performanceData = {
                studentName: userName || 'Anonymous',
                studentEmail: userEmail || '', // <--- ADD THIS LINE
                examName: "DM Syllogisms Worksheet 1", // Updated examName
                score: calculateScore(), // New function to calculate score
                totalQuestions: questions.length, // Should be 5
                totalPossibleScore: 10, // Explicitly add total possible score (2 points per question)
                timeTaken: formatTimeDifference(practiceSessionEndTime - practiceSessionStartTime),
                answers: userAnswers,
                questionTimes: questionTimes,
                flaggedQuestions: flaggedQuestions,
                goal: userGoal || '',
                focusArea: userFocusArea || '',
                focusRating: '', // No reflection data available at this point
                reflection: '',  // No reflection data available at this point
                submissionTimestamp: new Date().toISOString(),
                userAgent: navigator.userAgent
            };

            // Submit data to Firebase
            submitDataToFirebase(performanceData);
            
            // Show results
            showResultsScreen();
        }

        // Function to calculate the score
        function calculateScore() {
            let score = 0;
            questions.forEach((qData, index) => {
                if (!userAnswers[index]) return;
                
                // Count correct answers for this question
                let correctCount = 0;
                qData.correctAnswers.forEach((correctAnswer, statementIndex) => {
                    const userAnswer = userAnswers[index][statementIndex];
                    if (userAnswer === correctAnswer) {
                        correctCount++;
                    }
                });
                
                // Apply scoring rules:
                // 5/5 correct = 2 points
                // 4/5 correct = 1 point
                // 3 or fewer correct = 0 points
                if (correctCount === 5) {
                    score += 2;
                } else if (correctCount === 4) {
                    score += 1;
                }
            });
            return score;
        }

        // Function to submit data to Firebase
        function submitDataToFirebase(data) {
            // Only submit if Firebase is initialized
            if (typeof firebase !== 'undefined' && firebase.firestore) {
                try {
                    const db = firebase.firestore();
                    let userId = ''; // <--- Add this
                    if (firebase.auth && firebase.auth().currentUser) {
                        userId = firebase.auth().currentUser.uid; // <--- Get the UID
                    }
                    
                    const dataToSubmit = {
                        ...data, // Spread existing data
                        userId: userId // <--- Add userId here
                    };

                    db.collection("performanceSubmissions").add(dataToSubmit) // Use dataToSubmit
                      .then(() => {
                          console.log("Performance data submitted to Firebase with userId");
                          
                          // Show a success notification that will be displayed on the results screen
                          setTimeout(() => {
                              const successNotice = document.createElement('div');
                              successNotice.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded shadow-lg z-50';
                              successNotice.innerHTML = `
                                  <div class="flex items-center">
                                      <svg class="h-6 w-6 text-green-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                      </svg>
                                      <span class="font-medium">Success!</span>
                                      <span class="ml-2">Your test results have been submitted to the admin dashboard.</span>
                                  </div>
                              `;
                              document.body.appendChild(successNotice);
                              
                              // Remove the notice after 5 seconds
                              setTimeout(() => {
                                  successNotice.classList.add('opacity-0', 'transition-opacity', 'duration-500');
                                  setTimeout(() => {
                                      document.body.removeChild(successNotice);
                                  }, 500);
                              }, 5000);
                          }, 500); // Small delay to ensure results screen is visible
                      })
                      .catch((error) => {
                          console.error("Error submitting to Firebase:", error);
                          
                          // Show error notification
                          setTimeout(() => {
                              const errorNotice = document.createElement('div');
                              errorNotice.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded shadow-lg z-50';
                              errorNotice.innerHTML = `
                                  <div class="flex items-center">
                                      <svg class="h-6 w-6 text-red-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                      </svg>
                                      <span class="font-medium">Error!</span>
                                      <span class="ml-2">Could not submit your results. You can try adding a reflection.</span>
                                  </div>
                              `;
                              document.body.appendChild(errorNotice);
                              
                              // Remove the notice after 5 seconds
                              setTimeout(() => {
                                  errorNotice.classList.add('opacity-0', 'transition-opacity', 'duration-500');
                                  setTimeout(() => {
                                      document.body.removeChild(errorNotice);
                                  }, 500);
                              }, 5000);
                          }, 500);
                      });
                } catch (error) {
                    console.error("Error accessing Firebase:", error);
                }
            } else {
                console.error("Firebase is not initialized");
            }
        }

        function handleEndPracticeSessionFooterClick() {
             recordTimeSpent(currentQuestionIndex);
             // Remove stopTimer() call to keep timer running
             showReviewScreen();
         }

        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const reflection = reflectionText.value.trim();
            const focusRating = focusRatingInput.value;
            const finalScore = scoreEl.textContent;
            const totalQs = totalQuestionsResultsEl.textContent;
            const timeTaken = timeTakenEl.textContent;
            let y = 15;
            const lineHeight = 7;
            const pageHeight = doc.internal.pageSize.height;
            const margin = 15;

            doc.setFontSize(18);
            doc.text("UCAT Quantitative Reasoning Results", margin, y);
            y += lineHeight * 1.5;
            doc.setFontSize(12);
            doc.text(`Name: ${userName || 'N/A'}`, margin, y); y += lineHeight;
            doc.text(`Goal: ${userGoal || 'N/A'} / ${totalQs}`, margin, y); y += lineHeight;
            doc.text(`Focus Area: ${userFocusArea || 'N/A'}`, margin, y); y += lineHeight;
            doc.text(`Final Score: ${finalScore} / ${totalQs}`, margin, y); y += lineHeight;
            doc.text(`Time Taken: ${timeTaken}`, margin, y); y += lineHeight * 1.5;
            doc.setFontSize(14);
            doc.text("Focus Rating (1-5):", margin, y); y += lineHeight;
            doc.setFontSize(10);
            doc.text(focusRating || 'N/A', margin, y); y += lineHeight * 1.5;
            doc.setFontSize(14);
            doc.text("Main Takeaway:", margin, y); y += lineHeight;
            doc.setFontSize(10);
            const reflectionLines = doc.splitTextToSize(reflection || 'No reflection provided.', doc.internal.pageSize.width - margin * 2);
            doc.text(reflectionLines, margin, y);
            y += reflectionLines.length * (lineHeight * 0.7) + lineHeight;
            doc.setFontSize(14);
            doc.text("Detailed Results Summary:", margin, y); y += lineHeight * 1.5;
            doc.setFontSize(10);

            questions.forEach((qData, index) => {
                const userAnswer = userAnswers[index];
                const correctAnswer = qData.correctAnswer;
                const isCorrect = userAnswer !== null && userAnswer !== undefined && userAnswer === correctAnswer;
                const status = userAnswer === null || userAnswer === undefined ? "Not Answered" : (isCorrect ? "Correct" : "Incorrect");
                const timeSpentSec = Math.round((questionTimes[index] || 0) / 1000);
                const resultText = `Q${index + 1}: Your Ans: ${userAnswer || 'N/A'}, Correct: ${correctAnswer}, Status: ${status}, Time: ${timeSpentSec}s`;
                
                let textLines = doc.splitTextToSize(resultText, doc.internal.pageSize.width - margin * 2);
                if (y + (textLines.length * (lineHeight * 0.7)) > pageHeight - margin) {
                    doc.addPage();
                    y = margin;
                }
                doc.text(textLines, margin, y);
                y += textLines.length * (lineHeight * 0.7) + (lineHeight*0.3);
            });
            doc.save(`ucat_qr_results_${userName || 'user'}.pdf`);
        }
        
        // Function to submit performance data to server
        async function submitPerformanceData() {
            // Prevent multiple submissions
            if (isSubmittingReflection) {
                console.log("Submission already in progress, ignoring duplicate call");
                return;
            }
            
            try {
                isSubmittingReflection = true;
                
                // Get additional reflection data
                const focusRating = document.getElementById('focus-rating').value || '';
                const reflection = document.getElementById('reflection-text').value || '';
                
                if (typeof firebase !== 'undefined' && firebase.firestore) {
                    const db = firebase.firestore();
                    
                    // Get current authenticated user data if available
                    let userDisplayName = '';
                    let userId = ''; // <--- Add this
                    
                    if (firebase.auth && firebase.auth().currentUser) {
                        const currentUser = firebase.auth().currentUser;
                        userDisplayName = currentUser.displayName || '';
                        userId = currentUser.uid; // <--- Get the UID
                        // Note: we're already storing userEmail from when the test started
                    }
                    
                    // Instead of querying for existing document, create a new one with both test results and reflection
                    const performanceData = {
                        studentName: userName || userDisplayName || 'Anonymous',
                        studentEmail: userEmail || '',
                        userId: userId, // <--- Add userId here
                        examName: "DM Syllogisms Worksheet 1", // Updated examName
                        score: scoreEl.textContent,
                        totalQuestions: totalQuestionsResultsEl.textContent, // Should be 5
                        totalPossibleScore: 10, // Explicitly add total possible score (2 points per question)
                        timeTaken: timeTakenEl.textContent,
                        answers: userAnswers,
                        questionTimes: questionTimes,
                        flaggedQuestions: flaggedQuestions,
                        goal: userGoal || '',
                        focusArea: userFocusArea || '',
                        focusRating: focusRating,
                        reflection: reflection,
                        submissionTimestamp: new Date().toISOString(),
                        userAgent: navigator.userAgent,
                        isReflection: true // Flag to indicate this is a reflection submission
                    };
                    
                    // Add as a new document
                    await db.collection("performanceSubmissions").add(performanceData);
                    
                    // Show success message
                    const successNotice = document.createElement('div');
                    successNotice.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded shadow-lg z-50';
                    successNotice.innerHTML = `
                        <div class="flex items-center">
                            <svg class="h-6 w-6 text-green-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            <span class="font-medium">Success!</span>
                            <span class="ml-2">Your reflection has been saved.</span>
                        </div>
                    `;
                    document.body.appendChild(successNotice);
                    
                    // Remove the notice after 5 seconds
                    setTimeout(() => {
                        successNotice.classList.add('opacity-0', 'transition-opacity', 'duration-500');
                        setTimeout(() => {
                            document.body.removeChild(successNotice);
                        }, 500);
                    }, 5000);
                    
                    // Update the button
                    document.getElementById('submit-performance-button').disabled = true;
                    document.getElementById('submit-performance-button').textContent = 'Reflection Saved âœ“';
                    document.getElementById('submit-performance-button').classList.add('bg-green-500');
                } else {
                    alert('Firebase is not initialized. Please configure Firebase first.');
                    console.error('Firebase or Firestore is not available.');
                }
            } catch (error) {
                console.error('Error saving reflection:', error);
                alert('An error occurred while saving your reflection. Please try again.');
            } finally {
                // Reset the submission flag after a delay, just in case
                setTimeout(() => {
                    isSubmittingReflection = false;
                }, 2000);
            }
        }
        
        // --- Calculator Functions ---
        function updateCalcDisplay() {
            // Ensure display doesn't overflow, use scientific notation for very long numbers
            if (calcCurrentInput === 'Error') {
                calcDisplay.textContent = 'Error';
            } else if (calcCurrentInput.length > 12) {
                // For long numbers, try scientific notation
                try {
                    const num = parseFloat(calcCurrentInput);
                    if (isFinite(num)) {
                        calcDisplay.textContent = num.toExponential(6);
                    } else {
                        calcDisplay.textContent = 'Error';
                    }
                } catch (e) {
                    calcDisplay.textContent = calcCurrentInput.substring(0, 12);
                }
            } else {
                calcDisplay.textContent = calcCurrentInput;
            }
            
            // Show/hide memory indicator
            const memIndicator = document.getElementById('calc-memory-indicator');
            if (calcMemory !== 0) {
                memIndicator.style.display = 'block';
            } else {
                memIndicator.style.display = 'none';
            }
        }

        // Add specific event handler for equals button
        document.querySelector('.calc-button.equals').addEventListener('click', (e) => {
            console.log('Equals button clicked');
            calculate();
            e.stopPropagation(); // Prevent event bubbling
        });

        calcButtons.forEach(button => {
            button.addEventListener('click', () => {
                const value = button.dataset.calcValue;
                const action = button.dataset.calcAction;
                
                console.log('Button clicked:', button.textContent, 'value:', value, 'action:', action);

                if (value !== undefined) { 
                    if (value === '.') { inputDecimal(); } 
                    else { inputDigit(value); }
                } else if (action) { 
                    if (['+', '-', '*', '/'].includes(action)) { handleOperator(action); } 
                    else if (action === 'equals') { 
                        console.log('Equals action detected');
                        calculate(); 
                    } 
                    else if (action === 'clear') { clearCalculator(); } 
                    else if (['m+', 'm-', 'mrc'].includes(action)) { handleMemory(action); } 
                    else if (['sqrt', 'percent', 'negate', 'backspace'].includes(action)) { handleSpecialFunction(action); }
                }
            });
        });

        function clearCalculator() {
            calcCurrentInput = '0';
            calcPreviousInput = '';
            calcOperator = null;
            calcShouldResetDisplay = false;
            calcMrcPressedOnce = false; 
            updateCalcDisplay();
        }
        
        function inputDigit(digit) {
            if (calcCurrentInput === 'Error') calcCurrentInput = '0'; // Clear error on new digit
            if (calcShouldResetDisplay) {
                calcCurrentInput = digit;
                calcShouldResetDisplay = false;
            } else {
                // Prevent excessively long numbers before decimal
                if (calcCurrentInput.includes('.') && calcCurrentInput.split('.')[1].length >= 8) return; // Limit to 8 decimal places
                if (!calcCurrentInput.includes('.') && calcCurrentInput.length >= 10 && calcCurrentInput !== '0') return; // Limit to 10 integer digits

                calcCurrentInput = calcCurrentInput === '0' ? digit : calcCurrentInput + digit;
            }
            updateCalcDisplay();
            calcMrcPressedOnce = false; 
        }

        function inputDecimal() {
            if (calcCurrentInput === 'Error') calcCurrentInput = '0';
            if (calcShouldResetDisplay) {
                calcCurrentInput = '0.';
                calcShouldResetDisplay = false;
            } else if (!calcCurrentInput.includes('.')) {
                calcCurrentInput += '.';
            }
            updateCalcDisplay();
            calcMrcPressedOnce = false;
        }

        function handleOperator(nextOperator) {
            if (calcCurrentInput === 'Error') return;
            const inputValue = parseFloat(calcCurrentInput);
            if (calcOperator && !calcShouldResetDisplay) { 
                calculate();
                if (calcCurrentInput === 'Error') return; // Stop if calculation resulted in error
                calcPreviousInput = calcCurrentInput; 
            } else {
                calcPreviousInput = calcCurrentInput;
            }
            calcOperator = nextOperator;
            calcShouldResetDisplay = true;
            calcMrcPressedOnce = false;
        }

        function calculate() {
            if (!calcOperator || calcPreviousInput === '' || calcCurrentInput === 'Error') return;
            const prev = parseFloat(calcPreviousInput);
            const current = parseFloat(calcCurrentInput);
            if (isNaN(prev) || isNaN(current)) {
                calcCurrentInput = 'Error'; // Should not happen if inputs are validated
                updateCalcDisplay();
                return;
            }

            let result = 0;
            switch (calcOperator) {
                case '+': result = prev + current; break;
                case '-': result = prev - current; break;
                case '*': result = prev * current; break;
                case '/': 
                    if (current === 0) {
                        result = 'Error';
                    } else {
                        result = prev / current;
                    }
                    break;
                default: return;
            }

            if (result === 'Error') {
                calcCurrentInput = 'Error';
            } else {
                // Check if result is a valid number and not Infinity or NaN
                if (!isFinite(result)) {
                    calcCurrentInput = 'Error';
                } else {
                    // Format result: if it's a very small or large number, handle differently
                    try {
                        // Handle large numbers better - use toFixed for numbers that are too large
                        if (Math.abs(result) > 1e10) {
                            let resultStr = result.toExponential(6);
                            calcCurrentInput = resultStr;
                        } else if (Math.abs(result) < 1e-6 && result !== 0) {
                            // Small numbers in scientific notation
                            let resultStr = result.toExponential(6);
                            calcCurrentInput = resultStr;
                        } else {
                            // Normal sized numbers - keep precision but remove trailing zeros
                            let resultStr = parseFloat(result.toPrecision(10)).toString();
                            calcCurrentInput = resultStr;
                        }
                    } catch (e) {
                        // Fallback if formatting fails
                        calcCurrentInput = String(result);
                    }
                    
                    // Additional safety - if we end up with an invalid display value, show Error
                    if (calcCurrentInput === 'NaN' || calcCurrentInput === 'Infinity' || calcCurrentInput === '-Infinity') {
                        calcCurrentInput = 'Error';
                    }
                }
            }
            calcOperator = null;
            calcShouldResetDisplay = true; 
            updateCalcDisplay();
        }

        function handleMemory(action) {
            const currentValue = parseFloat(calcCurrentInput);
            if (calcCurrentInput === 'Error' && action !== 'mrc') return;

            switch (action) {
                case 'm+':
                    if (!isNaN(currentValue)) calcMemory += currentValue;
                    updateCalcDisplay();
                    break;
                case 'm-':
                    if (!isNaN(currentValue)) calcMemory -= currentValue;
                    updateCalcDisplay();
                    break;
                case 'mrc':
                    if (calcMrcPressedOnce) { 
                        calcMemory = 0;
                        calcMrcPressedOnce = false;
                        // Optionally, could also clear display to 0 here
                    } else { 
                        calcCurrentInput = String(parseFloat(calcMemory.toPrecision(10))); // Show memory with precision
                        calcMrcPressedOnce = true;
                        calcShouldResetDisplay = true; 
                    }
                    break;
            }
            if (action !== 'mrc') { // For M+ and M-, display doesn't change immediately
                calcShouldResetDisplay = true; // Next number input should overwrite current display
                calcMrcPressedOnce = false; 
            } else {
                updateCalcDisplay(); // For MRC, update display immediately
            }
        }

        function handleSpecialFunction(func) {
            if (calcCurrentInput === 'Error' && func !== 'clear') return;
            const currentValue = parseFloat(calcCurrentInput);

            switch (func) {
                case 'sqrt':
                    if (currentValue < 0 || isNaN(currentValue)) {
                        calcCurrentInput = 'Error';
                    } else {
                        try {
                            const sqrtResult = Math.sqrt(currentValue);
                            if (!isFinite(sqrtResult)) {
                                calcCurrentInput = 'Error';
                            } else {
                                calcCurrentInput = String(parseFloat(sqrtResult.toPrecision(10)));
                            }
                        } catch (e) {
                            calcCurrentInput = 'Error';
                        }
                    }
                    break;
                case 'percent':
                    if (isNaN(currentValue)) { calcCurrentInput = 'Error'; break; }
                    if (calcPreviousInput !== '' && calcOperator) {
                        const prev = parseFloat(calcPreviousInput);
                        if (isNaN(prev)) { calcCurrentInput = 'Error'; break; }
                        
                        try {
                            const percentResult = prev * (currentValue / 100);
                            if (!isFinite(percentResult)) {
                                calcCurrentInput = 'Error';
                            } else {
                                calcCurrentInput = String(parseFloat(percentResult.toPrecision(10)));
                            }
                        } catch (e) {
                            calcCurrentInput = 'Error';
                        }
                    } else { 
                        try {
                            const percentResult = currentValue / 100;
                            if (!isFinite(percentResult)) {
                                calcCurrentInput = 'Error';
                            } else {
                                calcCurrentInput = String(parseFloat(percentResult.toPrecision(10)));
                            }
                        } catch (e) {
                            calcCurrentInput = 'Error';
                        }
                    }
                    break;
                case 'negate':
                     if (calcCurrentInput !== '0' && !isNaN(currentValue)) { 
                        calcCurrentInput = String(currentValue * -1);
                    }
                    break;
                case 'backspace':
                    if (calcCurrentInput === 'Error' || calcShouldResetDisplay) {
                        calcCurrentInput = '0';
                        calcShouldResetDisplay = false;
                    } else if (calcCurrentInput.length > 1) {
                        calcCurrentInput = calcCurrentInput.slice(0, -1);
                    } else {
                        calcCurrentInput = '0';
                    }
                    break;
                case 'clear':
                    clearCalculator();
                    return; // Skip further processing
            }
            updateCalcDisplay();
            if (func !== 'backspace' && func !== 'negate' && func !== 'clear') { 
                calcShouldResetDisplay = true;
            }
            calcMrcPressedOnce = false;
        }


        function toggleCalculator() {
            const isVisible = calculatorUI.classList.toggle('visible');
            calculatorToggleButton.classList.toggle('active', isVisible);
            if (isVisible) {
                clearCalculator(); 
            }
        }
        
        // Draggable Calculator Logic
        function makeDraggable(element, handle) {
            let currentX, currentY;

            handle.onmousedown = function(event) {
                event.preventDefault();
                isDraggingCalculator = true;
                calculatorUI.style.cursor = 'grabbing';

                // Get the initial mouse cursor position
                currentX = event.clientX;
                currentY = event.clientY;

                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            };

            function elementDrag(event) {
                event.preventDefault();
                if (!isDraggingCalculator) return;

                // Calculate the new cursor position
                const dx = currentX - event.clientX;
                const dy = currentY - event.clientY;
                currentX = event.clientX;
                currentY = event.clientY;

                // Set the element's new position
                let newTop = element.offsetTop - dy;
                let newLeft = element.offsetLeft - dx;

                // Constrain within app-container (optional, can be complex)
                const appRect = appContainer.getBoundingClientRect();
                const calcRect = element.getBoundingClientRect();
                
                // Simple boundary check (relative to viewport for now, as appContainer might scroll)
                // For more robust boundary, calculate relative to appContainer's scroll position
                if (newLeft < 0) newLeft = 0;
                if (newTop < 0) newTop = 0;
                if (newLeft + calcRect.width > window.innerWidth) newLeft = window.innerWidth - calcRect.width;
                if (newTop + calcRect.height > window.innerHeight) newTop = window.innerHeight - calcRect.height;


                element.style.top = newTop + "px";
                element.style.left = newLeft + "px";
            }

            function closeDragElement() {
                isDraggingCalculator = false;
                calculatorUI.style.cursor = 'grab';
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }


        // --- Event Listeners ---
        startButton.addEventListener('click', () => {
            console.log("Start button event listener triggered, calling window.startTest()");
            window.startTest();
        });

        nextButton.addEventListener('click', showNextQuestion);
        prevButton.addEventListener('click', showPrevQuestion);
        endPracticeSessionButton.addEventListener('click', endPracticeSessionAndShowResults);
        endPracticeSessionButtonFooter.addEventListener('click', handleEndPracticeSessionFooterClick);
        backToResultsButton.addEventListener('click', () => { isReviewingFromResults = false; showResultsScreen(); });
        navigatorButton.addEventListener('click', () => { 
            // Hide calculator if it's open
            if (calculatorUI.classList.contains('visible')) {
                toggleCalculator(); 
            }
            recordTimeSpent(currentQuestionIndex); 
            updateNavigatorButtons(); 
            navigatorModal.classList.remove('hidden'); 
            navigatorModal.classList.add('flex'); 
        });
        closeModalButton.addEventListener('click', () => { navigatorModal.classList.remove('flex'); navigatorModal.classList.add('hidden'); if (!isReviewingFromResults) questionStartTime = Date.now(); });
        navigatorModal.addEventListener('click', (event) => { if (event.target === navigatorModal) closeModalButton.click(); });
        flagButton.addEventListener('click', toggleFlag);
        filterFlaggedButton.addEventListener('click', () => { isFilteringFlagged = !isFilteringFlagged; showReviewScreen(isFilteringFlagged); });
        downloadPdfButton.addEventListener('click', generatePDF);
        document.getElementById('submit-performance-button').addEventListener('click', submitPerformanceData);

        calculatorToggleButton.addEventListener('click', toggleCalculator);
        closeCalculatorButton.addEventListener('click', toggleCalculator);
        makeDraggable(calculatorUI, calculatorDragHeader);

        // Add a direct event listener for the equals button to ensure it works
        const equalsButton = document.querySelector('.calc-button.equals');
        if (equalsButton) {
            equalsButton.addEventListener('click', function(e) {
                console.log('Equals button clicked directly');
                calculate();
            });
        }

        // Add direct event listeners for all calculator buttons to ensure they work
        calcButtons.forEach(button => {
            button.addEventListener('click', function() {
                const value = button.dataset.calcValue;
                const action = button.dataset.calcAction;
                console.log('Calculator button clicked:', button.textContent, 'Value:', value, 'Action:', action);
                
                if (value !== undefined) { 
                    if (value === '.') { inputDecimal(); } 
                    else { inputDigit(value); }
                } else if (action) { 
                    if (['+', '-', '*', '/'].includes(action)) { handleOperator(action); } 
                    else if (action === 'equals') { 
                        console.log('Equals action triggered');
                        calculate(); 
                    } 
                    else if (action === 'clear') { clearCalculator(); } 
                    else if (['m+', 'm-', 'mrc'].includes(action)) { handleMemory(action); } 
                    else if (['sqrt', 'percent', 'negate', 'backspace'].includes(action)) { handleSpecialFunction(action); }
                }
            });
        });

        function handleKeyboardShortcuts(e) {
             const isPracticeSessionVisible = !practiceSessionScreen.classList.contains('hidden');
             const isModalVisible = navigatorModal.classList.contains('flex');
             const isInputFocused = document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA');
             const isCalcVisible = calculatorUI.classList.contains('visible');

             if (isCalcVisible && !isInputFocused) { 
                if (e.key >= '0' && e.key <= '9') { e.preventDefault(); inputDigit(e.key); return; }
                if (e.key === '.') { e.preventDefault(); inputDecimal(); return; }
                if (e.key === '+' || e.key === '-' || e.key === '*' || e.key === '/') { e.preventDefault(); handleOperator(e.key); return; }
                if (e.key === 'Enter' || e.key === '=') { e.preventDefault(); calculate(); return; }
                if (e.key === 'Backspace') { e.preventDefault(); handleSpecialFunction('backspace'); return; }
                if (e.key === 'Escape') { e.preventDefault(); toggleCalculator(); return; } 
                if (e.key.toLowerCase() === 'p') { e.preventDefault(); handleMemory('m+'); return; }
                if (e.key.toLowerCase() === 'm') { e.preventDefault(); handleMemory('m-'); return; }
                if (e.key.toLowerCase() === 'c' && !e.altKey && !e.metaKey && !e.ctrlKey) { e.preventDefault(); handleMemory('mrc'); return; } 
                if (e.key.toLowerCase() === 'x') { e.preventDefault(); handleSpecialFunction('sqrt'); return; }
             }
             
             if (isModalVisible || isInputFocused) return; 
             if (!isPracticeSessionVisible) return; 
             
             const key = e.key.toLowerCase();
             const altOrOption = e.altKey || e.metaKey; 
             const code = e.code.toLowerCase(); 

             if (altOrOption) {
                 switch (code) { 
                     case 'keyn': e.preventDefault(); if (!nextButton.disabled) nextButton.click(); return;
                     case 'keyp': e.preventDefault(); if (!prevButton.disabled) prevButton.click(); return;
                     case 'keyf': e.preventDefault(); if (!isReviewingFromResults && !flagButton.disabled) flagButton.click(); return;
                     case 'keyc': e.preventDefault(); toggleCalculator(); return; 
                     default: return; 
                 }
             } else { 
                 if (['a', 'b', 'c', 'd', 'e'].includes(key) && !isReviewingFromResults && !isCalcVisible) { 
                     e.preventDefault();
                     const optionIndex = ['a', 'b', 'c', 'd', 'e'].indexOf(key);
                     const optionValue = ['A', 'B', 'C', 'D', 'E'][optionIndex];
                     const currentQuestionData = questions[currentQuestionIndex];
                     if (optionIndex < currentQuestionData.options.length) {
                         handleOptionSelect(currentQuestionIndex, optionIndex, optionValue);
                     }
                     return;
                 }
             }
        }
        document.addEventListener('keydown', handleKeyboardShortcuts);

        // --- Initial Load ---
        // Only initialize the setup screen if we're not in review mode
        if (!urlParams.has('review')) {
            showSetupScreen();
        }

        updateCalcDisplay(); 

        // Update the review grid button click handler to not restart the timer
        reviewGrid.addEventListener('click', (e) => {
            if (e.target.classList.contains('review-grid-button')) {
                reviewScreen.classList.add('hidden');
                reviewScreen.classList.remove('flex');
                showPracticeSessionScreen();
                const index = parseInt(e.target.dataset.questionIndex);
                if (!isNaN(index) && index >= 0 && index < questions.length) {
                    // Hide calculator if it's open
                    if (calculatorUI.classList.contains('visible')) {
                        toggleCalculator();
                    }
                    loadQuestion(index);
                    updateTimerVisibility();
                }
            }
        });

        // Add keyboard event listeners for Enter key on the appropriate pages
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !event.ctrlKey && !event.shiftKey && !event.altKey && !event.metaKey) {
                const isInputOrTextareaFocused = document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA';
                
                // Only handle Enter key if no input or textarea is focused
                if (!isInputOrTextareaFocused) {
                    // Check which screen is active
                    if (!setupScreen.classList.contains('hidden')) {
                        // Begin test button on setup screen
                        startButton.click();
                        event.preventDefault();
                    } else if (!reviewScreen.classList.contains('hidden')) {
                        // End practice session button on review screen
                        endPracticeSessionButton.click();
                        event.preventDefault();
                    }
                }
            }
        });

        // Make sure the submit button has the right event listener
        const submitPerformanceBtn = document.getElementById('submit-performance-button');
        if (submitPerformanceBtn) {
            // Remove any existing listeners (just in case)
            submitPerformanceBtn.removeEventListener('click', submitPerformanceData);
            // Add the listener
            submitPerformanceBtn.addEventListener('click', submitPerformanceData);
        }

        // Function to handle loading a past test for review
        function loadPastTestForReview(resultId) {
            setupScreen.classList.add('hidden');
            
            // Show a loading indicator
            const loadingEl = document.createElement('div');
            loadingEl.className = 'fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center z-50';
            loadingEl.innerHTML = `
                <div class="text-center p-6 bg-white shadow-xl rounded-lg">
                    <div class="spinner mx-auto mb-4"></div>
                    <p class="text-gray-700 font-medium">Loading your test results...</p>
                </div>
            `;
            document.body.appendChild(loadingEl);
            
            // Fetch the result from Firestore
            db.collection("performanceSubmissions").doc(resultId)
                .get()
                .then((doc) => {
                    if (!doc.exists) {
                        alert("The requested test result could not be found.");
                        window.location.href = "student_dashboard.html";
                        return;
                    }
                    
                    const resultData = doc.data();
                    
                    // Store the data in the appropriate variables
                    userName = resultData.studentName || '';
                    userGoal = resultData.goal || '';
                    userFocusArea = resultData.focusArea || '';
                    userAnswers = resultData.answers || new Array(questions.length).fill(null);
                    questionTimes = resultData.questionTimes || new Array(questions.length).fill(0);
                    flaggedQuestions = resultData.flaggedQuestions || new Array(questions.length).fill(false);
                    practiceSessionStartTime = new Date(resultData.submissionTimestamp || Date.now());
                    practiceSessionEndTime = new Date(practiceSessionStartTime.getTime() + 26 * 60 * 1000); // Estimate end time
                    isReviewingFromResults = true;
                    
                    // Remove loading indicator
                    document.body.removeChild(loadingEl);
                    
                    // Show the results screen with the data
                    showResultsScreen();
                    
                    // Add a "Return to Results" button to the header
                    const headerBar = document.querySelector('.header-bar');
                    if (headerBar) {
                        const returnButtonContainer = document.createElement('div');
                        returnButtonContainer.className = 'absolute left-4';
                        returnButtonContainer.innerHTML = `
                            <button id="return-to-dashboard-results" class="bg-blue-500 text-white px-3 py-1 rounded text-sm flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                                </svg>
                                Return to Results
                            </button>
                        `;
                        headerBar.style.position = 'relative';
                        headerBar.appendChild(returnButtonContainer);
                        
                        // Add event listener to the return button
                        document.getElementById('return-to-dashboard-results').addEventListener('click', () => {
                            window.location.href = "student_dashboard.html";
                        });
                    }
                })
                .catch((error) => {
                    console.error("Error loading test result:", error);
                    alert("There was an error loading the test result. Please try again.");
                    window.location.href = "student_dashboard.html";
                });
        }
        
        // Add a direct click event listener to the Start button to ensure it works
        document.getElementById('start-button').addEventListener('click', function() {
            console.log("Start button clicked via direct listener");
            // Get user info from Firebase Auth if available
            if (firebase.auth && firebase.auth().currentUser) {
                const currentUser = firebase.auth().currentUser;
                userName = currentUser.displayName || currentUser.email || '';
                // Store email to be used later in submission
                userEmail = currentUser.email || '';
                console.log("Using user info from Firebase:", userName, userEmail);
            } else {
                userName = '';
                userEmail = '';
                console.log("No user logged in - using empty user info");
            }
            
            userGoal = goalInput.value.trim();
            userFocusArea = focusAreaInput.value.trim();
            timeLeft = 360; // 6 minutes
            userAnswers = new Array(questions.length).fill(null);
            questionTimes = new Array(questions.length).fill(0);
            flaggedQuestions = new Array(questions.length).fill(false);
            questionStartTime = null;
            currentQuestionIndex = 0;
            isReviewingFromResults = false;
            isFilteringFlagged = false;
            currentlyDisplayedPassageIndex = -1;
            practiceSessionEndTime = null;
            showPracticeSessionScreen();
            startTimer();
            loadQuestion(0);
            populateNavigator();
        });
        
        // Function to initialize the application - moved to the end to ensure all functions are defined
        function initializeApp() {
            // Initialize arrays with questions.length
            userAnswers = new Array(questions.length).fill(null);
            questionTimes = new Array(questions.length).fill(0);
            flaggedQuestions = new Array(questions.length).fill(false);
            
            // Check for review mode and initialize appropriate screen
            if (reviewParam) {
                // We're in review mode - load the past test data
                loadPastTestForReview(reviewParam);
            } else {
                // Regular test mode - continue with normal setup
                showSetupScreen();
            }
        }
        
        // Actually initialize the app now that all functions and DOM elements are defined
        initializeApp();

        // Initialize drag and drop functionality
        function initDragAndDrop() {
            const yesButton = document.getElementById('yes-button');
            const noButton = document.getElementById('no-button');
            const statementRows = document.querySelectorAll('.statement-row');
            
            if (!yesButton || !noButton) return;
            
            let draggedValue = null;
            
            // Make buttons draggable
            [yesButton, noButton].forEach(button => {
                button.setAttribute('draggable', true);
                
                button.addEventListener('dragstart', function(e) {
                    draggedValue = this.textContent;
                    e.dataTransfer.setData('text/plain', draggedValue);
                    this.classList.add('opacity-50');
                });
                
                button.addEventListener('dragend', function() {
                    this.classList.remove('opacity-50');
                });
                
                // Click functionality as alternative to drag
                button.addEventListener('click', function() {
                    const selectedRow = document.querySelector('.statement-row.selected');
                    if (selectedRow) {
                        const statementIndex = parseInt(selectedRow.dataset.statementIndex);
                        const answerBox = selectedRow.querySelector('.statement-answer-box');
                        
                        answerBox.textContent = this.textContent;
                        selectedRow.classList.remove('selected', 'border-blue-500', 'bg-blue-50');
                        
                        // Update userAnswers array
                        if (!userAnswers[currentQuestionIndex]) {
                            userAnswers[currentQuestionIndex] = [];
                        }
                        // Store the answer format expected by the scoring system (Y/N)
                        if (this.textContent === "Yes") {
                            userAnswers[currentQuestionIndex][statementIndex] = "Y";
                        } else if (this.textContent === "No") {
                            userAnswers[currentQuestionIndex][statementIndex] = "N";
                        } else {
                            userAnswers[currentQuestionIndex][statementIndex] = this.textContent;
                        }
                        
                        updateNavigatorButtons();
                    }
                });
            });
            
            // Make entire statement rows droppable
            statementRows.forEach(row => {
                row.addEventListener('click', function() {
                    // Clear any previous selections
                    document.querySelectorAll('.statement-row.selected').forEach(el => {
                        el.classList.remove('selected', 'border-blue-500', 'bg-blue-50');
                    });
                    
                    // Select this row
                    this.classList.add('selected', 'border-blue-500', 'bg-blue-50');
                });
                
                row.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('border-blue-500', 'bg-blue-50');
                });
                
                row.addEventListener('dragleave', function() {
                    this.classList.remove('border-blue-500', 'bg-blue-50');
                });
                
                row.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('border-blue-500', 'bg-blue-50');
                    
                    const value = e.dataTransfer.getData('text/plain');
                    const answerBox = this.querySelector('.statement-answer-box');
                    answerBox.textContent = value;
                    
                    // Update userAnswers array
                    const statementIndex = parseInt(this.dataset.statementIndex);
                    if (!userAnswers[currentQuestionIndex]) {
                        userAnswers[currentQuestionIndex] = [];
                    }
                    // Convert to Y/N format for consistency with scoring
                    if (value === "Yes") {
                        userAnswers[currentQuestionIndex][statementIndex] = "Y";
                    } else if (value === "No") {
                        userAnswers[currentQuestionIndex][statementIndex] = "N";
                    } else {
                        userAnswers[currentQuestionIndex][statementIndex] = value;
                    }
                    
                    updateNavigatorButtons();
                });
            });
        }
    }); // Closing bracket for DOMContentLoaded
    </script>
</body>
</html>