<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UCAT DM Syllogisms Worksheet 1 - MedwithPurpose</title> {/* Title from original DM sylls 1.html */}
    <link rel="icon" href="https://ik.imagekit.io/mwp/2.svg?updatedAt=1745982956185" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
    <style id="m3-styles">
        /* M3 Base Styles from DM sylls 2.html */
        :root {
          /* Brand Colors - DM Theme (Indigo/Purple) */
          --md-sys-color-primary: #6750A4; /* M3 Purple */
          --md-sys-color-on-primary: #FFFFFF;
          --md-sys-color-primary-container: #EADDFF;
          --md-sys-color-on-primary-container: #21005D;

          --md-sys-color-secondary: #625B71; /* M3 Neutral Purple-ish */
          --md-sys-color-on-secondary: #FFFFFF;
          --md-sys-color-secondary-container: #E8DEF8;
          --md-sys-color-on-secondary-container: #1D192B;

          --md-sys-color-tertiary: #7D5260; /* M3 Tertiary Pink-ish */
          --md-sys-color-on-tertiary: #FFFFFF;
          --md-sys-color-tertiary-container: #FFD8E4;
          --md-sys-color-on-tertiary-container: #31111D;

          /* Neutral Colors */
          --md-sys-color-background: #FFFBFE; /* M3 Surface Tone Background */
          --md-sys-color-on-background: #1C1B1F;
          --md-sys-color-surface: #FFFBFE; 
          --md-sys-color-on-surface: #1C1B1F;
          --md-sys-color-surface-variant: #E7E0EC;
          --md-sys-color-on-surface-variant: #49454F;
          --md-sys-color-surface-container-lowest: #FFFFFF;
          --md-sys-color-surface-container-low: #F7F2FA;
          --md-sys-color-surface-container: #F3EDF7;
          --md-sys-color-surface-container-high: #ECE6F0;
          --md-sys-color-surface-container-highest: #E6E0E9;

          --md-sys-color-outline: #79747E;
          --md-sys-color-outline-variant: #CAC4D0;

          /* Utility Colors */
          --md-sys-color-error: #B3261E; 
          --md-sys-color-on-error: #FFFFFF;
          --md-sys-color-error-container: #F9DEDC;
          --md-sys-color-on-error-container: #410E0B;
          --md-sys-color-success: #1E8E3E; /* Added for consistency */
          --md-sys-color-on-success: #FFFFFF;
          --md-sys-color-success-container: #C8E6C9;
          --md-sys-color-on-success-container: #0D3C1E;
          --md-sys-color-warning-container: #FFDDB3; /* For flagged in results */
          --md-sys-color-on-warning-container: #2B1700;
          --md-sys-color-scrim: #000000;
          --md-sys-color-scrim-rgb: 0,0,0;

          /* Shape */
          --md-sys-shape-corner-none: 0px;
          --md-sys-shape-corner-extra-small: 4px;
          --md-sys-shape-corner-small: 8px;
          --md-sys-shape-corner-medium: 12px;
          --md-sys-shape-corner-large: 16px;
          --md-sys-shape-corner-extra-large: 28px;
          --md-sys-shape-corner-full: 9999px;

          /* Typography - Using Inter as base */
          --md-sys-typescale-font-family-name: 'Inter', sans-serif;
          --md-sys-typescale-display-large-font-size: 3.5625rem; 
          --md-sys-typescale-display-large-line-height: 4rem; 
          --md-sys-typescale-display-large-font-weight: 400;
          --md-sys-typescale-headline-large-font-size: 2rem; 
          --md-sys-typescale-headline-large-line-height: 2.5rem; 
          --md-sys-typescale-headline-large-font-weight: 700; 
          --md-sys-typescale-title-large-font-size: 1.375rem; 
          --md-sys-typescale-title-large-line-height: 1.75rem; 
          --md-sys-typescale-title-large-font-weight: 700;
          --md-sys-typescale-body-large-font-size: 1rem; 
          --md-sys-typescale-body-large-line-height: 1.5rem; 
          --md-sys-typescale-body-large-font-weight: 400;
          --md-sys-typescale-label-large-font-size: 0.875rem; 
          --md-sys-typescale-label-large-line-height: 1.25rem; 
          --md-sys-typescale-label-large-font-weight: 600;
        }
        /* M3 Button Component Styles from DM sylls 2.html */
        .m3-button {
          font-family: var(--md-sys-typescale-label-large-font-family-name);
          font-size: var(--md-sys-typescale-label-large-font-size);
          font-weight: var(--md-sys-typescale-label-large-font-weight);
          line-height: var(--md-sys-typescale-label-large-line-height);
          padding: 0.625rem 1.5rem; 
          border-radius: var(--md-sys-shape-corner-full);
          border: none;
          cursor: pointer;
          text-align: center;
          text-decoration: none;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          min-height: 2.5rem; 
          transition: background-color 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease;
        }
        .m3-button:hover:not(:disabled) { box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06); }
        .m3-button:active:not(:disabled) { transform: scale(0.97); box-shadow: none; }
        .m3-button:disabled { cursor: not-allowed; box-shadow: none; }
        .m3-button .material-symbols-outlined { font-size: 1.125rem; margin-right: 0.5rem; }
        .m3-button.icon-only .material-symbols-outlined { margin-right: 0; }

        .m3-button-filled {
          background-color: var(--md-sys-color-primary);
          color: var(--md-sys-color-on-primary);
        }
        .m3-button-filled:hover:not(:disabled) { background-color: color-mix(in srgb, var(--md-sys-color-primary) 92%, var(--md-sys-color-on-primary) 8%); }
        .m3-button-filled:disabled {
          background-color: color-mix(in srgb, var(--md-sys-color-on-surface) 12%, transparent);
          color: color-mix(in srgb, var(--md-sys-color-on-surface) 38%, transparent);
        }
        .m3-button-filled-error {
          background-color: var(--md-sys-color-error);
          color: var(--md-sys-color-on-error);
        }
        .m3-button-filled-error:hover:not(:disabled) { background-color: color-mix(in srgb, var(--md-sys-color-error) 92%, var(--md-sys-color-on-error) 8%);}

        .m3-button-outlined {
          background-color: transparent;
          color: var(--md-sys-color-primary);
          border: 1px solid var(--md-sys-color-outline);
        }
        .m3-button-outlined:hover:not(:disabled) { background-color: color-mix(in srgb, var(--md-sys-color-primary) 8%, transparent); }
        .m3-button-outlined:disabled {
          border-color: color-mix(in srgb, var(--md-sys-color-on-surface) 12%, transparent);
          color: color-mix(in srgb, var(--md-sys-color-on-surface) 38%, transparent);
        }

        .m3-button-text {
          background-color: transparent;
          color: var(--md-sys-color-primary);
          padding: 0.625rem 0.75rem; 
        }
        .m3-button-text:hover:not(:disabled) { background-color: color-mix(in srgb, var(--md-sys-color-primary) 8%, transparent); }
        .m3-button-text:disabled { color: color-mix(in srgb, var(--md-sys-color-on-surface) 38%, transparent); }
        
        .m3-icon-button {
          display: inline-flex; align-items: center; justify-content: center;
          width: 2.5rem; height: 2.5rem; 
          padding: 0.5rem; 
          border-radius: var(--md-sys-shape-corner-full);
          background-color: transparent;
          color: var(--md-sys-color-on-surface-variant);
          border: none; cursor: pointer;
        }
        .m3-icon-button .material-symbols-outlined { font-size: 1.5rem; margin: 0; }
        .m3-icon-button:hover:not(:disabled) { background-color: color-mix(in srgb, currentColor 12%, transparent); }
        .m3-icon-button:disabled { color: color-mix(in srgb, var(--md-sys-color-on-surface) 38%, transparent); background-color: transparent; }
        .m3-icon-button.selected {
            background-color: color-mix(in srgb, var(--md-sys-color-primary) 12%, transparent);
            color: var(--md-sys-color-primary);
        }
        .m3-icon-button.selected .material-symbols-outlined {
            font-variation-settings: 'FILL' 1;
        }

        .m3-dialog-scrim {
          position: fixed; top: 0; left: 0; width: 100%; height: 100%;
          background-color: rgba(var(--md-sys-color-scrim-rgb), 0.4);
          display: flex; align-items: center; justify-content: center;
          z-index: 100;
        }
        .m3-dialog {
          background-color: var(--md-sys-color-surface-container-high);
          color: var(--md-sys-color-on-surface);
          border-radius: var(--md-sys-shape-corner-extra-large);
          padding: 1.5rem;
          width: calc(100% - 3.5rem);
          max-width: 35rem;
          box-shadow: 0px 8px 12px 6px rgba(0,0,0,0.15), 0px 4px 8px rgba(0,0,0,0.3);
          display: flex; flex-direction: column;
          max-height: calc(100% - 3.5rem);
        }
        .m3-dialog-title {
          font-family: var(--md-sys-typescale-font-family-name);
          font-size: 1.5rem; 
          font-weight: 600;
          line-height: 2rem; 
          color: var(--md-sys-color-on-surface);
          margin-bottom: 1rem; 
        }
        .m3-dialog-content {
          font-family: var(--md-sys-typescale-body-large-font-family-name);
          color: var(--md-sys-color-on-surface-variant);
          margin-bottom: 1.5rem; 
          overflow-y: auto;
        }
        .m3-dialog-actions { display: flex; justify-content: flex-end; gap: 0.5rem; }

        /* Typography helpers */
        .m3-body-large {
          font-family: var(--md-sys-typescale-body-large-font-family-name);
          font-size: var(--md-sys-typescale-body-large-font-size);
          font-weight: var(--md-sys-typescale-body-large-font-weight);
          line-height: var(--md-sys-typescale-body-large-line-height);
          color: var(--md-sys-color-on-surface);
        }
        .m3-title-large {
          font-family: var(--md-sys-typescale-title-large-font-family-name);
          font-size: var(--md-sys-typescale-title-large-font-size);
          font-weight: var(--md-sys-typescale-title-large-font-weight);
          line-height: var(--md-sys-typescale-title-large-line-height);
          color: var(--md-sys-color-on-surface);
        }
        .m3-label-large {
          font-family: var(--md-sys-typescale-label-large-font-family-name);
          font-size: var(--md-sys-typescale-label-large-font-size);
          font-weight: var(--md-sys-typescale-label-large-font-weight);
          line-height: var(--md-sys-typescale-label-large-line-height);
        }

        /* Material Symbols base style */
        .material-symbols-outlined {
          font-family: 'Material Symbols Outlined';
          font-weight: normal; font-style: normal;
          font-size: 24px; line-height: 1;
          letter-spacing: normal; text-transform: none;
          display: inline-block; white-space: nowrap; word-wrap: normal;
          direction: ltr;
          -webkit-font-smoothing: antialiased;
          text-rendering: optimizeLegibility;
          -moz-osx-font-smoothing: grayscale;
          font-feature-settings: 'liga';
          vertical-align: middle; /* Added for better alignment */
        }
    </style>
    <style>
        /* Custom styles for DM Syllogisms page, based on DM Sylls 2.html */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; 
        }
        body {
            font-family: var(--md-sys-typescale-font-family-name);
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--md-sys-color-background);
        }
        #app-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 2rem); 
            width: 100%;
            max-width: 1400px; /* Max width for large screens */
            background-color: var(--md-sys-color-surface);
            border: 1px solid var(--md-sys-color-outline-variant);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); /* M3 Elevation 1-2 */
            border-radius: var(--md-sys-shape-corner-large); 
            margin: 1rem; 
            overflow: hidden; 
            position: relative; 
        }
        
        .header-bar { 
            flex-shrink: 0;
            background-color: var(--md-sys-color-primary); 
            color: var(--md-sys-color-on-primary); 
            padding: 0.75rem 1.5rem; 
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 20; 
        }

        .secondary-toolbar { 
            flex-shrink: 0;
            background-color: var(--md-sys-color-surface-container); 
            color: var(--md-sys-color-on-surface-variant); 
            padding: 0.5rem 1.5rem; 
            display: flex;
            justify-content: flex-end; /* Only flag button here */
            align-items: center;
            border-bottom: 1px solid var(--md-sys-color-outline-variant); 
            z-index: 19;
        }
        
        #timer {
             background-color: color-mix(in srgb, var(--md-sys-color-on-primary) 15%, transparent); 
             color: var(--md-sys-color-on-primary); 
             font-family: var(--md-sys-typescale-label-large-font-family-name);
             font-size: var(--md-sys-typescale-label-large-font-size);
             font-weight: var(--md-sys-typescale-label-large-font-weight);
             padding: 0.375rem 0.75rem; 
             border-radius: var(--md-sys-shape-corner-small); 
        }
        
        .footer-bar {
            flex-shrink: 0;
            background-color: var(--md-sys-color-surface-container); 
            color: var(--md-sys-color-on-surface); 
            padding: 0.75rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid var(--md-sys-color-outline-variant);
        }
        
        .main-content-area {
            flex-grow: 1; 
            display: block; /* Single column for syllogisms */
            overflow: hidden; 
            padding: 1.5rem; /* Increased padding */
            background-color: var(--md-sys-color-surface); 
        }
        .question-column { /* Takes full width */
            width: 100%;
            max-width: 800px; /* Max width for readability */
            margin: 0 auto; /* Center the content */
            overflow-y: auto; 
            padding: 1rem;
            border: none; 
            border-radius: var(--md-sys-shape-corner-medium); 
            background-color: var(--md-sys-color-surface-container-lowest); 
            height: 100%; 
            position: relative; 
            color: var(--md-sys-color-on-surface); 
            font-family: var(--md-sys-typescale-body-large-font-family-name);
            font-size: var(--md-sys-typescale-body-large-font-size);
            line-height: var(--md-sys-typescale-body-large-line-height);
        }
        .question-column h4 { 
            font-family: var(--md-sys-typescale-title-large-font-family-name);
            font-size: var(--md-sys-typescale-title-large-font-size);
            font-weight: var(--md-sys-typescale-title-large-font-weight);
            color: var(--md-sys-color-on-surface-variant);
            margin-bottom: 0.75rem;
        }
        .question-column p#question-text { /* This ID is not used for Syllogisms structure */
            font-size: 1.125rem; 
            line-height: 1.625rem;
            margin-bottom: 1.25rem;
        }
        .premises-container {
            background-color: var(--md-sys-color-surface-container);
            padding: 1rem;
            border-radius: var(--md-sys-shape-corner-medium);
            margin-bottom: 1.5rem;
            border: 1px solid var(--md-sys-color-outline-variant);
        }
        .premises-container h3 {
            font-family: var(--md-sys-typescale-title-medium-font-family-name);
            font-weight: var(--md-sys-font-weight-medium);
            color: var(--md-sys-color-on-surface-variant);
            margin-bottom: 0.5rem;
        }
        .premises-container p {
            font-family: var(--md-sys-typescale-body-large-font-family-name);
            color: var(--md-sys-color-on-surface);
            line-height: 1.6;
        }

        .syllogism-options-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .syllogism-options-header h5 {
            font-family: var(--md-sys-typescale-title-medium-font-family-name);
            font-weight: var(--md-sys-font-weight-medium);
            color: var(--md-sys-color-on-surface);
        }
        .syllogism-options-header p {
            font-family: var(--md-sys-typescale-body-medium-font-family-name);
            color: var(--md-sys-color-on-surface-variant);
        }
        .drag-buttons-container {
            display: flex;
            gap: 0.5rem;
        }
        .drag-button { /* M3 Filled Tonal Button style */
            padding: 0.5rem 1rem;
            border-radius: var(--md-sys-shape-corner-full);
            font-family: var(--md-sys-typescale-label-large-font-family-name);
            font-weight: var(--md-sys-font-weight-medium);
            cursor: grab;
            user-select: none;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
            border: 1px solid transparent; /* Base border */
        }
        .drag-button:active { cursor: grabbing; }
        .drag-button.dragging { opacity: 0.7; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }

        #yes-button {
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            border-color: var(--md-sys-color-primary-container);
        }
        #yes-button:hover { background-color: color-mix(in srgb, var(--md-sys-color-primary) 12%, var(--md-sys-color-primary-container));}

        #no-button {
            background-color: var(--md-sys-color-error-container);
            color: var(--md-sys-color-on-error-container);
            border-color: var(--md-sys-color-error-container);
        }
        #no-button:hover { background-color: color-mix(in srgb, var(--md-sys-color-error) 12%, var(--md-sys-color-error-container));}
        
        .statement-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: var(--md-sys-shape-corner-medium);
            background-color: var(--md-sys-color-surface-container-lowest);
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        .statement-row.drag-over {
            background-color: var(--md-sys-color-secondary-container);
            border-color: var(--md-sys-color-secondary);
        }
        .statement-text {
            flex-grow: 1;
            font-family: var(--md-sys-typescale-body-large-font-family-name);
            color: var(--md-sys-color-on-surface);
        }
        .statement-answer-box {
            width: 4.5rem; /* 72px */
            height: 2.25rem; /* 36px */
            border: 2px dashed var(--md-sys-color-outline-variant);
            border-radius: var(--md-sys-shape-corner-small);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--md-sys-typescale-label-large-font-family-name);
            font-weight: var(--md-sys-font-weight-medium);
            color: var(--md-sys-color-on-surface-variant);
            margin-left: 1rem;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        .statement-answer-box.answered-yes {
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            border-style: solid;
            border-color: var(--md-sys-color-primary);
        }
        .statement-answer-box.answered-no {
            background-color: var(--md-sys-color-error-container);
            color: var(--md-sys-color-on-error-container);
            border-style: solid;
            border-color: var(--md-sys-color-error);
        }
        
        .nav-answered { background-color: var(--md-sys-color-secondary-container); color: var(--md-sys-color-on-secondary-container); border-color: var(--md-sys-color-secondary);}
        .nav-current { border: 2px solid var(--md-sys-color-primary) !important; font-weight: bold; background-color: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container); }
        .nav-flagged, .review-flagged { 
            border: 2px solid var(--md-sys-color-tertiary) !important; 
            position: relative; 
            background-color: var(--md-sys-color-tertiary-container); 
            color: var(--md-sys-color-on-tertiary-container); 
        }
        
        .modal { 
            display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; 
            overflow: auto; 
            background-color: rgba(var(--md-sys-color-scrim-rgb), 0.4); 
            align-items: center; justify-content: center; 
        }
        .modal-content { 
            background-color: var(--md-sys-color-surface-container-high); 
            color: var(--md-sys-color-on-surface); 
            margin: auto; padding: 1.5rem; 
            border: none; 
            width: calc(100% - 3.5rem); max-width: 35rem; 
            border-radius: var(--md-sys-shape-corner-extra-large); 
            box-shadow: 0px 8px 12px 6px rgba(0,0,0,0.15), 0px 4px 8px rgba(0,0,0,0.3); 
        }
        .modal.flex { display: flex; }
        .modal-content .flex.justify-between.items-center h3 {
            font-family: var(--md-sys-typescale-font-family-name);
            font-size: 1.5rem; 
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
        }
        .modal-content #close-modal-button { 
            font-size: 1.5rem; 
            color: var(--md-sys-color-on-surface-variant);
            background: transparent; border: none; padding: 0.5rem;
            border-radius: var(--md-sys-shape-corner-full);
            cursor:pointer;
        }
         .modal-content #close-modal-button:hover {
            background-color: color-mix(in srgb, var(--md-sys-color-on-surface-variant) 8%, transparent);
         }
        
        #results-details-grid {
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); 
            gap: 0.75rem; 
            padding-top: 0.5rem; 
            max-width: 950px; 
            margin-left: auto; 
            margin-right: auto;
        }
        .result-summary-item { display: flex; flex-direction: column; align-items: center; text-align: center; }
        .result-summary-box {
            width: 60px; 
            height: 60px; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: var(--md-sys-shape-corner-medium); 
            font-weight: 600; 
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 0.25rem;
        }
        .result-summary-box:hover { transform: translateY(-2px); box-shadow: 0 3px 6px rgba(0,0,0,0.15); }
        .correct-box { background-color: var(--md-sys-color-success-container); border: 1px solid var(--md-sys-color-success); color: var(--md-sys-color-on-success-container); }
        .partially-correct-box { background-color: var(--md-sys-color-warning-container); border: 1px solid var(--md-sys-color-tertiary); color: var(--md-sys-color-on-warning-container); }
        .incorrect-box { background-color: var(--md-sys-color-error-container); border: 1px solid var(--md-sys-color-error); color: var(--md-sys-color-on-error-container); }
        .not-answered-box { background-color: var(--md-sys-color-surface-variant); border: 1px solid var(--md-sys-color-outline); color: var(--md-sys-color-on-surface-variant); }
        .time-display-in-box { font-size: 0.8rem; line-height: 1; }
        .question-number-label { margin-top: 0.25rem; font-size: 0.75rem; font-weight: 500; color: var(--md-sys-color-on-surface-variant); }
        
        .explanation-box {
             background-color: var(--md-sys-color-surface-container-high); 
             border: 1px solid var(--md-sys-color-outline-variant); 
             padding: 0.75rem 1rem; 
             margin-top: 0.75rem; border-radius: var(--md-sys-shape-corner-medium); 
             font-family: var(--md-sys-typescale-body-large-font-family-name);
             color: var(--md-sys-color-on-surface-variant); 
        }
        .review-grid-button {
             padding: 0.5rem 0.25rem; border: 1px solid var(--md-sys-color-outline); 
             border-radius: var(--md-sys-shape-corner-medium); 
             text-align: center; transition: background-color 0.2s ease, border-color 0.2s ease;
             font-family: var(--md-sys-typescale-label-large-font-family-name);
             cursor: pointer;
             background-color: var(--md-sys-color-surface-container);
             color: var(--md-sys-color-on-surface-variant);
        }
        .review-grid-button-answered { background-color: var(--md-sys-color-secondary-container); border-color: var(--md-sys-color-secondary); color: var(--md-sys-color-on-secondary-container); }
        .review-grid-button-unanswered { background-color: var(--md-sys-color-surface-variant); border-color: var(--md-sys-color-outline); color: var(--md-sys-color-on-surface-variant); }
        .review-grid-button:hover { filter: brightness(95%); }

        /* No calculator for DM Syllogisms */
        #calculator-ui { display: none !important; }

        @media (max-width: 1024px) {
            #results-details-grid { 
                grid-template-columns: repeat(auto-fill, minmax(55px, 1fr));
                max-width: 760px;
            }
            .result-summary-box { width: 55px; height: 55px; }
        }
        
        @media (max-width: 768px) {
            #app-container { height: auto; margin: 0.5rem; border-radius:var(--md-sys-shape-corner-medium); }
            .main-content-area { flex-direction: column; padding: 0.5rem; gap: 0.5rem; }
            .question-column { flex-basis: auto; width: 100%; height: auto; max-height: none; padding: 0.75rem; }
            .header-bar, .secondary-toolbar, .footer-bar { padding: 0.5rem 1rem; }
            .header-bar span, .footer-bar button, .secondary-toolbar-button { font-size: var(--md-sys-typescale-label-large-font-size); }
            .footer-bar button { padding: 0.5rem 0.75rem; }
            #review-grid { grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); } 
            .review-grid-button { font-size: 0.8rem; }
            #results-details-grid { 
                grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); 
                gap: 0.5rem;
                max-width: 450px;
            }
            .result-summary-box { width: 50px; height: 50px; }
            .time-display-in-box { font-size: 0.75rem; }
            .question-number-label { font-size: 0.65rem; }
        }
         @media (max-width: 480px) {
             #review-grid { grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); } 
             .header-bar span, .footer-bar button, .secondary-toolbar-button { font-size: 0.8rem; }
             .footer-bar button { padding: 0.4rem 0.6rem; font-size: 0.7rem; }
             .review-grid-button { font-size: 0.75rem; border-radius: var(--md-sys-shape-corner-small); }
             #results-details-grid { 
                grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); 
                gap: 0.5rem;
                max-width: 100%; 
                padding-left: 0.5rem; padding-right: 0.5rem;
             }
             .result-summary-box { width: 45px; height: 45px; border-radius: var(--md-sys-shape-corner-small); }
             .time-display-in-box { font-size: 0.65rem; }
             .question-number-label { font-size: 0.65rem; }
         }
        .hidden { display: none !important; }
    </style>
</head> 
<body>
    <div id="app-container">

        <div id="setup-screen" class="p-6 md:p-8 flex flex-col justify-center items-center h-full">
             <div class="text-center mb-6">
                <img src="https://ik.imagekit.io/mwp/MWP%20Color%20no%20background.png?updatedAt=1745982959141"
                     alt="MedwithPurpose Logo" class="mx-auto h-11 w-auto mb-4" onerror="this.style.display='none'; this.onerror=null;">
                <h1 class="m3-headline-large" id="worksheet-title-setup">DM Syllogisms Worksheet 1</h1>
                <p class="m3-body-large text-[var(--md-sys-color-on-surface-variant)] mt-2">Prepare for the UCAT DM section.</p>
                 <p class="m3-label-large text-[var(--md-sys-color-on-surface-variant)] mt-4">
                     This section contains <strong id="setup-question-count" class="text-[var(--md-sys-color-primary)]">5 questions</strong> with 5 statements each. Maximum score is <strong class="text-[var(--md-sys-color-primary)]">10 points</strong>. You have <strong id="setup-time-limit" class="text-[var(--md-sys-color-primary)]">6 minutes</strong> to complete it.
                 </p>
            </div>
            <div class="space-y-4 w-full max-w-md">
                <div>
                    <label for="goal" class="block m3-label-large text-[var(--md-sys-color-on-surface-variant)] mb-1">Goal (Score out of 10):</label>
                    <input type="number" id="goal" name="goal" min="0" max="10" class="mt-1 block w-full px-3 py-2 border border-[var(--md-sys-color-outline)] rounded-md shadow-sm focus:outline-none focus:ring-[var(--md-sys-color-primary)] focus:border-[var(--md-sys-color-primary)] sm:text-sm bg-[var(--md-sys-color-surface-container-lowest)] text-[var(--md-sys-color-on-surface)] m3-body-large" placeholder="e.g., 8">
                </div>
                <div>
                    <label for="focus-area" class="block m3-label-large text-[var(--md-sys-color-on-surface-variant)] mb-1">Area of Focus / Intention For Practice:</label>
                    <input type="text" id="focus-area" name="focus-area" class="mt-1 block w-full px-3 py-2 border border-[var(--md-sys-color-outline)] rounded-md shadow-sm focus:outline-none focus:ring-[var(--md-sys-color-primary)] focus:border-[var(--md-sys-color-primary)] sm:text-sm bg-[var(--md-sys-color-surface-container-lowest)] text-[var(--md-sys-color-on-surface)] m3-body-large" placeholder="e.g., Identifying conclusions, Speed">
                </div>
            </div>
            <div class="mt-8 text-center space-y-3">
                <button id="start-button" class="m3-button m3-button-filled text-lg px-8 py-3"><span class="material-symbols-outlined">play_arrow</span>Begin</button>
                <button onclick="window.location.href='practice.html'" class="m3-button m3-button-outlined text-lg px-8 py-3"><span class="material-symbols-outlined">arrow_back</span>Return to Practice</button>
            </div>
        </div>

        <div id="practice-session-screen" class="hidden flex flex-col h-full">
            <div class="header-bar">
                <span id="practice-session-title" class="m3-title-large">DM Syllogisms Worksheet 1</span>
                <div class="flex items-center space-x-4">
                    <div id="timer" class="m3-label-large">06:00</div>
                    <span class="m3-label-large">Question <span id="question-number-info">1</span> of 5</span>
                </div>
            </div>
            <div class="secondary-toolbar">
                <button id="flag-button" class="m3-icon-button">
                    <span class="material-symbols-outlined">flag</span>
                </button>
            </div>

            <div class="main-content-area">
                <div class="question-column">
                    {/* Content dynamically inserted by JS */}
                </div>
            </div>

            <div class="footer-bar">
                 <button id="back-to-results-button" class="m3-button m3-button-text hidden mr-auto"><span class="material-symbols-outlined">arrow_back</span>Back to Results</button>
                 <button id="end-practice-session-button-footer" class="m3-button m3-button-text"><span class="material-symbols-outlined">stop_circle</span>End Session</button>
                 <div class="flex items-center space-x-2 ml-auto">
                     <button id="prev-button" class="m3-button m3-button-outlined icon-only" disabled aria-label="Previous Question"><span class="material-symbols-outlined">chevron_left</span></button>
                     <button id="navigator-button" class="m3-button m3-button-outlined"><span class="material-symbols-outlined">grid_view</span>Navigator</button>
                     <button id="next-button" class="m3-button m3-button-filled icon-only" aria-label="Next Question"><span class="material-symbols-outlined">chevron_right</span></button>
                 </div>
            </div>
        </div>
        
        <div id="review-screen" class="hidden p-6 md:p-8 flex-col items-center h-full overflow-y-auto">
             <div class="w-full max-w-3xl mb-4 flex justify-between items-center">
                 <h2 class="m3-dialog-title">Review Your Answers</h2>
                 <button id="filter-flagged-button" class="m3-button m3-button-text"><span class="material-symbols-outlined">filter_list</span>Show Flagged Only</button>
             </div>
             <p class="m3-body-large text-[var(--md-sys-color-on-surface-variant)] text-center mb-6">Click a number to jump. Answered questions are in a colored container. Flagged questions have a warning-colored border.</p>
            <div id="review-grid" class="grid grid-cols-5 sm:grid-cols-6 md:grid-cols-10 gap-3 mb-6 w-full max-w-2xl"></div>
            <div class="mt-auto pt-6">
                <button id="end-practice-session-button" class="m3-button m3-button-filled-error text-lg px-8 py-3">
                    <span class="material-symbols-outlined">check_circle</span>Submit & View Results
                </button>
            </div>
        </div>

        <div id="results-screen" class="hidden p-6 md:p-8 flex-col h-full">
             <div class="text-center mb-6 flex-shrink-0">
                <img src="https://ik.imagekit.io/mwp/MWP%20Color%20no%20background.png?updatedAt=1745982959141"
                     alt="MedwithPurpose Logo" class="mx-auto h-12 w-auto mb-4" onerror="this.style.display='none'; this.onerror=null;">
                 <h2 class="m3-headline-large text-[var(--md-sys-color-primary)]">DM Syllogisms Worksheet 1 Results</h2>
             </div>
            <div class="p-4 rounded-lg mb-6 text-center flex-shrink-0" style="background-color: var(--md-sys-color-primary-container);">
                 <p class="m3-title-large font-semibold" style="color: var(--md-sys-color-on-primary-container);">Your Score: <span id="score" class="text-[var(--md-sys-color-primary)]">0</span> / <span id="total-score-possible">10</span> Points</p>
                 <p class="m3-body-large" style="color: var(--md-sys-color-on-primary-container);">Time Taken: <span id="time-taken"></span></p>
            </div>
            <h3 class="m3-title-large font-semibold mb-2 flex-shrink-0">Detailed Results Summary:</h3>
            <p class="m3-body-medium text-[var(--md-sys-color-on-surface-variant)] mb-4 flex-shrink-0">Click on a question box below to review it.</p>
            <div id="results-details-grid" class="overflow-y-auto flex-grow"></div>
            <div class="mt-6 flex-shrink-0 border-t pt-4" style="border-color: var(--md-sys-color-outline-variant);">
                 <div class="p-3 rounded-md mb-4 text-center" style="background-color: var(--md-sys-color-secondary-container); border: 1px solid var(--md-sys-color-outline-variant);">
                    <p class="m3-body-medium" style="color: var(--md-sys-color-on-secondary-container);">Your test results have been submitted. You can add a reflection below.</p>
                 </div>
                 <div class="mb-4">
                    <label for="focus-rating" class="block m3-label-large text-[var(--md-sys-color-on-surface-variant)] mb-1">My focus (1-5):</label>
                    <input type="number" id="focus-rating" name="focus-rating" min="1" max="5" class="mt-1 block w-20 px-3 py-2 border border-[var(--md-sys-color-outline)] rounded-md shadow-sm focus:outline-none focus:ring-[var(--md-sys-color-primary)] focus:border-[var(--md-sys-color-primary)] sm:text-sm bg-[var(--md-sys-color-surface-container-lowest)] text-[var(--md-sys-color-on-surface)]" placeholder="1-5">
                 </div>
                 <div>
                    <label for="reflection-text" class="block m3-label-large text-[var(--md-sys-color-on-surface-variant)] mb-1">Main takeaway:</label>
                    <textarea id="reflection-text" name="reflection-text" rows="3" class="block w-full px-3 py-2 border border-[var(--md-sys-color-outline)] rounded-md shadow-sm focus:outline-none focus:ring-[var(--md-sys-color-primary)] focus:border-[var(--md-sys-color-primary)] sm:text-sm bg-[var(--md-sys-color-surface-container-lowest)] text-[var(--md-sys-color-on-surface)]" placeholder="Reflect on your performance..."></textarea>
                 </div>
            </div>
              <div class="mt-6 text-center flex-shrink-0 flex flex-col sm:flex-row justify-center items-center space-y-3 sm:space-y-0 sm:space-x-4">
                <button onclick="window.location.href='student_dashboard.html'" class="m3-button m3-button-outlined px-6 py-2 w-full sm:w-auto"><span class="material-symbols-outlined">dashboard</span>Dashboard</button>
                <button onclick="window.location.reload()" class="m3-button m3-button-outlined px-6 py-2 w-full sm:w-auto"><span class="material-symbols-outlined">refresh</span>Try Again</button>
                <button id="submit-performance-button" class="m3-button m3-button-filled px-6 py-2 w-full sm:w-auto"><span class="material-symbols-outlined">send</span>Submit Reflections</button>
                <button id="download-pdf-button" class="m3-button m3-button-filled px-6 py-2 w-full sm:w-auto"><span class="material-symbols-outlined">download</span>Download PDF</button>
            </div>
        </div>

        <div id="navigator-modal" class="modal m3-dialog-scrim">
            <div class="modal-content m3-dialog">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="m3-dialog-title">Question Navigator</h3>
                    <button id="close-modal-button" class="m3-icon-button"><span class="material-symbols-outlined">close</span></button>
                </div>
                 <p class="m3-dialog-content">Click a number to jump. Answered questions are colored. Flagged questions have a warning-colored border.</p>
                <div id="navigator-grid" class="grid grid-cols-5 gap-2 mt-4"> {/* Adjusted to 5 columns for 5 questions */}
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyASKsaFFTZ-finv2d5egR9K_mZNstEwdns",
          authDomain: "mwp-qr-test-page.firebaseapp.com",
          projectId: "mwp-qr-test-page",
          storageBucket: "mwp-qr-test-page.appspot.com", 
          messagingSenderId: "309084045110",
          appId: "1:309084045110:web:b09ca0fdff84b094963d97",
          measurementId: "G-4M3ED641M9"
        };
        
        // Initialize Firebase
        if (typeof firebase !== 'undefined' && !firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        } else if (typeof firebase === 'undefined') {
            console.error("Firebase SDK not loaded. Ensure Firebase scripts are in <head> with defer attribute.");
        }
        
        let db, auth;
        if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
            db = firebase.firestore();
            auth = firebase.auth();
        } else {
            console.error("Firebase not initialized. DB and Auth objects will be undefined.");
        }
        
        // --- Data for DM Syllogisms Worksheet 1 ---
        const questions = [
            { 
                premises: [
                    "All oranges in the bowl are sweet.",
                    "This fruit is an orange in the bowl."
                ],
                statements: [
                    "This fruit is sweet.",
                    "Some sweet fruits in the bowl are oranges.",
                    "No non-sweet fruits in the bowl are oranges.",
                    "All sweet fruits in the bowl are oranges.",
                    "Some fruits in the bowl are not sweet."
                ],
                correctAnswers: ["Y", "N", "Y", "N", "N"]
            },
            { 
                premises: [
                    "No penguin can fly."
                ],
                statements: [
                    "Some penguins can fly.",
                    "If something can fly, it is not a penguin.",
                    "All penguins cannot fly.",
                    "Some creatures that cannot fly are penguins.",
                    "All creatures that cannot fly are penguins."
                ],
                correctAnswers: ["N", "Y", "Y", "N", "N"]
            },
            { 
                premises: [
                    "Every burger on the menu contains bread."
                ],
                statements: [
                    "Some bread items on the menu are burgers.",
                    "All bread items on the menu are burgers.",
                    "Some burgers on the menu do not contain bread.",
                    "No burgers on the menu lack bread.",
                    "Some menu items lack bread."
                ],
                correctAnswers: ["N", "N", "N", "Y", "N"]
            },
            { 
                premises: [
                    "Some books in the library are new."
                ],
                statements: [
                    "All books in the library are new.",
                    "Some books in the library are not new.",
                    "At least one new item in the library is a book.",
                    "No new items in the library are books.",
                    "There is at least one book in the library."
                ],
                correctAnswers: ["N", "N", "Y", "N", "Y"]
            },
            { 
                premises: [
                    "All dogs at the shelter are vaccinated."
                ],
                statements: [
                    "Some vaccinated animals at the shelter are dogs.",
                    "Some dogs at the shelter are not vaccinated.",
                    "All vaccinated animals at the shelter are dogs.",
                    "No dogs at the shelter are unvaccinated.",
                    "Some animals at the shelter are not vaccinated."
                ],
                correctAnswers: ["N", "N", "N", "Y", "N"]
            }
        ];
        
        // --- State Variables ---
        let currentQuestionIndex = 0;
        let userAnswers = new Array(questions.length).fill(null).map(() => new Array(5).fill(null)); // For 5 statements per question
        let timerInterval;
        let timeLeft = 360; // 6 minutes for 5 questions
        let practiceSessionStartTime;
        let practiceSessionEndTime;
        let userName = '';
        let userEmail = '';
        let userGoal = '';
        let userFocusArea = '';
        let isReviewingFromResults = false;
        let questionStartTime = null;
        let questionTimes = new Array(questions.length).fill(0);
        let flaggedQuestions = new Array(questions.length).fill(false);
        let isFilteringFlagged = false;
        let isSubmittingReflection = false;

        // --- Elements ---
        // (Elements are largely the same as DM Sylls 2, ensure IDs match)
        const appContainer = document.getElementById('app-container');
        const setupScreen = document.getElementById('setup-screen');
        const practiceSessionScreen = document.getElementById('practice-session-screen');
        const reviewScreen = document.getElementById('review-screen');
        const resultsScreen = document.getElementById('results-screen');
        const navigatorModal = document.getElementById('navigator-modal');
        const startButton = document.getElementById('start-button');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const navigatorButton = document.getElementById('navigator-button');
        const closeModalButton = document.getElementById('close-modal-button');
        const endPracticeSessionButton = document.getElementById('end-practice-session-button');
        const endPracticeSessionButtonFooter = document.getElementById('end-practice-session-button-footer');
        const backToResultsButton = document.getElementById('back-to-results-button');
        const flagButton = document.getElementById('flag-button');
        const questionNumberInfoEl = document.getElementById('question-number-info');
        const timerEl = document.getElementById('timer');
        const reviewGrid = document.getElementById('review-grid');
        const navigatorGrid = document.getElementById('navigator-grid');
        const scoreEl = document.getElementById('score');
        const totalScorePossibleEl = document.getElementById('total-score-possible'); // Added for clarity
        const timeTakenEl = document.getElementById('time-taken');
        const resultsDetailsGrid = document.getElementById('results-details-grid');
        const goalInput = document.getElementById('goal');
        const focusAreaInput = document.getElementById('focus-area');
        const practiceSessionTitleEl = document.getElementById('practice-session-title');
        const filterFlaggedButton = document.getElementById('filter-flagged-button');
        const setupQuestionCountEl = document.getElementById('setup-question-count');
        const setupTimeLimitEl = document.getElementById('setup-time-limit');
        const reflectionText = document.getElementById('reflection-text');
        const downloadPdfButton = document.getElementById('download-pdf-button');
        const focusRatingInput = document.getElementById('focus-rating');
        const worksheetTitleSetupEl = document.getElementById('worksheet-title-setup');


        // --- Functions (Copied from DM Sylls 2, with minor adjustments for titles/counts) ---
        // (startTimer, stopTimer, formatTimeSeconds, formatTimeDifference, recordTimeSpent,
        // toggleFlag, updateFlagButtonAppearance, loadQuestion, showNextQuestion, showPrevQuestion,
        // showSetupScreen, showPracticeSessionScreen, showReviewScreen, populateNavigator,
        // updateNavigatorButtons, updateNavigatorHighlight, showResultsScreen, revisitQuestionFromResults,
        // endPracticeSessionAndShowResults, calculateScore, submitDataToFirebase, 
        // handleEndPracticeSessionFooterClick, generatePDF, submitPerformanceData, initDragAndDrop,
        // handleKeyboardShortcuts, initializeApp, loadPastTestForReview)

        // Ensure all functions from DM Sylls 2.html's script are here.
        // For brevity, I'm not re-listing all of them but they should be identical
        // except for minor text changes (e.g., worksheet title).

        function startTimer() {
            practiceSessionStartTime = new Date();
            clearInterval(timerInterval);
            timerEl.textContent = formatTimeSeconds(timeLeft);
            timerEl.classList.remove('text-[var(--md-sys-color-on-surface-variant)]'); // Assuming this was a placeholder
            timerEl.classList.add('text-[var(--md-sys-color-on-primary)]');
            timerInterval = setInterval(() => {
                timeLeft--;
                timerEl.textContent = formatTimeSeconds(timeLeft);
                if (timeLeft <= 0) {
                    endPracticeSessionAndShowResults();
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            practiceSessionEndTime = practiceSessionEndTime || new Date();
            timerEl.classList.add('text-[var(--md-sys-color-on-surface-variant)]');
            timerEl.classList.remove('text-[var(--md-sys-color-on-primary)]');
        }
        
        function formatTimeSeconds(totalSeconds) {
             if (totalSeconds < 0) totalSeconds = 0;
             const minutes = Math.floor(totalSeconds / 60);
             const seconds = totalSeconds % 60;
             return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }

        function formatTimeDifference(milliseconds) {
            if (!milliseconds || milliseconds < 0) return "0 min 00 sec";
            const totalSeconds = Math.round(milliseconds / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes} min ${seconds < 10 ? '0' : ''}${seconds} sec`;
        }
        
        function recordTimeSpent(index) {
            if (questionStartTime && index >= 0 && index < questions.length) {
                const timeSpent = Date.now() - questionStartTime;
                questionTimes[index] = (questionTimes[index] || 0) + timeSpent;
            }
            questionStartTime = null; // Reset for the next question
        }

        function toggleFlag() {
            if (isReviewingFromResults) return;
            const index = currentQuestionIndex;
            flaggedQuestions[index] = !flaggedQuestions[index];
            updateFlagButtonAppearance();
            updateNavigatorButtons(); // Update navigator appearance
        }

        function updateFlagButtonAppearance() {
            const isFlagged = flaggedQuestions[currentQuestionIndex];
            // flagButton.textContent = isFlagged ? 'Unflag' : 'Flag for Review'; // Text content not needed if using icon only
            flagButton.classList.toggle('selected', isFlagged); // M3 selected state for icon button
            const flagIcon = flagButton.querySelector('.material-symbols-outlined');
            if (flagIcon) {
                 flagIcon.textContent = isFlagged ? 'flag' : 'outlined_flag'; // Or 'flag' vs 'flag_outline'
                 if(isFlagged) {
                    flagIcon.style.fontVariationSettings = "'FILL' 1";
                    flagButton.style.backgroundColor = 'var(--md-sys-color-tertiary-container)';
                    flagButton.style.color = 'var(--md-sys-color-on-tertiary-container)';
                 } else {
                    flagIcon.style.fontVariationSettings = "'FILL' 0";
                    flagButton.style.backgroundColor = 'transparent';
                    flagButton.style.color = 'var(--md-sys-color-on-surface-variant)';
                 }
            }
        }
        
        function loadQuestion(index, reviewMode = false) {
            if (index < 0 || index >= questions.length) return;
            if (!isReviewingFromResults && !reviewMode) {
                recordTimeSpent(currentQuestionIndex);
            }
            currentQuestionIndex = index;
            isReviewingFromResults = reviewMode; // Set review mode state

            const question = questions[index];
            const questionContainer = document.querySelector('.question-column');
            if (!questionContainer) return;

            let premisesHtml = `<div class="premises-container"><h3>Premises</h3>`;
            question.premises.forEach(premise => {
                premisesHtml += `<p class="mb-1">${premise}</p>`;
            });
            premisesHtml += '</div>';

            let statementsHtml = `
                <h4 class="m3-title-large">Question ${index + 1}</h4>
                <div class="syllogism-options-header">
                    <div>
                        <h5 class="m3-title-medium">Conclusions</h5>
                        <p class="m3-body-medium">Drag 'Yes' or 'No' to the box, or click a statement then a button.</p>
                    </div>
                    <div class="drag-buttons-container">
                        <button id="yes-button" class="drag-button">Yes</button>
                        <button id="no-button" class="drag-button">No</button>
                    </div>
                </div>
                <div id="statements-container" class="space-y-2"></div>
                <div id="review-explanation-container" class="mt-4"></div>
            `;
            questionContainer.innerHTML = premisesHtml + statementsHtml;
            
            questionNumberInfoEl.textContent = `${index + 1} of ${questions.length}`;
            questionContainer.scrollTop = 0;

            const statementsContainer = document.getElementById('statements-container');
            if (statementsContainer) {
                question.statements.forEach((statement, i) => {
                    const statementId = `q${index}_statement${i}`;
                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'statement-row';
                    rowDiv.dataset.statementIndex = i;
                    
                    let userAnswerDisplay = '...';
                    let answerBoxClass = '';

                    if (userAnswers[index] && userAnswers[index][i]) {
                        userAnswerDisplay = userAnswers[index][i] === 'Y' ? 'Yes' : (userAnswers[index][i] === 'N' ? 'No' : '...');
                        if (userAnswers[index][i] === 'Y') answerBoxClass = 'answered-yes';
                        if (userAnswers[index][i] === 'N') answerBoxClass = 'answered-no';
                    }

                    rowDiv.innerHTML = `
                        <div class="statement-text">
                            <span class="font-medium">${String.fromCharCode(65 + i)}.</span> ${statement}
                        </div>
                        <div class="statement-answer-box ${answerBoxClass}" data-statement-index="${i}">
                            ${userAnswerDisplay}
                        </div>
                    `;
                    statementsContainer.appendChild(rowDiv);

                    if (reviewMode) {
                        const answerBox = rowDiv.querySelector('.statement-answer-box');
                        const userAnswer = userAnswers[index] ? userAnswers[index][i] : null;
                        const correctAnswer = question.correctAnswers[i];
                        answerBox.classList.remove('answered-yes', 'answered-no'); // Clear previous dynamic classes

                        if (userAnswer === correctAnswer) {
                            answerBox.classList.add('correct-box'); // Use results screen styling
                            answerBox.textContent = userAnswer === 'Y' ? 'Yes' : 'No';
                        } else {
                            answerBox.classList.add('incorrect-box');
                            answerBox.textContent = userAnswer === 'Y' ? 'Yes' : (userAnswer === 'N' ? 'No' : 'N/A');
                            const correctAnsDiv = document.createElement('div');
                            correctAnsDiv.className = 'text-xs text-gray-600 mt-1';
                            correctAnsDiv.textContent = `Correct: ${correctAnswer === 'Y' ? 'Yes' : 'No'}`;
                            rowDiv.querySelector('.statement-answer-box').insertAdjacentElement('afterend', correctAnsDiv);
                        }
                    }
                });
                if (!reviewMode) initDragAndDrop();
            }

            prevButton.disabled = index === 0;
            nextButton.disabled = index === questions.length - 1 && !reviewMode; // Disable next on last question unless in review
             if (!reviewMode && index === questions.length - 1) {
                nextButton.innerHTML = `<span class="material-symbols-outlined">done_all</span>Finish & Review`;
            } else {
                nextButton.innerHTML = `<span class="material-symbols-outlined">chevron_right</span>Next`;
            }

            updateFlagButtonAppearance();
            if (reviewMode) {
                backToResultsButton.classList.remove('hidden');
                endPracticeSessionButtonFooter.classList.add('hidden');
                if (practiceSessionTitleEl) practiceSessionTitleEl.textContent = "Reviewing Worksheet 1";
                flagButton.disabled = true;
                flagButton.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                backToResultsButton.classList.add('hidden');
                endPracticeSessionButtonFooter.classList.remove('hidden');
                if (practiceSessionTitleEl) practiceSessionTitleEl.textContent = "DM Syllogisms Worksheet 1";
                flagButton.disabled = false;
                flagButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
            updateNavigatorHighlight();
            if (!isReviewingFromResults && !reviewMode) {
                questionStartTime = Date.now();
            }
        }

        function showNextQuestion() {
            if (isReviewingFromResults) {
                if (currentQuestionIndex < questions.length - 1) {
                    loadQuestion(currentQuestionIndex + 1, true);
                }
            } else {
                 recordTimeSpent(currentQuestionIndex);
                 if (currentQuestionIndex === questions.length - 1) {
                     showReviewScreen();
                 } else if (currentQuestionIndex < questions.length - 1) {
                     loadQuestion(currentQuestionIndex + 1);
                 }
            }
        }

        function showPrevQuestion() {
             if (isReviewingFromResults) {
                 if (currentQuestionIndex > 0) {
                     loadQuestion(currentQuestionIndex - 1, true);
                 }
             } else if (currentQuestionIndex > 0) { // Not in review mode
                 recordTimeSpent(currentQuestionIndex);
                 loadQuestion(currentQuestionIndex - 1);
            }
        }

        function showSetupScreen() {
            userName = ''; userEmail = ''; userGoal = ''; userFocusArea = '';
            if (auth && auth.currentUser) {
                const currentUser = auth.currentUser;
                userName = currentUser.displayName || currentUser.email || '';
                userEmail = currentUser.email || '';
            }
            
            if (setupScreen) setupScreen.classList.remove('hidden');
            if (practiceSessionScreen) practiceSessionScreen.classList.add('hidden');
            if (reviewScreen) { reviewScreen.classList.add('hidden'); reviewScreen.classList.remove('flex');}
            if (resultsScreen) resultsScreen.classList.add('hidden');
            if (appContainer) appContainer.classList.remove('flex', 'flex-col'); // Reset app container style if needed
            
            if (worksheetTitleSetupEl) worksheetTitleSetupEl.textContent = "DM Syllogisms Worksheet 1";
            if (setupQuestionCountEl) setupQuestionCountEl.textContent = questions.length;
            if (setupTimeLimitEl) setupTimeLimitEl.textContent = `${timeLeft / 60} minutes`;
            if (goalInput) {
                goalInput.max = questions.length * 2; // Max score is 2 per question
                goalInput.value = userGoal;
                const goalLabel = document.querySelector('label[for="goal"]');
                if (goalLabel) goalLabel.textContent = `Goal (Score out of ${questions.length * 2}):`;
            }
            if (focusAreaInput) focusAreaInput.value = userFocusArea;
        }

        function showPracticeSessionScreen() {
            if (setupScreen) setupScreen.classList.add('hidden');
            if (practiceSessionScreen) {
                practiceSessionScreen.classList.remove('hidden');
                practiceSessionScreen.classList.add('flex');
            }
            if (reviewScreen) reviewScreen.classList.add('hidden');
            if (resultsScreen) resultsScreen.classList.add('hidden');
            if (appContainer) appContainer.classList.add('flex', 'flex-col');
            updateTimerVisibility();
        }

        function updateTimerVisibility() {
            if (!timerEl) return;
            if (timerInterval) { // Timer is running
                timerEl.classList.remove('text-[var(--md-sys-color-on-surface-variant)]');
                timerEl.classList.add('text-[var(--md-sys-color-on-primary)]');
            } else { // Timer is stopped or not started
                timerEl.classList.add('text-[var(--md-sys-color-on-surface-variant)]');
                timerEl.classList.remove('text-[var(--md-sys-color-on-primary)]');
            }
        }

        function showReviewScreen(filterFlagged = false) {
            recordTimeSpent(currentQuestionIndex);
            updateTimerVisibility(); // Keep timer display consistent
            if (practiceSessionScreen) practiceSessionScreen.classList.add('hidden');
            if (reviewScreen) { reviewScreen.classList.remove('hidden'); reviewScreen.classList.add('flex');}
            if (resultsScreen) resultsScreen.classList.add('hidden');
            if (setupScreen) setupScreen.classList.add('hidden');
            if (appContainer) appContainer.classList.add('flex', 'flex-col');
            
            reviewGrid.innerHTML = '';
            questions.forEach((_, index) => {
                 if (filterFlagged && !flaggedQuestions[index]) return;
                const button = document.createElement('button');
                button.textContent = index + 1;
                button.className = 'review-grid-button';
                button.dataset.questionIndex = index;
                // Check if any statement for this question has an answer
                const hasAnswer = userAnswers[index] && userAnswers[index].some(ans => ans !== null);
                if (hasAnswer) {
                    button.classList.add('review-grid-button-answered');
                } else {
                     button.classList.add('review-grid-button-unanswered');
                }
                if (flaggedQuestions[index]) button.classList.add('review-flagged');
                reviewGrid.appendChild(button);
            });
            if(filterFlaggedButton) filterFlaggedButton.innerHTML = `<span class="material-symbols-outlined">${filterFlagged ? 'checklist' : 'filter_list'}</span> ${filterFlagged ? 'Show All' : 'Flagged Only'}`;
        }

        function populateNavigator() {
            if (!navigatorGrid) return;
            navigatorGrid.innerHTML = '';
            questions.forEach((_, index) => {
                const button = document.createElement('button');
                button.textContent = index + 1;
                button.className = 'm3-button m3-button-outlined'; // Use M3 button style
                button.style.minWidth = '40px'; // Ensure buttons are reasonably sized
                button.style.padding = '0.5rem';
                button.dataset.questionIndex = index;

                const hasAnswer = userAnswers[index] && userAnswers[index].some(ans => ans !== null);
                if (hasAnswer) button.classList.add('nav-answered');
                if (index === currentQuestionIndex) button.classList.add('nav-current');
                if (flaggedQuestions[index]) button.classList.add('nav-flagged');
                
                button.onclick = () => {
                    if(navigatorModal) navigatorModal.classList.remove('flex');
                    if(navigatorModal) navigatorModal.classList.add('hidden');
                    const targetIndex = parseInt(button.dataset.questionIndex, 10);
                    loadQuestion(targetIndex, isReviewingFromResults);
                };
                navigatorGrid.appendChild(button);
            });
        }

        function updateNavigatorButtons() { // Simplified, relies on populateNavigator to rebuild for now
            populateNavigator(); // Rebuild to reflect current state
        }

         function updateNavigatorHighlight() {
             if (!navigatorGrid) return;
             const buttons = navigatorGrid.querySelectorAll('button');
             buttons.forEach(button => {
                 const index = parseInt(button.dataset.questionIndex, 10);
                 button.classList.remove('nav-current');
                 if (index === currentQuestionIndex) button.classList.add('nav-current');
             });
         }

        function showResultsScreen() {
            practiceSessionEndTime = practiceSessionEndTime || new Date();
            recordTimeSpent(currentQuestionIndex);
            stopTimer();

            if(practiceSessionScreen) practiceSessionScreen.classList.add('hidden');
            if(reviewScreen) {reviewScreen.classList.add('hidden'); reviewScreen.classList.remove('flex');}
            if(resultsScreen) {resultsScreen.classList.remove('hidden'); resultsScreen.classList.add('flex');}
            if(setupScreen) setupScreen.classList.add('hidden');
            if(appContainer) appContainer.classList.add('flex', 'flex-col');

            let totalScore = 0;
            resultsDetailsGrid.innerHTML = ''; 

            questions.forEach((qData, index) => {
                let correctStatements = 0;
                if (userAnswers[index]) {
                    qData.statements.forEach((_, statementIndex) => {
                        if (userAnswers[index][statementIndex] === qData.correctAnswers[statementIndex]) {
                            correctStatements++;
                        }
                    });
                }
                
                let questionScore = 0;
                let boxClass = 'not-answered-box';
                if (userAnswers[index] && userAnswers[index].some(ans => ans !== null)) { // If at least one statement was answered
                    if (correctStatements === 5) { questionScore = 2; boxClass = 'correct-box'; }
                    else if (correctStatements === 4) { questionScore = 1; boxClass = 'partially-correct-box'; }
                    else { questionScore = 0; boxClass = 'incorrect-box'; }
                }
                totalScore += questionScore;

                const summaryItem = document.createElement('div');
                summaryItem.className = 'result-summary-item';
                const summaryBox = document.createElement('div');
                summaryBox.className = `result-summary-box ${boxClass}`;
                summaryBox.dataset.index = index;
                summaryBox.title = `Click to review Question ${index + 1}`;
                summaryBox.innerHTML = `<span class="time-display-in-box">${correctStatements}/5</span>`;
                const numberLabel = document.createElement('div');
                numberLabel.className = 'question-number-label';
                numberLabel.textContent = `Q${index + 1}`;
                summaryBox.onclick = () => revisitQuestionFromResults(index);
                summaryItem.appendChild(summaryBox);
                summaryItem.appendChild(numberLabel);
                resultsDetailsGrid.appendChild(summaryItem);
            });

            if(scoreEl) scoreEl.textContent = totalScore;
            if(totalScorePossibleEl) totalScorePossibleEl.textContent = questions.length * 2; // Max 2 points per question
            if(timeTakenEl) timeTakenEl.textContent = formatTimeDifference(practiceSessionEndTime - practiceSessionStartTime);
            
            const submitButton = document.getElementById('submit-performance-button');
            if (submitButton) {
                submitButton.disabled = false;
                submitButton.innerHTML = '<span class="material-symbols-outlined">send</span>Submit Reflections';
            }
        }

        function revisitQuestionFromResults(index) {
            if(resultsScreen) resultsScreen.classList.add('hidden');
            showPracticeSessionScreen();
            loadQuestion(index, true); // true for reviewMode
        }

        function endPracticeSessionAndShowResults() {
            stopTimer();
            const finalScore = calculateScore();
            const performanceData = {
                studentName: userName || 'Anonymous',
                studentEmail: userEmail || '',
                userId: auth && auth.currentUser ? auth.currentUser.uid : '',
                examName: "DM Syllogisms Worksheet 1",
                score: finalScore,
                totalQuestions: questions.length,
                totalPossibleScore: questions.length * 2,
                timeTaken: formatTimeDifference(practiceSessionEndTime - practiceSessionStartTime),
                answers: userAnswers,
                questionTimes: questionTimes,
                flaggedQuestions: flaggedQuestions,
                goal: userGoal || '',
                focusArea: userFocusArea || '',
                submissionTimestamp: firebase.firestore.FieldValue.serverTimestamp(),
                userAgent: navigator.userAgent
            };
            submitDataToFirebase(performanceData); // Submit before showing results
            showResultsScreen();
        }

        function calculateScore() {
            let score = 0;
            questions.forEach((qData, index) => {
                if (!userAnswers[index]) return;
                let correctCount = 0;
                qData.statements.forEach((_, statementIndex) => {
                    if (userAnswers[index][statementIndex] === qData.correctAnswers[statementIndex]) {
                        correctCount++;
                    }
                });
                if (correctCount === 5) score += 2;
                else if (correctCount === 4) score += 1;
            });
            return score;
        }

        async function submitDataToFirebase(data) {
            if (!db || !auth) { console.error("Firebase (db or auth) not initialized for submission."); return; }
            try {
                await db.collection("performanceSubmissions").add(data);
                console.log("Performance data submitted to Firebase.");
                // Optional: Show a temporary success message on the results screen
            } catch (error) {
                console.error("Error submitting to Firebase:", error);
            }
        }

        function handleEndPracticeSessionFooterClick() {
             recordTimeSpent(currentQuestionIndex);
             showReviewScreen();
         }

        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const reflection = reflectionText ? reflectionText.value.trim() : 'N/A';
            const focusRating = focusRatingInput ? focusRatingInput.value : 'N/A';
            const finalScore = scoreEl ? scoreEl.textContent : 'N/A';
            const totalPossible = totalScorePossibleEl ? totalScorePossibleEl.textContent : (questions.length * 2);
            const timeTaken = timeTakenEl ? timeTakenEl.textContent : 'N/A';
            let y = 15;
            const lineHeight = 7;
            const pageHeight = doc.internal.pageSize.height;
            const margin = 15;

            doc.setFontSize(18);
            doc.text("UCAT DM Syllogisms Worksheet 1 Results", margin, y);
            y += lineHeight * 1.5;
            doc.setFontSize(12);
            doc.text(`Name: ${userName || 'N/A'}`, margin, y); y += lineHeight;
            doc.text(`Goal: ${userGoal || 'N/A'} / ${totalPossible}`, margin, y); y += lineHeight;
            doc.text(`Focus Area: ${userFocusArea || 'N/A'}`, margin, y); y += lineHeight;
            doc.text(`Final Score: ${finalScore} / ${totalPossible}`, margin, y); y += lineHeight;
            doc.text(`Time Taken: ${timeTaken}`, margin, y); y += lineHeight * 1.5;
            doc.setFontSize(14);
            doc.text("Focus Rating (1-5):", margin, y); y += lineHeight;
            doc.setFontSize(10);
            doc.text(focusRating || 'N/A', margin, y); y += lineHeight * 1.5;
            doc.setFontSize(14);
            doc.text("Main Takeaway:", margin, y); y += lineHeight;
            doc.setFontSize(10);
            const reflectionLines = doc.splitTextToSize(reflection || 'No reflection provided.', doc.internal.pageSize.width - margin * 2);
            doc.text(reflectionLines, margin, y);
            y += reflectionLines.length * (lineHeight * 0.7) + lineHeight;
            doc.setFontSize(14);
            doc.text("Detailed Results Summary:", margin, y); y += lineHeight * 1.5;
            doc.setFontSize(10);

            questions.forEach((qData, index) => {
                let resultText = `Q${index + 1}: `;
                let correctCount = 0;
                if (userAnswers[index]) {
                    qData.statements.forEach((stmt, stmtIdx) => {
                        const uAns = userAnswers[index][stmtIdx];
                        const cAns = qData.correctAnswers[stmtIdx];
                        if (uAns === cAns) correctCount++;
                        resultText += `S${stmtIdx+1}: ${uAns || 'N/A'} (Correct: ${cAns}) | `;
                    });
                } else {
                    resultText += "Not Answered";
                }
                resultText += ` (${correctCount}/5 correct)`;
                
                let textLines = doc.splitTextToSize(resultText, doc.internal.pageSize.width - margin * 2);
                if (y + (textLines.length * (lineHeight * 0.7)) > pageHeight - margin) {
                    doc.addPage();
                    y = margin;
                }
                doc.text(textLines, margin, y);
                y += textLines.length * (lineHeight * 0.7) + (lineHeight*0.3);
            });
            doc.save(`ucat_dm_syllogisms_1_results_${userName || 'user'}.pdf`);
        }
        
        async function submitPerformanceData() {
            if (isSubmittingReflection) return;
            if (!auth || !auth.currentUser || !db) {
                alert("You must be logged in to submit reflections.");
                return;
            }
            isSubmittingReflection = true;
            const submitButton = document.getElementById('submit-performance-button');
            if(submitButton) submitButton.disabled = true;
            if(submitButton) submitButton.innerHTML = `<span class="material-symbols-outlined animate-spin">progress_activity</span> Submitting...`;

            const focusRatingVal = focusRatingInput ? focusRatingInput.value : '';
            const reflectionVal = reflectionText ? reflectionText.value.trim() : '';
            
            // Find the most recent submission for THIS specific worksheet by this user to update it.
            // This assumes we have a unique examName for each worksheet.
            const examNameForQuery = "DM Syllogisms Worksheet 1"; 

            try {
                const querySnapshot = await db.collection("performanceSubmissions")
                    .where("userId", "==", auth.currentUser.uid)
                    .where("examName", "==", examNameForQuery)
                    .orderBy("submissionTimestamp", "desc")
                    .limit(1)
                    .get();

                if (!querySnapshot.empty) {
                    const docToUpdate = querySnapshot.docs[0];
                    await db.collection("performanceSubmissions").doc(docToUpdate.id).update({
                        focusRating: focusRatingVal,
                        reflection: reflectionVal,
                        reflectionTimestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    if(submitButton) submitButton.innerHTML = `<span class="material-symbols-outlined">check_circle</span> Reflections Saved!`;
                    if(submitButton) submitButton.style.backgroundColor = 'var(--md-sys-color-success)'; // M3 Success color
                    console.log("Reflection updated for existing submission.");
                } else {
                    // This case should ideally not happen if endPracticeSessionAndShowResults always submits initial data.
                    // But as a fallback, create a new entry if no prior submission for this worksheet is found.
                    console.warn("No prior submission found for this worksheet to update reflection. Creating new entry.");
                    const fallbackData = {
                        studentName: userName || auth.currentUser.displayName || 'Anonymous',
                        studentEmail: userEmail || auth.currentUser.email || '',
                        userId: auth.currentUser.uid,
                        examName: examNameForQuery,
                        score: scoreEl ? scoreEl.textContent : 'N/A',
                        totalQuestions: questions.length,
                        totalPossibleScore: questions.length * 2,
                        timeTaken: timeTakenEl ? timeTakenEl.textContent : 'N/A',
                        answers: userAnswers, // These might be empty if page was reloaded on results
                        questionTimes: questionTimes, // Same as above
                        flaggedQuestions: flaggedQuestions, // Same as above
                        goal: userGoal || '',
                        focusArea: userFocusArea || '',
                        focusRating: focusRatingVal,
                        reflection: reflectionVal,
                        submissionTimestamp: firebase.firestore.FieldValue.serverTimestamp(), // New timestamp for this entry
                        userAgent: navigator.userAgent,
                        isReflectionOnly: true // Flag to indicate this was primarily a reflection submission
                    };
                    await db.collection("performanceSubmissions").add(fallbackData);
                    if(submitButton) submitButton.innerHTML = `<span class="material-symbols-outlined">check_circle</span> Reflections Saved!`;
                     if(submitButton) submitButton.style.backgroundColor = 'var(--md-sys-color-success)';
                }
            } catch (error) {
                console.error('Error saving reflection:', error);
                alert('An error occurred while saving your reflection. Please try again.');
                if(submitButton) submitButton.disabled = false;
                if(submitButton) submitButton.innerHTML = `<span class="material-symbols-outlined">send</span>Submit Reflections`;
            } finally {
                setTimeout(() => { isSubmittingReflection = false; }, 2000);
            }
        }
        
        function initDragAndDrop() {
            const yesButton = document.getElementById('yes-button');
            const noButton = document.getElementById('no-button');
            const statementRows = document.querySelectorAll('.statement-row');
            
            if (!yesButton || !noButton || !statementRows.length) return;
            
            let draggedValue = null;
            
            [yesButton, noButton].forEach(button => {
                button.setAttribute('draggable', true);
                button.addEventListener('dragstart', function(e) {
                    draggedValue = this.textContent; // "Yes" or "No"
                    e.dataTransfer.setData('text/plain', draggedValue);
                    this.classList.add('dragging');
                });
                button.addEventListener('dragend', function() {
                    this.classList.remove('dragging');
                });
            });
            
            statementRows.forEach(row => {
                const answerBox = row.querySelector('.statement-answer-box');
                row.addEventListener('dragover', function(e) {
                    e.preventDefault(); 
                    this.classList.add('drag-over');
                });
                row.addEventListener('dragleave', function() {
                    this.classList.remove('drag-over');
                });
                row.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('drag-over');
                    const value = e.dataTransfer.getData('text/plain');
                    answerBox.textContent = value;
                    answerBox.classList.remove('answered-yes', 'answered-no');
                    answerBox.classList.add(value === 'Yes' ? 'answered-yes' : 'answered-no');
                    
                    const statementIndex = parseInt(this.dataset.statementIndex);
                    if (!userAnswers[currentQuestionIndex]) {
                        userAnswers[currentQuestionIndex] = new Array(questions[currentQuestionIndex].statements.length).fill(null);
                    }
                    userAnswers[currentQuestionIndex][statementIndex] = (value === 'Yes' ? 'Y' : 'N');
                    updateNavigatorButtons();
                });

                // Click to clear answer
                answerBox.addEventListener('click', function() {
                    if (isReviewingFromResults) return; // Don't allow clearing in review mode
                    this.textContent = '...';
                    this.classList.remove('answered-yes', 'answered-no');
                    const statementIndex = parseInt(this.dataset.statementIndex);
                     if (userAnswers[currentQuestionIndex]) {
                        userAnswers[currentQuestionIndex][statementIndex] = null;
                    }
                    updateNavigatorButtons();
                });
            });
        }

        function handleKeyboardShortcuts(e) {
             const isPracticeSessionVisible = practiceSessionScreen && !practiceSessionScreen.classList.contains('hidden');
             const isModalVisible = navigatorModal && navigatorModal.classList.contains('flex');
             const isInputFocused = document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA');
             
             if (isModalVisible || isInputFocused) return; 
             if (!isPracticeSessionVisible) return; 
             
             const key = e.key.toLowerCase();
             const altOrOption = e.altKey || e.metaKey; 
             const code = e.code.toLowerCase(); 

             if (altOrOption) {
                 switch (code) { 
                     case 'keyn': e.preventDefault(); if (nextButton && !nextButton.disabled) nextButton.click(); return;
                     case 'keyp': e.preventDefault(); if (prevButton && !prevButton.disabled) prevButton.click(); return;
                     case 'keyf': e.preventDefault(); if (!isReviewingFromResults && flagButton && !flagButton.disabled) flagButton.click(); return;
                     default: return; 
                 }
             }
        }
        document.addEventListener('keydown', handleKeyboardShortcuts);

        function initializeApp() {
            userAnswers = new Array(questions.length).fill(null).map(() => new Array(5).fill(null));
            questionTimes = new Array(questions.length).fill(0);
            flaggedQuestions = new Array(questions.length).fill(false);
            
            const urlParams = new URLSearchParams(window.location.search);
            const reviewParam = urlParams.get('review');
            if (reviewParam && db && auth) { // Ensure db and auth are available
                loadPastTestForReview(reviewParam);
            } else {
                showSetupScreen();
            }
        }
        
        // Ensure DOM is ready and Firebase is potentially loaded
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof firebase === 'undefined' || !firebase.apps.length) {
                console.error("Firebase SDKs not loaded when DOMContentLoaded. Retrying init or showing error.");
                // Attempt to re-initialize or show a persistent error
                if (typeof firebase !== 'undefined' && !firebase.apps.length) {
                     firebase.initializeApp(firebaseConfig);
                     db = firebase.firestore();
                     auth = firebase.auth();
                     console.log("Firebase initialized on DOMContentLoaded.");
                } else {
                    // Show critical error if Firebase still not loaded
                    const appContainerEl = document.getElementById('app-container');
                    if (appContainerEl) appContainerEl.innerHTML = "<p class='m3-body-large text-center p-8 text-[var(--md-sys-color-error)]'>Error: Critical application services failed to load. Please check your internet connection and refresh the page. If the problem persists, contact support.</p>";
                    return; // Stop further script execution
                }
            }
            initializeApp(); // Now call initializeApp
        });
    </script>
</body>
</html>