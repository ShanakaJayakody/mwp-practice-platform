<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Performance Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            /* M3 Color Palette - Light Theme */
            --md-sys-color-primary: #1967D2;
            --md-sys-color-on-primary: #FFFFFF;
            --md-sys-color-primary-container: #D1E3FF;
            --md-sys-color-on-primary-container: #001E3A;
            --md-sys-color-secondary: #5E89C2; 
            --md-sys-color-on-secondary: #FFFFFF;
            --md-sys-color-secondary-container: #D8E2FF;
            --md-sys-color-on-secondary-container: #001A43;
            --md-sys-color-tertiary: #7D5260;
            --md-sys-color-on-tertiary: #FFFFFF;
            --md-sys-color-tertiary-container: #FFD8E4;
            --md-sys-color-on-tertiary-container: #31111D;
            --md-sys-color-error: #D93025;
            --md-sys-color-on-error: #FFFFFF;
            --md-sys-color-error-container: #FAD2CF;
            --md-sys-color-on-error-container: #410001;
            --md-sys-color-background: #F8F9FA; 
            --md-sys-color-on-background: #1F1F1F;
            --md-sys-color-surface: #FFFFFF; 
            --md-sys-color-on-surface: #1F1F1F;
            --md-sys-color-surface-variant: #E1E3E5; 
            --md-sys-color-on-surface-variant: #444746;
            --md-sys-color-outline: #747775;
            --md-sys-color-outline-variant: #C4C7C5;

            /* M3 Typography */
            --md-sys-font-family-name: 'Roboto', sans-serif;
            --md-sys-typescale-headline-small-font-size: 24px;
            --md-sys-typescale-headline-small-line-height: 32px;
            --md-sys-typescale-title-large-font-size: 22px;
            --md-sys-typescale-title-large-line-height: 28px;
            --md-sys-typescale-title-medium-font-size: 16px;
            --md-sys-typescale-title-medium-line-height: 24px;
            --md-sys-typescale-label-large-font-size: 14px;
            --md-sys-typescale-label-large-line-height: 20px;
            --md-sys-typescale-body-medium-font-size: 14px;
            --md-sys-typescale-body-medium-line-height: 20px;
            --md-sys-typescale-body-small-font-size: 12px;
            --md-sys-typescale-body-small-line-height: 16px;
            --md-sys-font-weight-regular: 400;
            --md-sys-font-weight-medium: 500;

            /* M3 Spacing */
            --md-sys-spacing-unit: 0.5rem; /* 8px */
            --md-sys-spacing-xs: 0.5rem;
            --md-sys-spacing-s: 0.75rem;
            --md-sys-spacing-m: 1rem;
            --md-sys-spacing-l: 1.5rem;
            --md-sys-spacing-xl: 2rem;
            
            /* M3 Shape */
            --md-sys-shape-corner-extra-small: 0.25rem; /* 4dp */
            --md-sys-shape-corner-small: 0.5rem; /* 8dp */
            --md-sys-shape-corner-medium: 0.75rem; /* 12dp */
            --md-sys-shape-corner-large: 1rem;    /* 16dp */
            --md-sys-shape-corner-full: 9999px;
            
            /* M3 Elevation */
            --md-sys-elevation-level0: none;
            --md-sys-elevation-level1: 0px 1px 2px rgba(0,0,0,0.3), 0px 1px 3px 1px rgba(0,0,0,0.15);
            --md-sys-elevation-level2: 0px 1px 2px rgba(0,0,0,0.3), 0px 2px 6px 2px rgba(0,0,0,0.15);
            --md-sys-elevation-level3: 0px 4px 8px 3px rgba(0,0,0,0.3), 0px 1px 3px rgba(0,0,0,0.15);

            /* Transitions */
            --md-sys-motion-duration-short: 150ms;
            --md-sys-motion-easing-standard: cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        body { 
            font-family: var(--md-sys-font-family-name);
            margin: 0; 
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-background);
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding-top: var(--md-sys-spacing-l);
            min-height: 100vh; 
        }
        .container { 
            background-color: var(--md-sys-color-surface); 
            padding: var(--md-sys-spacing-l); 
            border-radius: var(--md-sys-shape-corner-medium);
            box-shadow: var(--md-sys-elevation-level1);
            width: 100%; 
            max-width: 1200px; 
            margin: var(--md-sys-spacing-m); 
        }
        .login-container { 
            max-width: 400px; 
            margin: var(--md-sys-spacing-xl) auto; 
            padding: var(--md-sys-spacing-xl);
            background-color: var(--md-sys-color-surface); 
            border-radius: var(--md-sys-shape-corner-large); 
            box-shadow: var(--md-sys-elevation-level2); 
        }

        /* M3 Text Field Inspired Styling */
        input[type="email"], input[type="password"], .filter-input { 
            width: 100%; 
            padding: var(--md-sys-spacing-m); 
            margin-bottom: var(--md-sys-spacing-m); 
            border: 1px solid var(--md-sys-color-outline);
            background-color: color-mix(in srgb, var(--md-sys-color-primary) 4%, var(--md-sys-color-surface));
            border-radius: var(--md-sys-shape-corner-extra-small) var(--md-sys-shape-corner-extra-small) 0 0;
            border-bottom: 1px solid var(--md-sys-color-on-surface-variant);
            box-sizing: border-box; 
            font-size: var(--md-sys-typescale-body-large-font-size);
            color: var(--md-sys-color-on-surface);
            transition: border-color var(--md-sys-motion-duration-short) var(--md-sys-motion-easing-standard), background-color var(--md-sys-motion-duration-short) var(--md-sys-motion-easing-standard);
        }
        input[type="email"]:focus, input[type="password"]:focus, .filter-input:focus {
            outline: none;
            border-bottom: 2px solid var(--md-sys-color-primary);
            background-color: color-mix(in srgb, var(--md-sys-color-primary) 8%, var(--md-sys-color-surface));
            margin-bottom: calc(var(--md-sys-spacing-m) - 1px); /* Adjust margin to keep layout stable */
        }
        select.filter-input {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23444746'%3E%3Cpath d='M7 10l5 5 5-5H7z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right var(--md-sys-spacing-m) center;
            background-size: 1.2em;
            padding-right: var(--md-sys-spacing-xl); /* Make space for arrow */
        }


        /* M3 Button Styles */
        .btn {
            display: inline-flex; align-items: center; justify-content: center;
            padding: var(--md-sys-spacing-s) var(--md-sys-spacing-l);
            border: none; border-radius: var(--md-sys-shape-corner-full);
            cursor: pointer;
            font-family: var(--md-sys-typescale-label-large-font-family-name);
            font-weight: var(--md-sys-font-weight-medium);
            font-size: var(--md-sys-typescale-label-large-font-size);
            transition: background-color var(--md-sys-motion-duration-short) var(--md-sys-motion-easing-standard), box-shadow var(--md-sys-motion-duration-short) var(--md-sys-motion-easing-standard);
            text-align: center;
            box-shadow: var(--md-sys-elevation-level0);
            gap: var(--md-sys-spacing-xs);
        }
        .btn:hover { box-shadow: var(--md-sys-elevation-level1); }
        .btn:active { box-shadow: var(--md-sys-elevation-level0); }

        .btn-filled { /* M3 Filled button */
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
        }
        .btn-filled:hover { background-color: color-mix(in srgb, var(--md-sys-color-primary) 92%, black); }

        .btn-outlined { /* M3 Outlined button */
            background-color: transparent;
            color: var(--md-sys-color-primary);
            border: 1px solid var(--md-sys-color-outline);
        }
        .btn-outlined:hover { background-color: color-mix(in srgb, var(--md-sys-color-primary) 8%, transparent); }
        
        .btn-text { /* M3 Text button */
            background-color: transparent;
            color: var(--md-sys-color-primary);
            padding-left: var(--md-sys-spacing-s);
            padding-right: var(--md-sys-spacing-s);
        }
        .btn-text:hover { background-color: color-mix(in srgb, var(--md-sys-color-primary) 8%, transparent); }


        .btn-email-login { /* Specific for login button */
            width: 100%; margin-bottom: var(--md-sys-spacing-s);
        }
        .btn-google-login { /* Specific for Google login */
            width: 100%; margin-top: var(--md-sys-spacing-s);
        }
        .btn-google-login img { width: 20px; height: 20px; }

        .btn-logout { 
            background-color: var(--md-sys-color-error); color: var(--md-sys-color-on-error);
            font-size: var(--md-sys-typescale-label-large-font-size);
        }
        .btn-logout:hover { background-color: color-mix(in srgb, var(--md-sys-color-error) 90%, black); }

        /* Table Styling */
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: var(--md-sys-spacing-l); border: 1px solid var(--md-sys-color-outline-variant); border-radius: var(--md-sys-shape-corner-small); overflow: hidden;}
        th, td { padding: var(--md-sys-spacing-m); text-align: left; font-size: var(--md-sys-typescale-body-medium-font-size); border-bottom: 1px solid var(--md-sys-color-outline-variant); }
        th { 
            background-color: var(--md-sys-color-surface-variant); 
            color: var(--md-sys-color-on-surface-variant); 
            font-weight: var(--md-sys-font-weight-medium);
            font-family: var(--md-sys-typescale-label-large-font-family-name);
            font-size: var(--md-sys-typescale-label-large-font-size);
            text-transform: none; /* M3 tables don't typically uppercase */
            letter-spacing: normal;
        }
        tbody tr:hover { background-color: color-mix(in srgb, var(--md-sys-color-primary) 4%, transparent); }
        tbody tr:last-child td { border-bottom: none; }

        h1 { 
            color: var(--md-sys-color-primary); 
            text-align: center; margin-bottom: var(--md-sys-spacing-l); 
            font-size: var(--md-sys-typescale-headline-medium-font-size); 
            font-weight: var(--md-sys-font-weight-regular); 
        }
        h2 { /* Title Large for filter section */
            color: var(--md-sys-color-on-surface);
            font-family: var(--md-sys-typescale-title-large-font-family-name);
            font-size: var(--md-sys-typescale-title-large-font-size);
            font-weight: var(--md-sys-font-weight-medium);
        }
        td { word-break: break-word; white-space: pre-wrap; color: var(--md-sys-color-on-surface);}
        .hidden { display: none !important; }
        #admin-controls { text-align: right; margin-bottom: var(--md-sys-spacing-m); display: flex; justify-content: flex-end; align-items: center; }
        #admin-user-email { color: var(--md-sys-color-on-surface-variant); margin-right: var(--md-sys-spacing-m); font-size: var(--md-sys-typescale-body-medium-font-size); }
        
        .social-login-divider { 
            display: flex; align-items: center; text-align: center; 
            color: var(--md-sys-color-on-surface-variant); margin: var(--md-sys-spacing-l) 0;
        }
        .social-login-divider::before, .social-login-divider::after {
            content: ''; flex: 1; border-bottom: 1px solid var(--md-sys-color-outline-variant);
        }
        .social-login-divider span { 
            padding: 0 var(--md-sys-spacing-m); font-size: var(--md-sys-typescale-label-large-font-size);
        }
        #login-error {
            min-height: 1.25rem; color: var(--md-sys-color-error); font-size: var(--md-sys-typescale-body-small-font-size);
        }

        /* Filter controls */
        .filter-controls {
            background-color: var(--md-sys-color-surface-variant); /* Distinct background for filter area */
            border-radius: var(--md-sys-shape-corner-medium);
            padding: var(--md-sys-spacing-l);
            margin-bottom: var(--md-sys-spacing-l);
        }
        .filter-group label {
            font-family: var(--md-sys-typescale-label-large-font-family-name);
            font-weight: var(--md-sys-font-weight-medium);
            color: var(--md-sys-color-on-surface-variant);
            margin-bottom: var(--md-sys-spacing-xs);
        }
        .filter-actions {
            display: flex; justify-content: space-between; align-items: center; margin-top: var(--md-sys-spacing-m);
        }
        .filter-button { /* General style for filter action buttons */
            padding: var(--md-sys-spacing-s) var(--md-sys-spacing-l);
            font-size: var(--md-sys-typescale-label-large-font-size);
        }
        .apply-filters { /* M3 Filled Button */
            background-color: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary);
        }
        .apply-filters:hover { background-color: color-mix(in srgb, var(--md-sys-color-primary) 92%, black); }
        .reset-filters { /* M3 Outlined Button */
            background-color: transparent; color: var(--md-sys-color-primary); border: 1px solid var(--md-sys-color-outline);
        }
        .reset-filters:hover { background-color: color-mix(in srgb, var(--md-sys-color-primary) 8%, transparent); }
        .export-csv { /* M3 Filled Tonal Button (using secondary as example) */
            background-color: var(--md-sys-color-secondary-container); color: var(--md-sys-color-on-secondary-container);
        }
        .export-csv:hover { background-color: color-mix(in srgb, var(--md-sys-color-secondary-container) 92%, black); }
        
        /* Sortable table headers */
        th.sortable { cursor: pointer; position: relative; padding-right: var(--md-sys-spacing-l); }
        th.sortable .material-symbols-outlined { /* For sort icon */
            font-size: 16px; position: absolute; right: var(--md-sys-spacing-xs); top: 50%;
            transform: translateY(-50%); opacity: 0.6;
        }
        th.sortable:hover .material-symbols-outlined { opacity: 1; color: var(--md-sys-color-primary); }
        th.sorted-asc .material-symbols-outlined, th.sorted-desc .material-symbols-outlined { opacity: 1; color: var(--md-sys-color-primary); }
        
        /* Modal Styling - M3 Dialog */
        #detailsModal {
            background-color: rgba(0,0,0,0.4); /* Scrim */
        }
        #detailsModal .modal-content {
            background-color: var(--md-sys-color-surface);
            border-radius: var(--md-sys-shape-corner-large); /* 28dp in M3, using large for now */
            box-shadow: var(--md-sys-elevation-level3);
            padding: var(--md-sys-spacing-l); /* 24dp */
            max-width: 600px;
        }
        #detailsModal h3 { /* Dialog Title */
            font-family: var(--md-sys-typescale-headline-small-font-family-name);
            font-size: var(--md-sys-typescale-headline-small-font-size);
            color: var(--md-sys-color-on-surface);
            margin-bottom: var(--md-sys-spacing-m);
        }
        #detailsModal #modalContent p {
            font-family: var(--md-sys-typescale-body-medium-font-family-name);
            color: var(--md-sys-color-on-surface-variant);
            margin-bottom: var(--md-sys-spacing-s);
        }
         #detailsModal #modalContent strong { color: var(--md-sys-color-on-surface); font-weight: var(--md-sys-font-weight-medium); }
        #closeModalButton { /* M3 Text Button for close */
            font-family: var(--md-sys-typescale-label-large-font-family-name);
            color: var(--md-sys-color-primary);
            background: none; border: none; font-size: 2rem; line-height: 1; padding: var(--md-sys-spacing-xs);
        }
         #closeModalButton:hover { background-color: color-mix(in srgb, var(--md-sys-color-primary) 8%, transparent); border-radius: 50%; }

        .material-symbols-outlined { vertical-align: middle; }

    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Outlined" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
</head>
<body>
    <div id="login-section" class="login-container">
        <h2 class="text-2xl font-bold text-center mb-8" style="font-family: var(--md-sys-typescale-headline-small-font-family-name); color: var(--md-sys-color-on-surface);">Admin Portal</h2>
        <input type="email" id="admin-email" placeholder="Email Address">
        <input type="password" id="admin-password" placeholder="Password">
        <button id="admin-login-button" class="btn btn-filled btn-email-login">
            <span class="material-symbols-outlined text-lg">login</span>Login with Email
        </button>
        
        <div class="social-login-divider"><span>OR</span></div>

        <button id="google-login-button" class="btn btn-outlined btn-google-login">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon">
            Sign in with Google
        </button>
        <p id="login-error" class="text-center mt-4"></p>
    </div>

    <div id="dashboard-section" class="container hidden">
        <div id="admin-controls" class="mb-6">
            <span id="admin-user-email" class="mr-4"></span>
            <button id="admin-logout-button" class="btn btn-logout">
                <span class="material-symbols-outlined text-lg">logout</span>Logout
            </button>
        </div>
        <h1>Student Performance Dashboard</h1>
        
        <div class="filter-controls">
            <h2 class="mb-4">Filter Results</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                <div class="filter-group">
                    <label for="filter-student">Student Name/Email</label>
                    <input type="text" id="filter-student" class="filter-input" placeholder="Filter by student">
                </div>
                <div class="filter-group">
                    <label for="filter-exam">Exam Type</label>
                    <select id="filter-exam" class="filter-input">
                        <option value="">All Exams</option>
                        </select>
                </div>
                <div class="filter-group">
                    <label for="filter-date-from">From Date</label>
                    <input type="date" id="filter-date-from" class="filter-input">
                </div>
                <div class="filter-group">
                    <label for="filter-date-to">To Date</label>
                    <input type="date" id="filter-date-to" class="filter-input">
                </div>
                <div class="filter-group">
                    <label for="search-input">Search (any field)</label>
                    <input type="text" id="search-input" class="filter-input" placeholder="Global search">
                </div>
                <div class="filter-group">
                    <label for="filter-score-min">Min Score (%)</label>
                    <input type="number" id="filter-score-min" class="filter-input" placeholder="e.g., 0" min="0" max="100">
                </div>
                <div class="filter-group">
                    <label for="filter-score-max">Max Score (%)</label>
                    <input type="number" id="filter-score-max" class="filter-input" placeholder="e.g., 100" min="0" max="100">
                </div>
                 <div class="filter-group flex items-end">
                    <div id="submissions-count" class="p-2 text-center rounded-md w-full" style="background-color: var(--md-sys-color-surface); color: var(--md-sys-color-on-surface-variant); border: 1px solid var(--md-sys-color-outline-variant);">Showing 0 results</div>
                </div>
            </div>
            <div class="filter-actions">
                <div>
                    <button id="apply-filters" class="filter-button apply-filters mr-2 btn btn-filled">
                        <span class="material-symbols-outlined text-lg">filter_alt</span>Apply Filters
                    </button>
                    <button id="reset-filters" class="filter-button reset-filters btn btn-outlined">
                        <span class="material-symbols-outlined text-lg">refresh</span>Reset
                    </button>
                </div>
                <button id="export-csv" class="filter-button export-csv btn" style="background-color: var(--md-sys-color-tertiary-container); color: var(--md-sys-color-on-tertiary-container);">
                    <span class="material-symbols-outlined text-lg">download</span>Export to CSV
                </button>
            </div>
        </div>
        
        <div id="performance-table-container" class="overflow-x-auto">
            <p class="text-center py-8" style="color: var(--md-sys-color-on-surface-variant);">Loading performance data...</p>
        </div>
    </div>

    <div id="detailsModal" class="fixed inset-0 flex items-center justify-center hidden z-50">
        <div class="modal-content w-full max-w-2xl max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3>Submission Details</h3>
                <button id="closeModalButton">&times;</button>
            </div>
            <div id="modalContent" class="text-sm"></div>
        </div>
    </div>

    <script>
        // Firebase Configuration (already in HTML)
        if (!firebase.apps.length) {
            const firebaseConfig = {
                apiKey: "AIzaSyASKsaFFTZ-finv2d5egR9K_mZNstEwdns",
                authDomain: "mwp-qr-test-page.firebaseapp.com",
                projectId: "mwp-qr-test-page",
                storageBucket: "YOUR_STORAGE_BUCKET",
                messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
                appId: "YOUR_APP_ID",
                measurementId: "YOUR_MEASUREMENT_ID" // Optional
            };
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();

        // DOM Elements
        const loginContainer = document.getElementById('login-section');
        const adminPanel = document.getElementById('dashboard-section');
        const adminLoginButton = document.getElementById('admin-login-button');
        const googleLoginButton = document.getElementById('google-login-button');
        const adminLogoutButton = document.getElementById('admin-logout-button');
        const adminEmailInput = document.getElementById('admin-email');
        const adminPasswordInput = document.getElementById('admin-password');
        const loginErrorP = document.getElementById('login-error');
        const adminUserEmailSpan = document.getElementById('admin-user-email');
        const performanceTableContainer = document.getElementById('performance-table-container');
        const submissionsCountDiv = document.getElementById('submissions-count');

        const filterStudentInput = document.getElementById('filter-student');
        const filterExamSelect = document.getElementById('filter-exam');
        const filterDateFromInput = document.getElementById('filter-date-from');
        const filterDateToInput = document.getElementById('filter-date-to');
        const searchInput = document.getElementById('search-input');
        const filterScoreMinInput = document.getElementById('filter-score-min');
        const filterScoreMaxInput = document.getElementById('filter-score-max');
        const applyFiltersButton = document.getElementById('apply-filters');
        const resetFiltersButton = document.getElementById('reset-filters');
        const exportCsvButton = document.getElementById('export-csv');
        
        const detailsModal = document.getElementById('detailsModal');
        const modalContent = document.getElementById('modalContent');
        const closeModalButton = document.getElementById('closeModalButton');

        let allPerformanceData = [];
        let currentSortColumn = 'submissionTimestamp';
        let currentSortOrder = 'desc';
        const specificAdminUid = "CPQ9CqEuY0Z1n2Yso0NPGN2j9z73"; // Specific Admin UID

        // Authentication
        auth.onAuthStateChanged(user => {
            if (user && user.uid === specificAdminUid) {
                adminUserEmailSpan.textContent = `Logged in as: ${user.email || 'Admin'}`;
                loginContainer.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                fetchPerformanceData();
            } else {
                if (user) { // Logged in but not the admin
                    loginErrorP.textContent = "Unauthorized access.";
                    auth.signOut(); // Sign out non-admin user
                }
                adminPanel.classList.add('hidden');
                loginContainer.classList.remove('hidden');
                adminUserEmailSpan.textContent = '';
                performanceTableContainer.innerHTML = '<p class="text-center py-8" style="color: var(--md-sys-color-on-surface-variant);">Please log in with admin credentials.</p>';
            }
        });

        adminLoginButton.addEventListener('click', () => {
            const email = adminEmailInput.value;
            const password = adminPasswordInput.value;
            loginErrorP.textContent = '';
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => loginErrorP.textContent = error.message);
        });

        googleLoginButton.addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            loginErrorP.textContent = '';
            auth.signInWithPopup(provider)
                .catch(error => loginErrorP.textContent = error.message);
        });

        adminLogoutButton.addEventListener('click', () => auth.signOut());

        // Fetch and Display Data
        async function fetchPerformanceData() {
            performanceTableContainer.innerHTML = '<p class="text-center py-8" style="color: var(--md-sys-color-on-surface-variant);">Loading performance data...</p>';
            try {
                const snapshot = await db.collection("performanceSubmissions").orderBy("submissionTimestamp", "desc").get();
                allPerformanceData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateExamFilter();
                applyAndDisplayFilters();
            } catch (error) {
                console.error("Error fetching performance data: ", error);
                performanceTableContainer.innerHTML = '<p class="text-center text-red-500 py-8">Error fetching data. Please try again.</p>';
            }
        }

        function populateExamFilter() {
            const examNames = new Set(allPerformanceData.map(item => item.examName).filter(name => name));
            filterExamSelect.innerHTML = '<option value="">All Exams</option>';
            [...examNames].sort().forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                filterExamSelect.appendChild(option);
            });
        }
        
        function applyAndDisplayFilters() {
            let filtered = [...allPerformanceData];
            const studentFilter = filterStudentInput.value.toLowerCase();
            const examFilter = filterExamSelect.value;
            const dateFromFilter = filterDateFromInput.value;
            const dateToFilter = filterDateToInput.value;
            const globalSearch = searchInput.value.toLowerCase();
            const scoreMin = parseFloat(filterScoreMinInput.value);
            const scoreMax = parseFloat(filterScoreMaxInput.value);

            if (studentFilter) {
                filtered = filtered.filter(item => 
                    (item.studentName && item.studentName.toLowerCase().includes(studentFilter)) ||
                    (item.studentEmail && item.studentEmail.toLowerCase().includes(studentFilter))
                );
            }
            if (examFilter) {
                filtered = filtered.filter(item => item.examName === examFilter);
            }
            if (dateFromFilter) {
                filtered = filtered.filter(item => {
                    if (!item.submissionTimestamp) return false;
                    const itemDate = item.submissionTimestamp.toDate ? item.submissionTimestamp.toDate() : new Date(item.submissionTimestamp);
                    return itemDate >= new Date(dateFromFilter + "T00:00:00");
                });
            }
            if (dateToFilter) {
                filtered = filtered.filter(item => {
                    if (!item.submissionTimestamp) return false;
                    const itemDate = item.submissionTimestamp.toDate ? item.submissionTimestamp.toDate() : new Date(item.submissionTimestamp);
                    return itemDate <= new Date(dateToFilter + "T23:59:59");
                });
            }
            if (!isNaN(scoreMin)) {
                filtered = filtered.filter(item => {
                    const totalPossible = parseFloat(item.totalPossibleScore || item.totalQuestions);
                    if (isNaN(item.score) || isNaN(totalPossible) || totalPossible === 0) return false;
                    return (parseFloat(item.score) / totalPossible * 100) >= scoreMin;
                });
            }
            if (!isNaN(scoreMax)) {
                 filtered = filtered.filter(item => {
                    const totalPossible = parseFloat(item.totalPossibleScore || item.totalQuestions);
                    if (isNaN(item.score) || isNaN(totalPossible) || totalPossible === 0) return false;
                    return (parseFloat(item.score) / totalPossible * 100) <= scoreMax;
                });
            }
            if (globalSearch) {
                filtered = filtered.filter(item => 
                    Object.values(item).some(val => 
                        String(val).toLowerCase().includes(globalSearch)
                    )
                );
            }
            
            sortDataArray(filtered, currentSortColumn, currentSortOrder);
            displayResults(filtered);
        }

        function sortDataArray(dataArray, column, order) {
            dataArray.sort((a, b) => {
                let valA = a[column];
                let valB = b[column];

                if (column === 'submissionTimestamp') {
                    valA = valA?.toDate ? valA.toDate().getTime() : new Date(valA).getTime();
                    valB = valB?.toDate ? valB.toDate().getTime() : new Date(valB).getTime();
                } else if (column === 'score') {
                    const scoreA = parseFloat(a.score);
                    const totalA = parseFloat(a.totalPossibleScore || a.totalQuestions);
                    valA = (totalA > 0 && !isNaN(scoreA)) ? (scoreA / totalA) * 100 : -1;

                    const scoreB = parseFloat(b.score);
                    const totalB = parseFloat(b.totalPossibleScore || b.totalQuestions);
                    valB = (totalB > 0 && !isNaN(scoreB)) ? (scoreB / totalB) * 100 : -1;
                } else if (typeof valA === 'string') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }

                if (valA < valB) return order === 'asc' ? -1 : 1;
                if (valA > valB) return order === 'asc' ? 1 : -1;
                return 0;
            });
        }
        
        function displayResults(data) {
            if (data.length === 0) {
                performanceTableContainer.innerHTML = "<p class='text-center py-8' style='color: var(--md-sys-color-on-surface-variant);'>No matching records found.</p>";
                submissionsCountDiv.textContent = "Showing 0 results";
                return;
            }
            submissionsCountDiv.textContent = `Showing ${data.length} results`;

            let tableHTML = `
                <table class="min-w-full">
                    <thead><tr>
                        ${createSortableHeader('submissionTimestamp', 'Timestamp')}
                        ${createSortableHeader('studentName', 'Student Name')}
                        ${createSortableHeader('userId', 'User ID')}
                        ${createSortableHeader('examName', 'Exam Name')}
                        ${createSortableHeader('score', 'Score (%)')}
                        ${createSortableHeader('timeTaken', 'Time Taken')}
                        ${createSortableHeader('focusRating', 'Focus (1-5)')}
                        <th>Details</th>
                    </tr></thead>
                    <tbody>`;

            data.forEach(item => {
                const submissionDate = item.submissionTimestamp?.toDate ? item.submissionTimestamp.toDate().toLocaleString() : (item.submissionTimestamp ? new Date(item.submissionTimestamp).toLocaleString() : 'N/A');
                const score = parseFloat(item.score);
                const totalPossible = parseFloat(item.totalPossibleScore || item.totalQuestions);
                const percentageScore = (totalPossible > 0 && !isNaN(score)) ? ((score / totalPossible) * 100).toFixed(1) + '%' : 'N/A';
                
                tableHTML += `
                    <tr>
                        <td>${submissionDate}</td>
                        <td>${item.studentName || 'N/A'}</td>
                        <td>${item.userId || 'N/A'}</td>
                        <td>${item.examName || 'N/A'}</td>
                        <td>${percentageScore} (${item.score || 'N/A'}/${totalPossible || 'N/A'})</td>
                        <td>${item.timeTaken || 'N/A'}</td>
                        <td>${item.focusRating || 'N/A'}</td>
                        <td><button class="btn btn-text view-details-btn" data-item-id="${item.id}">
                            <span class="material-symbols-outlined text-lg">visibility</span>View</button></td>
                    </tr>`;
            });
            tableHTML += `</tbody></table>`;
            performanceTableContainer.innerHTML = tableHTML;

            document.querySelectorAll('.view-details-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const item = allPerformanceData.find(d => d.id === this.dataset.itemId); // Changed to search allPerformanceData
                    if (item) showDetailsModal(item);
                });
            });
            
            document.querySelectorAll('th.sortable').forEach(th => {
                th.addEventListener('click', () => {
                    const column = th.dataset.sort;
                    if (currentSortColumn === column) {
                        currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSortColumn = column;
                        currentSortOrder = 'asc';
                    }
                    applyAndDisplayFilters(); // Re-sort and display
                });
            });
        }
        
        function createSortableHeader(columnKey, displayName) {
            let sortIcon = 'unfold_more'; // Default icon
            if (currentSortColumn === columnKey) {
                sortIcon = currentSortOrder === 'asc' ? 'arrow_upward' : 'arrow_downward';
            }
            return `<th class="sortable" data-sort="${columnKey}">${displayName} <span class="material-symbols-outlined">${sortIcon}</span></th>`;
        }

        applyFiltersButton.addEventListener('click', applyAndDisplayFilters);
        resetFiltersButton.addEventListener('click', () => {
            filterStudentInput.value = '';
            filterExamSelect.value = '';
            filterDateFromInput.value = '';
            filterDateToInput.value = '';
            searchInput.value = '';
            filterScoreMinInput.value = '';
            filterScoreMaxInput.value = '';
            currentSortColumn = 'submissionTimestamp'; // Reset sort
            currentSortOrder = 'desc';
            applyAndDisplayFilters();
        });
        exportCsvButton.addEventListener('click', exportToCSV);

        // Modal
        closeModalButton.addEventListener('click', () => detailsModal.classList.add('hidden'));
        detailsModal.addEventListener('click', (e) => { if (e.target === detailsModal) detailsModal.classList.add('hidden'); });

        function showDetailsModal(item) {
            let content = `<div class="space-y-3">`;
            for (const key in item) {
                if (Object.hasOwnProperty.call(item, key)) {
                    let value = item[key];
                    if (key === 'submissionTimestamp' && value && value.toDate) {
                        value = value.toDate().toLocaleString();
                    } else if (typeof value === 'object' && value !== null) {
                        value = `<pre class="bg-gray-100 p-2 rounded overflow-x-auto text-xs" style="background-color: var(--md-sys-color-surface-variant); color: var(--md-sys-color-on-surface-variant);">${JSON.stringify(value, null, 2)}</pre>`;
                    }
                    content += `<p><strong>${key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}:</strong> ${value}</p>`;
                }
            }
            content += `</div>`;
            modalContent.innerHTML = content;
            detailsModal.classList.remove('hidden');
        }
        
        function exportToCSV() {
            const dataToExport = allPerformanceData; // Or use filtered data by getting it from the current display
            if (dataToExport.length === 0) {
                alert('No data to export.');
                return;
            }
            const headers = ['Timestamp', 'Student Name', 'User ID', 'Exam Name', 'Score', 'Total Possible', 'Time Taken', 'Focus Rating', 'Reflection', 'Goal', 'Focus Area'];
            const csvRows = [headers.join(',')];

            dataToExport.forEach(item => {
                const timestamp = item.submissionTimestamp?.toDate ? item.submissionTimestamp.toDate().toLocaleString() : (item.submissionTimestamp ? new Date(item.submissionTimestamp).toLocaleString() : 'N/A');
                const score = item.score !== undefined ? item.score : 'N/A';
                const totalPossible = item.totalPossibleScore || item.totalQuestions || 'N/A';
                
                const row = [
                    `"${timestamp}"`,
                    `"${item.studentName || 'N/A'}"`,
                    `"${item.userId || 'N/A'}"`,
                    `"${item.examName || 'N/A'}"`,
                    score,
                    totalPossible,
                    `"${item.timeTaken || 'N/A'}"`,
                    `"${item.focusRating || 'N/A'}"`,
                    `"${(item.reflection || 'N/A').replace(/"/g, '""')}"`, // Escape quotes in reflection
                    `"${item.goal || 'N/A'}"`,
                    `"${item.focusArea || 'N/A'}"`
                ];
                csvRows.push(row.join(','));
            });

            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `ucat_performance_data_${new Date().toISOString().slice(0,10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
    </script>
</body>
</html>