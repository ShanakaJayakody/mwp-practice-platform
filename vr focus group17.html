<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UCAT VR Focus Group 17 - MedwithPurpose</title>
    <link rel="icon" href="https://ik.imagekit.io/mwp/2.svg?updatedAt=1745982956185" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        /* Custom styles for better UI/UX */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent scrolling on body */
        }
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f0f2f5; /* Light background like UCAT */
        }
        #app-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 2rem); /* Full height minus padding */
            width: 100%;
            background-color: #ffffff;
            border: 1px solid #d1d5db; /* Border like UCAT */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-radius: 0.375rem; /* Slightly rounded corners */
            margin: 1rem; /* Add some margin */
            overflow: hidden; /* Prevent content overflow from container */
            position: relative; /* For calculator positioning */
        }
        
        /* Header and Footer */
        .header-bar { /* Topmost bar */
            flex-shrink: 0;
            background-color: #005A8C; /* Slightly darker blue for top bar */
            color: white;
            padding: 0.5rem 1.5rem; /* Adjusted padding */
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 20; /* Ensure it's above the secondary bar if overlapping */
        }

        .secondary-toolbar { /* New toolbar for calculator and flag */
            flex-shrink: 0;
            background-color: #007BBD; /* Lighter blue for secondary bar */
            color: white;
            padding: 0.5rem 1.5rem; /* Consistent padding */
            display: flex;
            justify-content: space-between; /* Align items */
            align-items: center;
            border-bottom: 1px solid #005A8C; /* Optional: a subtle separator */
            z-index: 19;
        }

        /* Specific text colors within header/footer */
        .header-bar span, .header-bar div, .secondary-toolbar span, .secondary-toolbar div {
             color: white;
        }
        #timer {
             background-color: rgba(255, 255, 255, 0.2); 
             color: white;
             font-weight: bold;
             padding: 0.25rem 0.75rem; 
             border-radius: 0.25rem; 
        }
        
        /* Buttons in secondary toolbar */
        .secondary-toolbar-button {
            background-color: transparent;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.6);
            padding: 0.3rem 0.7rem;
            font-size: 0.8rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s ease, border-color 0.2s ease;
            margin-left: 0.5rem; /* Spacing between buttons */
        }
        .secondary-toolbar-button:hover:not(:disabled) {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: white;
        }
        .secondary-toolbar-button.active { /* For calculator button when active */
            background-color: rgba(255, 255, 255, 0.2);
            border-color: white;
        }

        /* Footer Button Styling */
        .footer-bar {
            flex-shrink: 0;
            background-color: #005A8C; /* Match top bar color */
            color: white;
            padding: 0.75rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .footer-bar button {
            background-color: transparent;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.5); 
            padding: 0.4rem 0.8rem; 
            font-size: 0.8rem; 
            border-radius: 0.375rem;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        .footer-bar button:hover:not(:disabled) {
            background-color: rgba(255, 255, 255, 0.15); 
            border-color: white;
        }
        .footer-bar button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: rgba(255, 255, 255, 0.3);
        }
        .footer-bar button#next-button {
            background-color: #ffffff; 
            color: #006DAA; 
            border: 1px solid white;
            font-weight: 500;
        }
        .footer-bar button#next-button:hover:not(:disabled) {
            background-color: #f0f0f0; 
        }
        #flag-button.flagged {
            background-color: #facc15; 
            border-color: #facc15;
            color: #422006; 
        }
        #flag-button.flagged:hover {
            background-color: #f59e0b; 
            border-color: #f59e0b;
        }

        /* Main Content Area */
        .main-content-area {
            flex-grow: 1; 
            display: flex;
            overflow: hidden; 
            padding: 1rem; 
        }
        
        .passage-column {
            width: 50%;
            overflow-y: auto;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            background-color: #fff;
            height: 100%;
            margin-right: 0.5rem;
        }
        
        .question-column {
            width: 50%;
            overflow-y: auto; 
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            background-color: #fff;
            height: 100%; 
            position: relative;
            margin-left: 0.5rem;
        }

        .selected-answer {
            background-color: #bfdbfe !important; 
            border-color: #3b82f6 !important; 
        }
        .nav-answered { background-color: #a7f3d0; }
        .nav-current { border: 2px solid #3b82f6 !important; font-weight: bold; }
        .nav-flagged, .review-flagged { border: 2px solid #f59e0b !important; position: relative; }
        
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 0.5rem; }
        .modal.flex { display: flex; }

        button, .button {
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            border-radius: 0.375rem; padding: 0.5rem 1rem; font-size: 0.875rem; font-weight: 500;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); cursor: pointer;
        }
        button:active, .button:active { transform: scale(0.98); }
        button:disabled { opacity: 0.6; cursor: not-allowed; }

        .primary-button { background-color: #3b82f6; color: white; border: 1px solid transparent; }
        .primary-button:hover:not(:disabled) { background-color: #2563eb; }
        .secondary-button { background-color: white; color: #374151; border: 1px solid #d1d5db; }
        .secondary-button:hover:not(:disabled) { background-color: #f9fafb; }
        .danger-button { background-color: #ef4444; color: white; border: 1px solid transparent; }
        .danger-button:hover:not(:disabled) { background-color: #dc2626; }
        
        .option-label {
            display: block; padding: 0.75rem 1rem; border: 1px solid #d1d5db; 
            border-radius: 0.375rem; margin-bottom: 0.5rem; cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease;
            background-color: #ffffff; 
        }
        .option-label:hover:not(.selected-answer) { background-color: #f3f4f6; border-color: #a5b4fc; }
        input[type="radio"] { display: none; }

        #results-details-grid {
            display: grid; 
            grid-template-columns: repeat(6, 1fr); 
            gap: 0.75rem; 
            padding-top: 0.5rem; 
            max-width: 950px; 
            margin-left: auto; 
            margin-right: auto;
        }
        .result-summary-item { display: flex; flex-direction: column; align-items: center; text-align: center; }
        .result-summary-box {
            width: 68px; 
            height: 68px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            border-radius: 0.375rem; 
            font-weight: 600; 
            color: white; 
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .result-summary-box:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .correct-box { background-color: #22c55e; border: 2px solid #16a34a; }
        .incorrect-box { background-color: #ef4444; border: 2px solid #dc2626; }
        .not-answered-box { background-color: #9ca3af; border: 2px solid #6b7280; }
        .time-display-in-box { font-size: 1rem; }
        .question-number-label { margin-top: 0.5rem; font-size: 0.875rem; color: #4b5563; font-weight: 500; }
        
        .explanation-box {
             background-color: #fef3c7; border: 1px solid #fcd34d; padding: 0.5rem 0.75rem; 
             margin-top: 0.75rem; border-radius: 0.375rem; font-size: 0.875rem; color: #78350f; 
        }
        .review-grid-button {
             padding: 0.5rem 0.25rem; border: 1px solid #d1d5db; border-radius: 0.375rem;
             text-align: center; transition: background-color 0.2s ease, border-color 0.2s ease;
             font-size: 0.875rem; line-height: 1.25rem; cursor: pointer;
        }
        .review-grid-button-answered { background-color: #dcfce7; border-color: #86efac; color: #15803d; }
        .review-grid-button-unanswered { background-color: #f3f4f6; border-color: #d1d5db; color: #4b5563; }
        .review-grid-button:hover { filter: brightness(95%); }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive styles */
        @media (max-width: 768px) {
            .main-content-area {
                flex-direction: column;
            }
            .passage-column, .question-column {
                width: 100%;
                margin: 0;
                height: 50%;
            }
            .passage-column {
                margin-bottom: 0.5rem;
            }
            .question-column {
                margin-top: 0.5rem;
            }
            .nav-tab {
                padding: 0.5rem;
                font-size: 0.8rem;
            }
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <p>Loading VR Focus Group 17...</p>
    </div>

    <!-- Main App Container -->
    <div id="app-container">
        <!-- Setup Screen -->
        <div id="setup-screen" class="p-6 md:p-8 flex flex-col justify-center items-center h-full">
            <div class="text-center mb-6">
                <img src="https://ik.imagekit.io/mwp/MWP%20Color%20no%20background.png?updatedAt=1745982959141"
                     alt="MedwithPurpose Logo" class="mx-auto h-11 w-auto mb-4" onerror="this.style.display='none'; this.onerror=null;">
                <h1 class="text-2xl md:text-3xl font-bold text-blue-600">Verbal Reasoning Focus Group 17</h1>
                <p class="text-gray-600 mt-2">Practice your verbal reasoning skills with this focused VR test.</p>
                <p class="text-sm text-gray-500 mt-4">
                    This section contains <strong id="setup-question-count">16 questions</strong> and you have <strong id="setup-time-limit">10 minutes</strong> to complete it.
                </p>
            </div>
            <div class="space-y-4 w-full max-w-md">
                <div>
                    <label for="goal" class="block text-sm font-medium text-gray-700">Goal (Score out of 16):</label>
                    <input type="number" id="goal" name="goal" min="0" max="16" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="e.g., 12">
                </div>
                <div>
                    <label for="focus-area" class="block text-sm font-medium text-gray-700">Area of Focus / Intention For Practice:</label>
                    <input type="text" id="focus-area" name="focus-area" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="e.g., Understanding implications, Speed">
                </div>
            </div>
            <div class="mt-8 text-center space-y-3">
                <button id="start-button" class="primary-button text-lg px-8 py-3">Begin</button>
                <button onclick="window.location.href='student_dashboard.html'" class="secondary-button text-lg px-8 py-3">Return to Dashboard</button>
                <button onclick="window.location.href='focus_groups.html'" class="secondary-button text-lg px-8 py-3">Return to Home</button>
            </div>
        </div>

        <!-- Main Test Screen -->
        <div id="practice-session-screen" class="hidden flex flex-col h-full">
            <!-- Header Bar -->
            <div class="header-bar">
                <div class="text-lg font-bold">VR Focus Group 17</div>
                <div id="timer">10:00</div>
            </div>
            
            <!-- Secondary Toolbar -->
            <div class="secondary-toolbar">
                <div>
                    <span id="question-counter">Question 1 of 16</span>
                </div>
                <div>
                    <button id="flag-button" class="secondary-toolbar-button">Flag Question</button>
                </div>
            </div>
            
            <!-- Main Content Area with Split View -->
            <div class="main-content-area">
                <div class="passage-column">
                    <!-- Passage content will be loaded here -->
                </div>
                <div class="question-column">
                    <!-- Question content will be loaded here -->
                </div>
            </div>
            
            <!-- Footer Bar -->
            <div class="footer-bar">
                <button id="back-to-results-button" class="hidden mr-auto">← Back to Results</button>
                <button id="end-practice-session-button-footer">End Practice Session</button>
                <div class="flex items-center space-x-2 ml-auto">
                    <button id="prev-button" disabled>← Previous</button>
                    <button id="navigator-button">Navigator</button>
                    <button id="next-button">Next →</button>
                </div>
            </div>
        </div>
        
        <!-- Review Screen -->
        <div id="review-screen" class="hidden p-6 md:p-8 flex flex-col items-center h-full overflow-y-auto">
            <div class="w-full max-w-3xl mb-4 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-blue-600">Review Your Answers</h2>
                <button id="filter-flagged-button" class="secondary-button text-sm">Show Flagged Only</button>
            </div>
            <p class="text-center text-gray-600 mb-6">Click on a question number to review it. Green indicates answered, Yellow border indicates flagged.</p>
            <div id="review-grid" class="grid grid-cols-4 gap-3 mb-6 w-full max-w-xs sm:max-w-sm md:max-w-md"></div>
            <div class="mt-auto pt-6">
                <button id="end-practice-session-button" class="danger-button text-lg px-8 py-3">Submit</button>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="results-screen" class="hidden p-6 md:p-8 flex flex-col h-full">
            <div class="text-center mb-6 flex-shrink-0">
                <img src="https://ik.imagekit.io/mwp/MWP%20Color%20no%20background.png?updatedAt=1745982959141"
                     alt="MedwithPurpose Logo" class="mx-auto h-11 w-auto mb-4" onerror="this.style.display='none'; this.onerror=null;">
                <h2 class="text-2xl md:text-3xl font-bold text-blue-600">Practice Session Results</h2>
            </div>
            <div class="bg-blue-50 p-4 rounded-lg mb-6 text-center flex-shrink-0">
                <p class="text-lg font-semibold">Your Score: <span id="score" class="text-blue-700">0</span> / <span id="total-questions-results">4</span></p>
                <p class="text-gray-600">Time Taken: <span id="time-taken"></span></p>
            </div>
            <h3 class="text-xl font-semibold mb-2 flex-shrink-0">Detailed Results Summary:</h3>
            <p class="text-sm text-gray-500 mb-4 flex-shrink-0">Click on a question box below to review it.</p>
            <div id="results-details-grid" class="overflow-y-auto flex-grow"></div>
            <div class="mt-6 flex-shrink-0 border-t pt-4">
                <div class="p-3 bg-blue-50 border border-blue-100 rounded-md mb-4 text-center">
                    <p class="text-blue-800 text-sm">Your test results have been submitted. You can add a reflection below if you'd like.</p>
                </div>
                <div class="mb-4">
                    <label for="focus-rating" class="block text-md font-semibold text-gray-700 mb-1">My focus out of 5 (1 very low, 5 very high):</label>
                    <input type="number" id="focus-rating" name="focus-rating" min="1" max="5" class="mt-1 block w-20 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="1-5">
                </div>
                <div>
                    <label for="reflection-text" class="block text-md font-semibold text-gray-700 mb-1">Main takeaway from this practice:</label>
                    <textarea id="reflection-text" name="reflection-text" rows="3" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Reflect on your performance, strategies, or areas for improvement..."></textarea>
                </div>
            </div>
            <div class="mt-6 text-center flex-shrink-0 flex flex-col sm:flex-row justify-center items-center space-y-3 sm:space-y-0 sm:space-x-4">
                <button onclick="window.location.href='student_dashboard.html'" class="secondary-button px-6 py-2 w-full sm:w-auto">Return to Dashboard</button>
                <button onclick="window.location.href='focus_groups.html'" class="secondary-button px-6 py-2 w-full sm:w-auto">Return to Home</button>
                <button onclick="window.location.reload()" class="secondary-button px-6 py-2 w-full sm:w-auto">Try Again</button>
                <div class="w-full sm:w-auto relative group">
                    <button id="submit-performance-button" class="primary-button px-6 py-2 w-full">Submit Reflections</button>
                    <div class="absolute left-0 right-0 -top-10 bg-blue-100 text-blue-800 text-xs p-1 rounded border border-blue-200 opacity-0 group-hover:opacity-100 transition-opacity">
                        ↓ Optional: Submit your reflection on this practice session
                    </div>
                </div>
                <button id="download-pdf-button" class="primary-button px-6 py-2 w-full sm:w-auto">Download Results PDF</button>
            </div>
        </div>

        <!-- Navigator Modal -->
        <div id="navigator-modal" class="modal">
            <div class="modal-content bg-white p-6 rounded-lg shadow-xl">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">Question Navigator</h3>
                    <button id="close-modal-button" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
                </div>
                <p class="text-sm text-gray-600 mb-4">Click a number to jump. Green: answered, Yellow border: flagged.</p>
                <div id="navigator-grid" class="grid grid-cols-4 gap-3"></div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyASKsaFFTZ-finv2d5egR9K_mZNstEwdns",
          authDomain: "mwp-qr-test-page.firebaseapp.com",
          projectId: "mwp-qr-test-page",
          storageBucket: "mwp-qr-test-page.appspot.com", 
          messagingSenderId: "309084045110",
          appId: "1:309084045110:web:b09ca0fdff84b094963d97",
          measurementId: "G-4M3ED641M9"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); // Initialize Firestore

        // Check for review mode from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const reviewParam = urlParams.get('review');
        
        // Check if user is logged in via Firebase
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                console.log("User is logged in:", user.displayName, user.email);
            } else {
                console.log("No user is logged in");
            }
        });
        
        // Hide loading overlay when page is ready
        document.getElementById('loading-overlay').style.display = 'none';
        
        // --- State Variables ---
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let timerInterval;
        let timeLeft = 10 * 60; // 10 minutes in seconds 
        let practiceSessionStartTime;
        let practiceSessionEndTime;
        let userName = '';
        let userEmail = '';
        let userGoal = '';
        let userFocusArea = '';
        let isReviewingFromResults = false;
        let questionStartTime = null;
        let questionTimes = [];
        let flaggedQuestions = [];
        let isFilteringFlagged = false;
        
        // Add a debounce flag for submissions
        let isSubmittingReflection = false;
        
        // --- Test Data: Passages and Questions ---
        const passages = [
            {
                text: `<p class='mb-4'>In Keynesian economics, the "paradox of thrift" refers to a counterintuitive idea: that while saving is beneficial to individuals, an increase in collective saving during a downturn can actually reduce overall economic growth. This occurs because one person\'s spending is another\'s income. If many households simultaneously cut back on spending to increase savings, businesses experience reduced demand, leading them to cut costs, lay off workers, or lower wages. As incomes fall, total savings in the economy may paradoxically decline, despite each household trying to save more.</p><p class='mb-4'>This concept was first articulated by John Maynard Keynes during the Great Depression of the 1930s. Keynes argued that during periods of economic slack, active government intervention—through fiscal stimulus and public investment—was essential to counteract the fall in aggregate demand caused by rising private saving.</p><p class='mb-4'>The paradox does not apply in the same way during times of full employment. When an economy is at or near its productive capacity, increased saving can lead to more investment in capital goods rather than reduced demand. Classical economists, in contrast to Keynesians, believe that savings naturally find their way into productive investment through interest rate adjustments, making recessions self-correcting over time.</p><p class='mb-4'>Critics of the paradox argue that it ignores long-term benefits of saving, such as improved capital accumulation and resilience against future shocks. However, empirical studies of past recessions in the U.S. and Japan show that abrupt increases in household savings rates often coincide with declining GDP and consumer confidence, particularly in liquidity traps where interest rates are near zero and monetary policy loses its effectiveness.</p>`,
                questions: [
                    {
                        text: `The passage suggests that the "paradox of thrift" is most pronounced and counterproductive when:`,
                        options: [
                            "Individual households prioritize long-term financial security over immediate spending, thereby bolstering capital accumulation for future growth.",
                            "A collective increase in the propensity to save during an economic downturn unintentionally deepens the recessionary impact due to falling aggregate demand.",
                            "Government intervention through fiscal stimulus fully counteracts any attempts by households to increase savings, leading to economic stagnation.",
                            "Classical economic theories about interest rate adjustments prove effective in rapidly converting increased savings into productive investments during a slump."
                        ],
                        correctAnswer: "B"
                    },
                    {
                        text: `The passage implies that Keynes\'s advocacy for active government intervention during periods of economic slack is primarily rooted in the understanding that:`,
                        options: [
                            "Private savings, if unchecked, inherently lead to a misallocation of resources that only public investment can rectify.",
                            "Without external stimulus, the cumulative effect of individual rational decisions to save more can trap the economy in a low-income, low-demand state.",
                            "The primary role of government is to educate households on the counterproductive nature of saving during recessions.",
                            "Interest rate mechanisms, while theoretically sound, are often too slow to respond, necessitating quicker fiscal action by the government."
                        ],
                        correctAnswer: "B"
                    },
                    {
                        text: `Which of the following scenarios, if empirically demonstrated, would most substantially challenge the central tenet of the Keynesian "paradox of thrift" as described in the passage?`,
                        options: [
                            "Evidence showing that increased government spending during recessions often leads to higher national debt without a proportionate increase in GDP.",
                            "Studies indicating that economies with higher average household savings rates consistently experience more stable, albeit slower, long-term growth.",
                            "Data revealing that during economic downturns, a surge in collective household saving is frequently and swiftly followed by a significant rise in business investment and subsequent economic recovery, even without government stimulus.",
                            "Observations that consumer confidence is more closely tied to perceived job security than to current savings levels or government fiscal policies."
                        ],
                        correctAnswer: "C"
                    },
                    {
                        text: `Based on the distinctions made in the passage, the negative consequences of the "paradox of thrift" are implied to be most subdued or potentially reversed when:`,
                        options: [
                            "An economy is experiencing a liquidity trap, with interest rates near zero, rendering monetary policy ineffective.",
                            "The economy is operating with significant unused productive capacity and high unemployment.",
                            "Increased household savings are primarily driven by widespread fear of future economic instability rather than confidence in investment opportunities.",
                            "The economy is functioning near its maximum output, allowing increased savings to be channeled into capital formation without depressing overall demand."
                        ],
                        correctAnswer: "D"
                    }
                ]
            },
            {
                text: `<p class='mb-4'>Wangari Maathai\'s life defied expectations — of her time, her gender, and even her profession. Born in rural Kenya in 1940, she came of age in a country still under British colonial rule. Against a backdrop of systemic gender bias and minimal access to education for girls, she earned a scholarship to study biology in the United States during the Kennedy-era African Airlift program. She would go on to earn a doctorate in veterinary anatomy — the first woman in East or Central Africa to do so.</p><p class='mb-4'>But it was not her academic credentials that made her a global icon. In 1977, Maathai founded the Green Belt Movement, a grassroots environmental initiative that began by simply planting trees. What set her apart was the belief that environmental degradation, poverty, and disenfranchisement were not separate issues but symptoms of the same systemic failure. Her campaign taught rural women to plant trees, restore ecosystems, and earn income — an act as politically charged as it was ecologically sound in a nation marred by authoritarianism and corruption.</p><p class='mb-4'>Despite imprisonment, smear campaigns, and violent pushback, Maathai remained steadfast. She once said, "Until you dig a hole, you plant a tree, you water it and make it survive, you haven\'t done a thing." Her approach combined scientific rigor with civic resistance and was recognized when she became the first African woman awarded the Nobel Peace Prize in 2004.</p><p class='mb-4'>To reduce Maathai\'s life to environmental activism alone would be to overlook the philosophical core of her work: that sustainable change must be rooted in dignity, participation, and ecology — not just policy.</p>`,
                questions: [
                    {
                        text: `The passage suggests that the most significant underlying challenge Wangari Maathai encountered in establishing and expanding the Green Belt Movement stemmed from:`,
                        options: [
                            "A general lack of awareness among rural Kenyan women regarding the long-term benefits of environmental conservation.",
                            "The inherent difficulty of large-scale reforestation in a country with limited resources and challenging climatic conditions.",
                            "The movement\'s direct confrontation with entrenched systems of power that benefited from or were indifferent to environmental degradation, poverty, and disenfranchisement.",
                            "The initial skepticism from international organizations regarding the feasibility of a grassroots movement led by women in a patriarchal society."
                        ],
                        correctAnswer: "C"
                    },
                    {
                        text: `The passage portrays Wangari Maathai\'s approach to tree planting primarily as:`,
                        options: [
                            "A pragmatic, albeit limited, first step towards addressing the complex issue of deforestation in Kenya.",
                            "An act of profound socio-political and ecological significance, aimed at empowering marginalized communities and healing both land and society.",
                            "A scientifically-driven method focused exclusively on ecological restoration, with social benefits being a secondary, indirect outcome.",
                            "A symbolic gesture of resistance, more valuable for its political statement than for its tangible environmental impact."
                        ],
                        correctAnswer: "B"
                    },
                    {
                        text: `The predominant tone of the final paragraph ("To reduce Maathai\'s life to environmental activism alone would be to overlook the philosophical core of her work: that sustainable change must be rooted in dignity, participation, and ecology not just policy.") can best be characterized as:`,
                        options: [
                            "Cautiously optimistic, suggesting potential but acknowledging significant hurdles.",
                            "Assertively respectful, aiming to correct a potential oversimplification of her profound legacy.",
                            "Objectively analytical, breaking down the components of her activism without personal judgment.",
                            "Somewhat critical, implying that focusing solely on policy is a common but flawed approach."
                        ],
                        correctAnswer: "B"
                    },
                    {
                        text: `Which of the following hypothetical discoveries would most effectively bolster the author\'s concluding assertion about Wangari Maathai\'s unique legacy being rooted in a philosophy that integrates dignity, participation, and ecology?`,
                        options: [
                            "A comparative analysis showing that reforestation projects achieve higher tree survival rates when managed by scientifically trained forestry experts rather than local community groups.",
                            "Previously unpublished diaries of Maathai revealing her primary motivation was to achieve international political leverage for Kenya through environmentalism.",
                            "Longitudinal studies of communities involved in the Green Belt Movement demonstrating sustained improvements in local governance, women\'s empowerment, and ecological health, attributed by participants to the movement\'s holistic principles.",
                            "Evidence that Maathai\'s academic work in veterinary anatomy directly informed her tree-planting techniques, making them uniquely effective."
                        ],
                        correctAnswer: "C"
                    }
                ]
            },
            {
                text: `<p class='mb-4'>The Murray–Darling Basin, stretching across four Australian states and one territory, supports over a third of the nation\'s agricultural output. In New South Wales, the Basin\'s rivers are vital not just for irrigation, but also for cultural heritage, Indigenous livelihoods, and ecosystems that depend on regular flooding cycles. However, water extraction has long outpaced sustainable levels.</p><p class='mb-4'>In 2012, the Murray–Darling Basin Plan was introduced to rebalance environmental and economic demands by capping water usage and returning a portion to the environment. This reform, while praised for its ambition, has been politically fraught. Farmers argue the reductions limit their viability, while ecologists warn the cuts don\'t go far enough. The plan\'s target of returning 2,750 gigalitres to the river system has faced repeated delays, with accusations of water hoarding, illegal diversions, and weak enforcement undermining public trust.</p><p class='mb-4'>Meanwhile, climate change has compounded pressures. Rainfall in the southern Basin has declined significantly over the past two decades, and longer droughts have become more frequent. A 2020 report by the CSIRO warned that even with full compliance, current water-sharing models may not protect against ecological collapse under projected warming scenarios.</p><p class='mb-4'>Policymakers now face a difficult balancing act: protect food production and rural communities, honour Indigenous water rights, and sustain a fragile river system. As the next major review of the Plan approaches, calls are growing for a more adaptive model — one that accounts not just for annual rainfall, but for long-term climate variability and enforceable environmental safeguards.</p>`,
                questions: [
                    {
                        text: `The passage as a whole suggests that the Murray-Darling Basin Plan, despite its ambitious goals, is primarily characterized by:`,
                        options: [
                            "A fundamental flaw in its initial scientific assessment of sustainable water extraction levels, rendering its targets unachievable.",
                            "A complex and ongoing struggle to reconcile competing legitimate interests amidst escalating environmental pressures and implementation difficulties.",
                            "A general consensus among stakeholders that, while imperfect, the Plan is the only viable path towards ecological sustainability for the Basin.",
                            "A successful rebalancing of environmental and economic demands, though facing minor delays in achieving its final water recovery targets."
                        ],
                        correctAnswer: "B"
                    },
                    {
                        text: `The author implies that climate change\'s primary effect on the Murray-Darling Basin\'s water management challenges is to:`,
                        options: [
                            "Necessitate a complete overhaul of agricultural practices towards drought-resistant crops, a solution not yet considered by policymakers.",
                            "Create new opportunities for water storage and diversion technologies that could offset declining rainfall.",
                            "Significantly worsen the pre-existing imbalance between water supply and demand, making the Basin Plan\'s objectives even harder to achieve.",
                            "Shift the focus of the Basin Plan from water quantity to water quality, as declining flows concentrate pollutants."
                        ],
                        correctAnswer: "C"
                    },
                    {
                        text: `The concluding sentences of the passage ("As the next major review of the Plan approaches, calls are growing for a more adaptive model one that accounts not just for annual rainfall, but for long-term climate variability and enforceable environmental safeguards." ) suggest that the author views the most critical need for the Basin\'s future as:`,
                        options: [
                            "A stricter enforcement mechanism for the existing water recovery targets, regardless of climatic changes.",
                            "The development of water management strategies that are flexible and responsive to evolving, long-term environmental conditions.",
                            "A significant increase in the overall water recovery target to create a buffer against future climate impacts.",
                            "A political resolution between farmers and ecologists to agree on a fixed, universally accepted water allocation formula."
                        ],
                        correctAnswer: "B"
                    },
                    {
                        text: `Which of the following findings would cast the most serious doubt on the fundamental premise underlying the Murray-Darling Basin Plan\'s current strategy of rebalancing demands by capping usage and returning water to the environment?`,
                        options: [
                            "Evidence that the economic impact on agricultural communities due to water reductions has been more severe than initially projected by the Plan\'s architects.",
                            "Scientific consensus that the targeted 2,750 gigalitres, even if fully returned, represents only a small fraction of the water needed for genuine long-term ecological restoration.",
                            "Research demonstrating that the dominant factor in the Basin\'s ecological decline is widespread land-clearing and soil degradation, which persist regardless of river flow volumes.",
                            "Reports showing that illegal water diversions have increased significantly since the Plan\'s implementation, offsetting any water returned to the environment."
                        ],
                        correctAnswer: "C"
                    }
                ]
            },
            {
                text: `<p class='mb-4'>Recent studies have shed light on the complex underground relationships between trees and fungi, known as mycorrhizal networks. These symbiotic connections involve fungi attaching to tree roots and extending vast networks of filaments, called hyphae, into the soil. Through these filaments, trees and fungi engage in a mutual exchange: fungi receive sugars produced by the trees through photosynthesis, while trees gain improved access to water and nutrients, especially phosphorus and nitrogen.</p><p class='mb-4'>More surprisingly, researchers have found that these networks may allow trees to communicate and even transfer resources to one another. In some documented cases, older trees have sent carbon-rich compounds to saplings that were shaded and unable to photosynthesise effectively. This phenomenon, often referred to as the "wood wide web," has led to a reconsideration of forest ecology, shifting the perception of trees from solitary organisms to members of interdependent communities.</p><p class='mb-4'>However, this view is not without critics. Some scientists caution that attributing intentionality or communication to trees anthropomorphises what could be basic chemical signaling. Others point to the variability in findings depending on tree species, climate, and soil composition. Nevertheless, many agree that mycorrhizal networks play a critical—if not fully understood—role in forest resilience and nutrient cycling.</p>`,
                questions: [
                    {
                        text: `The passage implies that the transfer of resources from mature trees to saplings through mycorrhizal networks is significant primarily because it:`,
                        options: [
                            "Confirms that trees possess a form of altruistic intentionality, actively deciding to aid weaker individuals.",
                            "Suggests that forest ecosystems may possess a higher degree of collective resilience and interconnected support than previously understood.",
                            "Provides a complete explanation for how all saplings in dense forests survive despite limited access to sunlight.",
                            "Indicates that fungi primarily act as passive conduits for resources dictated entirely by the needs of the trees."
                        ],
                        correctAnswer: "B"
                    },
                    {
                        text: `Regarding the concept of trees "communicating" via mycorrhizal networks, the passage leads the reader to infer that:`,
                        options: [
                            "The scientific community has largely dismissed the idea as an over-interpretation of basic biological processes.",
                            "While direct resource transfer is documented, the notion of intentional communication remains a subject of ongoing debate and requires careful interpretation.",
                            "The \"wood wide web\" is now unequivocally accepted as evidence of sophisticated, language-like interactions between trees.",
                            "Any signaling observed is purely a byproduct of nutrient exchange, with no adaptive significance for the trees involved."
                        ],
                        correctAnswer: "B"
                    },
                    {
                        text: `Based on the description of the tree-fungi relationship, it can be most reasonably inferred that:`,
                        options: [
                            "The fungi are entirely dependent on the trees for survival, while the trees could likely thrive without the fungi, albeit less efficiently.",
                            "The interaction is a clear instance of commensalism, where one species benefits significantly and the other is largely unaffected.",
                            "While both species derive benefits, the passage does not provide enough information to determine if these benefits are always quantitatively equal or if one partner consistently gains more.",
                            "The primary driver of the relationship is the trees\' need for enhanced nutrient uptake, with the fungi\'s sugar acquisition being a secondary, less critical outcome."
                        ],
                        correctAnswer: "C"
                    },
                    {
                        text: `The author\'s reference to the "wood wide web" and the subsequent discussion primarily serves to illustrate:`,
                        options: [
                            "The universal acceptance among ecologists of trees as highly social and cooperative organisms.",
                            "A pivotal conceptual evolution in understanding forest dynamics, moving from a view of isolated individuals to one of interconnected communities, though nuances are still debated.",
                            "The primary mechanism by which all forests achieve resilience against environmental stressors.",
                            "A controversial theory that, while popular in some circles, lacks substantial empirical support from the broader scientific community."
                        ],
                        correctAnswer: "B"
                    }
                ]
            }
        ];
        
        // --- DOM Elements ---
        const appContainer = document.getElementById('app-container');
        const setupScreen = document.getElementById('setup-screen');
        const practiceSessionScreen = document.getElementById('practice-session-screen');
        const reviewScreen = document.getElementById('review-screen');
        const resultsScreen = document.getElementById('results-screen');
        const navigatorModal = document.getElementById('navigator-modal');
        const startButton = document.getElementById('start-button');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const navigatorButton = document.getElementById('navigator-button');
        const closeModalButton = document.getElementById('close-modal-button');
        const endPracticeSessionButton = document.getElementById('end-practice-session-button');
        const endPracticeSessionButtonFooter = document.getElementById('end-practice-session-button-footer');
        const backToResultsButton = document.getElementById('back-to-results-button');
        const flagButton = document.getElementById('flag-button');
        const questionCounterEl = document.getElementById('question-counter');
        const timerEl = document.getElementById('timer');
        const reviewGrid = document.getElementById('review-grid');
        const navigatorGrid = document.getElementById('navigator-grid');
        const scoreEl = document.getElementById('score');
        const totalQuestionsResultsEl = document.getElementById('total-questions-results');
        const timeTakenEl = document.getElementById('time-taken');
        const resultsDetailsGrid = document.getElementById('results-details-grid');
        const goalInput = document.getElementById('goal');
        const focusAreaInput = document.getElementById('focus-area');
        const filterFlaggedButton = document.getElementById('filter-flagged-button');
        const setupQuestionCountEl = document.getElementById('setup-question-count');
        const setupTimeLimitEl = document.getElementById('setup-time-limit');
        const reflectionText = document.getElementById('reflection-text');
        const downloadPdfButton = document.getElementById('download-pdf-button');
        const focusRatingInput = document.getElementById('focus-rating');
        
        // --- Functions ---
        function showSetupScreen() {
            userName = '';
            userEmail = '';
            userGoal = '';
            userFocusArea = '';
            
            // Check for Firebase auth user
            if (firebase.auth && firebase.auth().currentUser) {
                const currentUser = firebase.auth().currentUser;
                userName = currentUser.displayName || currentUser.email || '';
                userEmail = currentUser.email || '';
            }
            
            setupScreen.classList.remove('hidden');
            practiceSessionScreen.classList.add('hidden');
            reviewScreen.classList.add('hidden');
            reviewScreen.classList.remove('flex');
            resultsScreen.classList.add('hidden');
            resultsScreen.classList.remove('flex');
            appContainer.classList.remove('flex', 'flex-col');
            
            if (setupQuestionCountEl) setupQuestionCountEl.textContent = "16";
            if (setupTimeLimitEl) setupTimeLimitEl.textContent = "10 minutes";
            if (goalInput) {
                goalInput.max = 16;
                goalInput.value = userGoal;
            }
            if (focusAreaInput) {
                focusAreaInput.value = userFocusArea;
            }
        }

        // Start test function to be called from the setup screen
        function startTest() {
            console.log("Starting test...");
            
            // Get user info from Firebase Auth if available
            if (firebase.auth && firebase.auth().currentUser) {
                const currentUser = firebase.auth().currentUser;
                userName = currentUser.displayName || currentUser.email || '';
                userEmail = currentUser.email || '';
            }
            
            userGoal = goalInput.value.trim();
            userFocusArea = focusAreaInput.value.trim();
            timeLeft = 10 * 60; // 10 minutes
            
            // Initialize arrays
            userAnswers = new Array(passages.length * 4).fill(null);
            questionTimes = new Array(passages.length * 4).fill(0);
            flaggedQuestions = new Array(passages.length * 4).fill(false);
            
            questionStartTime = null;
            currentQuestionIndex = 0;
            isReviewingFromResults = false;
            isFilteringFlagged = false;
            practiceSessionEndTime = null;
            
            showPracticeSessionScreen();
            startTimer();
            loadQuestion(0);
            populateNavigator();
        }

        function showPracticeSessionScreen() {
            setupScreen.classList.add('hidden');
            practiceSessionScreen.classList.remove('hidden');
            practiceSessionScreen.classList.add('flex');
            reviewScreen.classList.add('hidden');
            reviewScreen.classList.remove('flex');
            resultsScreen.classList.add('hidden');
            resultsScreen.classList.remove('flex');
            appContainer.classList.add('flex', 'flex-col');
        }

        function startTimer() {
            practiceSessionStartTime = new Date();
            clearInterval(timerInterval);
            timerEl.textContent = formatTimeSeconds(timeLeft);
            timerEl.classList.remove('text-gray-300');
            timerEl.classList.add('text-white', 'bg-opacity-20', 'bg-white');
            timerInterval = setInterval(() => {
                timeLeft--;
                timerEl.textContent = formatTimeSeconds(timeLeft);
                if (timeLeft <= 0) {
                    endPracticeSessionAndShowResults();
                }
            }, 1000);
        }

        function formatTimeSeconds(totalSeconds) {
            if (totalSeconds < 0) totalSeconds = 0;
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }

        // Load passage and question
        function loadQuestion(index) {
            console.log("Loading question:", index);
            
            if (index < 0 || index >= passages.length * 4) {
                console.error("Question index out of bounds:", index);
                return;
            }
            
            currentQuestionIndex = index;
            
            // Record time spent on the previous question
            if (questionStartTime && !isReviewingFromResults) {
                const timeSpent = Date.now() - questionStartTime;
                questionTimes[index] = (questionTimes[index] || 0) + timeSpent;
            }
            
            // Start timing for this question
            questionStartTime = Date.now();
            
            // Update question counter
            questionCounterEl.textContent = `Question ${index + 1} of ${passages.length * 4}`;
            
            // Update UI buttons
            prevButton.disabled = index === 0;
            nextButton.disabled = index === passages.length * 4 - 1;
            updateFlagButtonAppearance();
            
            // Load passage
            const passageIndex = Math.floor(index / 4);
            const passage = passages[passageIndex];
            const passageColumn = document.querySelector('.passage-column');
            if (passageColumn) {
                passageColumn.innerHTML = `<div class="passage-text">${passage.text}</div>`;
            }
            
            // Load question
            const questionIndex = index % 4;
            const question = passage.questions[questionIndex];
            const questionColumn = document.querySelector('.question-column');
            
            if (questionColumn) {
                let optionsHTML = '';
                
                question.options.forEach((option, i) => {
                    const letter = String.fromCharCode(65 + i); // A, B, C, D
                    const isSelected = userAnswers[index] === letter;
                    
                    optionsHTML += `
                        <label class="option-label ${isSelected ? 'selected-answer' : ''}">
                            <input type="radio" name="question-${index}" value="${letter}" ${isSelected ? 'checked' : ''}>
                            <span class="font-medium">${letter}.</span> ${option}
                        </label>
                    `;
                });
                
                questionColumn.innerHTML = `
                    <h3 class="text-base font-medium mb-4">${question.text}</h3>
                    <div class="options-container">
                        ${optionsHTML}
                    </div>
                `;
                
                // Add event listeners to the options
                const optionLabels = questionColumn.querySelectorAll('.option-label');
                optionLabels.forEach(label => {
                    label.addEventListener('click', function() {
                        const input = this.querySelector('input[type="radio"]');
                        if (input) {
                            userAnswers[index] = input.value;
                            optionLabels.forEach(l => l.classList.remove('selected-answer'));
                            this.classList.add('selected-answer');
                            updateNavigatorButtons();
                        }
                    });
                });
            }
        }

        function updateFlagButtonAppearance() {
            const isFlagged = flaggedQuestions[currentQuestionIndex];
            flagButton.textContent = isFlagged ? 'Unflag' : 'Flag Question';
            flagButton.classList.toggle('flagged', isFlagged);
        }

        function toggleFlag() {
            if (isReviewingFromResults) return;
            
            flaggedQuestions[currentQuestionIndex] = !flaggedQuestions[currentQuestionIndex];
            updateFlagButtonAppearance();
            updateNavigatorButtons();
        }

        function populateNavigator() {
            if (!navigatorGrid) return;
            
            navigatorGrid.innerHTML = '';
            
            for (let i = 0; i < passages.length * 4; i++) {
                const button = document.createElement('button');
                button.textContent = i + 1;
                button.classList.add('py-2', 'px-1', 'border', 'border-gray-300', 'rounded-md', 'text-center', 'transition', 'duration-150', 'ease-in-out', 'text-sm', 'hover:bg-gray-100');
                button.dataset.questionIndex = i;
                
                if (userAnswers[i]) button.classList.add('nav-answered');
                if (i === currentQuestionIndex) button.classList.add('nav-current');
                if (flaggedQuestions[i]) button.classList.add('nav-flagged');
                
                button.addEventListener('click', function() {
                    navigatorModal.classList.remove('flex');
                    navigatorModal.classList.add('hidden');
                    const targetIndex = parseInt(this.dataset.questionIndex, 10);
                    loadQuestion(targetIndex);
                });
                
                navigatorGrid.appendChild(button);
            }
        }

        function updateNavigatorButtons() {
            if (!navigatorGrid) return;
            
            const buttons = navigatorGrid.querySelectorAll('button');
            buttons.forEach(button => {
                const index = parseInt(button.dataset.questionIndex, 10);
                button.classList.remove('nav-answered', 'nav-current', 'nav-flagged');
                if (userAnswers[index]) button.classList.add('nav-answered');
                if (index === currentQuestionIndex) button.classList.add('nav-current');
                if (flaggedQuestions[index]) button.classList.add('nav-flagged');
            });
        }

        // Event listeners
        if (startButton) {
            startButton.addEventListener('click', startTest);
        }
        
        if (flagButton) {
            flagButton.addEventListener('click', toggleFlag);
        }
        
        if (prevButton) {
            prevButton.addEventListener('click', function() {
                if (currentQuestionIndex > 0) {
                    loadQuestion(currentQuestionIndex - 1);
                }
            });
        }
        
        if (nextButton) {
            nextButton.addEventListener('click', function() {
                if (currentQuestionIndex < passages.length * 4 - 1) {
                    loadQuestion(currentQuestionIndex + 1);
                }
            });
        }
        
        if (navigatorButton) {
            navigatorButton.addEventListener('click', function() {
                navigatorModal.classList.add('flex');
                populateNavigator();
            });
        }
        
        if (closeModalButton) {
            closeModalButton.addEventListener('click', function() {
                navigatorModal.classList.remove('flex');
                navigatorModal.classList.add('hidden');
            });
        }
        
        if (endPracticeSessionButton || endPracticeSessionButtonFooter) {
            const endSession = function() {
                if (confirm('Are you sure you want to end this practice session? Your progress will be saved.')) {
                    endPracticeSessionAndShowResults();
                }
            };
            
            if (endPracticeSessionButton) {
                endPracticeSessionButton.addEventListener('click', endSession);
            }
            
            if (endPracticeSessionButtonFooter) {
                endPracticeSessionButtonFooter.addEventListener('click', endSession);
            }
        }

        function endPracticeSessionAndShowResults() {
            // Record time spent on the current question
            if (questionStartTime) {
                const timeSpent = Date.now() - questionStartTime;
                questionTimes[currentQuestionIndex] = (questionTimes[currentQuestionIndex] || 0) + timeSpent;
                questionStartTime = null;
            }
            
            practiceSessionEndTime = new Date();
            clearInterval(timerInterval);
            
            // Calculate results to submit to Firebase
            const score = calculateScore();
            
            // Submit results to Firebase
            submitResultsToFirebase(score);
            
            // Show results screen
            showResultsScreen();
        }
        
        // Function to calculate score
        function calculateScore() {
            let score = 0;
            for (let i = 0; i < userAnswers.length; i++) {
                const passageIndex = Math.floor(i / 4);
                const questionIndex = i % 4;
                const question = passages[passageIndex].questions[questionIndex];
                
                if (userAnswers[i] === question.correctAnswer) {
                    score++;
                }
            }
            return score;
        }
        
        // Function to submit results to Firebase
        function submitResultsToFirebase(score) {
            try {
                if (typeof firebase !== 'undefined' && firebase.firestore) {
                    const db = firebase.firestore();
                    
                    // Get current authenticated user data if available
                    let userDisplayName = '';
                    let userId = '';
                    
                    if (firebase.auth && firebase.auth().currentUser) {
                        const currentUser = firebase.auth().currentUser;
                        userDisplayName = currentUser.displayName || '';
                        userId = currentUser.uid;
                    }
                    
                    const timeInMs = practiceSessionEndTime - practiceSessionStartTime;
                    const minutes = Math.floor(timeInMs / 60000);
                    const seconds = Math.floor((timeInMs % 60000) / 1000);
                    const formattedTime = `${minutes} min ${seconds < 10 ? '0' : ''}${seconds} sec`;
                    
                    // Create data object
                    const performanceData = {
                        studentName: userName || userDisplayName || 'Anonymous',
                        studentEmail: userEmail || '',
                        userId: userId,
                        examName: "VR Focus Group 17",
                        score: score.toString(),
                        totalQuestions: (passages.length * 4).toString(),
                        timeTaken: formattedTime,
                        answers: userAnswers,
                        correctAnswers: passages.flatMap(p => p.questions.map(q => q.correctAnswer)),
                        questionTimes: questionTimes,
                        flaggedQuestions: flaggedQuestions,
                        goal: userGoal || '',
                        focusArea: userFocusArea || '',
                        submissionTimestamp: new Date().toISOString(),
                        userAgent: navigator.userAgent
                    };
                    
                    // Add to Firestore
                    db.collection("performanceSubmissions").add(performanceData)
                        .catch(error => {
                            console.error("Error saving results to Firebase:", error);
                        });
                }
            } catch (error) {
                console.error("Error in submitResultsToFirebase:", error);
            }
        }
        
        function showResultsScreen() {
            practiceSessionScreen.classList.add('hidden');
            reviewScreen.classList.add('hidden');
            reviewScreen.classList.remove('flex');
            resultsScreen.classList.remove('hidden');
            resultsScreen.classList.add('flex');
            setupScreen.classList.add('hidden');
            
            // Calculate score
            let score = 0;
            for (let i = 0; i < userAnswers.length; i++) {
                const passageIndex = Math.floor(i / 4);
                const questionIndex = i % 4;
                const question = passages[passageIndex].questions[questionIndex];
                
                if (userAnswers[i] === question.correctAnswer) {
                    score++;
                }
            }
            
            // Update results
            scoreEl.textContent = score;
            totalQuestionsResultsEl.textContent = passages.length * 4;
            
            // Calculate time taken
            const timeInMs = practiceSessionEndTime - practiceSessionStartTime;
            const minutes = Math.floor(timeInMs / 60000);
            const seconds = Math.floor((timeInMs % 60000) / 1000);
            timeTakenEl.textContent = `${minutes} min ${seconds < 10 ? '0' : ''}${seconds} sec`;
            
            // Populate results grid
            populateResultsGrid();
        }
        
        function populateResultsGrid() {
            resultsDetailsGrid.innerHTML = '';
            
            for (let i = 0; i < userAnswers.length; i++) {
                const passageIndex = Math.floor(i / 4);
                const questionIndex = i % 4;
                const question = passages[passageIndex].questions[questionIndex];
                const userAnswer = userAnswers[i];
                const correctAnswer = question.correctAnswer;
                const isCorrect = userAnswer === correctAnswer;
                
                const summaryItem = document.createElement('div');
                summaryItem.classList.add('result-summary-item');
                
                const summaryBox = document.createElement('div');
                summaryBox.classList.add('result-summary-box');
                
                if (!userAnswer) {
                    summaryBox.classList.add('not-answered-box');
                } else {
                    summaryBox.classList.add(isCorrect ? 'correct-box' : 'incorrect-box');
                }
                
                const timeSpentMs = questionTimes[i] || 0;
                const timeSpentSec = Math.round(timeSpentMs / 1000);
                
                const timeDisplay = document.createElement('span');
                timeDisplay.classList.add('time-display-in-box');
                timeDisplay.textContent = `${timeSpentSec}s`;
                
                summaryBox.appendChild(timeDisplay);
                
                const numberLabel = document.createElement('div');
                numberLabel.classList.add('question-number-label');
                numberLabel.textContent = `Q${i + 1}`;
                
                summaryItem.appendChild(summaryBox);
                summaryItem.appendChild(numberLabel);
                
                resultsDetailsGrid.appendChild(summaryItem);
            }
        }

        // Initialize the setup screen
        // showSetupScreen(); // Original initial load

        // --- MODIFIED Initial Load ---
        // The main DOMContentLoaded listener is already present from line 438.
        // We will add the call to checkForReviewMode inside the existing one.

        // --- NEW FUNCTION to check for and load review mode ---
        function checkForReviewMode() {
            const reviewSubmissionId = localStorage.getItem('reviewSubmissionId');
            const isReviewHash = window.location.hash === '#review';

            if (reviewSubmissionId && isReviewHash) {
                console.log("Review mode detected for VR. Submission ID:", reviewSubmissionId);
                document.getElementById('loading-overlay').style.display = 'flex'; // Show loading

                if(setupScreen) setupScreen.classList.add('hidden');
                if(resultsScreen) resultsScreen.classList.add('hidden');
                if(reviewScreen) reviewScreen.classList.add('hidden');
                
                if (!db) { // db should be initialized by the time DOMContentLoaded fires
                    console.error("Firestore (db) is not initialized. Cannot load review data.");
                    alert("Error: Could not connect to load review data.");
                    document.getElementById('loading-overlay').style.display = 'none';
        showSetupScreen();
                    localStorage.removeItem('reviewSubmissionId');
                    return;
                }

                db.collection("performanceSubmissions").doc(reviewSubmissionId).get()
                    .then(doc => {
                        if (doc.exists) {
                            const submissionData = doc.data();
                            console.log("VR Submission data fetched for review:", submissionData);
                            
                            // Populate necessary global states from submissionData for VR
                            // The VR test data structure (passages, questions per passage) is fixed in the file.
                            // We need to map the flat `submissionData.answers` and `submissionData.flaggedQuestions` 
                            // (assuming they were saved as flat arrays) to the component's `userAnswers` and `flaggedQuestions`.
                            if (submissionData.answers && Array.isArray(submissionData.answers)) {
                                userAnswers = submissionData.answers;
                            } else {
                                userAnswers = new Array(passages.length * 4).fill(null); // Default if not found
                                console.warn("Review data: userAnswers not found or not an array in submissionData.questions.");
                            }
                            if (submissionData.flaggedQuestions && Array.isArray(submissionData.flaggedQuestions)) {
                                flaggedQuestions = submissionData.flaggedQuestions;
                            } else {
                                flaggedQuestions = new Array(passages.length * 4).fill(false); // Default
                                 console.warn("Review data: flaggedQuestions not found or not an array in submissionData.questions.");
                            }
                            
                            userName = submissionData.studentName || 'Review User';
                            isReviewingFromResults = true; // Critical flag for loadQuestion behavior

                            showPracticeSessionScreen();
                            
                            const nextBtn = document.getElementById('next-button');
                            const endExamFoot = document.getElementById('end-practice-session-button-footer');
                            const navigatorBtn = document.getElementById('navigator-button');
                            const backToDashResultsButton = document.createElement('button');
                            const flagBtn = document.getElementById('flag-button');
                            const timerElem = document.getElementById('timer');

                            if(nextBtn) nextBtn.textContent = 'Next Question →';
                            if(endExamFoot) endExamFoot.style.display = 'none';
                            if(navigatorBtn) navigatorBtn.style.display = 'none';
                            if(flagBtn) flagBtn.style.display = 'none';
                            if(timerElem) timerElem.style.display = 'none';

                            backToDashResultsButton.textContent = '← Back to Dashboard Results';
                            backToDashResultsButton.className = 'secondary-button';
                            backToDashResultsButton.onclick = () => {
                                if(localStorage.getItem('returnToDashboardResults')) {
                                    localStorage.removeItem('reviewSubmissionId');
                                    localStorage.removeItem('returnToDashboardResults');
                                    window.location.href = 'student_dashboard.html#results';
                                } else {
                                     window.location.href = 'student_dashboard.html';
                                }
                            };
                            const footerBar = document.querySelector('.footer-bar');
                            if (footerBar) {
                                const existingBtn = footerBar.querySelector('#back-to-dashboard-results-review-vr');
                                if(existingBtn) existingBtn.remove();
                                backToDashResultsButton.id = 'back-to-dashboard-results-review-vr';
                                footerBar.insertBefore(backToDashResultsButton, footerBar.firstChild);
                            }

                            currentQuestionIndex = 0;
                            loadQuestion(currentQuestionIndex); // VR loadQuestion doesn't take a reviewMode flag, it uses isReviewingFromResults global state.
                            document.getElementById('loading-overlay').style.display = 'none';
                        } else {
                            console.error("No such VR submission document! ID:", reviewSubmissionId);
                            alert("Could not find the VR submission to review.");
                            document.getElementById('loading-overlay').style.display = 'none';
                            showSetupScreen();
                            localStorage.removeItem('reviewSubmissionId');
                        }
                    }).catch(error => {
                        console.error("Error getting VR submission document:", error);
                        alert("Error fetching VR review data.");
                        document.getElementById('loading-overlay').style.display = 'none';
                        showSetupScreen();
                        localStorage.removeItem('reviewSubmissionId');
                    });
            } else {
                if(reviewSubmissionId) localStorage.removeItem('reviewSubmissionId');
                if(localStorage.getItem('returnToDashboardResults')) localStorage.removeItem('returnToDashboardResults');
                showSetupScreen(); // Normal startup
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }
    });
    </script>
</body>
</html> 