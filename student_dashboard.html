<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - UCAT Platform</title>
    <link rel="icon" href="https://ik.imagekit.io/mwp/2.svg?updatedAt=1745982956185" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            /* M3 Color Palette - Light Theme (Examples from Design Doc) */
            --md-sys-color-primary: #1967D2; /* Primary P40 */
            --md-sys-color-on-primary: #FFFFFF; /* Primary P100 */
            --md-sys-color-primary-container: #D1E3FF; /* Primary P90 */
            --md-sys-color-on-primary-container: #001E3A; /* Primary P10 */
            --md-sys-color-secondary: #4285F4; /* Secondary P40 (desaturated version of #4285F4 might be used, e.g. #5E89C2 if desaturated) */
            --md-sys-color-on-secondary: #FFFFFF;
            --md-sys-color-secondary-container: #D6E3FF; /* Example, derived */
            --md-sys-color-on-secondary-container: #001A43; /* Example, derived */
            --md-sys-color-accent-cta: #FF6D00; /* Tertiary P40 - Orange */
            --md-sys-color-on-accent-cta: #FFFFFF;
            --md-sys-color-accent-cta-container: #FFDDBA; /* Example, derived */
            --md-sys-color-on-accent-cta-container: #381E00; /* Example, derived */
            --md-sys-color-background: #F8F9FA; /* Neutral N99 (Light Mode Background) */
            --md-sys-color-on-background: #1F1F1F; /* Neutral N10 (Default text on Background) */
            --md-sys-color-surface: #FFFFFF; /* Neutral N98 (Card backgrounds, sheet backgrounds) */
            --md-sys-color-on-surface: #1F1F1F; /* Neutral N10 (Default text on Surface) */
            --md-sys-color-surface-variant: #E1E3E5; /* Neutral Variant N90 (e.g. for dividers, outlines) */
            --md-sys-color-on-surface-variant: #444746; /* Neutral Variant N30 (Lower emphasis text) */
            --md-sys-color-outline: #747775; /* Neutral Variant N50 */
            --md-sys-color-error: #D93025; /* Error P40 */
            --md-sys-color-on-error: #FFFFFF;
            --md-sys-color-error-container: #FAD2CF; /* Example, derived */
            --md-sys-color-on-error-container: #410001; /* Example, derived */
            --md-sys-color-success-container: #C8E6C9; /* Custom for success messages */
            --md-sys-color-on-success-container: #0D3C1E; /* Custom for success messages */


            /* M3 Typography */
            --md-sys-font-family-name: 'Roboto', sans-serif;
            /* Body Large (Main content text) */
            --md-sys-typescale-body-large-font-family-name: var(--md-sys-font-family-name);
            --md-sys-typescale-body-large-font-weight: 400; /* Regular */
            --md-sys-typescale-body-large-font-size: 16px; /* 1rem based on 16px root */
            --md-sys-typescale-body-large-line-height: 24px; /* 1.5rem */
            --md-sys-typescale-body-large-letter-spacing: 0.5px;
            /* Title Medium (List item titles, smaller card titles) */
            --md-sys-typescale-title-medium-font-family-name: var(--md-sys-font-family-name);
            --md-sys-typescale-title-medium-font-weight: 500; /* Medium */
            --md-sys-typescale-title-medium-font-size: 16px;
            --md-sys-typescale-title-medium-line-height: 24px;
            --md-sys-typescale-title-medium-letter-spacing: 0.15px;
            /* Label Large (Button text) */
            --md-sys-typescale-label-large-font-family-name: var(--md-sys-font-family-name);
            --md-sys-typescale-label-large-font-weight: 500; /* Medium */
            --md-sys-typescale-label-large-font-size: 14px;
            --md-sys-typescale-label-large-line-height: 20px;
            --md-sys-typescale-label-large-letter-spacing: 0.1px;
            /* Headline Small (Sub-headings) */
            --md-sys-typescale-headline-small-font-family-name: var(--md-sys-font-family-name);
            --md-sys-typescale-headline-small-font-weight: 400; /* Regular */
            --md-sys-typescale-headline-small-font-size: 24px;
            --md-sys-typescale-headline-small-line-height: 32px;
             /* Body Small (Helper/error text) */
            --md-sys-typescale-body-small-font-family-name: var(--md-sys-font-family-name);
            --md-sys-typescale-body-small-font-weight: 400;
            --md-sys-typescale-body-small-font-size: 12px;
            --md-sys-typescale-body-small-line-height: 16px;


            /* M3 Spacing (Base unit: 8dp, using rem based on 16px root: 8px = 0.5rem) */
            --md-sys-spacing-unit: 0.5rem; /* 8px */
            --md-sys-spacing-xxs: 0.25rem; /* 4px (0.5 * unit) */
            --md-sys-spacing-xs: 0.5rem;  /* 8px (1 * unit) */
            --md-sys-spacing-s: 0.75rem;   /* 12px (1.5 * unit) */
            --md-sys-spacing-m: 1rem;     /* 16px (2 * unit) */
            --md-sys-spacing-l: 1.5rem;   /* 24px (3 * unit) */
            --md-sys-spacing-xl: 2rem;    /* 32px (4 * unit) */
            --md-sys-spacing-xxl: 3rem;   /* 48px (6 * unit) */
            
            /* M3 Shape */
            --md-sys-shape-corner-extra-small: 0.25rem; /* 4dp */
            --md-sys-shape-corner-small: 0.5rem; /* 8dp */
            --md-sys-shape-corner-medium: 0.75rem; /* 12dp (M3 Card default is more like 12dp) */
            --md-sys-shape-corner-large: 1rem;    /* 16dp */
            --md-sys-shape-corner-extra-large: 1.75rem; /* 28dp */
            --md-sys-shape-corner-full: 9999px; /* Pill shape */
            
            /* M3 Shadows (Examples - TailwindCSS provides utility classes that can be mapped) */
            --md-sys-elevation-level0: none;
            --md-sys-elevation-level1: 0px 1px 2px rgba(0,0,0,0.3), 0px 1px 3px 1px rgba(0,0,0,0.15); /* M3 Level 1 */
            --md-sys-elevation-level2: 0px 1px 2px rgba(0,0,0,0.3), 0px 2px 6px 2px rgba(0,0,0,0.15); /* M3 Level 2 */
            --md-sys-elevation-level3: 0px 4px 8px 3px rgba(0,0,0,0.3), 0px 1px 3px rgba(0,0,0,0.15); /* M3 Level 3 */

            
            /* Transitions */
            --md-sys-motion-duration-short: 100ms;
            --md-sys-motion-duration-medium: 250ms;
            --md-sys-motion-easing-standard: cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        body {
            font-family: var(--md-sys-font-family-name);
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-background);
            line-height: var(--md-sys-typescale-body-large-line-height);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Auth Container Styles - M3 Inspired */
        .auth-container {
            background-color: var(--md-sys-color-surface);
            border-radius: var(--md-sys-shape-corner-large); /* More pronounced rounding */
            box-shadow: var(--md-sys-elevation-level2);
            padding: var(--md-sys-spacing-xl); /* 32px */
            width: 100%;
            max-width: 480px;
            text-align: center;
            margin: var(--md-sys-spacing-xl) auto;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .dashboard-wrapper {
            background-color: var(--md-sys-color-background);
            width: 100%;
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        .logo {
            max-width: 154px; 
            margin: 0 auto var(--md-sys-spacing-l) auto; /* 24px bottom margin */
            transition: transform var(--md-sys-motion-duration-medium) var(--md-sys-motion-easing-standard);
        }
        .logo:hover { transform: scale(1.05); }

        /* Dashboard Header - M3 Surface with Elevation */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--md-sys-spacing-m) var(--md-sys-spacing-l); /* 16px 24px */
            background-color: var(--md-sys-color-surface); 
            box-shadow: var(--md-sys-elevation-level1); /* Subtle shadow for header */
            position: sticky;
            top: 0;
            z-index: 1000; /* Ensure header is on top */
        }
        .dashboard-header .logo-small { max-width: 132px; }
        .settings-icon span { color: var(--md-sys-color-on-surface-variant); transition: color var(--md-sys-motion-duration-short) var(--md-sys-motion-easing-standard); }
        .settings-icon:hover span { color: var(--md-sys-color-primary); }

        /* Main Navigation - M3 Surface with Active Indicator */
        .main-nav {
            display: flex;
            justify-content: center;
            background-color: var(--md-sys-color-surface);
            padding: var(--md-sys-spacing-xxs) 0; 
            box-shadow: var(--md-sys-elevation-level1);
            position: sticky;
            top: 68px; /* Approx height of dashboard-header (adjust if header height changes) */
            z-index: 999; /* Below header, above content */
            overflow-x: auto; /* For smaller screens */
        }

        .nav-tab {
            padding: var(--md-sys-spacing-s) var(--md-sys-spacing-l); 
            margin: 0 var(--md-sys-spacing-xs); 
            cursor: pointer;
            font-family: var(--md-sys-typescale-label-large-font-family-name);
            font-weight: var(--md-sys-font-weight-medium); /* M3 Label Large uses medium weight */
            font-size: var(--md-sys-typescale-label-large-font-size);
            color: var(--md-sys-color-on-surface-variant); /* Lower emphasis for inactive tabs */
            border-bottom: 2px solid transparent;
            transition: color var(--md-sys-motion-duration-short) var(--md-sys-motion-easing-standard), 
                        border-color var(--md-sys-motion-duration-short) var(--md-sys-motion-easing-standard),
                        background-color var(--md-sys-motion-duration-short) var(--md-sys-motion-easing-standard);
            border-radius: var(--md-sys-shape-corner-small) var(--md-sys-shape-corner-small) 0 0;
            position: relative;
            user-select: none;
            text-decoration: none;
            display: inline-flex; /* To align icon and text */
            align-items: center;
            gap: var(--md-sys-spacing-xs); /* Space between icon and text */
        }
        .nav-tab:hover {
            color: var(--md-sys-color-primary);
            background-color: color-mix(in srgb, var(--md-sys-color-primary) 8%, transparent); /* Subtle hover bg */
        }
        .nav-tab.active {
            color: var(--md-sys-color-primary);
            border-bottom-color: var(--md-sys-color-primary); /* M3 active tab indicator */
        }
        .nav-tab.active::after { /* Remove if direct border-bottom is preferred */
           content: none;
        }
        .nav-tab-disabled {
            color: var(--md-sys-color-on-surface-variant);
            opacity: 0.38; /* M3 disabled state opacity */
            cursor: not-allowed;
        }
        .nav-tab-disabled .coming-soon-inline {
            font-size: 0.65rem;
            color: var(--md-sys-color-on-surface-variant);
            margin-left: var(--md-sys-spacing-xxs);
            background-color: var(--md-sys-color-surface-variant);
            padding: 0.1rem 0.4rem;
            border-radius: var(--md-sys-shape-corner-full);
        }

        /* Dashboard Content Area */
        .dashboard-content-area {
            padding: var(--md-sys-spacing-l); /* 24px */
            flex-grow: 1;
            background-color: var(--md-sys-color-background);
            overflow-y: auto;
        }

        /* Auth Form Inputs - M3 Text Fields */
        .auth-input { /* Generic class for all auth inputs */
            width: 100%;
            padding-top: var(--md-sys-spacing-m); 
            padding-bottom: var(--md-sys-spacing-m);
            padding-right: var(--md-sys-spacing-m); 
            padding-left: var(--md-sys-spacing-xl); /* Space for icon */
            margin-bottom: var(--md-sys-spacing-m); 
            border: 1px solid var(--md-sys-color-outline);
            border-radius: var(--md-sys-shape-corner-extra-small); /* M3 Text Field uses 4dp corners */
            box-sizing: border-box;
            font-size: var(--md-sys-typescale-body-large-font-size);
            background-color: color-mix(in srgb, var(--md-sys-color-primary) 4%, var(--md-sys-color-surface)); /* M3 Filled text field subtle bg */
            color: var(--md-sys-color-on-surface);
            transition: background-color var(--md-sys-motion-duration-short) var(--md-sys-motion-easing-standard), 
                        border-color var(--md-sys-motion-duration-short) var(--md-sys-motion-easing-standard);
        }
        .auth-input:focus {
            outline: none;
            border-color: var(--md-sys-color-primary); /* Focus border to primary */
            border-width: 2px; /* M3 focus indicator often a thicker line */
            padding-bottom: calc(var(--md-sys-spacing-m) - 1px); /* Adjust padding to maintain height with thicker border */
            background-color: color-mix(in srgb, var(--md-sys-color-primary) 8%, var(--md-sys-color-surface));
        }
        .auth-input-icon { 
            position: absolute;
            inset-y: 0;
            left: var(--md-sys-spacing-s); /* 12px */
            display: flex;
            align-items: center;
            color: var(--md-sys-color-on-surface-variant);
            pointer-events: none;
        }
        
        /* Buttons - M3 Filled Button (Primary) & M3 Outlined/Text Button (Secondary) */
        .btn {
            display: inline-flex; 
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: var(--md-sys-spacing-s) var(--md-sys-spacing-l); /* M3 Button typical padding for height ~40dp */
            border: none;
            border-radius: var(--md-sys-shape-corner-full); /* Pill shape for M3 buttons */
            cursor: pointer;
            font-family: var(--md-sys-typescale-label-large-font-family-name);
            font-weight: var(--md-sys-font-weight-medium);
            font-size: var(--md-sys-typescale-label-large-font-size);
            transition: background-color var(--md-sys-motion-duration-short) var(--md-sys-motion-easing-standard), 
                        box-shadow var(--md-sys-motion-duration-short) var(--md-sys-motion-easing-standard);
            text-align: center;
            box-shadow: var(--md-sys-elevation-level0); /* No shadow for resting state */
            position: relative;
            overflow: hidden; /* For ripple effect if added */
            gap: var(--md-sys-spacing-xs);
        }
        .btn:hover { box-shadow: var(--md-sys-elevation-level1); } 
        .btn:active { box-shadow: var(--md-sys-elevation-level0); } 

        .btn-primary {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
        }
        .btn-primary:hover { background-color: color-mix(in srgb, var(--md-sys-color-primary) 92%, black); } 

        .btn-google { /* M3 Outlined Button style */
            background-color: transparent;
            color: var(--md-sys-color-primary);
            border: 1px solid var(--md-sys-color-outline);
        }
        .btn-google:hover { background-color: color-mix(in srgb, var(--md-sys-color-primary) 8%, transparent); }
        .btn-google img { width: 20px; height: 20px; /* margin-right handled by gap in .btn */ }

        .btn-logout { /* M3 Filled Button with Error color */
            background-color: var(--md-sys-color-error);
            color: var(--md-sys-color-on-error);
            padding: var(--md-sys-spacing-xs) var(--md-sys-spacing-m); 
            border-radius: var(--md-sys-shape-corner-full);
            font-family: var(--md-sys-typescale-label-large-font-family-name);
            font-weight: var(--md-sys-font-weight-medium);
            font-size: var(--md-sys-typescale-label-large-font-size);
            border: none;
            display: inline-flex; align-items: center; gap: var(--md-sys-spacing-xs);
        }
        .btn-logout:hover { background-color: color-mix(in srgb, var(--md-sys-color-error) 92%, black); box-shadow: var(--md-sys-elevation-level1); }
        
        .auth-toggle-link {
            color: var(--md-sys-color-primary);
            cursor: pointer;
            text-decoration: none; /* M3 links often don't have underlines unless interactive state */
            font-family: var(--md-sys-typescale-label-large-font-family-name);
            font-weight: var(--md-sys-font-weight-medium);
        }
        .auth-toggle-link:hover { color: var(--md-sys-color-primary); text-decoration: underline; } /* Underline on hover */

        .error-message, .success-message { /* Updated for M3 */
            font-family: var(--md-sys-typescale-body-small-font-family-name);
            font-size: var(--md-sys-typescale-body-small-font-size);
            line-height: var(--md-sys-typescale-body-small-line-height);
            min-height: var(--md-sys-typescale-body-small-line-height);
            margin-top: var(--md-sys-spacing-xs); 
            padding: var(--md-sys-spacing-s) var(--md-sys-spacing-m);
            border-radius: var(--md-sys-shape-corner-extra-small);
            text-align: left;
            display: flex; align-items: center; gap: var(--md-sys-spacing-xs);
        }
        .error-message {
            background-color: var(--md-sys-color-error-container);
            color: var(--md-sys-color-on-error-container);
        }
        .success-message { /* Added for consistency if needed */
            background-color: var(--md-sys-color-success-container);
            color: var(--md-sys-color-on-success-container);
        }
        
        .divider {
            display: flex;
            align-items: center;
            margin: var(--md-sys-spacing-l) 0; 
            color: var(--md-sys-color-on-surface-variant);
            font-family: var(--md-sys-typescale-label-large-font-family-name);
            font-size: var(--md-sys-typescale-label-large-font-size);
        }
        .divider::before, .divider::after {
            content: ""; flex: 1; border-bottom: 1px solid var(--md-sys-color-outline);
        }
        .divider::before { margin-right: var(--md-sys-spacing-xs); }
        .divider::after { margin-left: var(--md-sys-spacing-xs); }

        .spinner {
            border: 3px solid color-mix(in srgb, currentColor 20%, transparent);
            border-radius: 50%;
            border-top-color: currentColor; 
            width: 18px; height: 18px; /* Slightly smaller for buttons */
            animation: spin 1s linear infinite;
            display: inline-block; /* margin-right handled by gap in .btn */
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Results specific styling */
        #results-content h1 {
            font-family: var(--md-sys-typescale-headline-small-font-family-name);
            font-size: var(--md-sys-typescale-headline-small-font-size);
            font-weight: var(--md-sys-font-weight-regular);
            color: var(--md-sys-color-primary);
            text-align:left;
        }
        #results-content > p { /* Description below heading */
             font-family: var(--md-sys-typescale-body-large-font-family-name);
             color: var(--md-sys-color-on-surface-variant);
             text-align:left;
             max-width: none; /* Remove max-width for better alignment */
             margin-left: 0; margin-right: 0;
        }

        #results-summary {
            background-color: var(--md-sys-color-surface);
            padding: var(--md-sys-spacing-l);
            border-radius: var(--md-sys-shape-corner-medium); /* M3 Card 12dp */
            box-shadow: var(--md-sys-elevation-level1);
            margin-bottom: var(--md-sys-spacing-l);
        }
         #results-summary h3 { /* If there's an H3 inside */
            font-family: var(--md-sys-typescale-title-large-font-family-name);
            font-size: var(--md-sys-typescale-title-large-font-size);
            color: var(--md-sys-color-on-surface);
            margin-bottom: var(--md-sys-spacing-m);
         }
        
        /* Accordion Styling */
        .section-accordion-item {
            background-color: var(--md-sys-color-surface); /* Main surface for accordion item */
            border: 1px solid var(--md-sys-color-outline);
            border-radius: var(--md-sys-shape-corner-medium); /* Consistent with cards */
            margin-bottom: var(--md-sys-spacing-s); /* Space between accordion items */
            box-shadow: var(--md-sys-elevation-level0); /* Optional subtle shadow, or level1 */
        }
        .section-accordion-header {
            background-color: transparent; /* Header takes surface from parent item */
            color: var(--md-sys-color-on-surface); /* Readable text on surface */
            padding: var(--md-sys-spacing-m); /* 16px padding */
            font-family: var(--md-sys-typescale-title-medium-font-family-name);
            font-weight: var(--md-sys-font-weight-medium);
            cursor: pointer;
            transition: background-color var(--md-sys-motion-duration-short) var(--md-sys-motion-easing-standard);
            width: 100%; display: flex; justify-content: space-between; align-items: center;
        }
        .section-accordion-header:hover {
            background-color: color-mix(in srgb, var(--md-sys-color-primary) 8%, transparent); /* Subtle hover */
        }
        .section-accordion-header .material-symbols-outlined {
            transition: transform var(--md-sys-motion-duration-short) var(--md-sys-motion-easing-standard);
            color: var(--md-sys-color-on-surface-variant);
        }
        .section-accordion-header .material-symbols-outlined.rotate-180 { /* JS will toggle this class */
            transform: rotate(180deg);
        }
        .section-accordion-content {
            background-color: var(--md-sys-color-surface); /* Content area uses surface */
            padding: var(--md-sys-spacing-m); /* Padding for content */
            border-top: 1px solid var(--md-sys-color-outline); /* Separator */
        }
        
        /* General table styling for results */
        #results-by-section-accordion table {
            width: 100%;
            border-collapse: collapse; /* Or separate with border-spacing: 0 */
        }
        #results-by-section-accordion th, #results-by-section-accordion td {
            padding: var(--md-sys-spacing-s) var(--md-sys-spacing-m); 
            text-align: left;
            border-bottom: 1px solid var(--md-sys-color-outline);
            font-family: var(--md-sys-typescale-body-medium-font-family-name);
            font-size: var(--md-sys-typescale-body-medium-font-size);
            color: var(--md-sys-color-on-surface);
        }
        #results-by-section-accordion th {
            font-family: var(--md-sys-typescale-label-large-font-family-name);
            font-weight: var(--md-sys-font-weight-medium);
            color: var(--md-sys-color-on-surface-variant);
            background-color: var(--md-sys-color-surface-variant); 
        }
        #results-by-section-accordion tbody tr:hover {
            background-color: color-mix(in srgb, var(--md-sys-color-primary) 4%, transparent); /* Subtle hover on rows */
        }
        #results-by-section-accordion tbody tr:last-child td {
            border-bottom: none; /* Remove border from last row */
        }
        .view-detail-button { /* Style as M3 Text Button */
            font-family: var(--md-sys-typescale-label-large-font-family-name);
            color: var(--md-sys-color-primary);
            background: none; border: none; padding: var(--md-sys-spacing-xs) var(--md-sys-spacing-s);
            border-radius: var(--md-sys-shape-corner-full);
            cursor: pointer;
            text-transform: none; /* Override Tailwind if it uppercases */
        }
        .view-detail-button:hover {
             background-color: color-mix(in srgb, var(--md-sys-color-primary) 8%, transparent);
        }

        /* Result Detail View */
        #result-detail {
             background-color: var(--md-sys-color-surface);
             padding: var(--md-sys-spacing-l);
             border-radius: var(--md-sys-shape-corner-large);
             box-shadow: var(--md-sys-elevation-level2); /* More prominent shadow for detail view */
             text-align: left;
        }
        #result-detail h3 {
            font-family: var(--md-sys-typescale-headline-small-font-family-name);
            color: var(--md-sys-color-primary);
            margin-bottom: var(--md-sys-spacing-m);
        }
        #result-detail p {
            font-family: var(--md-sys-typescale-body-large-font-family-name);
            color: var(--md-sys-color-on-surface);
            margin-bottom: var(--md-sys-spacing-s);
        }
        #result-detail p strong {
            font-weight: var(--md-sys-font-weight-medium);
            color: var(--md-sys-color-on-surface-variant);
        }
        #back-to-results-list { /* M3 Outlined button */
            background-color: transparent;
            color: var(--md-sys-color-primary);
            border: 1px solid var(--md-sys-color-outline);
            padding: var(--md-sys-spacing-s) var(--md-sys-spacing-l);
            border-radius: var(--md-sys-shape-corner-full);
            font-family: var(--md-sys-typescale-label-large-font-family-name);
            font-weight: var(--md-sys-font-weight-medium);
            margin-bottom: var(--md-sys-spacing-l);
            display: inline-flex; align-items: center; gap: var(--md-sys-spacing-xs);
        }
         #back-to-results-list:hover { background-color: color-mix(in srgb, var(--md-sys-color-primary) 8%, transparent); }
        
        /* Responsive Overrides */
        @media (max-width: 768px) {
            .main-nav { justify-content: flex-start; padding-left: var(--md-sys-spacing-xs); padding-right: var(--md-sys-spacing-xs); }
            .nav-tab { white-space: nowrap; margin: 0 var(--md-sys-spacing-xxs); padding: var(--md-sys-spacing-s) var(--md-sys-spacing-m); }
            .dashboard-content-area { padding: var(--md-sys-spacing-m); } 
            .auth-container { margin: var(--md-sys-spacing-m) auto; padding: var(--md-sys-spacing-l); }
        }
        @media (max-width: 480px) {
            .dashboard-header { padding: var(--md-sys-spacing-s) var(--md-sys-spacing-m); }
            .dashboard-header .logo-small { max-width: 100px; }
            .welcome-user { display: none; } /* Hide welcome on very small screens or make it wrap */
            .btn-logout { padding: var(--md-sys-spacing-xxs) var(--md-sys-spacing-s); font-size: var(--md-sys-typescale-label-large-font-size); }
            .nav-tab { padding: var(--md-sys-spacing-s) var(--md-sys-spacing-s); }
            #results-content h1 { font-size: var(--md-sys-typescale-title-large-font-size); }
            #results-by-section-accordion th, #results-by-section-accordion td { padding: var(--md-sys-spacing-s) var(--md-sys-spacing-xs); font-size: var(--md-sys-typescale-body-medium-font-size); }
        }
         /* Ensure hidden class is effective */
        .hidden { display: none !important; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Outlined" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <div id="auth-section" class="auth-container">
        <img src="https://ik.imagekit.io/mwp/MWP%20Color%20no%20background.png?updatedAt=1745982959141" alt="MedwithPurpose Logo" class="logo" onerror="this.style.display='none'; this.onerror=null;">
        
        <div id="login-form">
            <h2 style="font-family: var(--md-sys-typescale-headline-small-font-family-name); font-size: var(--md-sys-typescale-headline-small-font-size); color: var(--md-sys-color-on-surface); margin-bottom: var(--md-sys-spacing-s);">Welcome Back</h2>
            <p style="color: var(--md-sys-color-on-surface-variant); font-size: var(--md-sys-typescale-body-large-font-size); margin-bottom: var(--md-sys-spacing-l);">Log in to access your UCAT prep.</p>
            
            <div class="mb-4 relative">
                <span class="auth-input-icon material-symbols-outlined">mail</span>
                <input type="email" id="login-email" placeholder="Email Address" class="auth-input" aria-label="Email Address">
            </div>
            
            <div class="mb-6 relative">
                 <span class="auth-input-icon material-symbols-outlined">lock</span>
                <input type="password" id="login-password" placeholder="Password" class="auth-input" aria-label="Password">
            </div>
            
            <div style="text-align: right; margin-bottom: var(--md-sys-spacing-m);">
                <a href="#" id="forgot-password-link" class="auth-toggle-link">Forgot Password?</a>
            </div>
            
            <button id="login-button" class="btn btn-primary mb-4">
                <span id="login-spinner" class="spinner hidden"></span>
                <span class="material-symbols-outlined">login</span>
                <span>Login</span>
            </button>
            
            <div class="divider mb-4"><span>OR</span></div>
            
            <button id="google-login-button" class="btn btn-google mb-6">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon">
                <span>Sign in with Google</span>
            </button>
            
            <p style="font-size: var(--md-sys-typescale-body-medium-font-size); color: var(--md-sys-color-on-surface-variant);">Don't have an account? <a href="#" id="show-signup-link" class="auth-toggle-link">Create Account</a></p>
            <p id="login-error" class="error-message text-center mt-3 hidden" aria-live="polite"></p>
        </div>

        <div id="signup-form" class="hidden">
            <h2 style="font-family: var(--md-sys-typescale-headline-small-font-family-name); font-size: var(--md-sys-typescale-headline-small-font-size); color: var(--md-sys-color-on-surface); margin-bottom: var(--md-sys-spacing-s);">Create Account</h2>
            <p style="color: var(--md-sys-color-on-surface-variant); font-size: var(--md-sys-typescale-body-large-font-size); margin-bottom: var(--md-sys-spacing-l);">Join thousands of students preparing for the UCAT.</p>
            
            <div class="mb-4 relative">
                <span class="auth-input-icon material-symbols-outlined">person</span>
                <input type="text" id="signup-name" placeholder="Full Name" class="auth-input" aria-label="Full Name">
            </div>
            
            <div class="mb-4 relative">
                <span class="auth-input-icon material-symbols-outlined">mail</span>
                <input type="email" id="signup-email" placeholder="Email Address" class="auth-input" aria-label="Email Address">
            </div>
            
            <div class="mb-6 relative">
                <span class="auth-input-icon material-symbols-outlined">lock</span>
                <input type="password" id="signup-password" placeholder="Password (min. 6 characters)" class="auth-input" aria-label="Password">
            </div>
            
            <button id="signup-button" class="btn btn-primary mb-4">
                <span id="signup-spinner" class="spinner hidden"></span>
                <span class="material-symbols-outlined">person_add</span>
                <span>Create Account</span>
            </button>
            
            <div class="divider mb-4"><span>OR</span></div>
            
            <button id="google-signup-button" class="btn btn-google mb-6">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon">
                <span>Sign up with Google</span>
            </button>
            
            <p style="font-size: var(--md-sys-typescale-body-medium-font-size); color: var(--md-sys-color-on-surface-variant);">Already have an account? <a href="#" id="show-login-link" class="auth-toggle-link">Login</a></p>
            <p id="signup-error" class="error-message text-center mt-3 hidden" aria-live="polite"></p>
        </div>
    </div>

    <div id="dashboard-wrapper" class="dashboard-wrapper hidden">
        <div class="dashboard-header">
            <a href="home.html">
                <img src="https://ik.imagekit.io/mwp/MWP%20Color%20no%20background.png?updatedAt=1745982959141" alt="MedwithPurpose Logo" class="logo-small" onerror="this.style.display='none'; this.onerror=null;">
            </a>
            <div class="flex items-center">
                <span class="welcome-user mr-4" style="font-family: var(--md-sys-typescale-body-medium-font-family-name); color: var(--md-sys-color-on-surface-variant);">Welcome, <span id="student-display-name" style="font-weight: var(--md-sys-font-weight-medium); color: var(--md-sys-color-on-surface);">Student</span></span>
                <a href="settings.html" aria-label="Account Settings" class="mr-4 settings-icon">
                     <span class="material-symbols-outlined">settings</span>
                </a>
                <button id="logout-button" class="btn-logout" aria-label="Logout">
                    <span class="material-symbols-outlined">logout</span>
                    <span>Logout</span>
                </button>
            </div>
        </div>

        <nav class="main-nav" role="navigation" aria-label="Main Navigation">
            <a href="home.html" id="nav-home" class="nav-tab" role="tab" aria-selected="false">
                <span class="material-symbols-outlined">home</span>Home
            </a>
            <a href="practice.html" id="nav-practice-main" class="nav-tab" role="tab" aria-selected="false">
                <span class="material-symbols-outlined">model_training</span>Practice
            </a>
             <a href="student_dashboard.html#results" id="nav-results" class="nav-tab" role="tab" aria-selected="true">
                 <span class="material-symbols-outlined">bar_chart</span>Results
             </a>
            <div id="nav-skills" class="nav-tab nav-tab-disabled" role="tab" aria-disabled="true">
                <span class="material-symbols-outlined">psychology</span>
                <span>Skills</span> <span class="coming-soon-inline">Soon</span>
            </div>
        </nav>

        <div id="dashboard-content-area" class="dashboard-content-area">
            <div id="results-content" class="max-w-5xl mx-auto"> <h1 class="text-left">Your Performance History</h1>
                <p class="text-left mb-8">Track your progress and identify areas for improvement.</p>
                
                <div id="results-loading" class="text-center py-8 hidden">
                    <div class="spinner mx-auto mb-4"></div>
                    <p style="color: var(--md-sys-color-on-surface-variant);">Loading your performance data...</p>
                </div>
                
                <div id="results-error" class="hidden text-center py-8 error-message">
                    <span class="material-symbols-outlined" style="font-size: 28px; color: var(--md-sys-color-error);">error</span>
                    <p>Unable to load your results. Please try again later or contact support.</p>
                    <button id="results-retry-button" class="btn btn-primary" style="width:auto; margin-top: var(--md-sys-spacing-m);">Try Again</button>
                </div>
                
                <div id="results-empty" class="hidden text-center py-8">
                    <span class="material-symbols-outlined" style="font-size: 48px; color: var(--md-sys-color-primary); margin-bottom: var(--md-sys-spacing-m);">folder_off</span>
                    <h3 style="font-family: var(--md-sys-typescale-title-large-font-family-name); color: var(--md-sys-color-on-surface); margin-bottom: var(--md-sys-spacing-s);">No test results found</h3>
                    <p style="color: var(--md-sys-color-on-surface-variant); margin-bottom: var(--md-sys-spacing-l);">Complete a practice test and submit your reflections to see your performance history here.</p>
                    <button id="go-to-tests-button" class="btn btn-primary" style="width:auto;">
                        <span class="material-symbols-outlined">model_training</span> Go to Practice
                    </button>
                </div>
                
                <div id="results-summary" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="info-card-results">
                            <span class="material-symbols-outlined">checklist</span>
                            <p class="metric-label">Tests Completed</p>
                            <p id="tests-completed" class="metric-value">0</p>
                        </div>
                        <div class="info-card-results">
                            <span class="material-symbols-outlined">leaderboard</span>
                            <p class="metric-label">Average Score</p>
                            <p id="average-score" class="metric-value">0%</p>
                        </div>
                         <div class="info-card-results">
                            <span class="material-symbols-outlined">emoji_events</span>
                            <p class="metric-label">Highest Score</p>
                            <p id="highest-score" class="metric-value">0%</p>
                        </div>
                        <div class="info-card-results">
                            <span class="material-symbols-outlined">timer</span>
                            <p class="metric-label">Hours Practiced</p>
                            <p id="hours-practiced" class="metric-value">0h 0m</p>
                        </div>
                    </div>
                    <style>
                        .info-card-results {
                            background-color: var(--md-sys-color-surface);
                            border-radius: var(--md-sys-shape-corner-medium);
                            padding: var(--md-sys-spacing-l);
                            text-align: center;
                            box-shadow: var(--md-sys-elevation-level1);
                        }
                        .info-card-results .material-symbols-outlined {
                            font-size: 32px;
                            color: var(--md-sys-color-primary);
                            margin-bottom: var(--md-sys-spacing-s);
                        }
                        .info-card-results .metric-label {
                            font-family: var(--md-sys-typescale-body-medium-font-family-name);
                            color: var(--md-sys-color-on-surface-variant);
                            margin-bottom: var(--md-sys-spacing-xxs);
                        }
                        .info-card-results .metric-value {
                            font-family: var(--md-sys-typescale-headline-small-font-family-name);
                            color: var(--md-sys-color-primary);
                            font-weight: var(--md-sys-font-weight-medium);
                        }
                    </style>
                    
                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-3 p-3" style="background-color: var(--md-sys-color-surface-variant); border-radius: var(--md-sys-shape-corner-medium);">
                        <h3 style="font-family: var(--md-sys-typescale-title-medium-font-family-name); color: var(--md-sys-color-on-surface-variant);">Recent Tests</h3>
                        <div class="flex gap-2 flex-wrap justify-center">
                            <select id="results-filter" class="auth-input" style="width: auto; min-width:150px; padding: var(--md-sys-spacing-s) var(--md-sys-spacing-m); margin-bottom:0;">
                                <option value="all">All Exams</option>
                            </select>
                            <select id="results-sort" class="auth-input" style="width: auto; min-width:150px; padding: var(--md-sys-spacing-s) var(--md-sys-spacing-m); margin-bottom:0;">
                                <option value="date-desc">Newest First</option>
                                <option value="date-asc">Oldest First</option>
                                <option value="score-desc">Highest Score</option>
                                <option value="score-asc">Lowest Score</option>
                            </select>
                            <button id="refresh-results-button" class="btn btn-primary" style="width:auto;">
                                <span class="material-symbols-outlined">refresh</span> Refresh
                            </button>
                        </div>
                    </div>
                    
                    <div id="results-by-section-accordion" class="space-y-3">
                        </div>
                </div>
                
                <div id="result-detail" class="hidden mt-6">
                    <button id="back-to-results-list" class="btn btn-outlined mb-6" style="width:auto;">
                        <span class="material-symbols-outlined">arrow_back</span> Back to Results List
                    </button>
                    <h3 id="detail-test-name">Test Name</h3>
                    <p><strong>Date:</strong> <span id="detail-test-date"></span></p>
                    <p><strong>Score:</strong> <span id="detail-score"></span></p>
                    <p><strong>Time Taken:</strong> <span id="detail-time"></span></p>
                    <p><strong>Focus Rating:</strong> <span id="detail-focus"></span></p>
                    <p><strong>Reflection:</strong></p>
                    <div id="detail-reflection" style="background-color: var(--md-sys-color-surface-variant); padding: var(--md-sys-spacing-m); border-radius: var(--md-sys-shape-corner-small); color: var(--md-sys-color-on-surface-variant);"></div>
                    </div>
            </div>
            
            <div id="default-dashboard-message" class="hidden"> <p>Welcome to your dashboard. Select a section to get started.</p>
            </div>

        </div>
    </div>

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyASKsaFFTZ-finv2d5egR9K_mZNstEwdns",
          authDomain: "mwp-qr-test-page.firebaseapp.com",
          projectId: "mwp-qr-test-page",
          storageBucket: "mwp-qr-test-page.appspot.com",
          messagingSenderId: "309084045110",
          appId: "1:309084045110:web:b09ca0fdff84b094963d97",
          measurementId: "G-4M3ED641M9"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();

        // DOM Elements
        const authSection = document.getElementById('auth-section');
        const dashboardWrapper = document.getElementById('dashboard-wrapper');
        const loginFormEl = document.getElementById('login-form'); 
        const signupFormEl = document.getElementById('signup-form'); 
        
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const loginButton = document.getElementById('login-button');
        const loginSpinner = document.getElementById('login-spinner');
        const googleLoginButton = document.getElementById('google-login-button');
        const loginErrorP = document.getElementById('login-error');
        const showSignupLink = document.getElementById('show-signup-link');
        const forgotPasswordLink = document.getElementById('forgot-password-link');

        const signupNameInput = document.getElementById('signup-name');
        const signupEmailInput = document.getElementById('signup-email');
        const signupPasswordInput = document.getElementById('signup-password');
        const signupButton = document.getElementById('signup-button');
        const signupSpinner = document.getElementById('signup-spinner');
        const googleSignupButton = document.getElementById('google-signup-button');
        const signupErrorP = document.getElementById('signup-error');
        const showLoginLink = document.getElementById('show-login-link');

        const studentDisplayNameHeader = document.getElementById('student-display-name');
        const logoutButton = document.getElementById('logout-button');

        const navHome = document.getElementById('nav-home');
        const navPracticeMain = document.getElementById('nav-practice-main');
        const navResults = document.getElementById('nav-results');
        const navSkills = document.getElementById('nav-skills');
        const allNavTabs = document.querySelectorAll('.nav-tab');

        const resultsContent = document.getElementById('results-content');
        const defaultDashboardMessage = document.getElementById('default-dashboard-message');
        const resultsLoading = document.getElementById('results-loading');
        const resultsError = document.getElementById('results-error');
        const resultsEmpty = document.getElementById('results-empty');
        const resultsSummary = document.getElementById('results-summary');
        const resultsBySectionAccordion = document.getElementById('results-by-section-accordion');
        const resultDetailView = document.getElementById('result-detail');
        const backToResultsListButton = document.getElementById('back-to-results-list');
        const resultsFilterSelect = document.getElementById('results-filter');
        const resultsSortSelect = document.getElementById('results-sort');
        const refreshResultsButton = document.getElementById('refresh-results-button');
        const goToTestsButton = document.getElementById('go-to-tests-button');


        let allUserResults = []; 
        let uniqueExamNames = new Set();

        // --- UI Helpers ---
        function setButtonLoadingState(button, spinner, isLoading) {
            if (!button || !spinner) return;
            button.disabled = isLoading;
            spinner.classList.toggle('hidden', !isLoading);
            button.classList.toggle('opacity-70', isLoading); 
        }

        function showAuthMessage(element, text, isError = true) {
            if(!element) return;
            element.textContent = text; // Keep simple text content
            element.classList.remove('hidden', 'success-message', 'error-message');
            element.classList.add(isError ? 'error-message' : 'success-message');
            
            // Optionally, add an icon if you want, but for simplicity this is removed
            // const iconType = isError ? 'error' : 'check_circle';
            // element.innerHTML = `<span class="material-symbols-outlined" style="margin-right: 8px;">${iconType}</span> ${text}`;
        }
        
        function toggleAuthForms(showSignup) {
            loginFormEl.classList.toggle('hidden', showSignup);
            signupFormEl.classList.toggle('hidden', !showSignup);
            loginEmailInput.value = ''; loginPasswordInput.value = '';
            signupNameInput.value = ''; signupEmailInput.value = ''; signupPasswordInput.value = '';
            loginErrorP.classList.add('hidden'); signupErrorP.classList.add('hidden');
        }

        showSignupLink.addEventListener('click', (e) => { e.preventDefault(); toggleAuthForms(true); });
        showLoginLink.addEventListener('click', (e) => { e.preventDefault(); toggleAuthForms(false); });

        // --- Authentication Logic ---
        signupButton.addEventListener('click', () => {
            const name = signupNameInput.value.trim();
            const email = signupEmailInput.value.trim();
            const password = signupPasswordInput.value;
            if (!name) { showAuthMessage(signupErrorP, 'Please enter your name.'); return; }
            if (!email || !/\S+@\S+\.\S+/.test(email)) { showAuthMessage(signupErrorP, 'Please enter a valid email.'); return; }
            if (password.length < 6) { showAuthMessage(signupErrorP, 'Password must be at least 6 characters.'); return; }

            setButtonLoadingState(signupButton, signupSpinner, true);
            auth.createUserWithEmailAndPassword(email, password)
                .then(userCredential => userCredential.user.updateProfile({ displayName: name }))
                .then(() => db.collection("users").doc(auth.currentUser.uid).set({ displayName: name, email: email, createdAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true }))
                .catch(error => showAuthMessage(signupErrorP, error.message))
                .finally(() => setButtonLoadingState(signupButton, signupSpinner, false));
        });

        loginButton.addEventListener('click', () => {
            const email = loginEmailInput.value.trim();
            const password = loginPasswordInput.value;
            if (!email || !password) { showAuthMessage(loginErrorP, 'Please enter email and password.'); return; }
            setButtonLoadingState(loginButton, loginSpinner, true);
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => showAuthMessage(loginErrorP, error.message))
                .finally(() => setButtonLoadingState(loginButton, loginSpinner, false));
        });

        function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            setButtonLoadingState(googleLoginButton, loginSpinner, true); 
            auth.signInWithPopup(provider)
                .then(result => {
                    const user = result.user;
                    return db.collection("users").doc(user.uid).set({ displayName: user.displayName, email: user.email, createdAt: firebase.firestore.FieldValue.serverTimestamp(), provider: 'google.com' }, { merge: true });
                })
                .catch(error => showAuthMessage(loginErrorP, error.message))
                .finally(() => setButtonLoadingState(googleLoginButton, loginSpinner, false));
        }
        googleLoginButton.addEventListener('click', signInWithGoogle);
        googleSignupButton.addEventListener('click', signInWithGoogle);

        forgotPasswordLink.addEventListener('click', (e) => {
            e.preventDefault();
            const email = loginEmailInput.value.trim();
            if (!email) { showAuthMessage(loginErrorP, 'Please enter your email to reset password.'); return; }
            auth.sendPasswordResetEmail(email)
                .then(() => showAuthMessage(loginErrorP, 'Password reset email sent!', false))
                .catch(error => showAuthMessage(loginErrorP, error.message));
        });

        logoutButton.addEventListener('click', () => {
            if (confirm("Are you sure you want to log out?")) {
                auth.signOut();
            }
        });
        
        auth.onAuthStateChanged(user => {
            const pageJustLoaded = !dashboardWrapper.classList.contains('hidden') && authSection.classList.contains('hidden');
            if (user) {
                studentDisplayNameHeader.textContent = user.displayName || user.email;
                authSection.classList.add('hidden');
                dashboardWrapper.classList.remove('hidden');
                
                if (window.location.pathname.includes('student_dashboard.html')) {
                    const hash = window.location.hash;
                     if (hash === '#results' || (!hash && pageJustLoaded)) { 
                        showContentSection('results');
                        setActiveTab(navResults);
                        loadUserResults(user.uid);
                    } else if (hash) { 
                        const targetSection = hash.substring(1);
                        const targetNav = document.getElementById(`nav-${targetSection.split('-')[0]}`); 
                        showContentSection(targetSection);
                        if (targetNav) setActiveTab(targetNav);
                        else setActiveTab(navResults); 
                    } else { 
                         showContentSection('results');
                         setActiveTab(navResults);
                         loadUserResults(user.uid);
                    }
                }
            } else {
                authSection.classList.remove('hidden');
                dashboardWrapper.classList.add('hidden');
            }
        });

        // --- Content Display ---
        function showContentSection(contentIdSuffix) { // contentIdSuffix e.g., "results"
            [resultsContent, defaultDashboardMessage].forEach(el => {
                if(el) el.classList.add('hidden');
            });
            const sectionToShow = document.getElementById(contentIdSuffix + '-content') || document.getElementById(contentIdSuffix); // try with and without -content
            if (sectionToShow) {
                sectionToShow.classList.remove('hidden');
            } else {
                if(defaultDashboardMessage) defaultDashboardMessage.classList.remove('hidden'); 
            }
        }
        
        function setActiveTab(selectedTabEl) {
            allNavTabs.forEach(tab => tab.classList.remove('active'));
            if (selectedTabEl && !selectedTabEl.classList.contains('nav-tab-disabled')) {
                selectedTabEl.classList.add('active');
            }
        }

        navHome.addEventListener('click', (e) => { e.preventDefault(); window.location.href = 'home.html'; });
        navPracticeMain.addEventListener('click', (e) => { e.preventDefault(); window.location.href = 'practice.html'; });
        navResults.addEventListener('click', (e) => {
            e.preventDefault();
            showContentSection('results'); 
            setActiveTab(navResults);
            if (auth.currentUser) loadUserResults(auth.currentUser.uid);
            window.history.pushState({}, "", "#results");
        });
        navSkills.addEventListener('click', (e) => { e.preventDefault(); /* show coming soon or navigate if implemented */ });


        // --- Results Logic ---
        function getSectionFromExamName(examName) {
            const nameLower = examName ? examName.toLowerCase() : '';
            if (nameLower.includes('qr') || nameLower.includes('quantitative')) return 'qr';
            if (nameLower.includes('dm') || nameLower.includes('decision') || nameLower.includes('syllogism')) return 'dm';
            if (nameLower.includes('vr') || nameLower.includes('verbal')) return 'vr';
            return 'other';
        }
        
        async function loadUserResults(userId) {
            if (!db) { console.error("Firestore not initialized."); resultsLoading.classList.add('hidden'); resultsError.classList.remove('hidden'); return; }
            if (!userId) { console.error("No user ID provided for loading results."); resultsLoading.classList.add('hidden'); resultsError.classList.remove('hidden'); return; }

            resultsLoading.classList.remove('hidden');
            resultsError.classList.add('hidden');
            resultsSummary.classList.add('hidden'); 
            resultsBySectionAccordion.innerHTML = ''; 
            resultsEmpty.classList.add('hidden');
            
            try {
                const querySnapshot = await db.collection("performanceSubmissions")
                                          .where("userId", "==", userId)
                                          .orderBy("submissionTimestamp", "desc")
                                          .get();
                allUserResults = querySnapshot.docs.map(doc => ({
                    id: doc.id, 
                    ...doc.data(), 
                    date: doc.data().submissionTimestamp?.toDate ? doc.data().submissionTimestamp.toDate() : new Date(0) 
                }));
                
                if (allUserResults.length === 0) {
                    resultsEmpty.classList.remove('hidden');
                } else {
                    populateExamFilterOptions();
                    applyResultsFiltersAndSort(); 
                    resultsSummary.classList.remove('hidden'); 
                    updateOverallResultsSummary(allUserResults); 
                }
            } catch (error) {
                console.error("Error loading results: ", error);
                resultsError.classList.remove('hidden');
            } finally {
                resultsLoading.classList.add('hidden');
            }
        }

        function populateExamFilterOptions() {
            uniqueExamNames.clear();
            allUserResults.forEach(result => {
                if (result.examName) uniqueExamNames.add(result.examName);
            });
            resultsFilterSelect.innerHTML = '<option value="all">All Exams</option>';
            [...uniqueExamNames].sort().forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                resultsFilterSelect.appendChild(option);
            });
        }
        
        function applyResultsFiltersAndSort() {
            let filtered = [...allUserResults];
            const filterValue = resultsFilterSelect.value;
            if (filterValue !== 'all') {
                filtered = filtered.filter(r => r.examName === filterValue);
            }

            const sortValue = resultsSortSelect.value;
            filtered.sort((a, b) => {
                const dateA = a.date;
                const dateB = b.date;
                const scoreA = (parseFloat(a.score) / parseFloat(a.totalPossibleScore || a.totalQuestions || 1)) * 100 || 0;
                const scoreB = (parseFloat(b.score) / parseFloat(b.totalPossibleScore || b.totalQuestions || 1)) * 100 || 0;

                switch(sortValue) {
                    case 'date-asc': return dateA - dateB;
                    case 'score-desc': return scoreB - scoreA;
                    case 'score-asc': return scoreA - scoreB;
                    case 'date-desc': default: return dateB - dateA;
                }
            });
            renderResults(filtered);
        }

        function renderResults(resultsToDisplay) {
            resultsBySectionAccordion.innerHTML = ''; 
            const categorized = { qr: [], dm: [], vr: [], other: [] };
            resultsToDisplay.forEach(r => {
                const section = getSectionFromExamName(r.examName);
                categorized[section].push(r);
            });

            const sectionTitles = { qr: 'Quantitative Reasoning', dm: 'Decision Making', vr: 'Verbal Reasoning', other: 'Other Tests' };
            Object.keys(categorized).forEach(sectionKey => {
                if (categorized[sectionKey].length > 0) {
                    const accordionItem = createAccordionItem(sectionTitles[sectionKey], sectionKey, categorized[sectionKey]);
                    resultsBySectionAccordion.appendChild(accordionItem);
                }
            });
            if(resultsBySectionAccordion.innerHTML === ''){ 
                 resultsEmpty.classList.remove('hidden');
                 resultsSummary.classList.add('hidden'); 
            } else {
                 resultsEmpty.classList.add('hidden');
            }
        }

        function createAccordionItem(title, sectionKey, items) {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'section-accordion-item';

            const headerButton = document.createElement('button');
            headerButton.className = 'section-accordion-header';
            headerButton.innerHTML = `
                <span>${title}</span>
                <span class="material-symbols-outlined">expand_more</span>
            `;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'section-accordion-content hidden'; 
            contentDiv.id = `content-${sectionKey}`;

            const table = document.createElement('table');
            table.innerHTML = `
                <thead><tr>
                    <th>Date</th><th>Test</th><th>Score</th><th>Time Taken</th><th>Focus</th><th>Actions</th>
                </tr></thead>
                <tbody></tbody>
            `;
            const tbody = table.querySelector('tbody');
            items.forEach(item => {
                const row = tbody.insertRow();
                const scoreDisplay = `${item.score || 0}/${item.totalPossibleScore || item.totalQuestions || '-'}`;
                row.innerHTML = `
                    <td>${item.date.toLocaleDateString()}</td>
                    <td>${item.examName}</td>
                    <td>${scoreDisplay}</td>
                    <td>${item.timeTaken || '-'}</td>
                    <td>${item.focusRating || '-'}/5</td>
                    <td><button class="view-detail-button" data-result-id="${item.id}">View</button></td>
                `;
                row.querySelector('.view-detail-button').addEventListener('click', (e) => {
                     const result = allUserResults.find(r => r.id === e.target.dataset.resultId);
                     if(result) showResultDetail(result);
                });
            });
            contentDiv.appendChild(table);
            
            headerButton.addEventListener('click', () => {
                contentDiv.classList.toggle('hidden');
                headerButton.querySelector('.material-symbols-outlined').classList.toggle('rotate-180');
            });

            itemDiv.appendChild(headerButton);
            itemDiv.appendChild(contentDiv);
            return itemDiv;
        }
        
        function showResultDetail(result) {
            resultsContent.classList.add('hidden'); 
            resultDetailView.classList.remove('hidden'); 
            
            document.getElementById('detail-test-name').textContent = result.examName || 'N/A';
            document.getElementById('detail-test-date').textContent = result.date ? result.date.toLocaleString() : 'N/A';
            document.getElementById('detail-score').textContent = `${result.score || 0}/${result.totalPossibleScore || result.totalQuestions || '-'}`;
            document.getElementById('detail-time').textContent = result.timeTaken || 'N/A';
            document.getElementById('detail-focus').textContent = `${result.focusRating || '-'}/5`;
            document.getElementById('detail-reflection').textContent = result.reflection || 'No reflection provided.';
        }

        function updateOverallResultsSummary(allResults) { 
            const testsCompletedEl = document.getElementById('tests-completed');
            const averageScoreEl = document.getElementById('average-score');
            const highestScoreEl = document.getElementById('highest-score');
            const hoursPracticedEl = document.getElementById('hours-practiced');

            if (!testsCompletedEl || !averageScoreEl || !highestScoreEl || !hoursPracticedEl) return;

            const numTests = allResults.length;
            let totalPercentageSum = 0;
            let maxPercentage = 0;
            let totalMinutes = 0;

            allResults.forEach(result => {
                const score = parseFloat(result.score);
                const totalPossible = parseFloat(result.totalPossibleScore || result.totalQuestions);
                if (!isNaN(score) && !isNaN(totalPossible) && totalPossible > 0) {
                    const percentage = (score / totalPossible) * 100;
                    totalPercentageSum += percentage;
                    maxPercentage = Math.max(maxPercentage, percentage);
                }
                const timeTaken = result.timeTaken; 
                if (timeTaken) {
                    const minMatch = timeTaken.match(/(\d+)\s*min/);
                    const secMatch = timeTaken.match(/(\d+)\s*sec/);
                    if (minMatch) totalMinutes += parseInt(minMatch[1]);
                    if (secMatch) totalMinutes += parseInt(secMatch[1]) / 60; 
                }
            });

            testsCompletedEl.textContent = numTests;
            averageScoreEl.textContent = numTests > 0 ? (totalPercentageSum / numTests).toFixed(1) + '%' : '0%';
            highestScoreEl.textContent = maxPercentage.toFixed(1) + '%';
            hoursPracticedEl.textContent = (totalMinutes / 60).toFixed(1) + 'h';
        }
        
        backToResultsListButton.addEventListener('click', () => {
            resultDetailView.classList.add('hidden');
            resultsContent.classList.remove('hidden');
            if (auth.currentUser) loadUserResults(auth.currentUser.uid); 
        });

        resultsFilterSelect.addEventListener('change', applyResultsFiltersAndSort);
        resultsSortSelect.addEventListener('change', applyResultsFiltersAndSort);
        if(refreshResultsButton) refreshResultsButton.addEventListener('click', () => { if (auth.currentUser) loadUserResults(auth.currentUser.uid); });
        if(goToTestsButton) goToTestsButton.addEventListener('click', () => window.location.href = 'practice.html');


        // --- Initial DOMContentLoaded Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            if (window.location.pathname.includes('student_dashboard.html')) {
                const hash = window.location.hash;
                 if (hash === '#results') {
                    showContentSection('results');
                    setActiveTab(navResults);
                    if (auth.currentUser) loadUserResults(auth.currentUser.uid);
                } else {
                     if(auth.currentUser && resultsContent.classList.contains('hidden') && resultDetailView.classList.contains('hidden')) {
                        showContentSection('results');
                        setActiveTab(navResults);
                        loadUserResults(auth.currentUser.uid);
                    } else if (!auth.currentUser) {
                        // Auth section should be visible via onAuthStateChanged
                    } else if (resultsContent.classList.contains('hidden') && resultDetailView.classList.contains('hidden')) {
                        if(defaultDashboardMessage) defaultDashboardMessage.classList.remove('hidden');
                    }
                }
            }
        });
    </script>
</body>
</html>