<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - UCAT Platform</title>
    <link rel="icon" href="https://ik.imagekit.io/mwp/2.svg?updatedAt=1745982956185" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="m3_styles.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Outlined" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Flex:opsz,wght@8..144,100..1000&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* Existing styles from the original file are now refined or replaced by m3_styles.css */
        /* Any page-specific overrides can go here if m3_styles.css is not sufficient */
        body {
            font-family: var(--md-sys-typescale-font-family-name); /* Ensure M3 font is applied */
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-background);
            display: flex;
            justify-content: center; /* Center auth form initially */
            align-items: flex-start; /* Align dashboard to top when visible */
            min-height: 100vh;
            padding: 0; /* Reset padding */
        }

        /* Auth Container - M3 Card styling */
        .auth-container { /* This class is used in JS for the auth redirect message too */
            background-color: var(--md-sys-color-surface);
            border-radius: var(--md-sys-shape-corner-large);
            box-shadow: var(--md-sys-elevation-level2);
            padding: var(--md-sys-spacing-xl); /* 32px */
            width: 100%;
            max-width: 480px; /* Consistent max-width */
            text-align: center;
            margin: var(--md-sys-spacing-xl) auto; /* Centering for auth state */
            animation: fadeIn 0.3s var(--m3-sys-motion-easing-standard);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dashboard-wrapper {
            background-color: var(--md-sys-color-background);
            width: 100%;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden; /* Prevent horizontal scroll on dashboard */
        }

        .logo {
            max-width: 154px;
            margin: 0 auto var(--md-sys-spacing-l) auto;
            transition: transform var(--m3-sys-motion-duration-medium2) var(--m3-sys-motion-easing-standard);
        }
        .logo:hover { transform: scale(1.05); }

        .dashboard-header {
            background-color: var(--md-sys-color-surface);
            box-shadow: var(--md-sys-elevation-level1);
            /* padding, display, etc. are already in m3_styles.css */
        }
        .dashboard-header .logo-small { max-width: 132px; }

        .main-nav {
            background-color: var(--md-sys-color-surface);
            box-shadow: var(--md-sys-elevation-level1);
            top: 72px; /* Approximate height of dashboard-header (adjust if header height changes, M3 uses 64dp typically) */
            /* Other styles like display flex, justify center are in m3_styles.css */
        }
        .nav-tab {
            /* Uses M3 styling from m3_styles.css */
        }
        .nav-tab:hover {
            color: var(--md-sys-color-primary);
            background-color: color-mix(in srgb, var(--md-sys-color-primary) 8%, transparent);
        }
        .nav-tab.active {
            color: var(--md-sys-color-primary);
            border-bottom-color: var(--md-sys-color-primary);
        }

        .dashboard-content-area {
            padding: var(--md-sys-spacing-l);
            flex-grow: 1;
            background-color: var(--md-sys-color-background);
            overflow-y: auto; /* Allow content to scroll if it overflows */
        }

        /* M3 Inspired Text Field Styling for Auth Inputs */
        .auth-input-container { /* New wrapper for icon + input */
            position: relative;
            margin-bottom: var(--md-sys-spacing-m);
        }
        .auth-input {
            width: 100%;
            padding-top: var(--md-sys-spacing-m); /* 16dp */
            padding-bottom: var(--md-sys-spacing-m);
            padding-left: calc(var(--md-sys-spacing-xs) + var(--md-sys-spacing-m) + var(--md-sys-spacing-s)); /* Icon space + padding */
            padding-right: var(--md-sys-spacing-m);
            border: none; /* Remove default border */
            border-bottom: 1px solid var(--md-sys-color-on-surface-variant); /* M3 underline */
            border-radius: var(--md-sys-shape-corner-extra-small) var(--md-sys-shape-corner-extra-small) 0 0; /* Top corners rounded */
            box-sizing: border-box;
            font-size: var(--md-sys-typescale-body-large-font-size);
            background-color: color-mix(in srgb, var(--md-sys-color-primary) 4%, var(--md-sys-color-surface-container-highest)); /* M3 Filled text field subtle bg */
            color: var(--md-sys-color-on-surface);
            transition: background-color var(--m3-sys-motion-duration-short2) var(--m3-sys-motion-easing-standard),
                        border-color var(--m3-sys-motion-duration-short2) var(--m3-sys-motion-easing-standard);
        }
        .auth-input:focus {
            outline: none;
            border-bottom: 2px solid var(--md-sys-color-primary); /* M3 focus indicator */
            padding-bottom: calc(var(--md-sys-spacing-m) - 1px); /* Adjust padding for thicker border */
            background-color: color-mix(in srgb, var(--md-sys-color-primary) 8%, var(--md-sys-color-surface-container-highest));
        }
        .auth-input-icon {
            position: absolute;
            top: 50%;
            left: var(--md-sys-spacing-m); /* 16dp */
            transform: translateY(-50%);
            color: var(--md-sys-color-on-surface-variant);
            pointer-events: none; /* So icon doesn't interfere with input click */
        }

        .auth-toggle-link {
            color: var(--md-sys-color-primary);
            cursor: pointer;
            text-decoration: none;
            font-family: var(--md-sys-typescale-label-large-font-family-name);
            font-weight: var(--md-sys-typescale-label-large-font-weight); /* Medium */
        }
        .auth-toggle-link:hover { text-decoration: underline; }

        .error-message, .success-message {
            font-family: var(--md-sys-typescale-body-small-font-size);
            padding: var(--md-sys-spacing-s) var(--md-sys-spacing-m);
            border-radius: var(--md-sys-shape-corner-extra-small);
            text-align: left; /* M3 typically left-aligns inline messages */
            display: flex; align-items: center; gap: var(--md-sys-spacing-xs);
            margin-top: var(--md-sys-spacing-xs);
        }
        .error-message {
            background-color: var(--md-sys-color-error-container);
            color: var(--md-sys-color-on-error-container);
        }
        .success-message {
            background-color: var(--md-sys-color-success-container);
            color: var(--md-sys-color-on-success-container);
        }

        .divider { /* M3 Divider style */
            display: flex;
            align-items: center;
            margin: var(--md-sys-spacing-l) 0;
            color: var(--md-sys-color-on-surface-variant);
            font-family: var(--md-sys-typescale-label-large-font-family-name);
            font-size: var(--md-sys-typescale-label-large-font-size);
        }
        .divider::before, .divider::after {
            content: ""; flex: 1; border-bottom: 1px solid var(--md-sys-color-outline-variant); /* Thinner outline */
        }
        .divider::before { margin-right: var(--md-sys-spacing-xs); }
        .divider::after { margin-left: var(--md-sys-spacing-xs); }

        .spinner { /* Using M3 progress indicator idea */
            border: 3px solid color-mix(in srgb, currentColor 20%, transparent);
            border-radius: 50%;
            border-top-color: currentColor; /* Uses button's text color */
            width: 1.125rem; /* 18dp, matches icon size */
            height: 1.125rem;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Results specific styling */
        #results-content h1 {
            font-family: var(--md-sys-typescale-headline-small-font-family-name); /* Using Headline Small */
            font-size: var(--md-sys-typescale-headline-small-font-size);
            font-weight: var(--md-sys-typescale-headline-small-font-weight); /* Regular */
            color: var(--md-sys-color-primary);
            text-align:left; /* As per original */
            margin-bottom: var(--md-sys-spacing-xs);
        }
        #results-content > p {
             font-family: var(--md-sys-typescale-title-medium-font-family-name); /* Title Medium for subtitle */
             color: var(--md-sys-color-on-surface-variant);
             text-align:left;
             margin-bottom: var(--md-sys-spacing-l);
        }

        #results-summary { /* M3 Card */
            background-color: var(--md-sys-color-surface);
            padding: var(--md-sys-spacing-l);
            border-radius: var(--md-sys-shape-corner-medium);
            box-shadow: var(--md-sys-elevation-level1);
            margin-bottom: var(--md-sys-spacing-l);
        }
        .info-card-results { /* M3 Card per metric */
            background-color: var(--md-sys-color-surface-container-highest); /* Slightly more elevated */
            border-radius: var(--md-sys-shape-corner-medium);
            padding: var(--md-sys-spacing-l);
            text-align: center;
            box-shadow: var(--md-sys-elevation-level1);
        }
        .info-card-results .material-symbols-outlined {
            font-size: 32px; /* Adjust as needed */
            color: var(--md-sys-color-primary);
            margin-bottom: var(--md-sys-spacing-s);
        }
        .info-card-results .metric-label {
            font-family: var(--md-sys-typescale-body-medium-font-family-name);
            color: var(--md-sys-color-on-surface-variant);
            margin-bottom: var(--md-sys-spacing-xxs);
        }
        .info-card-results .metric-value {
            font-family: var(--md-sys-typescale-headline-small-font-family-name); /* For impact */
            color: var(--md-sys-color-primary);
            font-weight: var(--md-sys-font-weight-medium); /* Regular is default for headline */
        }

        /* Accordion M3 Styling */
        .section-accordion-item {
            background-color: var(--md-sys-color-surface);
            border: 1px solid var(--md-sys-color-outline-variant); /* Lighter border */
            border-radius: var(--md-sys-shape-corner-medium);
            margin-bottom: var(--md-sys-spacing-s);
            box-shadow: var(--md-sys-elevation-level0); /* Default, can be elevated on hover/active */
        }
        .section-accordion-header {
            background-color: transparent;
            color: var(--md-sys-color-on-surface);
            padding: var(--md-sys-spacing-m);
            font-family: var(--md-sys-typescale-title-medium-font-family-name);
            font-weight: var(--md-sys-typescale-title-medium-font-weight);
            cursor: pointer;
            transition: background-color var(--m3-sys-motion-duration-short2) var(--m3-sys-motion-easing-standard);
            width: 100%; display: flex; justify-content: space-between; align-items: center;
        }
        .section-accordion-header:hover {
            background-color: color-mix(in srgb, var(--md-sys-color-primary) 8%, transparent);
        }
        .section-accordion-header .material-symbols-outlined {
            transition: transform var(--m3-sys-motion-duration-short2) var(--m3-sys-motion-easing-standard);
            color: var(--md-sys-color-on-surface-variant);
        }
        .section-accordion-header .material-symbols-outlined.rotate-180 { transform: rotate(180deg); }
        .section-accordion-content {
            background-color: var(--md-sys-color-surface);
            padding: var(--md-sys-spacing-m);
            border-top: 1px solid var(--md-sys-color-outline-variant);
        }

        #results-by-section-accordion table {
            width: 100%;
            border-collapse: collapse;
        }
        #results-by-section-accordion th, #results-by-section-accordion td {
            padding: var(--md-sys-spacing-s) var(--md-sys-spacing-m);
            text-align: left;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
            font-family: var(--md-sys-typescale-body-medium-font-family-name);
            font-size: var(--md-sys-typescale-body-medium-font-size);
            color: var(--md-sys-color-on-surface);
        }
        #results-by-section-accordion th {
            font-family: var(--md-sys-typescale-label-large-font-family-name);
            font-weight: var(--md-sys-typescale-label-large-font-weight);
            color: var(--md-sys-color-on-surface-variant);
            background-color: var(--md-sys-color-surface-container); /* Lighter header for table */
        }
        #results-by-section-accordion tbody tr:hover {
            background-color: color-mix(in srgb, var(--md-sys-color-primary) 4%, transparent);
        }
        #results-by-section-accordion tbody tr:last-child td { border-bottom: none; }

        .view-detail-button { /* Style as M3 Text Button */
            font-family: var(--md-sys-typescale-label-large-font-family-name);
            font-weight: var(--md-sys-typescale-label-large-font-weight);
            color: var(--md-sys-color-primary);
            background: none; border: none;
            padding: var(--md-sys-spacing-xs) var(--md-sys-spacing-s);
            border-radius: var(--md-sys-shape-corner-full);
            cursor: pointer;
            transition: background-color var(--m3-sys-motion-duration-short2) ease;
        }
        .view-detail-button:hover {
             background-color: color-mix(in srgb, var(--md-sys-color-primary) 8%, transparent);
        }

        /* Result Detail View (Modal like) */
        #result-detail {
             background-color: var(--md-sys-color-surface);
             padding: var(--md-sys-spacing-l);
             border-radius: var(--md-sys-shape-corner-large); /* M3 Dialog like */
             box-shadow: var(--md-sys-elevation-level2);
             text-align: left;
        }
        #result-detail h3 {
            font-family: var(--md-sys-typescale-headline-small-font-family-name);
            color: var(--md-sys-color-primary);
            margin-bottom: var(--md-sys-spacing-m);
        }
        #result-detail p {
            font-family: var(--md-sys-typescale-body-large-font-family-name);
            color: var(--md-sys-color-on-surface);
            margin-bottom: var(--md-sys-spacing-s);
        }
        #result-detail p strong {
            font-weight: var(--md-sys-font-weight-medium);
            color: var(--md-sys-color-on-surface-variant);
        }
        #result-detail #detail-reflection { /* Make reflection area visually distinct */
            background-color: var(--md-sys-color-surface-container);
            padding: var(--md-sys-spacing-m);
            border-radius: var(--md-sys-shape-corner-small);
            color: var(--md-sys-color-on-surface-variant);
            white-space: pre-wrap; /* Preserve formatting */
            border: 1px solid var(--md-sys-color-outline-variant);
        }

        /* Focus outline for accessibility */
        *:focus-visible {
            outline: 2px solid var(--md-sys-color-secondary); /* Using secondary for focus outline */
            outline-offset: 2px;
            box-shadow: none; /* Remove hover shadow on focus to make outline clear */
        }

        /* Ensure hidden class is effective */
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="auth-section" class="auth-container">
        <img src="https://ik.imagekit.io/mwp/MWP%20Color%20no%20background.png?updatedAt=1745982959141" alt="MedwithPurpose Logo" class="logo" onerror="this.style.display='none'; this.onerror=null;">

        <div id="login-form">
            <h2 style="font-family: var(--md-sys-typescale-headline-small-font-family-name); font-size: var(--md-sys-typescale-headline-small-font-size); color: var(--md-sys-color-on-surface); margin-bottom: var(--md-sys-spacing-s);">Welcome Back</h2>
            <p style="color: var(--md-sys-color-on-surface-variant); font-size: var(--md-sys-typescale-body-large-font-size); margin-bottom: var(--md-sys-spacing-l);">Log in to access your UCAT prep.</p>

            <div class="auth-input-container">
                <span class="auth-input-icon material-symbols-outlined">mail</span>
                <input type="email" id="login-email" placeholder="Email Address" class="auth-input" aria-label="Email Address">
            </div>

            <div class="auth-input-container">
                 <span class="auth-input-icon material-symbols-outlined">lock</span>
                <input type="password" id="login-password" placeholder="Password" class="auth-input" aria-label="Password">
            </div>

            <div style="text-align: right; margin-bottom: var(--md-sys-spacing-m);">
                <a href="#" id="forgot-password-link" class="auth-toggle-link">Forgot Password?</a>
            </div>

            <button id="login-button" class="m3-button m3-button-filled w-full mb-4">
                <span id="login-spinner" class="spinner hidden"></span>
                <span class="material-symbols-outlined">login</span>
                <span>Login</span>
            </button>

            <div class="divider mb-4"><span>OR</span></div>

            <button id="google-login-button" class="m3-button m3-button-outlined w-full mb-6">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon" class="w-5 h-5">
                <span>Sign in with Google</span>
            </button>

            <p style="font-size: var(--md-sys-typescale-body-medium-font-size); color: var(--md-sys-color-on-surface-variant);">Don't have an account? <a href="#" id="show-signup-link" class="auth-toggle-link">Create Account</a></p>
            <p id="login-error" class="error-message text-center mt-3 hidden" aria-live="polite"></p>
        </div>

        <div id="signup-form" class="hidden">
            <h2 style="font-family: var(--md-sys-typescale-headline-small-font-family-name); font-size: var(--md-sys-typescale-headline-small-font-size); color: var(--md-sys-color-on-surface); margin-bottom: var(--md-sys-spacing-s);">Create Account</h2>
            <p style="color: var(--md-sys-color-on-surface-variant); font-size: var(--md-sys-typescale-body-large-font-size); margin-bottom: var(--md-sys-spacing-l);">Join thousands of students preparing for the UCAT.</p>

            <div class="auth-input-container">
                <span class="auth-input-icon material-symbols-outlined">person</span>
                <input type="text" id="signup-name" placeholder="Full Name" class="auth-input" aria-label="Full Name">
            </div>

            <div class="auth-input-container">
                <span class="auth-input-icon material-symbols-outlined">mail</span>
                <input type="email" id="signup-email" placeholder="Email Address" class="auth-input" aria-label="Email Address">
            </div>

            <div class="auth-input-container">
                <span class="auth-input-icon material-symbols-outlined">lock</span>
                <input type="password" id="signup-password" placeholder="Password (min. 6 characters)" class="auth-input" aria-label="Password">
            </div>

            <button id="signup-button" class="m3-button m3-button-filled w-full mb-4">
                <span id="signup-spinner" class="spinner hidden"></span>
                <span class="material-symbols-outlined">person_add</span>
                <span>Create Account</span>
            </button>

            <div class="divider mb-4"><span>OR</span></div>

            <button id="google-signup-button" class="m3-button m3-button-outlined w-full mb-6">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon" class="w-5 h-5">
                <span>Sign up with Google</span>
            </button>

            <p style="font-size: var(--md-sys-typescale-body-medium-font-size); color: var(--md-sys-color-on-surface-variant);">Already have an account? <a href="#" id="show-login-link" class="auth-toggle-link">Login</a></p>
            <p id="signup-error" class="error-message text-center mt-3 hidden" aria-live="polite"></p>
        </div>
    </div>

    <div id="dashboard-wrapper" class="dashboard-wrapper hidden">
        <header class="dashboard-header">
            <a href="home.html">
                <img src="https://ik.imagekit.io/mwp/MWP%20Color%20no%20background.png?updatedAt=1745982959141" alt="MedwithPurpose Logo" class="logo-small" onerror="this.style.display='none'; this.onerror=null;">
            </a>
            <div class="flex items-center">
                <span class="welcome-user mr-4">Welcome, <span id="student-display-name" class="font-semibold" style="color: var(--md-sys-color-on-surface);">Student</span></span>
                <a href="settings.html" aria-label="Account Settings" class="mr-4 settings-icon m3-icon-button">
                     <span class="material-symbols-outlined">settings</span>
                </a>
                <button id="logout-button" class="m3-button m3-button-filled-error" aria-label="Logout">
                    <span class="material-symbols-outlined">logout</span>
                    <span>Logout</span>
                </button>
            </div>
        </header>

        <nav class="main-nav" role="navigation" aria-label="Main Navigation">
            <a href="home.html" id="nav-home" class="nav-tab" role="tab" aria-selected="false">
                <span class="material-symbols-outlined">home</span>Home
            </a>
            <a href="practice.html" id="nav-practice-main" class="nav-tab" role="tab" aria-selected="false">
                <span class="material-symbols-outlined">exercise</span>Practice
            </a>
             <a href="student_dashboard.html#results" id="nav-results" class="nav-tab" role="tab" aria-selected="true">
                 <span class="material-symbols-outlined">bar_chart</span>Results
             </a>
            <div id="nav-skills" class="nav-tab nav-tab-disabled" role="tab" aria-disabled="true">
                <span class="material-symbols-outlined">psychology</span>
                <span>Skills</span> <span class="coming-soon-inline">Soon</span>
            </div>
        </nav>

        <main id="dashboard-content-area" class="dashboard-content-area">
            <div id="results-content" class="max-w-5xl mx-auto hidden">
                <h1>Your Performance History</h1>
                <p>Track your progress and identify areas for improvement.</p>

                <div id="results-loading" class="text-center py-8 hidden">
                    <div class="spinner mx-auto mb-4" style="color: var(--md-sys-color-primary);"></div>
                    <p style="color: var(--md-sys-color-on-surface-variant);">Loading your performance data...</p>
                </div>

                <div id="results-error" class="hidden text-center py-8 error-message">
                    <span class="material-symbols-outlined" style="font-size: 28px;">error</span>
                    <p>Unable to load your results. Please try again later or contact support.</p>
                    <button id="results-retry-button" class="m3-button m3-button-filled ml-auto" style="width:auto; margin-top: var(--md-sys-spacing-m);">Try Again</button>
                </div>

                <div id="results-empty" class="hidden text-center py-8 m3-card m3-card-outlined items-center">
                    <span class="material-symbols-outlined" style="font-size: 48px; color: var(--md-sys-color-primary); margin-bottom: var(--md-sys-spacing-m);">folder_off</span>
                    <h3 style="font-family: var(--md-sys-typescale-title-large-font-family-name); color: var(--md-sys-color-on-surface); margin-bottom: var(--md-sys-spacing-s);">No test results found</h3>
                    <p style="color: var(--md-sys-color-on-surface-variant); margin-bottom: var(--md-sys-spacing-l);">Complete a practice test and submit your reflections to see your performance history here.</p>
                    <button id="go-to-tests-button" class="m3-button m3-button-filled" style="width:auto;">
                        <span class="material-symbols-outlined">exercise</span> Go to Practice
                    </button>
                </div>

                <div id="results-summary" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="info-card-results">
                            <span class="material-symbols-outlined">checklist</span>
                            <p class="metric-label">Tests Completed</p>
                            <p id="tests-completed" class="metric-value">0</p>
                        </div>
                        <div class="info-card-results">
                            <span class="material-symbols-outlined" style="color: var(--md-sys-color-success);">military_tech</span>
                            <p class="metric-label">Average Score</p>
                            <p id="average-score" class="metric-value" style="color: var(--md-sys-color-success);">0%</p>
                        </div>
                         <div class="info-card-results">
                            <span class="material-symbols-outlined" style="color: var(--md-sys-color-tertiary);">emoji_events</span>
                            <p class="metric-label">Highest Score</p>
                            <p id="highest-score" class="metric-value" style="color: var(--md-sys-color-tertiary);">0%</p>
                        </div>
                        <div class="info-card-results">
                            <span class="material-symbols-outlined" style="color: var(--md-sys-color-secondary);">timer</span>
                            <p class="metric-label">Hours Practiced</p>
                            <p id="hours-practiced" class="metric-value" style="color: var(--md-sys-color-secondary);">0h 0m</p>
                        </div>
                    </div>

                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-3 p-3" style="background-color: var(--md-sys-color-surface-container); border-radius: var(--md-sys-shape-corner-medium);">
                        <h3 style="font-family: var(--md-sys-typescale-title-medium-font-family-name); color: var(--md-sys-color-on-surface-variant);">Recent Tests</h3>
                        <div class="flex gap-2 flex-wrap justify-center md:justify-end">
                            <select id="results-filter" class="m3-text-field filter-input" style="width: auto; min-width:150px; padding: var(--md-sys-spacing-s) var(--md-sys-spacing-m); margin-bottom:0;">
                                <option value="all">All Exams</option>
                            </select>
                            <select id="results-sort" class="m3-text-field filter-input" style="width: auto; min-width:150px; padding: var(--md-sys-spacing-s) var(--md-sys-spacing-m); margin-bottom:0;">
                                <option value="date-desc">Newest First</option>
                                <option value="date-asc">Oldest First</option>
                                <option value="score-desc">Highest Score</option>
                                <option value="score-asc">Lowest Score</option>
                            </select>
                            <button id="refresh-results-button" class="m3-button m3-button-filled" style="width:auto;">
                                <span class="material-symbols-outlined">refresh</span> Refresh
                            </button>
                        </div>
                    </div>

                    <div id="results-by-section-accordion" class="space-y-3">
                        </div>
                </div>

                <div id="result-detail" class="hidden mt-6 m3-card m3-card-elevated">
                    <button id="back-to-results-list" class="m3-button m3-button-outlined mb-6" style="width:auto;">
                        <span class="material-symbols-outlined">arrow_back</span> Back to Results List
                    </button>
                    <h3 id="detail-test-name">Test Name</h3>
                    <p><strong>Date:</strong> <span id="detail-test-date"></span></p>
                    <p><strong>Score:</strong> <span id="detail-score"></span></p>
                    <p><strong>Time Taken:</strong> <span id="detail-time"></span></p>
                    <p><strong>Focus Rating:</strong> <span id="detail-focus"></span></p>
                    <p><strong>Reflection:</strong></p>
                    <div id="detail-reflection" style="white-space: pre-wrap;"></div>
                </div>
            </div>

            <div id="default-dashboard-message" class="hidden m3-card m3-card-outlined p-8 text-center">
                <span class="material-symbols-outlined text-5xl mb-4" style="color: var(--md-sys-color-primary);">waving_hand</span>
                <h2 class="m3-title-large mb-2">Welcome to Your Dashboard</h2>
                <p class="m3-body-large" style="color: var(--md-sys-color-on-surface-variant);">Select a section from the top navigation to get started or view your results.</p>
            </div>

        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyASKsaFFTZ-finv2d5egR9K_mZNstEwdns",
          authDomain: "mwp-qr-test-page.firebaseapp.com",
          projectId: "mwp-qr-test-page",
          storageBucket: "mwp-qr-test-page.appspot.com",
          messagingSenderId: "309084045110",
          appId: "1:309084045110:web:b09ca0fdff84b094963d97",
          measurementId: "G-4M3ED641M9"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();

        // DOM Elements
        const authSection = document.getElementById('auth-section');
        const dashboardWrapper = document.getElementById('dashboard-wrapper');
        const loginFormEl = document.getElementById('login-form');
        const signupFormEl = document.getElementById('signup-form');

        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const loginButton = document.getElementById('login-button');
        const loginSpinner = document.getElementById('login-spinner');
        const googleLoginButton = document.getElementById('google-login-button');
        const loginErrorP = document.getElementById('login-error');
        const showSignupLink = document.getElementById('show-signup-link');
        const forgotPasswordLink = document.getElementById('forgot-password-link');

        const signupNameInput = document.getElementById('signup-name');
        const signupEmailInput = document.getElementById('signup-email');
        const signupPasswordInput = document.getElementById('signup-password');
        const signupButton = document.getElementById('signup-button');
        const signupSpinner = document.getElementById('signup-spinner');
        const googleSignupButton = document.getElementById('google-signup-button');
        const signupErrorP = document.getElementById('signup-error');
        const showLoginLink = document.getElementById('show-login-link');

        const studentDisplayNameHeader = document.getElementById('student-display-name');
        const logoutButton = document.getElementById('logout-button');

        const navHome = document.getElementById('nav-home');
        const navPracticeMain = document.getElementById('nav-practice-main');
        const navResults = document.getElementById('nav-results');
        const navSkills = document.getElementById('nav-skills');
        const allNavTabs = document.querySelectorAll('.nav-tab');

        const resultsContent = document.getElementById('results-content');
        const defaultDashboardMessage = document.getElementById('default-dashboard-message');
        const resultsLoading = document.getElementById('results-loading');
        const resultsErrorEl = document.getElementById('results-error'); // Renamed for clarity
        const resultsEmpty = document.getElementById('results-empty');
        const resultsSummary = document.getElementById('results-summary');
        const resultsBySectionAccordion = document.getElementById('results-by-section-accordion');
        const resultDetailView = document.getElementById('result-detail');
        const backToResultsListButton = document.getElementById('back-to-results-list');
        const resultsFilterSelect = document.getElementById('results-filter');
        const resultsSortSelect = document.getElementById('results-sort');
        const refreshResultsButton = document.getElementById('refresh-results-button');
        const goToTestsButton = document.getElementById('go-to-tests-button');


        let allUserResults = [];
        let uniqueExamNames = new Set();

        // --- UI Helpers ---
        function setButtonLoadingState(button, spinner, isLoading) {
            if (!button || !spinner) return;
            button.disabled = isLoading;
            spinner.classList.toggle('hidden', !isLoading);
            button.classList.toggle('opacity-70', isLoading); // Consider M3 disabled styles
        }

        function showAuthMessage(element, text, isError = true) {
            if(!element) return;
            element.textContent = text;
            element.classList.remove('hidden', 'success-message', 'error-message');
            element.classList.add(isError ? 'error-message' : 'success-message');

            const iconSpan = document.createElement('span');
            iconSpan.classList.add('material-symbols-outlined');
            iconSpan.style.marginRight = 'var(--md-sys-spacing-xs)';
            iconSpan.textContent = isError ? 'error' : 'check_circle';
            element.prepend(iconSpan);
        }

        function toggleAuthForms(showSignup) {
            if (loginFormEl) loginFormEl.classList.toggle('hidden', showSignup);
            if (signupFormEl) signupFormEl.classList.toggle('hidden', !showSignup);
            if (loginEmailInput) loginEmailInput.value = '';
            if (loginPasswordInput) loginPasswordInput.value = '';
            if (signupNameInput) signupNameInput.value = '';
            if (signupEmailInput) signupEmailInput.value = '';
            if (signupPasswordInput) signupPasswordInput.value = '';
            if (loginErrorP) loginErrorP.classList.add('hidden');
            if (signupErrorP) signupErrorP.classList.add('hidden');
        }

        if (showSignupLink) showSignupLink.addEventListener('click', (e) => { e.preventDefault(); toggleAuthForms(true); });
        if (showLoginLink) showLoginLink.addEventListener('click', (e) => { e.preventDefault(); toggleAuthForms(false); });

        // --- Authentication Logic ---
        if (signupButton) {
            signupButton.addEventListener('click', () => {
                const name = signupNameInput.value.trim();
                const email = signupEmailInput.value.trim();
                const password = signupPasswordInput.value;
                if (!name) { showAuthMessage(signupErrorP, 'Please enter your name.'); return; }
                if (!email || !/\S+@\S+\.\S+/.test(email)) { showAuthMessage(signupErrorP, 'Please enter a valid email.'); return; }
                if (password.length < 6) { showAuthMessage(signupErrorP, 'Password must be at least 6 characters.'); return; }

                setButtonLoadingState(signupButton, signupSpinner, true);
                auth.createUserWithEmailAndPassword(email, password)
                    .then(userCredential => userCredential.user.updateProfile({ displayName: name }))
                    .then(() => db.collection("users").doc(auth.currentUser.uid).set({ displayName: name, email: email, createdAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true }))
                    .catch(error => showAuthMessage(signupErrorP, error.message))
                    .finally(() => setButtonLoadingState(signupButton, signupSpinner, false));
            });
        }

        if (loginButton) {
            loginButton.addEventListener('click', () => {
                const email = loginEmailInput.value.trim();
                const password = loginPasswordInput.value;
                if (!email || !password) { showAuthMessage(loginErrorP, 'Please enter email and password.'); return; }
                setButtonLoadingState(loginButton, loginSpinner, true);
                auth.signInWithEmailAndPassword(email, password)
                    .catch(error => showAuthMessage(loginErrorP, error.message))
                    .finally(() => setButtonLoadingState(loginButton, loginSpinner, false));
            });
        }


        function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            // Determine which spinner to use based on which form is visible
            const currentSpinner = loginFormEl && !loginFormEl.classList.contains('hidden') ? loginSpinner : signupSpinner;
            const currentErrorP = loginFormEl && !loginFormEl.classList.contains('hidden') ? loginErrorP : signupErrorP;
            const buttonToLoad = loginFormEl && !loginFormEl.classList.contains('hidden') ? googleLoginButton : googleSignupButton;


            if (buttonToLoad && currentSpinner) setButtonLoadingState(buttonToLoad, currentSpinner, true);

            auth.signInWithPopup(provider)
                .then(result => {
                    const user = result.user;
                    return db.collection("users").doc(user.uid).set({ displayName: user.displayName, email: user.email, createdAt: firebase.firestore.FieldValue.serverTimestamp(), provider: 'google.com' }, { merge: true });
                })
                .catch(error => showAuthMessage(currentErrorP, error.message))
                .finally(() => {
                    if (buttonToLoad && currentSpinner) setButtonLoadingState(buttonToLoad, currentSpinner, false);
                });
        }
        if (googleLoginButton) googleLoginButton.addEventListener('click', signInWithGoogle);
        if (googleSignupButton) googleSignupButton.addEventListener('click', signInWithGoogle);


        if (forgotPasswordLink) {
            forgotPasswordLink.addEventListener('click', (e) => {
                e.preventDefault();
                const email = loginEmailInput.value.trim();
                if (!email) { showAuthMessage(loginErrorP, 'Please enter your email to reset password.'); return; }
                auth.sendPasswordResetEmail(email)
                    .then(() => showAuthMessage(loginErrorP, 'Password reset email sent!', false))
                    .catch(error => showAuthMessage(loginErrorP, error.message));
            });
        }

        if (logoutButton) {
            logoutButton.addEventListener('click', () => {
                if (confirm("Are you sure you want to log out?")) {
                    auth.signOut(); // onAuthStateChanged will handle redirect
                }
            });
        }

        auth.onAuthStateChanged(user => {
            const isCurrentlyOnDashboardPage = window.location.pathname.includes('student_dashboard.html');
            
            if (user) {
                if(studentDisplayNameHeader) studentDisplayNameHeader.textContent = user.displayName || user.email;
                if(authSection) authSection.classList.add('hidden');
                if(dashboardWrapper) dashboardWrapper.classList.remove('hidden');

                if (isCurrentlyOnDashboardPage) {
                    const hash = window.location.hash;
                     if (hash === '#results') {
                        showContentSection('results');
                        setActiveTab(navResults);
                        loadUserResults(user.uid);
                    } else if (hash) { // Handle other potential hashes if student_dashboard can show more than just results
                        const targetSectionId = hash.substring(1) + "-content"; // e.g. #practice -> practice-content
                        const targetNavId = "nav-" + hash.substring(1).split('-')[0]; // e.g. #practice-main -> nav-practice
                        const targetSectionEl = document.getElementById(targetSectionId);
                        const targetNavEl = document.getElementById(targetNavId);

                        if (targetSectionEl) {
                             showContentSection(hash.substring(1)); // Pass without -content
                             if(targetNavEl) setActiveTab(targetNavEl); else setActiveTab(null); // No specific nav or default
                        } else {
                             // Fallback to results if specific hash content not found on this page
                             showContentSection('results');
                             setActiveTab(navResults);
                             loadUserResults(user.uid);
                        }
                    } else {
                         // Default to results if no hash on student_dashboard.html
                         showContentSection('results');
                         setActiveTab(navResults);
                         loadUserResults(user.uid);
                    }
                }
                // If on other pages (like home.html, practice.html), their own JS will handle active tab and content.
            } else {
                if(authSection) authSection.classList.remove('hidden');
                if(dashboardWrapper) dashboardWrapper.classList.add('hidden');
                if (isCurrentlyOnDashboardPage) {
                     // If on dashboard and logs out, clear results, show auth
                    if(resultsContent) resultsContent.classList.add('hidden');
                    if(defaultDashboardMessage) defaultDashboardMessage.classList.add('hidden');
                }
            }
        });

        // --- Content Display ---
        function showContentSection(contentIdSuffix) {
            [resultsContent, defaultDashboardMessage, resultDetailView].forEach(el => {
                if(el) el.classList.add('hidden');
            });
            const sectionToShow = document.getElementById(contentIdSuffix + '-content') || document.getElementById(contentIdSuffix);
            if (sectionToShow) {
                sectionToShow.classList.remove('hidden');
            } else {
                if(defaultDashboardMessage) defaultDashboardMessage.classList.remove('hidden');
            }
        }

        function setActiveTab(selectedTabEl) {
            allNavTabs.forEach(tab => {
                tab.classList.remove('active');
                tab.setAttribute('aria-selected', 'false');
            });
            if (selectedTabEl && !selectedTabEl.classList.contains('nav-tab-disabled')) {
                selectedTabEl.classList.add('active');
                selectedTabEl.setAttribute('aria-selected', 'true');
            }
        }

        if(navHome) navHome.addEventListener('click', (e) => { e.preventDefault(); window.location.href = 'home.html'; });
        if(navPracticeMain) navPracticeMain.addEventListener('click', (e) => { e.preventDefault(); window.location.href = 'practice.html'; });
        if(navResults) {
            navResults.addEventListener('click', (e) => {
                e.preventDefault();
                showContentSection('results');
                setActiveTab(navResults);
                if (auth.currentUser) loadUserResults(auth.currentUser.uid);
                window.history.pushState({}, "", "#results"); // Update hash for direct linking
            });
        }
        // if(navSkills) navSkills.addEventListener('click', (e) => { /* Future functionality */ });


        // --- Results Logic ---
        function getSectionFromExamName(examName) {
            const nameLower = examName ? examName.toLowerCase() : '';
            if (nameLower.includes('qr') || nameLower.includes('quantitative')) return 'qr';
            if (nameLower.includes('dm') || nameLower.includes('decision') || nameLower.includes('syllogism')) return 'dm';
            if (nameLower.includes('vr') || nameLower.includes('verbal')) return 'vr';
            // Add other sections if needed
            return 'other';
        }

        async function loadUserResults(userId) {
            if (!db) { console.error("Firestore not initialized."); resultsLoading.classList.add('hidden'); resultsErrorEl.classList.remove('hidden'); return; } //
            if (!userId) { console.error("No user ID provided for loading results."); resultsLoading.classList.add('hidden'); resultsErrorEl.classList.remove('hidden'); return; } //

            resultsLoading.classList.remove('hidden'); //
            resultsErrorEl.classList.add('hidden'); //
            resultsSummary.classList.add('hidden'); //
            resultsBySectionAccordion.innerHTML = ''; //
            resultsEmpty.classList.add('hidden'); //

            try {
                const querySnapshot = await db.collection("performanceSubmissions")
                                          .where("userId", "==", userId) //
                                          .orderBy("submissionTimestamp", "desc") //
                                          .get();
                allUserResults = querySnapshot.docs.map(doc => ({ //
                    id: doc.id, //
                    ...doc.data(), //
                    date: doc.data().submissionTimestamp?.toDate ? doc.data().submissionTimestamp.toDate() : new Date(doc.data().submissionTimestamp || 0) //
                }));

                if (allUserResults.length === 0) { //
                    resultsEmpty.classList.remove('hidden'); //
                } else {
                    populateExamFilterOptions(); //
                    applyResultsFiltersAndSort(); //
                    resultsSummary.classList.remove('hidden'); //
                    updateOverallResultsSummary(allUserResults); //
                }
            } catch (error) {
                console.error("Error loading results: ", error);
                resultsErrorEl.classList.remove('hidden'); //
            } finally {
                resultsLoading.classList.add('hidden'); //
            }
        }

        function populateExamFilterOptions() {
            uniqueExamNames.clear(); //
            allUserResults.forEach(result => { //
                if (result.examName) uniqueExamNames.add(result.examName); //
            });
            resultsFilterSelect.innerHTML = '<option value="all">All Exams</option>'; //
            [...uniqueExamNames].sort().forEach(name => { //
                const option = document.createElement('option'); //
                option.value = name; //
                option.textContent = name; //
                resultsFilterSelect.appendChild(option); //
            });
        }

        function applyResultsFiltersAndSort() {
            let filtered = [...allUserResults]; //
            const filterValue = resultsFilterSelect.value; //
            if (filterValue !== 'all') { //
                filtered = filtered.filter(r => r.examName === filterValue); //
            }

            const sortValue = resultsSortSelect.value; //
            filtered.sort((a, b) => { //
                const dateA = a.date; //
                const dateB = b.date; //
                const scoreA = (parseFloat(a.score) / parseFloat(a.totalPossibleScore || a.totalQuestions || 1)) * 100 || 0; //
                const scoreB = (parseFloat(b.score) / parseFloat(b.totalPossibleScore || b.totalQuestions || 1)) * 100 || 0; //

                switch(sortValue) { //
                    case 'date-asc': return dateA - dateB; //
                    case 'score-desc': return scoreB - scoreA; //
                    case 'score-asc': return scoreA - scoreB; //
                    case 'date-desc': default: return dateB - dateA; //
                }
            });
            renderResults(filtered); //
        }

        function renderResults(resultsToDisplay) {
            resultsBySectionAccordion.innerHTML = ''; //
            const categorized = { qr: [], dm: [], vr: [], other: [] }; //
            resultsToDisplay.forEach(r => { //
                const section = getSectionFromExamName(r.examName); //
                categorized[section].push(r); //
            });

            const sectionTitles = { qr: 'Quantitative Reasoning', dm: 'Decision Making', vr: 'Verbal Reasoning', other: 'Other Tests' }; //
            Object.keys(categorized).forEach(sectionKey => { //
                if (categorized[sectionKey].length > 0) { //
                    const accordionItem = createAccordionItem(sectionTitles[sectionKey], sectionKey, categorized[sectionKey]); //
                    resultsBySectionAccordion.appendChild(accordionItem); //
                }
            });
            if(resultsBySectionAccordion.innerHTML === ''){ //
                 resultsEmpty.classList.remove('hidden'); //
                 resultsSummary.classList.add('hidden'); //
            } else {
                 resultsEmpty.classList.add('hidden'); //
            }
        }

        function createAccordionItem(title, sectionKey, items) {
            const itemDiv = document.createElement('div'); //
            itemDiv.className = 'section-accordion-item'; //

            const headerButton = document.createElement('button'); //
            headerButton.className = 'section-accordion-header'; //
            headerButton.innerHTML = `
                <span>${title}</span>
                <span class="material-symbols-outlined">expand_more</span>
            `; //

            const contentDiv = document.createElement('div'); //
            contentDiv.className = 'section-accordion-content hidden'; //
            contentDiv.id = `content-${sectionKey}`; //

            const table = document.createElement('table'); //
            table.innerHTML = `
                <thead><tr>
                    <th>Date</th><th>Test</th><th>Score</th><th>Time Taken</th><th>Focus</th><th>Actions</th>
                </tr></thead>
                <tbody></tbody>
            `; //
            const tbody = table.querySelector('tbody'); //
            items.forEach(item => { //
                const row = tbody.insertRow(); //
                const scoreDisplay = `${item.score || 0}/${item.totalPossibleScore || item.totalQuestions || '-'}`; //
                row.innerHTML = `
                    <td>${item.date.toLocaleDateString()}</td>
                    <td>${item.examName}</td>
                    <td>${scoreDisplay}</td>
                    <td>${item.timeTaken || '-'}</td>
                    <td>${item.focusRating || '-'}/5</td>
                    <td><button class="view-detail-button m3-button m3-button-text" data-result-id="${item.id}">
                        <span class="material-symbols-outlined">visibility</span>View</button></td>
                `; //
                row.querySelector('.view-detail-button').addEventListener('click', (e) => { //
                     const result = allUserResults.find(r => r.id === e.target.closest('button').dataset.resultId); //
                     if(result) showResultDetail(result); //
                });
            });
            contentDiv.appendChild(table); //

            headerButton.addEventListener('click', () => { //
                contentDiv.classList.toggle('hidden'); //
                headerButton.querySelector('.material-symbols-outlined').classList.toggle('rotate-180'); //
            });

            itemDiv.appendChild(headerButton); //
            itemDiv.appendChild(contentDiv); //
            return itemDiv; //
        }

        function showResultDetail(result) {
            if(resultsContent) resultsContent.classList.add('hidden'); //
            if(resultDetailView) resultDetailView.classList.remove('hidden'); //

            if(document.getElementById('detail-test-name')) document.getElementById('detail-test-name').textContent = result.examName || 'N/A'; //
            if(document.getElementById('detail-test-date')) document.getElementById('detail-test-date').textContent = result.date ? result.date.toLocaleString() : 'N/A'; //
            if(document.getElementById('detail-score')) document.getElementById('detail-score').textContent = `${result.score || 0}/${result.totalPossibleScore || result.totalQuestions || '-'}`; //
            if(document.getElementById('detail-time')) document.getElementById('detail-time').textContent = result.timeTaken || 'N/A'; //
            if(document.getElementById('detail-focus')) document.getElementById('detail-focus').textContent = `${result.focusRating || '-'}/5`; //
            if(document.getElementById('detail-reflection')) document.getElementById('detail-reflection').textContent = result.reflection || 'No reflection provided.'; //
        }

        function updateOverallResultsSummary(allResults) {
            const testsCompletedEl = document.getElementById('tests-completed'); //
            const averageScoreEl = document.getElementById('average-score'); //
            const highestScoreEl = document.getElementById('highest-score'); //
            const hoursPracticedEl = document.getElementById('hours-practiced'); //

            if (!testsCompletedEl || !averageScoreEl || !highestScoreEl || !hoursPracticedEl) return; //

            const numTests = allResults.length; //
            let totalPercentageSum = 0; //
            let maxPercentage = 0; //
            let totalMinutes = 0; //

            allResults.forEach(result => { //
                const score = parseFloat(result.score); //
                const totalPossible = parseFloat(result.totalPossibleScore || result.totalQuestions); //
                if (!isNaN(score) && !isNaN(totalPossible) && totalPossible > 0) { //
                    const percentage = (score / totalPossible) * 100; //
                    totalPercentageSum += percentage; //
                    maxPercentage = Math.max(maxPercentage, percentage); //
                }
                const timeTaken = result.timeTaken; //
                if (timeTaken && typeof timeTaken === 'string') { //
                    let minutesInThisEntry = 0;
                    const hourMatch = timeTaken.match(/(\d+)\s*h/); //
                    const minMatch = timeTaken.match(/(\d+)\s*min/); //
                    const secMatch = timeTaken.match(/(\d+)\s*sec/); /* Extracted from logic in QR Test 2.html */
                    if (hourMatch) minutesInThisEntry += parseInt(hourMatch[1]) * 60;
                    if (minMatch) minutesInThisEntry += parseInt(minMatch[1]); //
                    if (secMatch) minutesInThisEntry += parseInt(secMatch[1]) / 60; /* Extracted from logic in QR Test 2.html */
                    totalMinutes += minutesInThisEntry;
                }
            });

            testsCompletedEl.textContent = numTests; //
            averageScoreEl.textContent = numTests > 0 ? (totalPercentageSum / numTests).toFixed(1) + '%' : '0%'; //
            highestScoreEl.textContent = maxPercentage.toFixed(1) + '%'; //
            const hours = Math.floor(totalMinutes / 60);
            const minutes = Math.round(totalMinutes % 60); // Round minutes for display
            hoursPracticedEl.textContent = `${hours}h ${minutes}m`; //
        }

        if(backToResultsListButton) {
            backToResultsListButton.addEventListener('click', () => {
                if(resultDetailView) resultDetailView.classList.add('hidden'); //
                if(resultsContent) resultsContent.classList.remove('hidden'); //
                // No need to reload all results if filters haven't changed,
                // but if coming from a detail view, the main list might need re-rendering or ensuring it's up-to-date.
                // For simplicity, we can just call applyResultsFiltersAndSort to ensure the view is correct.
                applyResultsFiltersAndSort();
            });
        }


        if(resultsFilterSelect) resultsFilterSelect.addEventListener('change', applyResultsFiltersAndSort); //
        if(resultsSortSelect) resultsSortSelect.addEventListener('change', applyResultsFiltersAndSort); //
        if(refreshResultsButton) refreshResultsButton.addEventListener('click', () => { if (auth.currentUser) loadUserResults(auth.currentUser.uid); }); //
        if(goToTestsButton) goToTestsButton.addEventListener('click', () => window.location.href = 'practice.html'); //
        if(document.getElementById('results-retry-button')) {
            document.getElementById('results-retry-button').addEventListener('click', () => {
                if (auth.currentUser) loadUserResults(auth.currentUser.uid);
            });
        }


        // --- Initial DOMContentLoaded Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            // The onAuthStateChanged listener will handle the initial content display and active tab
            // based on the URL hash or default to results.
            // No specific tab needs to be forced active here solely on DOMContentLoaded for this page,
            // as auth state and hash will determine it.
        });
    </script>
</body>
</html>