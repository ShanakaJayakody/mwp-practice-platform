<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Settings - Student Dashboard</title>
    <link rel="icon" href="https://ik.imagekit.io/mwp/2.svg?updatedAt=1745982956185" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --color-primary: #3b82f6;
            --color-primary-dark: #2563eb;
            --color-primary-light: #93c5fd;
            --color-primary-bg: #eff6ff;
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-danger: #ef4444;
            --color-text: #1f2937;
            --color-text-secondary: #4b5563;
            --color-text-tertiary: #6b7280;
            --color-bg: #f9fafb;
            --color-bg-secondary: #f3f4f6;
            --color-border: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --radius-sm: 0.375rem;
            --radius: 0.5rem;
            --radius-md: 0.75rem;
            --radius-lg: 1rem;
            --transition: 220ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 0;
            color: var(--color-text);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .dashboard-wrapper {
            background-color: #ffffff;
            width: 100%;
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* Dashboard Header */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background-color: #ffffff;
            border-bottom: 1px solid var(--color-border);
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 40;
        }

        .dashboard-header .logo-small {
            max-width: 132px;
            transition: all var(--transition);
        }

        .dashboard-header .logo-small:hover {
            transform: scale(1.03);
        }
        
        .settings-icon {
            color: var(--color-text-secondary);
            transition: color var(--transition);
        }
        .settings-icon:hover {
            color: var(--color-primary);
        }

        /* Main Navigation */
        .main-nav {
            display: flex;
            justify-content: center;
            background-color: #ffffff;
            padding: 0.25rem 0;
            border-bottom: 1px solid var(--color-border);
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 61px; /* Height of header */
            z-index: 30;
        }

        .nav-tab {
            padding: 0.875rem 1.5rem;
            margin: 0 0.5rem;
            cursor: pointer;
            font-weight: 500;
            color: var(--color-text-secondary);
            border-bottom: 2px solid transparent; /* Keep for spacing */
            transition: color var(--transition), background-color var(--transition), border-color var(--transition);
            border-radius: var(--radius-sm) var(--radius-sm) 0 0;
            position: relative;
            user-select: none;
            text-decoration: none; /* For anchor tags */
        }
        
        .nav-tab::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: -2px; /* Aligns with the original border-bottom space */
            width: 100%;
            height: 2px;
            background-color: var(--color-primary);
            transform: scaleX(0);
            transform-origin: center; /* Underline grows from the center */
            transition: transform 0.3s ease-out;
        }

        .nav-tab:hover {
            color: var(--color-primary);
            background-color: var(--color-primary-bg);
        }
        
        .nav-tab:hover::after {
            transform: scaleX(1); /* Show underline on hover */
        }

        .nav-tab.active {
            color: var(--color-primary);
            background-color: var(--color-primary-bg);
        }
        
        .nav-tab.active::after {
            transform: scaleX(1); 
        }

        .nav-tab-disabled {
            color: var(--color-text-tertiary);
            cursor: not-allowed;
            opacity: 0.7;
        }

        .nav-tab-disabled .coming-soon-inline {
            font-size: 0.65rem;
            color: var(--color-text-tertiary);
            margin-left: 4px;
            background-color: var(--color-bg-secondary);
            padding: 0.1rem 0.4rem;
            border-radius: 1rem;
        }

        /* Dropdown for Tests Tab */
        .tests-dropdown-container {
            position: relative;
        }

        .tests-dropdown-content {
            opacity: 0;
            visibility: hidden;
            position: absolute;
            background-color: #ffffff;
            min-width: 200px;
            box-shadow: var(--shadow-md);
            z-index: 50;
            border-radius: var(--radius);
            margin-top: 0.25rem;
            border: 1px solid var(--color-border);
            transform: translateY(-10px);
            transition: all var(--transition);
            overflow: hidden;
        }

        .tests-dropdown-container:hover .tests-dropdown-content {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            color: var(--color-text-secondary);
            padding: 0.75rem 1rem;
            text-decoration: none;
            display: block;
            font-size: 0.9rem;
            border-bottom: 1px solid var(--color-border);
            transition: all var(--transition);
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover:not(.disabled) {
            background-color: var(--color-primary-bg);
            color: var(--color-primary-dark);
            padding-left: 1.25rem;
        }
        
        .dropdown-item.disabled {
            color: var(--color-text-tertiary);
            cursor: not-allowed;
            background-color: var(--color-bg-secondary);
            opacity: 0.7;
        }

        .dropdown-item.disabled .coming-soon-inline {
            font-size: 0.65rem;
            color: var(--color-text-tertiary);
            margin-left: 4px;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 0.1rem 0.4rem;
            border-radius: 1rem;
        }

        .welcome-user {
            font-size: 0.9rem;
            color: var(--color-text-secondary);
            display: flex;
            align-items: center;
        }

        .welcome-user::before {
            content: "";
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: var(--color-success);
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .btn-logout {
            background-color: var(--color-danger);
            color: white;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            border-radius: var(--radius);
            transition: all var(--transition);
            border: none;
            cursor: pointer;
        }

        .btn-logout:hover {
            background-color: #dc2626;
            box-shadow: var(--shadow);
        }
        
        /* Settings Page Specific Styles */
        .dashboard-content-area {
            padding: 2rem 2.5rem;
            flex-grow: 1;
        }
        
        .settings-container {
            max-width: 700px;
            margin: 0 auto;
            background-color: #ffffff;
            padding: 2rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
        }

        .settings-section {
            margin-bottom: 2.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--color-border);
        }
        .settings-section:last-child {
            margin-bottom: 0;
            border-bottom: none;
            padding-bottom: 0;
        }

        .settings-section h2 {
            font-size: 1.5rem; /* 24px */
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 1.25rem; /* 20px */
        }

        .input-group {
            margin-bottom: 1.25rem; /* 20px */
        }

        .input-group label {
            display: block;
            font-size: 0.875rem; /* 14px */
            font-weight: 500;
            color: var(--color-text-secondary);
            margin-bottom: 0.375rem; /* 6px */
        }

        .input-group input[type="text"],
        .input-group input[type="email"],
        .input-group input[type="password"],
        .input-group input[type="date"] {
            width: 100%;
            padding: 0.75rem 1rem; /* 12px 16px */
            border: 1px solid var(--color-border);
            border-radius: var(--radius); /* 0.5rem */
            font-size: 1rem; /* 16px */
            color: var(--color-text);
            background-color: var(--color-bg-secondary);
            transition: border-color var(--transition), box-shadow var(--transition);
        }
        .input-group input[type="text"]:read-only,
        .input-group input[type="email"]:read-only {
             background-color: var(--color-bg);
             cursor: default;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); /* Primary focus ring */
        }

        .btn-save {
            background-color: var(--color-primary);
            color: white;
            padding: 0.6rem 1.2rem;
            border-radius: var(--radius);
            font-weight: 500;
            transition: background-color 0.2s ease;
            border: none;
            cursor: pointer;
            min-width: 120px;
        }
        .btn-save:hover {
            background-color: var(--color-primary-dark);
        }
        .btn-save:disabled {
            background-color: var(--color-text-tertiary);
            cursor: not-allowed;
        }
        
        .message {
            font-size: 0.875rem;
            padding: 0.75rem 1rem;
            border-radius: var(--radius);
            margin-top: 1rem;
            text-align: center;
        }
        .message.success {
            background-color: var(--color-success-bg, #d1fae5); /* Adding a fallback */
            color: var(--color-success-dark, #065f46); /* Adding a fallback */
            border: 1px solid var(--color-success, #10b981);
        }
        .message.error {
            background-color: var(--color-danger-bg, #fee2e2); /* Adding a fallback */
            color: var(--color-danger-dark, #991b1b); /* Adding a fallback */
            border: 1px solid var(--color-danger, #ef4444);
        }
        
        #auth-redirect-message {
            background-color: white;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            padding: 2.5rem;
            width: 100%;
            max-width: 480px;
            text-align: center;
            margin: 2.5rem auto;
        }
        
        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .dashboard-content-area {
                padding: 1.5rem 1rem;
            }
            .settings-container {
                padding: 1.5rem;
            }
            .main-nav { /* Allow horizontal scrolling for nav tabs on small screens */
                overflow-x: auto;
                justify-content: flex-start;
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
            .nav-tab {
                white-space: nowrap; /* Prevent tabs from wrapping */
            }
        }
         /* Spinner for loading state */
        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 3px solid var(--color-primary);
            width: 16px; /* Smaller spinner */
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden {
            display: none !important;
        }

    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <div id="auth-redirect-message" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-50 hidden">
        <div class="auth-container bg-white p-8 rounded-lg shadow-xl max-w-md w-full text-center">
            <img src="https://ik.imagekit.io/mwp/MWP%20Color%20no%20background.png?updatedAt=1745982959141" alt="MedwithPurpose Logo" class="mx-auto h-12 w-auto mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-3">Access Denied</h2>
            <p class="text-gray-600 mb-6">You need to be logged in to view this page.</p>
            <a href="student_dashboard.html" class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg transition-colors">
                Go to Login
            </a>
        </div>
    </div>

    <div id="dashboard-wrapper" class="dashboard-wrapper hidden"> <!-- Initially hidden -->
        <!-- Header -->
        <div class="dashboard-header">
            <a href="home.html">
                <img src="https://ik.imagekit.io/mwp/MWP%20Color%20no%20background.png?updatedAt=1745982959141" alt="MedwithPurpose Logo" class="logo-small" onerror="this.style.display='none'; this.onerror=null;">
            </a>
            <div class="flex items-center">
                <span class="welcome-user mr-4">Welcome, <span id="student-display-name" class="font-semibold">Student</span></span>
                <button id="logout-button" class="btn-logout" aria-label="Logout">
                    <span>Logout</span>
                </button>
            </div>
        </div>

        <!-- Main Navigation -->
        <nav class="main-nav" role="navigation" aria-label="Main Navigation">
            <a href="home.html" id="nav-home" class="nav-tab">Home</a>
            <div id="nav-practice" class="nav-tab nav-tab-disabled" role="button" aria-disabled="true">
                <span>Practice</span> <span class="coming-soon-inline">Coming Soon</span>
            </div>
            <div class="tests-dropdown-container">
                <div id="nav-tests" class="nav-tab" role="button" aria-haspopup="true">Tests</div>
                <div class="tests-dropdown-content" role="menu">
                    <a href="#" id="nav-tests-exams" class="dropdown-item disabled" role="menuitem" aria-disabled="true">Full Exams <span class="coming-soon-inline">Coming Soon</span></a>
                    <a href="#" id="nav-tests-vr" class="dropdown-item disabled" role="menuitem" aria-disabled="true">Verbal Reasoning <span class="coming-soon-inline">Coming Soon</span></a>
                    <a href="#" id="nav-tests-dm" class="dropdown-item disabled" role="menuitem" aria-disabled="true">Decision Making <span class="coming-soon-inline">Coming Soon</span></a>
                    <a href="student_dashboard.html#qr" id="nav-tests-qr" class="dropdown-item" role="menuitem">Quantitative Reasoning</a>
                    <a href="#" id="nav-tests-sjt" class="dropdown-item disabled" role="menuitem" aria-disabled="true">Situational Judgement <span class="coming-soon-inline">Coming Soon</span></a>
                </div>
            </div>
            <a href="focus_groups.html" id="nav-focus-groups" class="nav-tab" role="button">Focus Groups</a>
            <a href="student_dashboard.html#results" id="nav-results" class="nav-tab" role="button">Results</a>
            <div id="nav-skills" class="nav-tab nav-tab-disabled" role="button" aria-disabled="true">
                <span>Skills</span> <span class="coming-soon-inline">Coming Soon</span>
            </div>
        </nav>

        <!-- Content Area for Settings -->
        <main id="dashboard-content-area" class="dashboard-content-area">
            <div class="settings-container">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-8 text-center">Account Settings</h1>

                <!-- Profile Information Section -->
                <section class="settings-section" id="profile-settings">
                    <h2>Profile Information</h2>
                    <div class="input-group">
                        <label for="settings-name">Full Name</label>
                        <input type="text" id="settings-name" name="settings-name" placeholder="Your full name">
                    </div>
                    <div class="input-group">
                        <label for="settings-email">Email Address</label>
                        <input type="email" id="settings-email" name="settings-email" placeholder="your.email@example.com">
                    </div>
                    <button id="save-profile-button" class="btn-save">
                        <span id="profile-spinner" class="spinner hidden"></span>
                        Save Profile
                    </button>
                    <div id="profile-message" class="message hidden"></div>
                </section>

                <!-- Change Password Section -->
                <section class="settings-section" id="password-settings">
                    <h2>Change Password</h2>
                    <div class="input-group">
                        <label for="current-password">Current Password</label>
                        <input type="password" id="current-password" name="current-password" placeholder="Enter your current password">
                    </div>
                    <div class="input-group">
                        <label for="new-password">New Password</label>
                        <input type="password" id="new-password" name="new-password" placeholder="Enter new password (min. 6 characters)">
                    </div>
                    <div class="input-group">
                        <label for="confirm-password">Confirm New Password</label>
                        <input type="password" id="confirm-password" name="confirm-password" placeholder="Confirm new password">
                    </div>
                    <button id="change-password-button" class="btn-save">
                        <span id="password-spinner" class="spinner hidden"></span>
                        Change Password
                    </button>
                    <div id="password-message" class="message hidden"></div>
                </section>

                <!-- Exam Date Section -->
                <section class="settings-section" id="exam-date-settings">
                    <h2>Exam Date</h2>
                    <div class="input-group">
                        <label for="settings-exam-date">Date of Your Exam</label>
                        <input type="date" id="settings-exam-date" name="settings-exam-date">
                    </div>
                    <div class="input-group">
                        <label for="days-remaining-display">Days Remaining</label>
                        <input type="text" id="days-remaining-display" name="days-remaining-display" readonly class="bg-gray-100 cursor-default">
                    </div>
                    <button id="save-exam-date-button" class="btn-save">
                        <span id="exam-date-spinner" class="spinner hidden"></span>
                        Save Exam Date
                    </button>
                    <div id="exam-date-message" class="message hidden"></div>
                </section>

            </div>
        </main>
    </div>

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "YOUR_API_KEY_GOES_HERE_AFTER_RESTRICTING_IT_IN_GOOGLE_CLOUD_CONSOLE",
          authDomain: "mwp-qr-test-page.firebaseapp.com",
          projectId: "mwp-qr-test-page",
          storageBucket: "mwp-qr-test-page.appspot.com",
          messagingSenderId: "309084045110",
          appId: "1:309084045110:web:b09ca0fdff84b094963d97",
          measurementId: "G-4M3ED641M9"
        };

        let db;
        let auth;

        // --- UI Helper Functions ---
        function setButtonLoading(buttonId, spinnerId, isLoading) {
            const button = document.getElementById(buttonId);
            const spinner = document.getElementById(spinnerId);
            if (!button || !spinner) return;

            if (isLoading) {
                button.disabled = true;
                spinner.classList.remove('hidden');
                button.classList.add('opacity-70');
            } else {
                button.disabled = false;
                spinner.classList.add('hidden');
                button.classList.remove('opacity-70');
            }
        }

        function showMessage(elementId, text, type = 'success') {
            const element = document.getElementById(elementId);
            if (!element) return;
            element.textContent = text;
            element.className = 'message'; // Reset classes
            element.classList.add(type); // Add 'success' or 'error'
            element.classList.remove('hidden');
            setTimeout(() => {
                element.classList.add('hidden');
            }, 5000); // Hide after 5 seconds
        }

        document.addEventListener('DOMContentLoaded', function() {
            function initializeFirebaseAndSetup() {
                if (typeof firebase === 'undefined' || typeof firebase.initializeApp === 'undefined') {
                    console.log("Firebase scripts not loaded yet, trying again in 100ms for settings.html");
                    setTimeout(initializeFirebaseAndSetup, 100);
                    return;
                }
                
                try {
                    if (!firebase.apps.length) {
                        firebase.initializeApp(firebaseConfig);
                    }
                    auth = firebase.auth();
                    db = firebase.firestore();
                    console.log("Firebase and Firestore initialized successfully for settings.html");

                    setupEventListeners();
                    checkAuthStateAndLoadData();

                } catch (error) {
                    console.error("Firebase initialization error for settings.html:", error);
                    const authRedirectMessage = document.getElementById('auth-redirect-message');
                    authRedirectMessage.innerHTML = `<h2 class="text-xl font-semibold text-red-600 mb-4">Initialization Error</h2><p class="text-gray-700">Could not connect to services. Please try again later.</p>`;
                    authRedirectMessage.classList.remove('hidden');
                }
            }

            function checkAuthStateAndLoadData() {
                const dashboardWrapper = document.getElementById('dashboard-wrapper');
                const authRedirectMessage = document.getElementById('auth-redirect-message');
                const studentDisplayNameHeader = document.getElementById('student-display-name');
                
                const settingsNameInput = document.getElementById('settings-name');
                const settingsEmailInput = document.getElementById('settings-email');
                const settingsExamDateInput = document.getElementById('settings-exam-date');

                auth.onAuthStateChanged(async user => {
                    if (user) {
                        dashboardWrapper.classList.remove('hidden');
                        authRedirectMessage.classList.add('hidden');
                        
                        const displayName = user.displayName || user.email || 'Student';
                        if (studentDisplayNameHeader) studentDisplayNameHeader.textContent = displayName;
                        
                        // Load existing user data into forms
                        if (settingsNameInput) settingsNameInput.value = user.displayName || '';
                        if (settingsEmailInput) settingsEmailInput.value = user.email || '';
                        
                        loadExamDate(user); // Load and display exam date

                    } else {
                        dashboardWrapper.classList.add('hidden');
                        authRedirectMessage.classList.remove('hidden');
                    }
                });
            }

            function setupEventListeners() {
                const logoutButton = document.getElementById('logout-button');
                if (logoutButton) {
                    logoutButton.addEventListener('click', () => {
                        auth.signOut().then(() => {
                            window.location.href = 'student_dashboard.html';
                        }).catch(error => {
                            console.error("Logout error:", error);
                            showMessage('profile-message', 'Error logging out: ' + error.message, 'error'); // Show error somewhere
                        });
                    });
                }
                // Navigation Tabs - Remove 'active' from Home if it was set by template
                const navHome = document.getElementById('nav-home');
                if (navHome) navHome.classList.remove('active');

                // Save Profile Button
                const saveProfileButton = document.getElementById('save-profile-button');
                if (saveProfileButton) {
                    saveProfileButton.addEventListener('click', handleSaveProfile);
                }

                // Change Password Button
                const changePasswordButton = document.getElementById('change-password-button');
                if (changePasswordButton) {
                    changePasswordButton.addEventListener('click', handleChangePassword);
                }
                
                // Save Exam Date Button
                const saveExamDateButton = document.getElementById('save-exam-date-button');
                if (saveExamDateButton) {
                    saveExamDateButton.addEventListener('click', handleSaveExamDate);
                }

                // Update days remaining when exam date input changes
                const examDateInput = document.getElementById('settings-exam-date');
                if (examDateInput) {
                    examDateInput.addEventListener('change', () => {
                        updateDaysRemainingDisplay(examDateInput.value);
                    });
                }
            }

            // --- Profile Settings ---
            async function handleSaveProfile() {
                const user = auth.currentUser;
                if (!user) return;

                const newName = document.getElementById('settings-name').value.trim();
                const newEmail = document.getElementById('settings-email').value.trim();

                if (!newName) {
                    showMessage('profile-message', 'Name cannot be empty.', 'error');
                    return;
                }
                if (!newEmail || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(newEmail)) {
                    showMessage('profile-message', 'Please enter a valid email address.', 'error');
                    return;
                }
                
                setButtonLoading('save-profile-button', 'profile-spinner', true);
                
                try {
                    // Update Auth display name
                    if (user.displayName !== newName) {
                        await user.updateProfile({ displayName: newName });
                        console.log("Auth display name updated.");
                    }

                    // Update Auth email (requires re-authentication if different)
                    // For simplicity, we'll prompt for current password if email is changed.
                    // A more robust solution might involve a separate "verify email" flow.
                    if (user.email !== newEmail) {
                        const currentPassword = prompt("To change your email, please re-enter your current password:");
                        if (currentPassword) {
                            const credential = firebase.auth.EmailAuthProvider.credential(user.email, currentPassword);
                            await user.reauthenticateWithCredential(credential);
                            await user.updateEmail(newEmail);
                            console.log("Auth email updated.");
                        } else {
                            throw new Error("Password not provided for email change.");
                        }
                    }

                    // Update Firestore 'users' collection
                    await db.collection('users').doc(user.uid).set({
                        displayName: newName,
                        email: newEmail // Firestore email should match auth email
                    }, { merge: true });
                    console.log("Firestore user document updated.");

                    showMessage('profile-message', 'Profile updated successfully!', 'success');
                    // Update header display name
                     const studentDisplayNameHeader = document.getElementById('student-display-name');
                     if (studentDisplayNameHeader) studentDisplayNameHeader.textContent = newName;

                } catch (error) {
                    console.error("Error updating profile:", error);
                    showMessage('profile-message', 'Error updating profile: ' + error.message, 'error');
                } finally {
                    setButtonLoading('save-profile-button', 'profile-spinner', false);
                }
            }

            // --- Password Settings ---
            async function handleChangePassword() {
                const user = auth.currentUser;
                if (!user) return;

                const currentPassword = document.getElementById('current-password').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;

                if (!currentPassword) {
                    showMessage('password-message', 'Please enter your current password.', 'error');
                    return;
                }
                if (newPassword.length < 6) {
                    showMessage('password-message', 'New password must be at least 6 characters.', 'error');
                    return;
                }
                if (newPassword !== confirmPassword) {
                    showMessage('password-message', 'New passwords do not match.', 'error');
                    return;
                }

                setButtonLoading('change-password-button', 'password-spinner', true);

                try {
                    const credential = firebase.auth.EmailAuthProvider.credential(user.email, currentPassword);
                    await user.reauthenticateWithCredential(credential);
                    await user.updatePassword(newPassword);
                    
                    showMessage('password-message', 'Password changed successfully!', 'success');
                    document.getElementById('current-password').value = '';
                    document.getElementById('new-password').value = '';
                    document.getElementById('confirm-password').value = '';

                } catch (error) {
                    console.error("Error changing password:", error);
                     let friendlyMessage = 'Error changing password. Please check your current password.';
                    if(error.code === 'auth/wrong-password'){
                         friendlyMessage = 'Incorrect current password. Please try again.';
                    } else if (error.message) {
                        friendlyMessage = error.message;
                    }
                    showMessage('password-message', friendlyMessage, 'error');
                } finally {
                    setButtonLoading('change-password-button', 'password-spinner', false);
                }
            }

            // --- Exam Date Settings ---
            async function loadExamDate(user) {
                if (!user || !db) return;
                const examDateInput = document.getElementById('settings-exam-date');
                try {
                    const docRef = db.collection('userPreferences').doc(user.uid);
                    const docSnap = await docRef.get();
                    if (docSnap.exists) {
                        const preferences = docSnap.data();
                        if (preferences.examDate) {
                            examDateInput.value = preferences.examDate;
                            updateDaysRemainingDisplay(preferences.examDate);
                        } else {
                            updateDaysRemainingDisplay(null);
                        }
                    } else {
                         updateDaysRemainingDisplay(null);
                    }
                } catch (error) {
                    console.error("Error loading exam date for settings:", error);
                    showMessage('exam-date-message', 'Could not load exam date.', 'error');
                    updateDaysRemainingDisplay(null);
                }
            }
            
            function updateDaysRemainingDisplay(examDateStr) {
                const daysRemainingDisplay = document.getElementById('days-remaining-display');
                if (!daysRemainingDisplay) return;

                if (!examDateStr) {
                    daysRemainingDisplay.value = 'Not set';
                    return;
                }
                const examDate = new Date(examDateStr + "T00:00:00"); // Ensure local midnight
                const today = new Date();
                today.setHours(0,0,0,0);

                if (examDate < today) {
                    daysRemainingDisplay.value = 'Date has passed';
                } else {
                    const diffTime = Math.abs(examDate - today);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    daysRemainingDisplay.value = `${diffDays} day(s) remaining`;
                }
            }

            async function handleSaveExamDate() {
                const user = auth.currentUser;
                if (!user || !db) return;

                const examDate = document.getElementById('settings-exam-date').value;
                if (!examDate) {
                    showMessage('exam-date-message', 'Please select an exam date.', 'error');
                    return;
                }
                
                setButtonLoading('save-exam-date-button', 'exam-date-spinner', true);

                try {
                    await db.collection('userPreferences').doc(user.uid).set({
                        examDate: examDate
                    }, { merge: true });
                    showMessage('exam-date-message', 'Exam date saved successfully!', 'success');
                    updateDaysRemainingDisplay(examDate);
                } catch (error) {
                    console.error("Error saving exam date:", error);
                    showMessage('exam-date-message', 'Error saving exam date: ' + error.message, 'error');
                } finally {
                     setButtonLoading('save-exam-date-button', 'exam-date-spinner', false);
                }
            }

            // Start Firebase initialization
            initializeFirebaseAndSetup();
        });
    </script>
</body>
</html> 